!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e,i){var s;t.exports=function t(e,i,r){function o(a,l){if(!i[a]){if(!e[a]){if(!l&&"function"==typeof s&&s)return s(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[a]={exports:{}};e[a][0].call(c.exports,function(t){return o(e[a][1][t]||t)},c,c.exports,t,e,i,r)}return i[a].exports}for(var n="function"==typeof s&&s,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(t,e,i){"use strict";var s=t("./zlib/deflate"),r=t("./utils/common"),o=t("./utils/strings"),n=t("./zlib/messages"),a=t("./zlib/zstream"),l=Object.prototype.toString,h=0,c=-1,d=0,u=8;function _(t){if(!(this instanceof _))return new _(t);this.options=r.assign({level:c,method:u,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==h)throw new Error(n[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var p;if(p="string"==typeof e.dictionary?o.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(i=s.deflateSetDictionary(this.strm,p))!==h)throw new Error(n[i]);this._dict_set=!0}}function p(t,e){var i=new _(e);if(i.push(t,!0),i.err)throw i.msg||n[i.err];return i.result}_.prototype.push=function(t,e){var i,n,a=this.strm,c=this.options.chunkSize;if(this.ended)return!1;n=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=o.string2buf(t):"[object ArrayBuffer]"===l.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new r.Buf8(c),a.next_out=0,a.avail_out=c),1!==(i=s.deflate(a,n))&&i!==h)return this.onEnd(i),this.ended=!0,!1;0!==a.avail_out&&(0!==a.avail_in||4!==n&&2!==n)||("string"===this.options.to?this.onData(o.buf2binstring(r.shrinkBuf(a.output,a.next_out))):this.onData(r.shrinkBuf(a.output,a.next_out)))}while((a.avail_in>0||0===a.avail_out)&&1!==i);return 4===n?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===h):2!==n||(this.onEnd(h),a.avail_out=0,!0)},_.prototype.onData=function(t){this.chunks.push(t)},_.prototype.onEnd=function(t){t===h&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=_,i.deflate=p,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,p(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,p(t,e)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(t,e,i){"use strict";var s=t("./zlib/inflate"),r=t("./utils/common"),o=t("./utils/strings"),n=t("./zlib/constants"),a=t("./zlib/messages"),l=t("./zlib/zstream"),h=t("./zlib/gzheader"),c=Object.prototype.toString;function d(t){if(!(this instanceof d))return new d(t);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==n.Z_OK)throw new Error(a[i]);if(this.header=new h,s.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=o.string2buf(e.dictionary):"[object ArrayBuffer]"===c.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=s.inflateSetDictionary(this.strm,e.dictionary))!==n.Z_OK))throw new Error(a[i])}function u(t,e){var i=new d(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}d.prototype.push=function(t,e){var i,a,l,h,d,u=this.strm,_=this.options.chunkSize,p=this.options.dictionary,f=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?n.Z_FINISH:n.Z_NO_FLUSH,"string"==typeof t?u.input=o.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?u.input=new Uint8Array(t):u.input=t,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new r.Buf8(_),u.next_out=0,u.avail_out=_),(i=s.inflate(u,n.Z_NO_FLUSH))===n.Z_NEED_DICT&&p&&(i=s.inflateSetDictionary(this.strm,p)),i===n.Z_BUF_ERROR&&!0===f&&(i=n.Z_OK,f=!1),i!==n.Z_STREAM_END&&i!==n.Z_OK)return this.onEnd(i),this.ended=!0,!1;u.next_out&&(0!==u.avail_out&&i!==n.Z_STREAM_END&&(0!==u.avail_in||a!==n.Z_FINISH&&a!==n.Z_SYNC_FLUSH)||("string"===this.options.to?(l=o.utf8border(u.output,u.next_out),h=u.next_out-l,d=o.buf2string(u.output,l),u.next_out=h,u.avail_out=_-h,h&&r.arraySet(u.output,u.output,l,h,0),this.onData(d)):this.onData(r.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(f=!0)}while((u.avail_in>0||0===u.avail_out)&&i!==n.Z_STREAM_END);return i===n.Z_STREAM_END&&(a=n.Z_FINISH),a===n.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===n.Z_OK):a!==n.Z_SYNC_FLUSH||(this.onEnd(n.Z_OK),u.avail_out=0,!0)},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===n.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=d,i.inflate=u,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},i.ungzip=u},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(t,e,i){"use strict";var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function r(t,e){return Object.prototype.hasOwnProperty.call(t,e)}i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)r(i,s)&&(t[s]=i[s])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var o={arraySet:function(t,e,i,s,r){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),r);else for(var o=0;o<s;o++)t[r+o]=e[i+o]},flattenChunks:function(t){var e,i,s,r,o,n;for(s=0,e=0,i=t.length;e<i;e++)s+=t[e].length;for(n=new Uint8Array(s),r=0,e=0,i=t.length;e<i;e++)o=t[e],n.set(o,r),r+=o.length;return n}},n={arraySet:function(t,e,i,s,r){for(var o=0;o<s;o++)t[r+o]=e[i+o]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,o)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,n))},i.setTyped(s)},{}],4:[function(t,e,i){"use strict";var s=t("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(t){r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){o=!1}for(var n=new s.Buf8(256),a=0;a<256;a++)n[a]=a>=252?6:a>=248?5:a>=240?4:a>=224?3:a>=192?2:1;function l(t,e){if(e<65534&&(t.subarray&&o||!t.subarray&&r))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",n=0;n<e;n++)i+=String.fromCharCode(t[n]);return i}n[254]=n[254]=1,i.string2buf=function(t){var e,i,r,o,n,a=t.length,l=0;for(o=0;o<a;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(r=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(r-56320),o++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(l),n=0,o=0;n<l;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<a&&56320==(64512&(r=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(r-56320),o++),i<128?e[n++]=i:i<2048?(e[n++]=192|i>>>6,e[n++]=128|63&i):i<65536?(e[n++]=224|i>>>12,e[n++]=128|i>>>6&63,e[n++]=128|63&i):(e[n++]=240|i>>>18,e[n++]=128|i>>>12&63,e[n++]=128|i>>>6&63,e[n++]=128|63&i);return e},i.buf2binstring=function(t){return l(t,t.length)},i.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,r=e.length;i<r;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,s,r,o,a=e||t.length,h=new Array(2*a);for(s=0,i=0;i<a;)if((r=t[i++])<128)h[s++]=r;else if((o=n[r])>4)h[s++]=65533,i+=o-1;else{for(r&=2===o?31:3===o?15:7;o>1&&i<a;)r=r<<6|63&t[i++],o--;o>1?h[s++]=65533:r<65536?h[s++]=r:(r-=65536,h[s++]=55296|r>>10&1023,h[s++]=56320|1023&r)}return l(h,s)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0?e:0===i?e:i+n[t[i]]>e?i:e}},{"./common":3}],5:[function(t,e,i){"use strict";e.exports=function(t,e,i,s){for(var r=65535&t|0,o=t>>>16&65535|0,n=0;0!==i;){i-=n=i>2e3?2e3:i;do{o=o+(r=r+e[s++]|0)|0}while(--n);r%=65521,o%=65521}return r|o<<16|0}},{}],6:[function(t,e,i){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(t,e,i){"use strict";var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,r){var o=s,n=r+i;t^=-1;for(var a=r;a<n;a++)t=t>>>8^o[255&(t^e[a])];return-1^t}},{}],8:[function(t,e,i){"use strict";var s,r=t("../utils/common"),o=t("./trees"),n=t("./adler32"),a=t("./crc32"),l=t("./messages"),h=0,c=1,d=3,u=4,_=5,p=0,f=1,g=-2,m=-3,v=-5,b=-1,y=1,w=2,P=3,M=4,x=0,A=2,E=8,L=9,C=15,k=8,D=286,S=30,R=19,B=2*D+1,T=15,F=3,I=258,N=I+F+1,O=32,V=42,z=69,U=73,j=91,Y=103,G=113,H=666,K=1,X=2,W=3,q=4,Z=3;function $(t,e){return t.msg=l[e],e}function Q(t){return(t<<1)-(t>4?9:0)}function J(t){for(var e=t.length;--e>=0;)t[e]=0}function tt(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(r.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function et(t,e){o._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,tt(t.strm)}function it(t,e){t.pending_buf[t.pending++]=e}function st(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function rt(t,e){var i,s,r=t.max_chain_length,o=t.strstart,n=t.prev_length,a=t.nice_match,l=t.strstart>t.w_size-N?t.strstart-(t.w_size-N):0,h=t.window,c=t.w_mask,d=t.prev,u=t.strstart+I,_=h[o+n-1],p=h[o+n];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do{if(h[(i=e)+n]===p&&h[i+n-1]===_&&h[i]===h[o]&&h[++i]===h[o+1]){o+=2,i++;do{}while(h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&o<u);if(s=I-(u-o),o=u-I,s>n){if(t.match_start=e,n=s,s>=a)break;_=h[o+n-1],p=h[o+n]}}}while((e=d[e&c])>l&&0!=--r);return n<=t.lookahead?n:t.lookahead}function ot(t){var e,i,s,o,l,h,c,d,u,_,p=t.w_size;do{if(o=t.window_size-t.lookahead-t.strstart,t.strstart>=p+(p-N)){r.arraySet(t.window,t.window,p,p,0),t.match_start-=p,t.strstart-=p,t.block_start-=p,e=i=t.hash_size;do{s=t.head[--e],t.head[e]=s>=p?s-p:0}while(--i);e=i=p;do{s=t.prev[--e],t.prev[e]=s>=p?s-p:0}while(--i);o+=p}if(0===t.strm.avail_in)break;if(h=t.strm,c=t.window,d=t.strstart+t.lookahead,u=o,_=void 0,(_=h.avail_in)>u&&(_=u),i=0===_?0:(h.avail_in-=_,r.arraySet(c,h.input,h.next_in,_,d),1===h.state.wrap?h.adler=n(h.adler,c,_,d):2===h.state.wrap&&(h.adler=a(h.adler,c,_,d)),h.next_in+=_,h.total_in+=_,_),t.lookahead+=i,t.lookahead+t.insert>=F)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+F-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<F)););}while(t.lookahead<N&&0!==t.strm.avail_in)}function nt(t,e){for(var i,s;;){if(t.lookahead<N){if(ot(t),t.lookahead<N&&e===h)return K;if(0===t.lookahead)break}if(i=0,t.lookahead>=F&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+F-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-N&&(t.match_length=rt(t,i)),t.match_length>=F)if(s=o._tr_tally(t,t.strstart-t.match_start,t.match_length-F),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=F){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+F-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(et(t,!1),0===t.strm.avail_out))return K}return t.insert=t.strstart<F-1?t.strstart:F-1,e===u?(et(t,!0),0===t.strm.avail_out?W:q):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?K:X}function at(t,e){for(var i,s,r;;){if(t.lookahead<N){if(ot(t),t.lookahead<N&&e===h)return K;if(0===t.lookahead)break}if(i=0,t.lookahead>=F&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+F-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=F-1,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-N&&(t.match_length=rt(t,i),t.match_length<=5&&(t.strategy===y||t.match_length===F&&t.strstart-t.match_start>4096)&&(t.match_length=F-1)),t.prev_length>=F&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-F,s=o._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-F),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=r&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+F-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=F-1,t.strstart++,s&&(et(t,!1),0===t.strm.avail_out))return K}else if(t.match_available){if((s=o._tr_tally(t,0,t.window[t.strstart-1]))&&et(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return K}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=o._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<F-1?t.strstart:F-1,e===u?(et(t,!0),0===t.strm.avail_out?W:q):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?K:X}function lt(t,e,i,s,r){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=r}function ht(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=E,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*B),this.dyn_dtree=new r.Buf16(2*(2*S+1)),this.bl_tree=new r.Buf16(2*(2*R+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(T+1),this.heap=new r.Buf16(2*D+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*D+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function ct(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=A,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?V:G,t.adler=2===e.wrap?0:1,e.last_flush=h,o._tr_init(e),p):$(t,g)}function dt(t){var e,i=ct(t);return i===p&&((e=t.state).window_size=2*e.w_size,J(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=F-1,e.match_available=0,e.ins_h=0),i}function ut(t,e,i,s,o,n){if(!t)return g;var a=1;if(e===b&&(e=6),s<0?(a=0,s=-s):s>15&&(a=2,s-=16),o<1||o>L||i!==E||s<8||s>15||e<0||e>9||n<0||n>M)return $(t,g);8===s&&(s=9);var l=new ht;return t.state=l,l.strm=t,l.wrap=a,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=o+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+F-1)/F),l.window=new r.Buf8(2*l.w_size),l.head=new r.Buf16(l.hash_size),l.prev=new r.Buf16(l.w_size),l.lit_bufsize=1<<o+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new r.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=n,l.method=i,dt(t)}s=[new lt(0,0,0,0,function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(ot(t),0===t.lookahead&&e===h)return K;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,et(t,!1),0===t.strm.avail_out))return K;if(t.strstart-t.block_start>=t.w_size-N&&(et(t,!1),0===t.strm.avail_out))return K}return t.insert=0,e===u?(et(t,!0),0===t.strm.avail_out?W:q):(t.strstart>t.block_start&&(et(t,!1),t.strm.avail_out),K)}),new lt(4,4,8,4,nt),new lt(4,5,16,8,nt),new lt(4,6,32,32,nt),new lt(4,4,16,16,at),new lt(8,16,32,32,at),new lt(8,16,128,128,at),new lt(8,32,128,256,at),new lt(32,128,258,1024,at),new lt(32,258,258,4096,at)],i.deflateInit=function(t,e){return ut(t,e,E,C,k,x)},i.deflateInit2=ut,i.deflateReset=dt,i.deflateResetKeep=ct,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?g:(t.state.gzhead=e,p):g},i.deflate=function(t,e){var i,r,n,l;if(!t||!t.state||e>_||e<0)return t?$(t,g):g;if(r=t.state,!t.output||!t.input&&0!==t.avail_in||r.status===H&&e!==u)return $(t,0===t.avail_out?v:g);if(r.strm=t,i=r.last_flush,r.last_flush=e,r.status===V)if(2===r.wrap)t.adler=0,it(r,31),it(r,139),it(r,8),r.gzhead?(it(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),it(r,255&r.gzhead.time),it(r,r.gzhead.time>>8&255),it(r,r.gzhead.time>>16&255),it(r,r.gzhead.time>>24&255),it(r,9===r.level?2:r.strategy>=w||r.level<2?4:0),it(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(it(r,255&r.gzhead.extra.length),it(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(t.adler=a(t.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=z):(it(r,0),it(r,0),it(r,0),it(r,0),it(r,0),it(r,9===r.level?2:r.strategy>=w||r.level<2?4:0),it(r,Z),r.status=G);else{var m=E+(r.w_bits-8<<4)<<8;m|=(r.strategy>=w||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(m|=O),m+=31-m%31,r.status=G,st(r,m),0!==r.strstart&&(st(r,t.adler>>>16),st(r,65535&t.adler)),t.adler=1}if(r.status===z)if(r.gzhead.extra){for(n=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),tt(t),n=r.pending,r.pending!==r.pending_buf_size));)it(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=U)}else r.status=U;if(r.status===U)if(r.gzhead.name){n=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),tt(t),n=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,it(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),0===l&&(r.gzindex=0,r.status=j)}else r.status=j;if(r.status===j)if(r.gzhead.comment){n=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),tt(t),n=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,it(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>n&&(t.adler=a(t.adler,r.pending_buf,r.pending-n,n)),0===l&&(r.status=Y)}else r.status=Y;if(r.status===Y&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&tt(t),r.pending+2<=r.pending_buf_size&&(it(r,255&t.adler),it(r,t.adler>>8&255),t.adler=0,r.status=G)):r.status=G),0!==r.pending){if(tt(t),0===t.avail_out)return r.last_flush=-1,p}else if(0===t.avail_in&&Q(e)<=Q(i)&&e!==u)return $(t,v);if(r.status===H&&0!==t.avail_in)return $(t,v);if(0!==t.avail_in||0!==r.lookahead||e!==h&&r.status!==H){var b=r.strategy===w?function(t,e){for(var i;;){if(0===t.lookahead&&(ot(t),0===t.lookahead)){if(e===h)return K;break}if(t.match_length=0,i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(et(t,!1),0===t.strm.avail_out))return K}return t.insert=0,e===u?(et(t,!0),0===t.strm.avail_out?W:q):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?K:X}(r,e):r.strategy===P?function(t,e){for(var i,s,r,n,a=t.window;;){if(t.lookahead<=I){if(ot(t),t.lookahead<=I&&e===h)return K;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=F&&t.strstart>0&&(s=a[r=t.strstart-1])===a[++r]&&s===a[++r]&&s===a[++r]){n=t.strstart+I;do{}while(s===a[++r]&&s===a[++r]&&s===a[++r]&&s===a[++r]&&s===a[++r]&&s===a[++r]&&s===a[++r]&&s===a[++r]&&r<n);t.match_length=I-(n-r),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=F?(i=o._tr_tally(t,1,t.match_length-F),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(et(t,!1),0===t.strm.avail_out))return K}return t.insert=0,e===u?(et(t,!0),0===t.strm.avail_out?W:q):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?K:X}(r,e):s[r.level].func(r,e);if(b!==W&&b!==q||(r.status=H),b===K||b===W)return 0===t.avail_out&&(r.last_flush=-1),p;if(b===X&&(e===c?o._tr_align(r):e!==_&&(o._tr_stored_block(r,0,0,!1),e===d&&(J(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),tt(t),0===t.avail_out))return r.last_flush=-1,p}return e!==u?p:r.wrap<=0?f:(2===r.wrap?(it(r,255&t.adler),it(r,t.adler>>8&255),it(r,t.adler>>16&255),it(r,t.adler>>24&255),it(r,255&t.total_in),it(r,t.total_in>>8&255),it(r,t.total_in>>16&255),it(r,t.total_in>>24&255)):(st(r,t.adler>>>16),st(r,65535&t.adler)),tt(t),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?p:f)},i.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==V&&e!==z&&e!==U&&e!==j&&e!==Y&&e!==G&&e!==H?$(t,g):(t.state=null,e===G?$(t,m):p):g},i.deflateSetDictionary=function(t,e){var i,s,o,a,l,h,c,d,u=e.length;if(!t||!t.state)return g;if(2===(a=(i=t.state).wrap)||1===a&&i.status!==V||i.lookahead)return g;for(1===a&&(t.adler=n(t.adler,e,u,0)),i.wrap=0,u>=i.w_size&&(0===a&&(J(i.head),i.strstart=0,i.block_start=0,i.insert=0),d=new r.Buf8(i.w_size),r.arraySet(d,e,u-i.w_size,i.w_size,0),e=d,u=i.w_size),l=t.avail_in,h=t.next_in,c=t.input,t.avail_in=u,t.next_in=0,t.input=e,ot(i);i.lookahead>=F;){s=i.strstart,o=i.lookahead-(F-1);do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+F-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++}while(--o);i.strstart=s,i.lookahead=F-1,ot(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=F-1,i.match_available=0,t.next_in=h,t.input=c,t.avail_in=l,i.wrap=a,p},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(t,e,i){"use strict";e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(t,e,i){"use strict";e.exports=function(t,e){var i,s,r,o,n,a,l,h,c,d,u,_,p,f,g,m,v,b,y,w,P,M,x,A,E;i=t.state,s=t.next_in,A=t.input,r=s+(t.avail_in-5),o=t.next_out,E=t.output,n=o-(e-t.avail_out),a=o+(t.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,d=i.wnext,u=i.window,_=i.hold,p=i.bits,f=i.lencode,g=i.distcode,m=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;t:do{p<15&&(_+=A[s++]<<p,p+=8,_+=A[s++]<<p,p+=8),b=f[_&m];e:for(;;){if(_>>>=y=b>>>24,p-=y,0==(y=b>>>16&255))E[o++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=f[(65535&b)+(_&(1<<y)-1)];continue e}if(32&y){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}w=65535&b,(y&=15)&&(p<y&&(_+=A[s++]<<p,p+=8),w+=_&(1<<y)-1,_>>>=y,p-=y),p<15&&(_+=A[s++]<<p,p+=8,_+=A[s++]<<p,p+=8),b=g[_&v];i:for(;;){if(_>>>=y=b>>>24,p-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=g[(65535&b)+(_&(1<<y)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(P=65535&b,p<(y&=15)&&(_+=A[s++]<<p,(p+=8)<y&&(_+=A[s++]<<p,p+=8)),(P+=_&(1<<y)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(_>>>=y,p-=y,P>(y=o-n)){if((y=P-y)>c&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(M=0,x=u,0===d){if(M+=h-y,y<w){w-=y;do{E[o++]=u[M++]}while(--y);M=o-P,x=E}}else if(d<y){if(M+=h+d-y,(y-=d)<w){w-=y;do{E[o++]=u[M++]}while(--y);if(M=0,d<w){w-=y=d;do{E[o++]=u[M++]}while(--y);M=o-P,x=E}}}else if(M+=d-y,y<w){w-=y;do{E[o++]=u[M++]}while(--y);M=o-P,x=E}for(;w>2;)E[o++]=x[M++],E[o++]=x[M++],E[o++]=x[M++],w-=3;w&&(E[o++]=x[M++],w>1&&(E[o++]=x[M++]))}else{M=o-P;do{E[o++]=E[M++],E[o++]=E[M++],E[o++]=E[M++],w-=3}while(w>2);w&&(E[o++]=E[M++],w>1&&(E[o++]=E[M++]))}break}}break}}while(s<r&&o<a);s-=w=p>>3,_&=(1<<(p-=w<<3))-1,t.next_in=s,t.next_out=o,t.avail_in=s<r?r-s+5:5-(s-r),t.avail_out=o<a?a-o+257:257-(o-a),i.hold=_,i.bits=p}},{}],11:[function(t,e,i){"use strict";var s=t("../utils/common"),r=t("./adler32"),o=t("./crc32"),n=t("./inffast"),a=t("./inftrees"),l=0,h=1,c=2,d=4,u=5,_=6,p=0,f=1,g=2,m=-2,v=-3,b=-4,y=-5,w=8,P=1,M=2,x=3,A=4,E=5,L=6,C=7,k=8,D=9,S=10,R=11,B=12,T=13,F=14,I=15,N=16,O=17,V=18,z=19,U=20,j=21,Y=22,G=23,H=24,K=25,X=26,W=27,q=28,Z=29,$=30,Q=31,J=32,tt=852,et=592,it=15;function st(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function rt(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ot(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=P,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(tt),e.distcode=e.distdyn=new s.Buf32(et),e.sane=1,e.back=-1,p):m}function nt(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,ot(t)):m}function at(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?m:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,nt(t))):m}function lt(t,e){var i,s;return t?(s=new rt,t.state=s,s.window=null,(i=at(t,e))!==p&&(t.state=null),i):m}var ht,ct,dt=!0;function ut(t){if(dt){var e;for(ht=new s.Buf32(512),ct=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(h,t.lens,0,288,ht,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(c,t.lens,0,32,ct,0,t.work,{bits:5}),dt=!1}t.lencode=ht,t.lenbits=9,t.distcode=ct,t.distbits=5}function _t(t,e,i,r){var o,n=t.state;return null===n.window&&(n.wsize=1<<n.wbits,n.wnext=0,n.whave=0,n.window=new s.Buf8(n.wsize)),r>=n.wsize?(s.arraySet(n.window,e,i-n.wsize,n.wsize,0),n.wnext=0,n.whave=n.wsize):((o=n.wsize-n.wnext)>r&&(o=r),s.arraySet(n.window,e,i-r,o,n.wnext),(r-=o)?(s.arraySet(n.window,e,i-r,r,0),n.wnext=r,n.whave=n.wsize):(n.wnext+=o,n.wnext===n.wsize&&(n.wnext=0),n.whave<n.wsize&&(n.whave+=o))),0}i.inflateReset=nt,i.inflateReset2=at,i.inflateResetKeep=ot,i.inflateInit=function(t){return lt(t,it)},i.inflateInit2=lt,i.inflate=function(t,e){var i,tt,et,it,rt,ot,nt,at,lt,ht,ct,dt,pt,ft,gt,mt,vt,bt,yt,wt,Pt,Mt,xt,At,Et=0,Lt=new s.Buf8(4),Ct=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return m;(i=t.state).mode===B&&(i.mode=T),rt=t.next_out,et=t.output,nt=t.avail_out,it=t.next_in,tt=t.input,ot=t.avail_in,at=i.hold,lt=i.bits,ht=ot,ct=nt,Mt=p;t:for(;;)switch(i.mode){case P:if(0===i.wrap){i.mode=T;break}for(;lt<16;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(2&i.wrap&&35615===at){i.check=0,Lt[0]=255&at,Lt[1]=at>>>8&255,i.check=o(i.check,Lt,2,0),at=0,lt=0,i.mode=M;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&at)<<8)+(at>>8))%31){t.msg="incorrect header check",i.mode=$;break}if((15&at)!==w){t.msg="unknown compression method",i.mode=$;break}if(lt-=4,Pt=8+(15&(at>>>=4)),0===i.wbits)i.wbits=Pt;else if(Pt>i.wbits){t.msg="invalid window size",i.mode=$;break}i.dmax=1<<Pt,t.adler=i.check=1,i.mode=512&at?S:B,at=0,lt=0;break;case M:for(;lt<16;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(i.flags=at,(255&i.flags)!==w){t.msg="unknown compression method",i.mode=$;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=$;break}i.head&&(i.head.text=at>>8&1),512&i.flags&&(Lt[0]=255&at,Lt[1]=at>>>8&255,i.check=o(i.check,Lt,2,0)),at=0,lt=0,i.mode=x;case x:for(;lt<32;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.head&&(i.head.time=at),512&i.flags&&(Lt[0]=255&at,Lt[1]=at>>>8&255,Lt[2]=at>>>16&255,Lt[3]=at>>>24&255,i.check=o(i.check,Lt,4,0)),at=0,lt=0,i.mode=A;case A:for(;lt<16;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.head&&(i.head.xflags=255&at,i.head.os=at>>8),512&i.flags&&(Lt[0]=255&at,Lt[1]=at>>>8&255,i.check=o(i.check,Lt,2,0)),at=0,lt=0,i.mode=E;case E:if(1024&i.flags){for(;lt<16;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.length=at,i.head&&(i.head.extra_len=at),512&i.flags&&(Lt[0]=255&at,Lt[1]=at>>>8&255,i.check=o(i.check,Lt,2,0)),at=0,lt=0}else i.head&&(i.head.extra=null);i.mode=L;case L:if(1024&i.flags&&((dt=i.length)>ot&&(dt=ot),dt&&(i.head&&(Pt=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,tt,it,dt,Pt)),512&i.flags&&(i.check=o(i.check,tt,dt,it)),ot-=dt,it+=dt,i.length-=dt),i.length))break t;i.length=0,i.mode=C;case C:if(2048&i.flags){if(0===ot)break t;dt=0;do{Pt=tt[it+dt++],i.head&&Pt&&i.length<65536&&(i.head.name+=String.fromCharCode(Pt))}while(Pt&&dt<ot);if(512&i.flags&&(i.check=o(i.check,tt,dt,it)),ot-=dt,it+=dt,Pt)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=k;case k:if(4096&i.flags){if(0===ot)break t;dt=0;do{Pt=tt[it+dt++],i.head&&Pt&&i.length<65536&&(i.head.comment+=String.fromCharCode(Pt))}while(Pt&&dt<ot);if(512&i.flags&&(i.check=o(i.check,tt,dt,it)),ot-=dt,it+=dt,Pt)break t}else i.head&&(i.head.comment=null);i.mode=D;case D:if(512&i.flags){for(;lt<16;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(at!==(65535&i.check)){t.msg="header crc mismatch",i.mode=$;break}at=0,lt=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=B;break;case S:for(;lt<32;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}t.adler=i.check=st(at),at=0,lt=0,i.mode=R;case R:if(0===i.havedict)return t.next_out=rt,t.avail_out=nt,t.next_in=it,t.avail_in=ot,i.hold=at,i.bits=lt,g;t.adler=i.check=1,i.mode=B;case B:if(e===u||e===_)break t;case T:if(i.last){at>>>=7&lt,lt-=7&lt,i.mode=W;break}for(;lt<3;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}switch(i.last=1&at,lt-=1,3&(at>>>=1)){case 0:i.mode=F;break;case 1:if(ut(i),i.mode=U,e===_){at>>>=2,lt-=2;break t}break;case 2:i.mode=O;break;case 3:t.msg="invalid block type",i.mode=$}at>>>=2,lt-=2;break;case F:for(at>>>=7&lt,lt-=7&lt;lt<32;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if((65535&at)!=(at>>>16^65535)){t.msg="invalid stored block lengths",i.mode=$;break}if(i.length=65535&at,at=0,lt=0,i.mode=I,e===_)break t;case I:i.mode=N;case N:if(dt=i.length){if(dt>ot&&(dt=ot),dt>nt&&(dt=nt),0===dt)break t;s.arraySet(et,tt,it,dt,rt),ot-=dt,it+=dt,nt-=dt,rt+=dt,i.length-=dt;break}i.mode=B;break;case O:for(;lt<14;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(i.nlen=257+(31&at),at>>>=5,lt-=5,i.ndist=1+(31&at),at>>>=5,lt-=5,i.ncode=4+(15&at),at>>>=4,lt-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=$;break}i.have=0,i.mode=V;case V:for(;i.have<i.ncode;){for(;lt<3;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.lens[Ct[i.have++]]=7&at,at>>>=3,lt-=3}for(;i.have<19;)i.lens[Ct[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,xt={bits:i.lenbits},Mt=a(l,i.lens,0,19,i.lencode,0,i.work,xt),i.lenbits=xt.bits,Mt){t.msg="invalid code lengths set",i.mode=$;break}i.have=0,i.mode=z;case z:for(;i.have<i.nlen+i.ndist;){for(;mt=(Et=i.lencode[at&(1<<i.lenbits)-1])>>>16&255,vt=65535&Et,!((gt=Et>>>24)<=lt);){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(vt<16)at>>>=gt,lt-=gt,i.lens[i.have++]=vt;else{if(16===vt){for(At=gt+2;lt<At;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(at>>>=gt,lt-=gt,0===i.have){t.msg="invalid bit length repeat",i.mode=$;break}Pt=i.lens[i.have-1],dt=3+(3&at),at>>>=2,lt-=2}else if(17===vt){for(At=gt+3;lt<At;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}lt-=gt,Pt=0,dt=3+(7&(at>>>=gt)),at>>>=3,lt-=3}else{for(At=gt+7;lt<At;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}lt-=gt,Pt=0,dt=11+(127&(at>>>=gt)),at>>>=7,lt-=7}if(i.have+dt>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=$;break}for(;dt--;)i.lens[i.have++]=Pt}}if(i.mode===$)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=$;break}if(i.lenbits=9,xt={bits:i.lenbits},Mt=a(h,i.lens,0,i.nlen,i.lencode,0,i.work,xt),i.lenbits=xt.bits,Mt){t.msg="invalid literal/lengths set",i.mode=$;break}if(i.distbits=6,i.distcode=i.distdyn,xt={bits:i.distbits},Mt=a(c,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,xt),i.distbits=xt.bits,Mt){t.msg="invalid distances set",i.mode=$;break}if(i.mode=U,e===_)break t;case U:i.mode=j;case j:if(ot>=6&&nt>=258){t.next_out=rt,t.avail_out=nt,t.next_in=it,t.avail_in=ot,i.hold=at,i.bits=lt,n(t,ct),rt=t.next_out,et=t.output,nt=t.avail_out,it=t.next_in,tt=t.input,ot=t.avail_in,at=i.hold,lt=i.bits,i.mode===B&&(i.back=-1);break}for(i.back=0;mt=(Et=i.lencode[at&(1<<i.lenbits)-1])>>>16&255,vt=65535&Et,!((gt=Et>>>24)<=lt);){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(mt&&0==(240&mt)){for(bt=gt,yt=mt,wt=vt;mt=(Et=i.lencode[wt+((at&(1<<bt+yt)-1)>>bt)])>>>16&255,vt=65535&Et,!(bt+(gt=Et>>>24)<=lt);){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}at>>>=bt,lt-=bt,i.back+=bt}if(at>>>=gt,lt-=gt,i.back+=gt,i.length=vt,0===mt){i.mode=X;break}if(32&mt){i.back=-1,i.mode=B;break}if(64&mt){t.msg="invalid literal/length code",i.mode=$;break}i.extra=15&mt,i.mode=Y;case Y:if(i.extra){for(At=i.extra;lt<At;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.length+=at&(1<<i.extra)-1,at>>>=i.extra,lt-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=G;case G:for(;mt=(Et=i.distcode[at&(1<<i.distbits)-1])>>>16&255,vt=65535&Et,!((gt=Et>>>24)<=lt);){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(0==(240&mt)){for(bt=gt,yt=mt,wt=vt;mt=(Et=i.distcode[wt+((at&(1<<bt+yt)-1)>>bt)])>>>16&255,vt=65535&Et,!(bt+(gt=Et>>>24)<=lt);){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}at>>>=bt,lt-=bt,i.back+=bt}if(at>>>=gt,lt-=gt,i.back+=gt,64&mt){t.msg="invalid distance code",i.mode=$;break}i.offset=vt,i.extra=15&mt,i.mode=H;case H:if(i.extra){for(At=i.extra;lt<At;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}i.offset+=at&(1<<i.extra)-1,at>>>=i.extra,lt-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=$;break}i.mode=K;case K:if(0===nt)break t;if(dt=ct-nt,i.offset>dt){if((dt=i.offset-dt)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=$;break}dt>i.wnext?(dt-=i.wnext,pt=i.wsize-dt):pt=i.wnext-dt,dt>i.length&&(dt=i.length),ft=i.window}else ft=et,pt=rt-i.offset,dt=i.length;dt>nt&&(dt=nt),nt-=dt,i.length-=dt;do{et[rt++]=ft[pt++]}while(--dt);0===i.length&&(i.mode=j);break;case X:if(0===nt)break t;et[rt++]=i.length,nt--,i.mode=j;break;case W:if(i.wrap){for(;lt<32;){if(0===ot)break t;ot--,at|=tt[it++]<<lt,lt+=8}if(ct-=nt,t.total_out+=ct,i.total+=ct,ct&&(t.adler=i.check=i.flags?o(i.check,et,ct,rt-ct):r(i.check,et,ct,rt-ct)),ct=nt,(i.flags?at:st(at))!==i.check){t.msg="incorrect data check",i.mode=$;break}at=0,lt=0}i.mode=q;case q:if(i.wrap&&i.flags){for(;lt<32;){if(0===ot)break t;ot--,at+=tt[it++]<<lt,lt+=8}if(at!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=$;break}at=0,lt=0}i.mode=Z;case Z:Mt=f;break t;case $:Mt=v;break t;case Q:return b;case J:default:return m}return t.next_out=rt,t.avail_out=nt,t.next_in=it,t.avail_in=ot,i.hold=at,i.bits=lt,(i.wsize||ct!==t.avail_out&&i.mode<$&&(i.mode<W||e!==d))&&_t(t,t.output,t.next_out,ct-t.avail_out)?(i.mode=Q,b):(ht-=t.avail_in,ct-=t.avail_out,t.total_in+=ht,t.total_out+=ct,i.total+=ct,i.wrap&&ct&&(t.adler=i.check=i.flags?o(i.check,et,ct,t.next_out-ct):r(i.check,et,ct,t.next_out-ct)),t.data_type=i.bits+(i.last?64:0)+(i.mode===B?128:0)+(i.mode===U||i.mode===I?256:0),(0===ht&&0===ct||e===d)&&Mt===p&&(Mt=y),Mt)},i.inflateEnd=function(t){if(!t||!t.state)return m;var e=t.state;return e.window&&(e.window=null),t.state=null,p},i.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?m:(i.head=e,e.done=!1,p):m},i.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&i.mode!==R?m:i.mode===R&&r(1,e,s,0)!==i.check?v:_t(t,e,s,s)?(i.mode=Q,b):(i.havedict=1,p):m},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(t,e,i){"use strict";var s=t("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],n=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,l,h,c,d,u){var _,p,f,g,m,v,b,y,w,P=u.bits,M=0,x=0,A=0,E=0,L=0,C=0,k=0,D=0,S=0,R=0,B=null,T=0,F=new s.Buf16(16),I=new s.Buf16(16),N=null,O=0;for(M=0;M<=15;M++)F[M]=0;for(x=0;x<l;x++)F[e[i+x]]++;for(L=P,E=15;E>=1&&0===F[E];E--);if(L>E&&(L=E),0===E)return h[c++]=20971520,h[c++]=20971520,u.bits=1,0;for(A=1;A<E&&0===F[A];A++);for(L<A&&(L=A),D=1,M=1;M<=15;M++)if(D<<=1,(D-=F[M])<0)return-1;if(D>0&&(0===t||1!==E))return-1;for(I[1]=0,M=1;M<15;M++)I[M+1]=I[M]+F[M];for(x=0;x<l;x++)0!==e[i+x]&&(d[I[e[i+x]]++]=x);if(0===t?(B=N=d,v=19):1===t?(B=r,T-=257,N=o,O-=257,v=256):(B=n,N=a,v=-1),R=0,x=0,M=A,m=c,C=L,k=0,f=-1,g=(S=1<<L)-1,1===t&&S>852||2===t&&S>592)return 1;for(;;){b=M-k,d[x]<v?(y=0,w=d[x]):d[x]>v?(y=N[O+d[x]],w=B[T+d[x]]):(y=96,w=0),_=1<<M-k,A=p=1<<C;do{h[m+(R>>k)+(p-=_)]=b<<24|y<<16|w|0}while(0!==p);for(_=1<<M-1;R&_;)_>>=1;if(0!==_?(R&=_-1,R+=_):R=0,x++,0==--F[M]){if(M===E)break;M=e[i+d[x]]}if(M>L&&(R&g)!==f){for(0===k&&(k=L),m+=A,D=1<<(C=M-k);C+k<E&&!((D-=F[C+k])<=0);)C++,D<<=1;if(S+=1<<C,1===t&&S>852||2===t&&S>592)return 1;h[f=R&g]=L<<24|C<<16|m-c|0}}return 0!==R&&(h[m+R]=M-k<<24|64<<16|0),u.bits=L,0}},{"../utils/common":3}],13:[function(t,e,i){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(t,e,i){"use strict";var s=t("../utils/common"),r=4,o=0,n=1,a=2;function l(t){for(var e=t.length;--e>=0;)t[e]=0}var h=0,c=1,d=2,u=29,_=256,p=_+1+u,f=30,g=19,m=2*p+1,v=15,b=16,y=7,w=256,P=16,M=17,x=18,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],E=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],L=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],C=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],k=new Array(2*(p+2));l(k);var D=new Array(2*f);l(D);var S=new Array(512);l(S);var R=new Array(256);l(R);var B=new Array(u);l(B);var T,F,I,N=new Array(f);function O(t,e,i,s,r){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=r,this.has_stree=t&&t.length}function V(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function z(t){return t<256?S[t]:S[256+(t>>>7)]}function U(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function j(t,e,i){t.bi_valid>b-i?(t.bi_buf|=e<<t.bi_valid&65535,U(t,t.bi_buf),t.bi_buf=e>>b-t.bi_valid,t.bi_valid+=i-b):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function Y(t,e,i){j(t,i[2*e],i[2*e+1])}function G(t,e){var i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}function H(t,e,i){var s,r,o=new Array(v+1),n=0;for(s=1;s<=v;s++)o[s]=n=n+i[s-1]<<1;for(r=0;r<=e;r++){var a=t[2*r+1];0!==a&&(t[2*r]=G(o[a]++,a))}}function K(t){var e;for(e=0;e<p;e++)t.dyn_ltree[2*e]=0;for(e=0;e<f;e++)t.dyn_dtree[2*e]=0;for(e=0;e<g;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*w]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function X(t){t.bi_valid>8?U(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function W(t,e,i,s){var r=2*e,o=2*i;return t[r]<t[o]||t[r]===t[o]&&s[e]<=s[i]}function q(t,e,i){for(var s=t.heap[i],r=i<<1;r<=t.heap_len&&(r<t.heap_len&&W(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!W(e,s,t.heap[r],t.depth));)t.heap[i]=t.heap[r],i=r,r<<=1;t.heap[i]=s}function Z(t,e,i){var s,r,o,n,a=0;if(0!==t.last_lit)do{s=t.pending_buf[t.d_buf+2*a]<<8|t.pending_buf[t.d_buf+2*a+1],r=t.pending_buf[t.l_buf+a],a++,0===s?Y(t,r,e):(Y(t,(o=R[r])+_+1,e),0!==(n=A[o])&&j(t,r-=B[o],n),Y(t,o=z(--s),i),0!==(n=E[o])&&j(t,s-=N[o],n))}while(a<t.last_lit);Y(t,w,e)}function $(t,e){var i,s,r,o=e.dyn_tree,n=e.stat_desc.static_tree,a=e.stat_desc.has_stree,l=e.stat_desc.elems,h=-1;for(t.heap_len=0,t.heap_max=m,i=0;i<l;i++)0!==o[2*i]?(t.heap[++t.heap_len]=h=i,t.depth[i]=0):o[2*i+1]=0;for(;t.heap_len<2;)o[2*(r=t.heap[++t.heap_len]=h<2?++h:0)]=1,t.depth[r]=0,t.opt_len--,a&&(t.static_len-=n[2*r+1]);for(e.max_code=h,i=t.heap_len>>1;i>=1;i--)q(t,o,i);r=l;do{i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],q(t,o,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,o[2*r]=o[2*i]+o[2*s],t.depth[r]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,o[2*i+1]=o[2*s+1]=r,t.heap[1]=r++,q(t,o,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,r,o,n,a,l=e.dyn_tree,h=e.max_code,c=e.stat_desc.static_tree,d=e.stat_desc.has_stree,u=e.stat_desc.extra_bits,_=e.stat_desc.extra_base,p=e.stat_desc.max_length,f=0;for(o=0;o<=v;o++)t.bl_count[o]=0;for(l[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<m;i++)(o=l[2*l[2*(s=t.heap[i])+1]+1]+1)>p&&(o=p,f++),l[2*s+1]=o,s>h||(t.bl_count[o]++,n=0,s>=_&&(n=u[s-_]),a=l[2*s],t.opt_len+=a*(o+n),d&&(t.static_len+=a*(c[2*s+1]+n)));if(0!==f){do{for(o=p-1;0===t.bl_count[o];)o--;t.bl_count[o]--,t.bl_count[o+1]+=2,t.bl_count[p]--,f-=2}while(f>0);for(o=p;0!==o;o--)for(s=t.bl_count[o];0!==s;)(r=t.heap[--i])>h||(l[2*r+1]!==o&&(t.opt_len+=(o-l[2*r+1])*l[2*r],l[2*r+1]=o),s--)}}(t,e),H(o,h,t.bl_count)}function Q(t,e,i){var s,r,o=-1,n=e[1],a=0,l=7,h=4;for(0===n&&(l=138,h=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)r=n,n=e[2*(s+1)+1],++a<l&&r===n||(a<h?t.bl_tree[2*r]+=a:0!==r?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[2*P]++):a<=10?t.bl_tree[2*M]++:t.bl_tree[2*x]++,a=0,o=r,0===n?(l=138,h=3):r===n?(l=6,h=3):(l=7,h=4))}function J(t,e,i){var s,r,o=-1,n=e[1],a=0,l=7,h=4;for(0===n&&(l=138,h=3),s=0;s<=i;s++)if(r=n,n=e[2*(s+1)+1],!(++a<l&&r===n)){if(a<h)do{Y(t,r,t.bl_tree)}while(0!=--a);else 0!==r?(r!==o&&(Y(t,r,t.bl_tree),a--),Y(t,P,t.bl_tree),j(t,a-3,2)):a<=10?(Y(t,M,t.bl_tree),j(t,a-3,3)):(Y(t,x,t.bl_tree),j(t,a-11,7));a=0,o=r,0===n?(l=138,h=3):r===n?(l=6,h=3):(l=7,h=4)}}l(N);var tt=!1;function et(t,e,i,r){j(t,(h<<1)+(r?1:0),3),function(t,e,i,r){X(t),r&&(U(t,i),U(t,~i)),s.arraySet(t.pending_buf,t.window,e,i,t.pending),t.pending+=i}(t,e,i,!0)}i._tr_init=function(t){tt||(function(){var t,e,i,s,r,o=new Array(v+1);for(i=0,s=0;s<u-1;s++)for(B[s]=i,t=0;t<1<<A[s];t++)R[i++]=s;for(R[i-1]=s,r=0,s=0;s<16;s++)for(N[s]=r,t=0;t<1<<E[s];t++)S[r++]=s;for(r>>=7;s<f;s++)for(N[s]=r<<7,t=0;t<1<<E[s]-7;t++)S[256+r++]=s;for(e=0;e<=v;e++)o[e]=0;for(t=0;t<=143;)k[2*t+1]=8,t++,o[8]++;for(;t<=255;)k[2*t+1]=9,t++,o[9]++;for(;t<=279;)k[2*t+1]=7,t++,o[7]++;for(;t<=287;)k[2*t+1]=8,t++,o[8]++;for(H(k,p+1,o),t=0;t<f;t++)D[2*t+1]=5,D[2*t]=G(t,5);T=new O(k,A,_+1,p,v),F=new O(D,E,0,f,v),I=new O(new Array(0),L,0,g,y)}(),tt=!0),t.l_desc=new V(t.dyn_ltree,T),t.d_desc=new V(t.dyn_dtree,F),t.bl_desc=new V(t.bl_tree,I),t.bi_buf=0,t.bi_valid=0,K(t)},i._tr_stored_block=et,i._tr_flush_block=function(t,e,i,s){var l,h,u=0;t.level>0?(t.strm.data_type===a&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return o;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return n;for(e=32;e<_;e++)if(0!==t.dyn_ltree[2*e])return n;return o}(t)),$(t,t.l_desc),$(t,t.d_desc),u=function(t){var e;for(Q(t,t.dyn_ltree,t.l_desc.max_code),Q(t,t.dyn_dtree,t.d_desc.max_code),$(t,t.bl_desc),e=g-1;e>=3&&0===t.bl_tree[2*C[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),l=t.opt_len+3+7>>>3,(h=t.static_len+3+7>>>3)<=l&&(l=h)):l=h=i+5,i+4<=l&&-1!==e?et(t,e,i,s):t.strategy===r||h===l?(j(t,(c<<1)+(s?1:0),3),Z(t,k,D)):(j(t,(d<<1)+(s?1:0),3),function(t,e,i,s){var r;for(j(t,e-257,5),j(t,i-1,5),j(t,s-4,4),r=0;r<s;r++)j(t,t.bl_tree[2*C[r]+1],3);J(t,t.dyn_ltree,e-1),J(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,u+1),Z(t,t.dyn_ltree,t.dyn_dtree)),K(t),s&&X(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(R[i]+_+1)]++,t.dyn_dtree[2*z(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){j(t,c<<1,3),Y(t,w,k),function(t){16===t.bi_valid?(U(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},{"../utils/common":3}],15:[function(t,e,i){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(t,e,i){"use strict";var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=s},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")},function(t,e,i){"use strict";i.r(e);class s{constructor(t,e){this.items=t||[],this._lastUniqueId=(e||0)+1}addItem(){let t;if(2===arguments.length){const e=arguments[0];if(t=arguments[1],this.items[e])throw"ID clash: '"+e+"'";return this.items[e]=t,e}for(t=arguments[0]||{};;){const e=this._lastUniqueId++;if(!this.items[e])return this.items[e]=t,e}}removeItem(t){const e=this.items[t];return delete this.items[t],e}}const r={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var o=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(t){for(var e=[],i=t[0].charCodeAt(0),s=i+t[1],r=i;r<s;++r)e.push(r);return String.fromCharCode.apply(null,e)}).join("");function n(t,e){return(e&&4!==e?[0,6]:[0,6,12,18]).map(function(e){return o.substr(parseInt(t/(1<<e))%64,1)}).reverse().join("")}const a={xmlToJson:function t(e,i){if(e.nodeType===e.TEXT_NODE){var s=e.nodeValue;if(null===s.match(/^\s+$/))return s}else if(e.nodeType===e.ELEMENT_NODE||e.nodeType===e.DOCUMENT_NODE){var r={type:e.nodeName,children:[]};if(e.nodeType===e.ELEMENT_NODE)for(var o=0;o<e.attributes.length;o++){var n=e.attributes[o];r[i[n.nodeName]||n.nodeName]=n.nodeValue}for(var a=0;a<e.childNodes.length;a++)(o=t(e.childNodes[a],i))&&r.children.push(o);return r}},clone:function(t){return JSON.parse(JSON.stringify(t))},compressGuid:function(t){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(e){return parseInt(t.substr(e,2),16)});return n(e[0],2)+[1,4,7,10,13].map(function(t){return n((e[t]<<16)+(e[t+1]<<8)+e[t+2])}).join("")},findNodeOfType:function(t,e){var i=[],s=function(t){t.type===e&&i.push(t),(t.children||[]).forEach(function(t){s(t)})};return s(t),i},timeout:function(t){return new Promise(function(e,i){setTimeout(e,t)})},httpRequest:function(t){return new Promise(function(e,i){var s=new XMLHttpRequest;s.open(t.method||"GET",t.url,!0),s.onload=function(r){console.log(t.url,s.readyState,s.status),4===s.readyState&&(200===s.status?e(s.responseXML):i(s.statusText))},s.send(null)})},loadJSON:function(t,e,i){var s=t=>void 0;e=e||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",t,!0),r.addEventListener("load",function(t){var s=t.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(t){i(`utils.loadJSON(): Failed to parse JSON response - ${t}`)}e(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(s))}catch(t){i(`utils.loadJSON(): Failed to parse JSON response - ${t}`)}}else i(t)},!1),r.addEventListener("error",function(t){i(t)},!1),r.send(null)},loadArraybuffer:function(t,e,i){var s=t=>void 0;e=e||s,i=i||s;const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const t=!!r[2];var o=r[3];o=window.decodeURIComponent(o),t&&(o=window.atob(o));try{const t=new ArrayBuffer(o.length),s=new Uint8Array(t);for(var n=0;n<o.length;n++)s[n]=o.charCodeAt(n);window.setTimeout(function(){e(t)},0)}catch(t){window.setTimeout(function(){i(t)},0)}}else{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:function(){for(var t={},e=window.location.search.substring(1).split("&"),i=0;i<e.length;i++){var s=e[i].split("=");if(void 0===t[s[0]])t[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof t[s[0]]){var r=[t[s[0]],decodeURIComponent(s[1])];t[s[0]]=r}else t[s[0]].push(decodeURIComponent(s[1]))}return t}(),isArray:function(t){return t&&!t.propertyIsEnumerable("length")&&"object"==typeof t&&"number"==typeof t.length},isString:function(t){return"string"==typeof t||t instanceof String},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},isID:function(t){return a.isString(t)||a.isNumeric(t)},isSameComponent:function(t,e){return!(!t||!e)&&(a.isNumeric(t)||a.isString(t)?`${t}`:t.id)===(a.isNumeric(e)||a.isString(e)?`${e}`:e.id)},isFunction:function(t){return"function"==typeof t},isObject:function(t){const e={}.constructor;return!!t&&t.constructor===e},copy:function(t){return a.apply(t,{})},apply:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},apply2:function(t,e){for(const i in t)t.hasOwnProperty(i)&&void 0!==t[i]&&null!==t[i]&&(e[i]=t[i]);return e},applyIf:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(void 0!==e[i]&&null!==e[i]||(e[i]=t[i]));return e},isEmptyObject:function(t){for(const e in t)if(t.hasOwnProperty(e))return!1;return!0},inQuotes:function(t){return a.isNumeric(t)?`${t}`:`'${t}'`},concat:function(t,e){const i=new t.constructor(t.length+e.length);return i.set(t),i.set(e,t.length),i},flattenParentChildHierarchy:function(t){var e=[];return function t(i){i.id=i.uuid,delete i.oid,e.push(i);var s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)s[r].parent=i.id,t(s[r]);i.children=[]}(t),console.log(JSON.stringify(e,null,"\t")),e}},l={},h=new s,c=new class{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}const t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t}push(t){return this._length++,this._tail.push(t),this}unshift(t){return this._head[--this._index]=t,this._length++,this}},d={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},u=10,_=[];let p,f=null,g=0,m=0;const v=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this.getDefaultScene=function(){return f||(f=new Ot({id:"default.scene"})),f},this.setDefaultScene=function(t){return f=t},this._addScene=function(t){if(t.id){if(v.scenes[t.id])return void console.error(`[ERROR] Scene ${a.inQuotes(t.id)} already exists`)}else t.id=h.addItem({});v.scenes[t.id]=t;const e=t.ticksPerOcclusionTest,i=t.ticksPerRender;l[t.id]={ticksPerOcclusionTest:e,occlusionTestCountdown:e,ticksPerRender:i,renderCountdown:i},r.components.scenes++,t.once("destroyed",()=>{h.removeItem(t.id),delete v.scenes[t.id],delete l[t.id],r.components.scenes--})},this.clear=function(){let t;for(const e in v.scenes)v.scenes.hasOwnProperty(e)&&(t=v.scenes[e],"default.scene"===e?t.clear():(t.destroy(),delete v.scenes[t.id]))},this.scheduleTask=function(t,e){c.push(t),c.push(e)},this.runTasks=function(t=-1){let e,i,s=(new Date).getTime(),r=0;for(;c.length>0&&(t<0||s<t);)e=c.shift(),(i=c.shift())?e.call(i):e(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return c.length}},b=function(){let t=Date.now();if(g>0){var e=1e3/(p=t-g);m+=e,_.push(e),_.length>=30&&(m-=_.shift()),r.frame.fps=Math.round(m/_.length)}!function(t){const e=v.runTasks(t+u),i=v.getNumTasks();r.frame.tasksRun=e,r.frame.tasksScheduled=i,r.frame.tasksBudget=u}(t),function(t){for(var e in d.time=t,v.scenes)if(v.scenes.hasOwnProperty(e)){var i=v.scenes[e];d.sceneId=e,d.startTime=i.startTime,d.deltaTime=null!=d.prevTime?d.time-d.prevTime:0,i.fire("tick",d,!0)}d.prevTime=t}(t),function(){const t=v.scenes;let e,i,s,r,o;for(o in t)t.hasOwnProperty(o)&&(e=t[o],(i=l[o])||(i=l[o]={}),s=e.ticksPerOcclusionTest,i.ticksPerOcclusionTest!==s&&(i.ticksPerOcclusionTest=s,i.renderCountdown=s),0==--i.occlusionTestCountdown&&(e.doOcclusionTest(),i.occlusionTestCountdown=s),r=e.ticksPerRender,i.ticksPerRender!==r&&(i.ticksPerRender=r,i.renderCountdown=r),0==--i.renderCountdown&&(e.render(!1),i.renderCountdown=r))}(),g=t,window.requestAnimationFrame(b)};window.requestAnimationFrame(b);const y=new Float32Array(16),w=new Float32Array(16),P=new Float32Array(4),M={MAX_DOUBLE:Number.MAX_VALUE,MIN_DOUBLE:Number.MIN_VALUE,DEGTORAD:.0174532925,RADTODEG:57.295779513,vec2:t=>new Float32Array(t||2),vec3:t=>new Float32Array(t||3),vec4:t=>new Float32Array(t||4),mat3:t=>new Float32Array(t||9),mat3ToMat4:(t,e=new Float32Array(16))=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),mat4:t=>new Float32Array(t||16),mat4ToMat3(t,e){},createUUID:(()=>{const t=[];for(let e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]}-${t[255&i]}${t[i>>8&255]}-${t[i>>16&15|64]}${t[i>>24&255]}-${t[63&s|128]}${t[s>>8&255]}-${t[s>>16&255]}${t[s>>24&255]}${t[255&r]}${t[r>>8&255]}${t[r>>16&255]}${t[r>>24&255]}`}})(),clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),fmod(t,e){if(t<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),t;for(;e<=t;)t-=e;return t},negateVec4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e),addVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i),addVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i),addVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i),addVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i),subVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i),subVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i),subVec2:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i),subVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i),subScalarVec4:(t,e,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i),mulVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i),mulVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i),mulVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i),mulVec2Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i),divVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i),divVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i),divScalarVec3:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i),divVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i),divVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i[3]=t[3]/e,i),divScalarVec4:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i[3]=t/e[3],i),dotVec4:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],cross3Vec4(t,e){const i=t[0],s=t[1],r=t[2],o=e[0],n=e[1],a=e[2];return[s*a-r*n,r*o-i*a,i*n-s*o,0]},cross3Vec3(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],n=e[0],a=e[1],l=e[2];return i[0]=r*l-o*a,i[1]=o*n-s*l,i[2]=s*a-r*n,i},sqLenVec4:t=>M.dotVec4(t,t),lenVec4:t=>Math.sqrt(M.sqLenVec4(t)),dotVec3:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],dotVec2:(t,e)=>t[0]*e[0]+t[1]*e[1],sqLenVec3:t=>M.dotVec3(t,t),sqLenVec2:t=>M.dotVec2(t,t),lenVec3:t=>Math.sqrt(M.sqLenVec3(t)),distVec3:(()=>{const t=new Float32Array(3);return(e,i)=>M.lenVec3(M.subVec3(e,i,t))})(),lenVec2:t=>Math.sqrt(M.sqLenVec2(t)),distVec2:(()=>{const t=new Float32Array(2);return(e,i)=>M.lenVec2(M.subVec2(e,i,t))})(),rcpVec3:(t,e)=>M.divScalarVec3(1,t,e),normalizeVec4(t,e){const i=1/M.lenVec4(t);return M.mulVec4Scalar(t,i,e)},normalizeVec3(t,e){const i=1/M.lenVec3(t);return M.mulVec3Scalar(t,i,e)},normalizeVec2(t,e){const i=1/M.lenVec2(t);return M.mulVec2Scalar(t,i,e)},angleVec3(t,e){let i=M.dotVec3(t,e)/Math.sqrt(M.sqLenVec3(t)*M.sqLenVec3(e));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const t=new Float32Array(3);return(e,i)=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],i[0]=M.lenVec3(t),t[0]=e[4],t[1]=e[5],t[2]=e[6],i[1]=M.lenVec3(t),t[0]=e[8],t[1]=e[9],t[2]=e[10],i[2]=M.lenVec3(t),i)})(),vecToArray:(()=>{function t(t){return Math.round(1e5*t)/1e5}return e=>{for(let i=0,s=(e=Array.prototype.slice.call(e)).length;i<s;i++)e[i]=t(e[i]);return e}})(),xyzArrayToObject:t=>({x:t[0],y:t[1],z:t[2]}),xyzObjectToArray:(t,e)=>((e=e||new Float32Array(3))[0]=t.x,e[1]=t.y,e[2]=t.z,e),dupMat4:t=>t.slice(0,16),mat4To3:t=>[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]],m4s:t=>[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],setMat4ToZeroes:()=>M.m4s(0),setMat4ToOnes:()=>M.m4s(1),diagonalMat4v:t=>new Float32Array([t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,t[3]]),diagonalMat4c:(t,e,i,s)=>M.diagonalMat4v([t,e,i,s]),diagonalMat4s:t=>M.diagonalMat4c(t,t,t,t),identityMat4:(t=new Float32Array(16))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),identityMat3:(t=new Float32Array(9))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t),isIdentityMat4:t=>1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15],negateMat4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e),addMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i),addMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i[4]=t[4]+e,i[5]=t[5]+e,i[6]=t[6]+e,i[7]=t[7]+e,i[8]=t[8]+e,i[9]=t[9]+e,i[10]=t[10]+e,i[11]=t[11]+e,i[12]=t[12]+e,i[13]=t[13]+e,i[14]=t[14]+e,i[15]=t[15]+e,i),addScalarMat4:(t,e,i)=>M.addMat4Scalar(e,t,i),subMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i),subMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i[4]=t[4]-e,i[5]=t[5]-e,i[6]=t[6]-e,i[7]=t[7]-e,i[8]=t[8]-e,i[9]=t[9]-e,i[10]=t[10]-e,i[11]=t[11]-e,i[12]=t[12]-e,i[13]=t[13]-e,i[14]=t[14]-e,i[15]=t[15]-e,i),subScalarMat4:(t,e,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i[4]=t-e[4],i[5]=t-e[5],i[6]=t-e[6],i[7]=t-e[7],i[8]=t-e[8],i[9]=t-e[9],i[10]=t-e[10],i[11]=t-e[11],i[12]=t-e[12],i[13]=t-e[13],i[14]=t-e[14],i[15]=t-e[15],i),mulMat4(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],n=t[3],a=t[4],l=t[5],h=t[6],c=t[7],d=t[8],u=t[9],_=t[10],p=t[11],f=t[12],g=t[13],m=t[14],v=t[15],b=e[0],y=e[1],w=e[2],P=e[3],M=e[4],x=e[5],A=e[6],E=e[7],L=e[8],C=e[9],k=e[10],D=e[11],S=e[12],R=e[13],B=e[14],T=e[15];return i[0]=b*s+y*a+w*d+P*f,i[1]=b*r+y*l+w*u+P*g,i[2]=b*o+y*h+w*_+P*m,i[3]=b*n+y*c+w*p+P*v,i[4]=M*s+x*a+A*d+E*f,i[5]=M*r+x*l+A*u+E*g,i[6]=M*o+x*h+A*_+E*m,i[7]=M*n+x*c+A*p+E*v,i[8]=L*s+C*a+k*d+D*f,i[9]=L*r+C*l+k*u+D*g,i[10]=L*o+C*h+k*_+D*m,i[11]=L*n+C*c+k*p+D*v,i[12]=S*s+R*a+B*d+T*f,i[13]=S*r+R*l+B*u+T*g,i[14]=S*o+R*h+B*_+T*m,i[15]=S*n+R*c+B*p+T*v,i},mulMat3(t,e,i){i||(i=new Float32Array(9));const s=t[0],r=t[3],o=t[6],n=t[1],a=t[4],l=t[7],h=t[2],c=t[5],d=t[8],u=e[0],_=e[3],p=e[6],f=e[1],g=e[4],m=e[7],v=e[2],b=e[5],y=e[8];return i[0]=s*u+r*f+o*v,i[3]=s*_+r*g+o*b,i[6]=s*p+r*m+o*y,i[1]=n*u+a*f+l*v,i[4]=n*_+a*g+l*b,i[7]=n*p+a*m+l*y,i[2]=h*u+c*f+d*v,i[5]=h*_+c*g+d*b,i[8]=h*p+c*m+d*y,i},mulMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i),mulMat4v4(t,e,i=M.vec4()){const s=e[0],r=e[1],o=e[2],n=e[3];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*n,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*n,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*n,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*n,i},transposeMat4(t,e){const i=t[4],s=t[14],r=t[8],o=t[13],n=t[12],a=t[9];if(!e||t===e){const e=t[1],l=t[2],h=t[3],c=t[6],d=t[7],u=t[11];return t[1]=i,t[2]=r,t[3]=n,t[4]=e,t[6]=a,t[7]=o,t[8]=l,t[9]=c,t[11]=s,t[12]=h,t[13]=d,t[14]=u,t}return e[0]=t[0],e[1]=i,e[2]=r,e[3]=n,e[4]=t[1],e[5]=t[5],e[6]=a,e[7]=o,e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=s,e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},transposeMat3(t,e){if(e===t){const i=t[1],s=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=s,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},determinantMat4(t){const e=t[0],i=t[1],s=t[2],r=t[3],o=t[4],n=t[5],a=t[6],l=t[7],h=t[8],c=t[9],d=t[10],u=t[11],_=t[12],p=t[13],f=t[14],g=t[15];return _*c*a*r-h*p*a*r-_*n*d*r+o*p*d*r+h*n*f*r-o*c*f*r-_*c*s*l+h*p*s*l+_*i*d*l-e*p*d*l-h*i*f*l+e*c*f*l+_*n*s*u-o*p*s*u-_*i*a*u+e*p*a*u+o*i*f*u-e*n*f*u-h*n*s*g+o*c*s*g+h*i*a*g-e*c*a*g-o*i*d*g+e*n*d*g},inverseMat4(t,e){e||(e=t);const i=t[0],s=t[1],r=t[2],o=t[3],n=t[4],a=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],_=t[11],p=t[12],f=t[13],g=t[14],m=t[15],v=i*a-s*n,b=i*l-r*n,y=i*h-o*n,w=s*l-r*a,P=s*h-o*a,M=r*h-o*l,x=c*f-d*p,A=c*g-u*p,E=c*m-_*p,L=d*g-u*f,C=d*m-_*f,k=u*m-_*g,D=1/(v*k-b*C+y*L+w*E-P*A+M*x);return e[0]=(a*k-l*C+h*L)*D,e[1]=(-s*k+r*C-o*L)*D,e[2]=(f*M-g*P+m*w)*D,e[3]=(-d*M+u*P-_*w)*D,e[4]=(-n*k+l*E-h*A)*D,e[5]=(i*k-r*E+o*A)*D,e[6]=(-p*M+g*y-m*b)*D,e[7]=(c*M-u*y+_*b)*D,e[8]=(n*C-a*E+h*x)*D,e[9]=(-i*C+s*E-o*x)*D,e[10]=(p*P-f*y+m*v)*D,e[11]=(-c*P+d*y-_*v)*D,e[12]=(-n*L+a*A-l*x)*D,e[13]=(i*L-s*A+r*x)*D,e[14]=(-p*w+f*b-g*v)*D,e[15]=(c*w-d*b+u*v)*D,e},traceMat4:t=>t[0]+t[5]+t[10]+t[15],translationMat4v(t,e){const i=e||M.identityMat4();return i[12]=t[0],i[13]=t[1],i[14]=t[2],i},translationMat3v(t,e){const i=e||M.identityMat3();return i[6]=t[0],i[7]=t[1],i},translationMat4c:(()=>{const t=new Float32Array(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,M.translationMat4v(t,r))})(),translationMat4s:(t,e)=>M.translationMat4c(t,t,t,e),translateMat4v:(t,e)=>M.translateMat4c(t[0],t[1],t[2],e),OLDtranslateMat4c(t,e,i,s){const r=s[12];s[0]+=r*t,s[4]+=r*e,s[8]+=r*i;const o=s[13];s[1]+=o*t,s[5]+=o*e,s[9]+=o*i;const n=s[14];s[2]+=n*t,s[6]+=n*e,s[10]+=n*i;const a=s[15];return s[3]+=a*t,s[7]+=a*e,s[11]+=a*i,s},translateMat4c(t,e,i,s){const r=s[3];s[0]+=r*t,s[1]+=r*e,s[2]+=r*i;const o=s[7];s[4]+=o*t,s[5]+=o*e,s[6]+=o*i;const n=s[11];s[8]+=n*t,s[9]+=n*e,s[10]+=n*i;const a=s[15];return s[12]+=a*t,s[13]+=a*e,s[14]+=a*i,s},rotationMat4v(t,e,i){const s=M.normalizeVec4([e[0],e[1],e[2],0],[]),r=Math.sin(t),o=Math.cos(t),n=1-o,a=s[0],l=s[1],h=s[2];let c,d,u,_,p,f;return c=a*l,d=l*h,u=h*a,_=a*r,p=l*r,f=h*r,(i=i||M.mat4())[0]=n*a*a+o,i[1]=n*c+f,i[2]=n*u-p,i[3]=0,i[4]=n*c-f,i[5]=n*l*l+o,i[6]=n*d+_,i[7]=0,i[8]=n*u+p,i[9]=n*d-_,i[10]=n*h*h+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(t,e,i,s,r)=>M.rotationMat4v(t,[e,i,s],r),scalingMat4v:(t,e=M.identityMat4())=>(e[0]=t[0],e[5]=t[1],e[10]=t[2],e),scalingMat3v:(t,e=M.identityMat3())=>(e[0]=t[0],e[4]=t[1],e),scalingMat4c:(()=>{const t=new Float32Array(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,M.scalingMat4v(t,r))})(),scaleMat4c:(t,e,i,s)=>(s[0]*=t,s[4]*=e,s[8]*=i,s[1]*=t,s[5]*=e,s[9]*=i,s[2]*=t,s[6]*=e,s[10]*=i,s[3]*=t,s[7]*=e,s[11]*=i,s),scaleMat4v(t,e){const i=t[0],s=t[1],r=t[2];return e[0]*=i,e[4]*=s,e[8]*=r,e[1]*=i,e[5]*=s,e[9]*=r,e[2]*=i,e[6]*=s,e[10]*=r,e[3]*=i,e[7]*=s,e[11]*=r,e},scalingMat4s:t=>M.scalingMat4c(t,t,t),rotationTranslationMat4(t,e,i=M.mat4()){const s=t[0],r=t[1],o=t[2],n=t[3],a=s+s,l=r+r,h=o+o,c=s*a,d=s*l,u=s*h,_=r*l,p=r*h,f=o*h,g=n*a,m=n*l,v=n*h;return i[0]=1-(_+f),i[1]=d+v,i[2]=u-m,i[3]=0,i[4]=d-v,i[5]=1-(c+f),i[6]=p+g,i[7]=0,i[8]=u+m,i[9]=p-g,i[10]=1-(c+_),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler(t,e,i=M.vec4()){const s=M.clamp,r=t[0],o=t[4],n=t[8],a=t[1],l=t[5],h=t[9],c=t[2],d=t[6],u=t[10];return"XYZ"===e?(i[1]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,u),i[2]=Math.atan2(-o,r)):(i[0]=Math.atan2(d,l),i[2]=0)):"YXZ"===e?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(n,u),i[2]=Math.atan2(a,l)):(i[1]=Math.atan2(-c,r),i[2]=0)):"ZXY"===e?(i[0]=Math.asin(s(d,-1,1)),Math.abs(d)<.99999?(i[1]=Math.atan2(-c,u),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(a,r))):"ZYX"===e?(i[1]=Math.asin(-s(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(d,u),i[2]=Math.atan2(a,r)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===e?(i[2]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-c,r)):(i[0]=0,i[1]=Math.atan2(n,u))):"XZY"===e&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(d,l),i[1]=Math.atan2(n,r)):(i[0]=Math.atan2(-h,u),i[1]=0)),i},composeMat4:(t,e,i,s=M.mat4())=>(M.quaternionToRotationMat4(e,s),M.scaleMat4v(i,s),M.translateMat4v(t,s),s),decomposeMat4:(()=>{const t=new Float32Array(3),e=new Float32Array(16);return function(i,s,r,o){t[0]=i[0],t[1]=i[1],t[2]=i[2];let n=M.lenVec3(t);t[0]=i[4],t[1]=i[5],t[2]=i[6];const a=M.lenVec3(t);t[8]=i[8],t[9]=i[9],t[10]=i[10];const l=M.lenVec3(t);M.determinantMat4(i)<0&&(n=-n),s[0]=i[12],s[1]=i[13],s[2]=i[14],e.set(i);const h=1/n,c=1/a,d=1/l;return e[0]*=h,e[1]*=h,e[2]*=h,e[4]*=c,e[5]*=c,e[6]*=c,e[8]*=d,e[9]*=d,e[10]*=d,M.mat4ToQuaternion(e,r),o[0]=n,o[1]=a,o[2]=l,this}})(),lookAtMat4v(t,e,i,s){s||(s=M.mat4());const r=t[0],o=t[1],n=t[2],a=i[0],l=i[1],h=i[2],c=e[0],d=e[1],u=e[2];if(r===c&&o===d&&n===u)return M.identityMat4();let _,p,f,g,m,v,b,y,w,P;return _=r-c,p=o-d,f=n-u,g=l*(f*=P=1/Math.sqrt(_*_+p*p+f*f))-h*(p*=P),m=h*(_*=P)-a*f,v=a*p-l*_,(P=Math.sqrt(g*g+m*m+v*v))?(g*=P=1/P,m*=P,v*=P):(g=0,m=0,v=0),b=p*v-f*m,y=f*g-_*v,w=_*m-p*g,(P=Math.sqrt(b*b+y*y+w*w))?(b*=P=1/P,y*=P,w*=P):(b=0,y=0,w=0),s[0]=g,s[1]=b,s[2]=_,s[3]=0,s[4]=m,s[5]=y,s[6]=p,s[7]=0,s[8]=v,s[9]=w,s[10]=f,s[11]=0,s[12]=-(g*r+m*o+v*n),s[13]=-(b*r+y*o+w*n),s[14]=-(_*r+p*o+f*n),s[15]=1,s},lookAtMat4c:(t,e,i,s,r,o,n,a,l)=>M.lookAtMat4v([t,e,i],[s,r,o],[n,a,l],[]),orthoMat4c(t,e,i,s,r,o,n){n||(n=M.mat4());const a=e-t,l=s-i,h=o-r;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/h,n[11]=0,n[12]=-(t+e)/a,n[13]=-(s+i)/l,n[14]=-(o+r)/h,n[15]=1,n},frustumMat4v(t,e,i){i||(i=M.mat4());const s=[t[0],t[1],t[2],0],r=[e[0],e[1],e[2],0];M.addVec4(r,s,y),M.subVec4(r,s,w);const o=2*s[2],n=w[0],a=w[1],l=w[2];return i[0]=o/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/a,i[6]=0,i[7]=0,i[8]=y[0]/n,i[9]=y[1]/a,i[10]=-y[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*r[2]/l,i[15]=0,i},frustumMat4(t,e,i,s,r,o,n){n||(n=M.mat4());const a=e-t,l=s-i,h=o-r;return n[0]=2*r/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/l,n[6]=0,n[7]=0,n[8]=(e+t)/a,n[9]=(s+i)/l,n[10]=-(o+r)/h,n[11]=-1,n[12]=0,n[13]=0,n[14]=-o*r*2/h,n[15]=0,n},perspectiveMat4(t,e,i,s,r){const o=[],n=[];return o[2]=i,n[2]=s,n[1]=o[2]*Math.tan(t/2),o[1]=-n[1],n[0]=n[1]*e,o[0]=-n[0],M.frustumMat4v(o,n,r)},transformPoint3(t,e,i=M.vec3()){const s=e[0],r=e[1],o=e[2];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12],i[1]=t[1]*s+t[5]*r+t[9]*o+t[13],i[2]=t[2]*s+t[6]*r+t[10]*o+t[14],i},transformPoint4:(t,e,i=M.vec4())=>(i[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],i[3]=t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],i),transformPoints3(t,e,i){const s=i||[],r=e.length;let o,n,a,l;const h=t[0],c=t[1],d=t[2],u=t[3],_=t[4],p=t[5],f=t[6],g=t[7],m=t[8],v=t[9],b=t[10],y=t[11],w=t[12],P=t[13],M=t[14],x=t[15];let A;for(let t=0;t<r;++t)o=(l=e[t])[0],n=l[1],a=l[2],(A=s[t]||(s[t]=[0,0,0]))[0]=h*o+_*n+m*a+w,A[1]=c*o+p*n+v*a+P,A[2]=d*o+f*n+b*a+M,A[3]=u*o+g*n+y*a+x;return s.length=r,s},transformPositions3(t,e,i=e){let s;const r=e.length;let o,n,a;const l=t[0],h=t[1],c=t[2],d=t[3],u=t[4],_=t[5],p=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],w=t[13],P=t[14],M=t[15];for(s=0;s<r;s+=3)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=l*o+u*n+g*a+y,i[s+1]=h*o+_*n+m*a+w,i[s+2]=c*o+p*n+v*a+P,i[s+3]=d*o+f*n+b*a+M;return i},transformPositions4(t,e,i=e){let s;const r=e.length;let o,n,a;const l=t[0],h=t[1],c=t[2],d=t[3],u=t[4],_=t[5],p=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],w=t[13],P=t[14],M=t[15];for(s=0;s<r;s+=4)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=l*o+u*n+g*a+y,i[s+1]=h*o+_*n+m*a+w,i[s+2]=c*o+p*n+v*a+P,i[s+3]=d*o+f*n+b*a+M;return i},transformVec3(t,e,i){const s=e[0],r=e[1],o=e[2];return(i=i||this.vec3())[0]=t[0]*s+t[4]*r+t[8]*o,i[1]=t[1]*s+t[5]*r+t[9]*o,i[2]=t[2]*s+t[6]*r+t[10]*o,i},transformVec4(t,e,i){const s=e[0],r=e[1],o=e[2],n=e[3];return(i=i||M.vec4())[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*n,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*n,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*n,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*n,i},rotateVec3X(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Y(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Z(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},projectVec4(t,e){const i=1/t[3];return(e=e||M.vec2())[0]=t[0]*i,e[1]=t[1]*i,e},unprojectVec3:(()=>{const t=new Float32Array(16),e=new Float32Array(16),i=new Float32Array(16);return function(s,r,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(r,t),this.inverseMat4(o,e),i),s,n)}})(),lerpVec3(t,e,i,s,r,o){const n=o||M.vec3(),a=(t-e)/(i-e);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n},lerpMat4(t,e,i,s,r,o){const n=o||M.mat4(),a=(t-e)/(i-e);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n[3]=s[3]+a*(r[3]-s[3]),n[4]=s[4]+a*(r[4]-s[4]),n[5]=s[5]+a*(r[5]-s[5]),n[6]=s[6]+a*(r[6]-s[6]),n[7]=s[7]+a*(r[7]-s[7]),n[8]=s[8]+a*(r[8]-s[8]),n[9]=s[9]+a*(r[9]-s[9]),n[10]=s[10]+a*(r[10]-s[10]),n[11]=s[11]+a*(r[11]-s[11]),n[12]=s[12]+a*(r[12]-s[12]),n[13]=s[13]+a*(r[13]-s[13]),n[14]=s[14]+a*(r[14]-s[14]),n[15]=s[15]+a*(r[15]-s[15]),n},flatten(t){const e=[];let i,s,r,o,n;for(i=0,s=t.length;i<s;i++)for(r=0,o=(n=t[i]).length;r<o;r++)e.push(n[r]);return e},identityQuaternion:(t=M.vec4())=>(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t),eulerToQuaternion(t,e,i=M.vec4()){const s=t[0]*M.DEGTORAD/2,r=t[1]*M.DEGTORAD/2,o=t[2]*M.DEGTORAD/2,n=Math.cos(s),a=Math.cos(r),l=Math.cos(o),h=Math.sin(s),c=Math.sin(r),d=Math.sin(o);return"XYZ"===e?(i[0]=h*a*l+n*c*d,i[1]=n*c*l-h*a*d,i[2]=n*a*d+h*c*l,i[3]=n*a*l-h*c*d):"YXZ"===e?(i[0]=h*a*l+n*c*d,i[1]=n*c*l-h*a*d,i[2]=n*a*d-h*c*l,i[3]=n*a*l+h*c*d):"ZXY"===e?(i[0]=h*a*l-n*c*d,i[1]=n*c*l+h*a*d,i[2]=n*a*d+h*c*l,i[3]=n*a*l-h*c*d):"ZYX"===e?(i[0]=h*a*l-n*c*d,i[1]=n*c*l+h*a*d,i[2]=n*a*d-h*c*l,i[3]=n*a*l+h*c*d):"YZX"===e?(i[0]=h*a*l+n*c*d,i[1]=n*c*l+h*a*d,i[2]=n*a*d-h*c*l,i[3]=n*a*l-h*c*d):"XZY"===e&&(i[0]=h*a*l-n*c*d,i[1]=n*c*l-h*a*d,i[2]=n*a*d+h*c*l,i[3]=n*a*l+h*c*d),i},mat4ToQuaternion(t,e=M.vec4()){const i=t[0],s=t[4],r=t[8],o=t[1],n=t[5],a=t[9],l=t[2],h=t[6],c=t[10];let d;const u=i+n+c;return u>0?(d=.5/Math.sqrt(u+1),e[3]=.25/d,e[0]=(h-a)*d,e[1]=(r-l)*d,e[2]=(o-s)*d):i>n&&i>c?(d=2*Math.sqrt(1+i-n-c),e[3]=(h-a)/d,e[0]=.25*d,e[1]=(s+o)/d,e[2]=(r+l)/d):n>c?(d=2*Math.sqrt(1+n-i-c),e[3]=(r-l)/d,e[0]=(s+o)/d,e[1]=.25*d,e[2]=(a+h)/d):(d=2*Math.sqrt(1+c-i-n),e[3]=(o-s)/d,e[0]=(r+l)/d,e[1]=(a+h)/d,e[2]=.25*d),e},vec3PairToQuaternion(t,e,i=M.vec4()){const s=Math.sqrt(M.dotVec3(t,t)*M.dotVec3(e,e));let r=s+M.dotVec3(t,e);return r<1e-8*s?(r=0,Math.abs(t[0])>Math.abs(t[2])?(i[0]=-t[1],i[1]=t[0],i[2]=0):(i[0]=0,i[1]=-t[2],i[2]=t[1])):M.cross3Vec3(t,e,i),i[3]=r,M.normalizeQuaternion(i)},angleAxisToQuaternion(t,e=M.vec4()){const i=t[3]/2,s=Math.sin(i);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(i),e},quaternionToEuler:(()=>{const t=new Float32Array(16);return(e,i,s)=>(s=s||M.vec3(),M.quaternionToRotationMat4(e,t),M.mat4ToEuler(t,i,s),s)})(),mulQuaternions(t,e,i=M.vec4()){const s=t[0],r=t[1],o=t[2],n=t[3],a=e[0],l=e[1],h=e[2],c=e[3];return i[0]=n*a+s*c+r*h-o*l,i[1]=n*l+r*c+o*a-s*h,i[2]=n*h+o*c+s*l-r*a,i[3]=n*c-s*a-r*l-o*h,i},vec3ApplyQuaternion(t,e,i=M.vec3()){const s=e[0],r=e[1],o=e[2],n=t[0],a=t[1],l=t[2],h=t[3],c=h*s+a*o-l*r,d=h*r+l*s-n*o,u=h*o+n*r-a*s,_=-n*s-a*r-l*o;return i[0]=c*h+_*-n+d*-l-u*-a,i[1]=d*h+_*-a+u*-n-c*-l,i[2]=u*h+_*-l+c*-a-d*-n,i},quaternionToMat4(t,e){e=M.identityMat4(e);const i=t[0],s=t[1],r=t[2],o=t[3],n=2*i,a=2*s,l=2*r,h=n*o,c=a*o,d=l*o,u=n*i,_=a*i,p=l*i,f=a*s,g=l*s,m=l*r;return e[0]=1-(f+m),e[1]=_+d,e[2]=p-c,e[4]=_-d,e[5]=1-(u+m),e[6]=g+h,e[8]=p+c,e[9]=g-h,e[10]=1-(u+f),e},quaternionToRotationMat4(t,e){const i=t[0],s=t[1],r=t[2],o=t[3],n=i+i,a=s+s,l=r+r,h=i*n,c=i*a,d=i*l,u=s*a,_=s*l,p=r*l,f=o*n,g=o*a,m=o*l;return e[0]=1-(u+p),e[4]=c-m,e[8]=d+g,e[1]=c+m,e[5]=1-(h+p),e[9]=_-f,e[2]=d-g,e[6]=_+f,e[10]=1-(h+u),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(t,e=t){const i=M.lenVec4([t[0],t[1],t[2],t[3]]);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,e},conjugateQuaternion:(t,e=t)=>(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e),inverseQuaternion:(t,e)=>M.normalizeQuaternion(M.conjugateQuaternion(t,e)),quaternionToAngleAxis(t,e=M.vec4()){const i=(t=M.normalizeQuaternion(t,P))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r),e[3]=s,e},AABB3:t=>new Float32Array(t||6),AABB2:t=>new Float32Array(t||4),OBB3:t=>new Float32Array(t||32),OBB2:t=>new Float32Array(t||16),Sphere3:(t,e,i,s)=>new Float32Array([t,e,i,s]),transformOBB3(t,e,i=e){let s;const r=e.length;let o,n,a;const l=t[0],h=t[1],c=t[2],d=t[3],u=t[4],_=t[5],p=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],w=t[13],P=t[14],M=t[15];for(s=0;s<r;s+=4)o=e[s+0],n=e[s+1],a=e[s+2],i[s+0]=l*o+u*n+g*a+y,i[s+1]=h*o+_*n+m*a+w,i[s+2]=c*o+p*n+v*a+P,i[s+3]=d*o+f*n+b*a+M;return i},getAABB3Diag:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return s=>(t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5],M.subVec3(e,t,i),Math.abs(M.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return(s,r)=>{t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5];const o=M.subVec3(e,t,i),n=r[0]-s[0],a=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],c=r[2]-s[2],d=s[5]-r[2];return o[0]+=n>a?n:a,o[1]+=l>h?l:h,o[2]+=c>d?c:d,Math.abs(M.lenVec3(o))}})(),getAABB3Center(t,e){const i=e||M.vec3();return i[0]=(t[0]+t[3])/2,i[1]=(t[1]+t[4])/2,i[2]=(t[2]+t[5])/2,i},getAABB2Center(t,e){const i=e||M.vec2();return i[0]=(t[2]+t[0])/2,i[1]=(t[3]+t[1])/2,i},collapseAABB3:(t=M.AABB3())=>(t[0]=M.MAX_DOUBLE,t[1]=M.MAX_DOUBLE,t[2]=M.MAX_DOUBLE,t[3]=-M.MAX_DOUBLE,t[4]=-M.MAX_DOUBLE,t[5]=-M.MAX_DOUBLE,t),AABB3ToOBB3:(t,e=M.OBB3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,e[4]=t[3],e[5]=t[1],e[6]=t[2],e[7]=1,e[8]=t[3],e[9]=t[4],e[10]=t[2],e[11]=1,e[12]=t[0],e[13]=t[4],e[14]=t[2],e[15]=1,e[16]=t[0],e[17]=t[1],e[18]=t[5],e[19]=1,e[20]=t[3],e[21]=t[1],e[22]=t[5],e[23]=1,e[24]=t[3],e[25]=t[4],e[26]=t[5],e[27]=1,e[28]=t[0],e[29]=t[4],e[30]=t[5],e[31]=1,e),positions3ToAABB3:(()=>{const t=new Float32Array(3);return(e,i,s)=>{i=i||M.AABB3();let r,o,n,a=M.MAX_DOUBLE,l=M.MAX_DOUBLE,h=M.MAX_DOUBLE,c=-M.MAX_DOUBLE,d=-M.MAX_DOUBLE,u=-M.MAX_DOUBLE;for(let i=0,_=e.length;i<_;i+=3)s?(t[0]=e[i+0],t[1]=e[i+1],t[2]=e[i+2],M.decompressPosition(t,s,t),r=t[0],o=t[1],n=t[2]):(r=e[i+0],o=e[i+1],n=e[i+2]),r<a&&(a=r),o<l&&(l=o),n<h&&(h=n),r>c&&(c=r),o>d&&(d=o),n>u&&(u=n);return i[0]=a,i[1]=l,i[2]=h,i[3]=c,i[4]=d,i[5]=u,i}})(),OBB3ToAABB3(t,e=M.AABB3()){let i,s,r,o=M.MAX_DOUBLE,n=M.MAX_DOUBLE,a=M.MAX_DOUBLE,l=-M.MAX_DOUBLE,h=-M.MAX_DOUBLE,c=-M.MAX_DOUBLE;for(let e=0,d=t.length;e<d;e+=4)(i=t[e+0])<o&&(o=i),(s=t[e+1])<n&&(n=s),(r=t[e+2])<a&&(a=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return e[0]=o,e[1]=n,e[2]=a,e[3]=l,e[4]=h,e[5]=c,e},points3ToAABB3(t,e=M.AABB3()){let i,s,r,o=M.MAX_DOUBLE,n=M.MAX_DOUBLE,a=M.MAX_DOUBLE,l=-M.MAX_DOUBLE,h=-M.MAX_DOUBLE,c=-M.MAX_DOUBLE;for(let e=0,d=t.length;e<d;e++)(i=t[e][0])<o&&(o=i),(s=t[e][1])<n&&(n=s),(r=t[e][2])<a&&(a=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return e[0]=o,e[1]=n,e[2]=a,e[3]=l,e[4]=h,e[5]=c,e},points3ToSphere3:(()=>{const t=new Float32Array(3);return(e,i)=>{i=i||M.vec4();let s,r=0,o=0,n=0;const a=e.length;for(s=0;s<a;s++)r+=e[s][0],o+=e[s][1],n+=e[s][2];i[0]=r/a,i[1]=o/a,i[2]=n/a;let l,h=0;for(s=0;s<a;s++)(l=Math.abs(M.lenVec3(M.subVec3(e[s],i,t))))>h&&(h=l);return i[3]=h,i}})(),positions3ToSphere3:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s)=>{s=s||M.vec4();let r,o=0,n=0,a=0;const l=i.length;let h=0;for(r=0;r<l;r+=3)o+=i[r],n+=i[r+1],a+=i[r+2];const c=l/3;let d;for(s[0]=o/c,s[1]=n/c,s[2]=a/c,r=0;r<l;r+=3)t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],(d=Math.abs(M.lenVec3(M.subVec3(t,s,e))))>h&&(h=d);return s[3]=h,s}})(),OBB3ToSphere3:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s)=>{s=s||M.vec4();let r,o=0,n=0,a=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)o+=i[r+0],n+=i[r+1],a+=i[r+2];s[0]=o/h,s[1]=n/h,s[2]=a/h;let c,d=0;for(r=0;r<l;r+=4)t[0]=i[r+0],t[1]=i[r+1],t[2]=i[r+2],(c=Math.abs(M.lenVec3(M.subVec3(t,s,e))))>d&&(d=c);return s[3]=d,s}})(),getSphere3Center:(t,e=M.vec3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e),expandAABB3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t[4]<e[4]&&(t[4]=e[4]),t[5]<e[5]&&(t[5]=e[5]),t),expandAABB3Point3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[0]&&(t[3]=e[0]),t[4]<e[1]&&(t[4]=e[1]),t[5]<e[2]&&(t[5]=e[2]),t),expandAABB3Points3(t,e){for(var i,s,r,o=0,n=e.length;o<n;o+=3)i=e[o],s=e[o+1],r=e[o+2],t[0]>i&&(t[0]=i),t[1]>s&&(t[1]=s),t[2]>r&&(t[2]=r),t[3]<i&&(t[3]=i),t[4]<s&&(t[4]=s),t[5]<r&&(t[5]=r);return t},collapseAABB2:(t=M.AABB2())=>(t[0]=M.MAX_DOUBLE,t[1]=M.MAX_DOUBLE,t[2]=-M.MAX_DOUBLE,t[3]=-M.MAX_DOUBLE,t),OBB3ToAABB2(t,e=M.AABB2()){let i,s,r,o,n=M.MAX_DOUBLE,a=M.MAX_DOUBLE,l=-M.MAX_DOUBLE,h=-M.MAX_DOUBLE;for(let e=0,c=t.length;e<c;e+=4)i=t[e+0],s=t[e+1],(i*=o=1/(r=t[e+3]||1))<n&&(n=i),(s*=o)<a&&(a=s),i>l&&(l=i),s>h&&(h=s);return e[0]=n,e[1]=a,e[2]=l,e[3]=h,e},expandAABB2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t),expandAABB2Point2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1]),t),AABB2ToCanvas(t,e,i,s=t){const r=.5*(t[0]+1),o=.5*(t[1]+1),n=.5*(t[2]+1),a=.5*(t[3]+1);return s[0]=Math.floor(r*e),s[1]=i-Math.floor(a*i),s[2]=Math.floor(n*e),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier:(t,e,i,s)=>2*(1-t)*(i-e)+2*t*(s-i),tangentQuadraticBezier3:(t,e,i,s,r)=>-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*s*(1-t)-3*t*t*s+3*t*t*r,tangentSpline:t=>6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t),catmullRomInterpolate(t,e,i,s,r){const o=.5*(i-t),n=.5*(s-e),a=r*r;return(2*e-2*i+o+n)*(r*a)+(-3*e+3*i-2*o-n)*a+o*r+e},b2p0(t,e){const i=1-t;return i*i*e},b2p1:(t,e)=>2*(1-t)*t*e,b2p2:(t,e)=>t*t*e,b2(t,e,i,s){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,s)},b3p0(t,e){const i=1-t;return i*i*i*e},b3p1(t,e){const i=1-t;return 3*i*i*t*e},b3p2:(t,e)=>3*(1-t)*t*t*e,b3p3:(t,e)=>t*t*t*e,b3(t,e,i,s,r){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,s)+this.b3p3(t,r)},triangleNormal(t,e,i,s=M.vec3()){const r=e[0]-t[0],o=e[1]-t[1],n=e[2]-t[2],a=i[0]-t[0],l=i[1]-t[1],h=i[2]-t[2],c=o*h-n*l,d=n*a-r*h,u=r*l-o*a,_=Math.sqrt(c*c+d*d+u*u);return 0===_?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/_,s[1]=d/_,s[2]=u/_),s},rayTriangleIntersect:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3);return(o,n,a,l,h,c)=>{c=c||M.vec3();const d=M.subVec3(l,a,t),u=M.subVec3(h,a,e),_=M.cross3Vec3(n,u,i),p=M.dotVec3(d,_);if(p<1e-6)return null;const f=M.subVec3(o,a,s),g=M.dotVec3(f,_);if(g<0||g>p)return null;const m=M.cross3Vec3(f,d,r),v=M.dotVec3(n,m);if(v<0||g+v>p)return null;const b=M.dotVec3(u,m)/p;return c[0]=o[0]+b*n[0],c[1]=o[1]+b*n[1],c[2]=o[2]+b*n[2],c}})(),rayPlaneIntersect:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3);return(r,o,n,a,l,h)=>{h=h||M.vec3(),o=M.normalizeVec3(o,t);const c=M.subVec3(a,n,e),d=M.subVec3(l,n,i),u=M.cross3Vec3(c,d,s);M.normalizeVec3(u,u);const _=-M.dotVec3(n,u),p=-(M.dotVec3(r,u)+_)/M.dotVec3(o,u);return h[0]=r[0]+p*o[0],h[1]=r[1]+p*o[1],h[2]=r[2]+p*o[2],h}})(),cartesianToBarycentric:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return(s,r,o,n,a)=>{const l=M.subVec3(n,r,t),h=M.subVec3(o,r,e),c=M.subVec3(s,r,i),d=M.dotVec3(l,l),u=M.dotVec3(l,h),_=M.dotVec3(l,c),p=M.dotVec3(h,h),f=M.dotVec3(h,c),g=d*p-u*u;if(0===g)return null;const m=1/g,v=(p*_-u*f)*m,b=(d*f-u*_)*m;return a[0]=1-v-b,a[1]=b,a[2]=v,a}})(),barycentricInsideTriangle(t){const e=t[1],i=t[2];return i>=0&&e>=0&&i+e<1},barycentricToCartesian(t,e,i,s,r=M.vec3()){const o=t[0],n=t[1],a=t[2];return r[0]=e[0]*o+i[0]*n+s[0]*a,r[1]=e[1]*o+i[1]*n+s[1]*a,r[2]=e[2]*o+i[2]*n+s[2]*a,r},mergeVertices(t,e,i,s){const r={},o=[],n=[],a=e?[]:null,l=i?[]:null,h=[];let c,d,u,_;let p,f,g=0;for(p=0,f=t.length;p<f;p+=3)c=t[p],d=t[p+1],u=t[p+2],void 0===r[_=`${Math.round(1e4*c)}_${Math.round(1e4*d)}_${Math.round(1e4*u)}`]&&(r[_]=n.length/3,n.push(c),n.push(d),n.push(u),e&&(a.push(e[p]),a.push(e[p+1]),a.push(e[p+2])),i&&(l.push(i[g]),l.push(i[g+1]))),o[p/3]=r[_],g+=2;for(p=0,f=s.length;p<f;p++)h[p]=o[s[p]];const m={positions:n,indices:h};return a&&(m.normals=a),l&&(m.uv=l),m},buildNormals:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),o=new Float32Array(3);return(n,a,l)=>{let h,c;const d=new Array(n.length/3);let u,_,p,f,g,m,v;for(h=0,c=a.length;h<c;h+=3){u=a[h],_=a[h+1],p=a[h+2],t[0]=n[3*u],t[1]=n[3*u+1],t[2]=n[3*u+2],e[0]=n[3*_],e[1]=n[3*_+1],e[2]=n[3*_+2],i[0]=n[3*p],i[1]=n[3*p+1],i[2]=n[3*p+2],M.subVec3(e,t,s),M.subVec3(i,t,r);const l=new Float32Array(3);M.normalizeVec3(M.cross3Vec3(s,r,o),l),d[u]||(d[u]=[]),d[_]||(d[_]=[]),d[p]||(d[p]=[]),d[u].push(l),d[_].push(l),d[p].push(l)}for(l=l&&l.length===n.length?l:new Float32Array(n.length),h=0,c=d.length;h<c;h++){f=d[h].length,g=0,m=0,v=0;for(let t=0;t<f;t++)g+=d[h][t][0],m+=d[h][t][1],v+=d[h][t][2];l[3*h]=g/f,l[3*h+1]=m/f,l[3*h+2]=v/f}return l}})(),buildTangents:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),o=new Float32Array(3),n=new Float32Array(3);return(a,l,h)=>{const c=new Float32Array(a.length);for(let d=0;d<l.length;d+=3){let u=l[d];const _=a.subarray(3*u,3*u+3),p=h.subarray(2*u,2*u+2);u=l[d+1];const f=a.subarray(3*u,3*u+3),g=h.subarray(2*u,2*u+2);u=l[d+2];const m=a.subarray(3*u,3*u+3),v=h.subarray(2*u,2*u+2),b=M.subVec3(f,_,t),y=M.subVec3(m,_,e),w=M.subVec2(g,p,i),P=M.subVec2(v,p,s),x=1/(w[0]*P[1]-w[1]*P[0]),A=M.mulVec3Scalar(M.subVec3(M.mulVec3Scalar(b,P[1],r),M.mulVec3Scalar(y,w[1],o),n),x,o);let E;for(let t=0;t<3;t++)c[E=3*l[d+t]]+=A[0],c[E+1]+=A[1],c[E+2]+=A[2]}return c}})(),buildPickTriangles(t,e,i){const s=e.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),o=new Uint8Array(12*s);let n,a,l,h,c,d,u=0,_=0,p=0;for(let i=0;i<s;i+=3)d=u>>24&255,c=u>>16&255,h=u>>8&255,l=255&u,n=3*(a=e[i]),r[_++]=t[n],r[_++]=t[n+1],r[_++]=t[n+2],o[p++]=l,o[p++]=h,o[p++]=c,o[p++]=d,n=3*(a=e[i+1]),r[_++]=t[n],r[_++]=t[n+1],r[_++]=t[n+2],o[p++]=l,o[p++]=h,o[p++]=c,o[p++]=d,n=3*(a=e[i+2]),r[_++]=t[n],r[_++]=t[n+1],r[_++]=t[n+2],o[p++]=l,o[p++]=h,o[p++]=c,o[p++]=d,u++;return{positions:r,colors:o}},faceToVertexNormals(t,e,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},o=[],n={};let a,l,h,c,d;let u,_,p,f,g,m;for(_=0,f=t.length;_<f;_+=3){u=_/3,l=t[_],h=t[_+1],c=t[_+2],void 0===r[d=`${Math.round(1e4*l)}_${Math.round(1e4*h)}_${Math.round(1e4*c)}`]?r[d]=[u]:r[d].push(u);const i=M.normalizeVec3([e[_],e[_+1],e[_+2]]);o[u]=i,a=M.vec4([i[0],i[1],i[2],1]),n[u]=a}for(d in r)if(r.hasOwnProperty(d)){const t=r[d],e=t.length;for(_=0;_<e;_++){const i=t[_];for(a=n[i],p=0;p<e;p++){if(_===p)continue;const e=t[p];g=o[i],m=o[e],Math.abs(M.angleVec3(g,m)/M.DEGTORAD)<s&&(a[0]+=m[0],a[1]+=m[1],a[2]+=m[2],a[3]+=1)}}}for(_=0,f=e.length;_<f;_+=3)a=n[_/3],e[_+0]=a[0]/a[3],e[_+1]=a[1]/a[3],e[_+2]=a[2]/a[3]},canvasPosToWorldRay:(()=>{const t=new Float32Array(16),e=new Float32Array(16),i=new Float32Array(4),s=new Float32Array(4),r=new Float32Array(4),o=new Float32Array(4);return(n,a,l,h,c,d)=>{const u=M.mulMat4(l,a,t),_=M.inverseMat4(u,e),p=n.width,f=n.height,g=(h[0]-p/2)/(p/2),m=-(h[1]-f/2)/(f/2);i[0]=g,i[1]=m,i[2]=-1,i[3]=1,M.transformVec4(_,i,s),M.mulVec4Scalar(s,1/s[3]),r[0]=g,r[1]=m,r[2]=1,r[3]=1,M.transformVec4(_,r,o),M.mulVec4Scalar(o,1/o[3]),c[0]=o[0],c[1]=o[1],c[2]=o[2],M.subVec3(o,s,d),M.normalizeVec3(d)}})(),canvasPosToLocalRay:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s,r,o,n,a,l)=>{M.canvasPosToWorldRay(i,s,r,n,t,e),M.worldRayToLocalRay(o,t,e,a,l)}})(),worldRayToLocalRay:(()=>{const t=new Float32Array(16),e=new Float32Array(4),i=new Float32Array(4);return(s,r,o,n,a)=>{const l=M.inverseMat4(s,t);e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,M.transformVec4(l,e,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],M.transformVec3(l,o,a)}})(),buildKDTree:(()=>{const t=10,e=20,i=new Float32Array;return(s,r)=>{const o=s.length/3,n=new Array(o);for(let t=0;t<o;++t)n[t]=t;return function s(r,o,n,a){const l=new Float32Array(6),h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};let c,d;for(l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY,c=0,d=r.length;c<d;++c){var u=3*r[c];for(let t=0;t<3;++t){const e=3*o[u+t];n[e]<l[0]&&(l[0]=n[e]),n[e]>l[3]&&(l[3]=n[e]),n[e+1]<l[1]&&(l[1]=n[e+1]),n[e+1]>l[4]&&(l[4]=n[e+1]),n[e+2]<l[2]&&(l[2]=n[e+2]),n[e+2]>l[5]&&(l[5]=n[e+2])}}if(r.length<e||a>t)return h.triangles=r,h.leaf=!0,h;i[0]=l[3]-l[0],i[1]=l[4]-l[1],i[2]=l[5]-l[2];let _=0;i[1]>i[_]&&(_=1),i[2]>i[_]&&(_=2),h.splitDim=_;const p=(l[_]+l[_+3])/2,f=new Array(r.length);let g=0;const m=new Array(r.length);let v=0;for(c=0,d=r.length;c<d;++c){const t=o[u=3*r[c]],e=3*o[u+1],i=3*o[u+2];n[3*t+_]<=p||n[e+_]<=p||n[i+_]<=p?f[g++]=r[c]:m[v++]=r[c]}return f.length=g,m.length=v,h.left=s(f,o,n,a+1),h.right=s(m,o,n,a+1),h}(n,s,r,0)}})(),decompressPosition(t,e,i){i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14]},decompressPositions(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressUV(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},decompressUVs(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},octDecodeVec2(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e},octDecodeVec2s(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);e[s+0]=r/a,e[s+1]=o/a,e[s+2]=n/a,s+=3}return e}};M.buildEdgeIndices=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),h=M.vec3(),c=M.vec3(),d=M.vec3(),u=M.vec3(),_=M.vec3(),p=M.vec3(),f=M.vec3();return function(g,m,v,b){!function(r,o){const n={};let a,l,h,c;const d=Math.pow(10,4);let u,_,p=0;for(u=0,_=r.length;u<_;u+=3)a=r[u],l=r[u+1],h=r[u+2],void 0===n[c=Math.round(a*d)+"_"+Math.round(l*d)+"_"+Math.round(h*d)]&&(n[c]=p/3,t[p++]=a,t[p++]=l,t[p++]=h),e[u/3]=n[c];for(u=0,_=o.length;u<_;u++)s[u]=e[o[u]],i[s[u]]=o[u]}(g,m),function(e,i){o=0;for(let g=0,m=e;g<m;g+=3){const e=3*s[g],m=3*s[g+1],v=3*s[g+2];i?(n[0]=t[e],n[1]=t[e+1],n[2]=t[e+2],a[0]=t[m],a[1]=t[m+1],a[2]=t[m+2],l[0]=t[v],l[1]=t[v+1],l[2]=t[v+2],M.decompressPosition(n,i,h),M.decompressPosition(a,i,c),M.decompressPosition(l,i,d)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],c[0]=t[m],c[1]=t[m+1],c[2]=t[m+2],d[0]=t[v],d[1]=t[v+1],d[2]=t[v+2]),M.subVec3(d,c,u),M.subVec3(h,c,_),M.cross3Vec3(u,_,p),M.normalizeVec3(p,f);const b=r[o]||(r[o]={normal:M.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],o++}}(m.length,v);const y=[],w=Math.cos(M.DEGTORAD*b),P={};let x,A,E,L,C,k,D,S,R,B,T,F=!1;for(let t=0,e=m.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)x=s[t+i],A=s[t+(i+1)%3],void 0===P[C=(E=Math.min(x,A))+","+(L=Math.max(x,A))]?P[C]={index1:E,index2:L,face1:e,face2:void 0}:P[C].face2=e}for(C in P)void 0!==(k=P[C]).face2&&(D=r[k.face1].normal,S=r[k.face2].normal,(R=M.dotVec3(D,S))>w)||(B=i[k.index1],T=i[k.index2],(!F&&B>65535||T>65535)&&(F=!0),y.push(B),y.push(T));return F?new Uint32Array(y):new Uint16Array(y)}}();class x{get type(){return"Component"}get isComponent(){return!0}constructor(t=null,e={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=e.viewer;else{if("Scene"===t.type)this.scene=t;else{if(!(t instanceof x))throw"Invalid param: owner must be a Component";this.scene=t.scene}this._owner=t,this._renderer=this.scene._renderer}this._dontClear=!!e.dontClear,this._renderer=this.scene._renderer,this.meta=e.meta||{},this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,t&&t._own(this)}glRedraw(){this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty()}glResort(){this._renderer.needStateSort()}get owner(){return this._owner}isType(t){return this.type===t}fire(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[t]=e||!0);const s=this._eventSubs[t];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,e):this.error("fire: potential stack overflow from recursive event '"+t+"' - dropping this event"),this._eventCallDepth--)}on(t,e,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new s),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});let r=this._eventSubs[t];r||(r={},this._eventSubs[t]=r);const o=this._subIdMap.addItem();r[o]={callback:e,scope:i||this},this._subIdEvents[o]=t;const n=this._events[t];return void 0!==n&&e.call(i||this,n),o}off(t){if(null==t)return;if(!this._subIdEvents)return;const e=this._subIdEvents[t];if(e){delete this._subIdEvents[t];const i=this._eventSubs[e];i&&delete i[t],this._subIdMap.removeItem(t)}}once(t,e,i){const s=this,r=this.on(t,function(t){s.off(r),e.call(i||this,t)},i)}hasSubs(t){return this._eventSubs&&!!this._eventSubs[t]}log(t){t="[LOG]"+this._message(t),window.console.log(t),this.scene.fire("log",t)}_message(t){return" ["+this.type+" "+a.inQuotes(this.id)+"]: "+t}warn(t){t="[WARN]"+this._message(t),window.console.warn(t),this.scene.fire("warn",t)}error(t){t="[ERROR]"+this._message(t),window.console.error(t),this.scene.fire("error",t)}_attach(t){const e=t.name;if(!e)return void this.error("Component 'name' expected");let i=t.component;const s=t.sceneDefault,r=t.sceneSingleton,o=t.type,n=t.on,l=!1!==t.recompiles;if(i&&(a.isNumeric(i)||a.isString(i))){const t=i;if(!(i=this.scene.components[t]))return void this.error("Component not found: "+a.inQuotes(t))}if(!i)if(!0===r){const t=this.scene.types[o];for(const e in t)if(t.hasOwnProperty){i=t[e];break}if(!i)return this.error("Scene has no default component for '"+e+"'"),null}else if(!0===s&&!(i=this.scene[e]))return this.error("Scene has no default component for '"+e+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+a.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+a.inQuotes(i.id))}this._attachments||(this._attachments={});const h=this._attached[e];let c,d,u;if(h){if(i&&h.id===i.id)return;const t=this._attachments[h.id];for(d=0,u=(c=t.subs).length;d<u;d++)h.off(c[d]);delete this._attached[e],delete this._attachments[h.id];const s=t.params.onDetached;s&&(a.isFunction(s)?s(h):s.scope?s.callback.call(s.scope,h):s.callback(h)),t.managingLifecycle&&h.destroy()}if(i){const s={params:t,component:i,subs:[],managingLifecycle:!1};s.subs.push(i.once("destroyed",function(){s.params.component=null,this._attach(s.params)},this)),l&&s.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[e]=i,this._attachments[i.id]=s;const r=t.onAttached;if(r&&(a.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),n){let t,e,r,o;for(t in n)if(n.hasOwnProperty(t)){if(e=n[t],a.isFunction(e)?(r=e,o=null):(r=e.callback,o=e.scope),!r)continue;s.subs.push(i.on(t,r,o))}}}return l&&this.fire("dirty",this),this.fire(e,i),i}_checkComponent(t,e){if(!e.isComponent){if(!a.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(t===e.type){if(e.scene.id===this.scene.id)return e;this.error("Not in same scene: "+e.type)}else this.error("Expected a "+t+" Component")}_checkComponent2(t,e){if(!e.isComponent){if(!a.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(e.scene.id===this.scene.id){for(var i=0,s=t.length;i<s;i++)if(t[i]===e.type)return e;return this.error("Expected component types: "+t),null}this.error("Not in same scene: "+e.type)}_own(t){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[t.id]||(this._ownedComponents[t.id]=t),t.once("destroyed",()=>{delete this._ownedComponents[t.id]},this)}_needUpdate(t){this._updateScheduled||(this._updateScheduled=!0,0===t?this._doUpdate():v.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}clear(){if(this._ownedComponents)for(var t in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(t)){this._ownedComponents[t].destroy(),delete this._ownedComponents[t]}}destroy(){if(this.destroyed)return;let t,e,i,s,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(t in this._attachments)if(this._attachments.hasOwnProperty(t)){for(i=(e=this._attachments[t]).component,r=0,o=(s=e.subs).length;r<o;r++)i.off(s[r]);e.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(t in this._ownedComponents)this._ownedComponents.hasOwnProperty(t)&&((i=this._ownedComponents[t]).destroy(),delete this._ownedComponents[t]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const A=function(){const t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!t.getContext("2d").getImageData,s=!!t.toDataURL,r=!!window.btoa,o=function(t){let i="";const s=t.width,r=t.height;i+="BM";let o=s*r*4+54;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);let n=s;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256);let a=r;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),i+=e(1,0,32,0),i+=e(0,0,0,0);let l=s*r*4;i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=t.data;let c,d,u,_,p="",f=r;do{for(u=s*(f-1)*4,_="",c=0;c<s;c++)_+=e(h[u+(d=4*c)+2],h[u+d+1],h[u+d],h[u+d+3]);p+=_}while(--f);return function(t){let i,s,r="";if("string"==typeof t)r=t;else for(s=t,i=0;i<s.length;i++)r+=e(s[i]);return btoa(r)}(i+p)},n=function(t){window.open(t)||(document.location.href=t)},a=function(t,e){return"data:"+e+";base64,"+t},l=function(t){const e=document.createElement("img");return e.src=t,e},h=function(t,e,i){if(e&&i){const s=document.createElement("canvas");return s.width=e,s.height=i,s.style.width=e+"px",s.style.height=i+"px",s.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e,i),s}return t};return{saveAsPNG:function(t,e,i,r){if(!s)return!1;const o=h(t,i,r).toDataURL("image/png");return e?l(o):(n(o),!0)},saveAsJPEG:function(t,e,i,r){if(!s)return!1;const o=h(t,i,r).toDataURL("image/jpeg");return 5==o.indexOf("image/jpeg")&&(e?l(o):(n(o),!0))},saveAsBMP:function(t,e,c,d){if(!(s&&i&&r))return!1;const u=function(t){const e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(h(t,c,d)),_=o(u);return e?l(a(_,"image/bmp")):(n(a(_,"image/bmp")),!0)}}}(),E=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }";class L extends x{get type(){return"Spinner"}constructor(t,e={}){super(t,e),this._canvas=e.canvas,this._element=null,this._isCustom=!1,e.elementId&&(this._element=document.getElementById(e.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+e.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const t=document.createElement("div"),e=t.style;e["z-index"]="9000",e.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){if(document.getElementById("xeokit-spinner-css"))return;const t=document.createElement("style");t.innerHTML=E,t.id="xeokit-spinner-css",document.body.appendChild(t)}_adjustPosition(){if(this._isCustom)return;const t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}set processes(t){if(t=t||0,this._processes===t)return;if(t<0)return;const e=this._processes;this._processes=t;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==e&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null)}}const C={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},k=document.createElement("canvas");if(k){const t=k.getContext("webgl",{antialias:!0})||k.getContext("experimental-webgl",{antialias:!0});C.WEBGL=!!t,C.WEBGL&&(C.ANTIALIAS=t.getContextAttributes().antialias,t.getShaderPrecisionFormat?t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?C.FS_MAX_FLOAT_PRECISION="highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?C.FS_MAX_FLOAT_PRECISION="mediump":C.FS_MAX_FLOAT_PRECISION="lowp":C.FS_MAX_FLOAT_PRECISION="mediump",C.DEPTH_BUFFER_BITS=t.getParameter(t.DEPTH_BITS),C.MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),C.MAX_CUBE_MAP_SIZE=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),C.MAX_RENDERBUFFER_SIZE=t.getParameter(t.MAX_RENDERBUFFER_SIZE),C.MAX_TEXTURE_UNITS=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),C.MAX_TEXTURE_IMAGE_UNITS=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),C.MAX_VERTEX_ATTRIBS=t.getParameter(t.MAX_VERTEX_ATTRIBS),C.MAX_VERTEX_UNIFORM_VECTORS=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),C.MAX_FRAGMENT_UNIFORM_VECTORS=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),C.MAX_VARYING_VECTORS=t.getParameter(t.MAX_VARYING_VECTORS),t.getSupportedExtensions().forEach(function(t){C.SUPPORTED_EXTENSIONS[t]=!0}))}const D=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class S extends x{get type(){return"Canvas"}constructor(t,e={}){super(t,e),this.canvas=e.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!0),this.contextAttr.stencil=!1,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(e);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(t){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(t){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),t.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=null,o=null,n=null,a=null,l=null,h=null,c=null;this._tick=this.scene.on("tick",function(){const t=i.canvas,e=window.innerWidth!==s||window.innerHeight!==o,d=t.clientWidth!==n||t.clientHeight!==a,u=t.offsetLeft!==l||t.offsetTop!==h,_=t.parentElement;if(e||d||u||_!==c){if(i._spinner._adjustPosition(),d||u){const e=t.clientWidth,s=t.clientHeight;if(d){let e,i=0;for(const t in v.scenes)v.scenes.hasOwnProperty(t)&&(i+=(e=v.scenes[t]).canvas.canvas.clientWidth*e.canvas.canvas.clientHeight);r.memory.pixels=i,t.width=t.clientWidth,t.height=t.clientHeight}const o=i.boundary;o[0]=t.offsetLeft,o[1]=t.offsetTop,o[2]=e,o[3]=s,i.fire("boundary",o),n=e,a=s}e&&(s=window.innerWidth,o=window.innerHeight),u&&(l=t.offsetLeft,h=t.offsetTop),c=_}}),this.canvas.oncontextmenu=function(t){t.preventDefault()},this._spinner=new L(this.scene,{canvas:this.canvas,elementId:e.spinnerElementId}),this.clearColorAmbient=e.clearColorAmbient}_createCanvas(){const t="xeokit-canvas-"+M.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)}_getElementXY(t){let e=0,i=0;for(;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}}_initWebGL(){if(!this.gl)for(let t=0;!this.gl&&t<D.length;t++)try{this.gl=this.canvas.getContext(D[t],this.contextAttr)}catch(t){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else if(C.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const t=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}}set clearColorAmbient(t){this._clearColorAmbient=!!t}get clearColorAmbient(){return this._clearColorAmbient}getSnapshot(t){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}_getSnapshot(t){const e=(t=t||{}).width||this.canvas.width,i=t.height||this.canvas.height,s=t.format||"jpeg";let r;switch(s){case"jpeg":r=A.saveAsJPEG(this.canvas,!0,e,i);break;case"png":r=A.saveAsPNG(this.canvas,!0,e,i);break;case"bmp":r=A.saveAsBMP(this.canvas,!0,e,i);break;default:this.error("Unsupported snapshot format: '"+s+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),r=A.saveAsJPEG(this.canvas,!0,e,i)}return r.src}readPixels(t,e,i,s){return this.scene._renderer.readPixels(t,e,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}get spinner(){return this._spinner}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.canvas=null,this.gl=null,super.destroy()}}class R{constructor(){this.reset()}reset(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.lineWidth=1}}class B{constructor(){this.reset()}reset(){this.normalFillOpaque=!1,this.normalEdgesOpaque=!1,this.normalFillTransparent=!1,this.normalEdgesTransparent=!1,this.xrayedFillOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedFillTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedFillOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedFillTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedFillOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedFillTransparent=!1,this.selectedEdgesTransparent=!1}}class T{constructor(t,e,i){i=i||{},this.gl=e,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=i.size}setSize(t){this.size=t}webglContextRestored(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let t,e;const i=this.gl;if(this.size?(t=this.size[0],e=this.size[1]):(t=this.canvas.clientWidth,e=this.canvas.clientHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);const r=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);const o=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,r),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,o),!i.isFramebuffer(o))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:o,renderbuf:r,texture:s,width:t,height:e},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}read(t,e){const i=t,s=this.canvas.height-e,r=new Uint8Array(4),o=this.gl;return o.readPixels(i,s,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}unbind(){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.bound=!1}getTexture(){const t=this;return{renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}}}destroy(){if(this.allocated){const t=this.gl;t.deleteTexture(this.buffer.texture),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}}}class F{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float32Array([0,0,0]),this._direction=new Float32Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float32Array([0,0,0]),this._worldPos=new Float32Array([0,0,0]),this._viewPos=new Float32Array([0,0,0]),this._bary=new Float32Array([0,0,0]),this._worldNormal=new Float32Array([0,0,0]),this._uv=new Float32Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(t){t?(this._canvasPos[0]=t[0],this._canvasPos[1]=t[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(t){t?(this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(t){t?(this._direction[0]=t[0],this._direction[1]=t[1],this._direction[2]=t[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(t){t?(this._indices[0]=t[0],this._indices[1]=t[1],this._indices[2]=t[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(t){t?(this._localPos[0]=t[0],this._localPos[1]=t[1],this._localPos[2]=t[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(t){t?(this._worldPos[0]=t[0],this._worldPos[1]=t[1],this._worldPos[2]=t[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(t){t?(this._viewPos[0]=t[0],this._viewPos[1]=t[1],this._viewPos[2]=t[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(t){t?(this._bary[0]=t[0],this._bary[1]=t[1],this._bary[2]=t[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(t){t?(this._worldNormal[0]=t[0],this._worldNormal[1]=t[1],this._worldNormal[2]=t[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(t){t?(this._uv[0]=t[0],this._uv[1]=t[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}class I{constructor(t,e,i){if(this.allocated=!1,this.compiled=!1,this.handle=t.createShader(e),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){const e=i.split("\n"),s=[];for(let t=0;t<e.length;t++)s.push(t+1+": "+e[t]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class N{constructor(t,e){this.bindTexture=function(i,s){return!!i.bind(s)&&(t.uniform1i(e,s),!0)}}}class O{constructor(t,e){this._gl=t,this.location=e}bindArrayBuffer(t){t&&(t.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t.itemSize,t.itemType,t.normalized,t.stride,t.offset))}}const V=new s({});function z(t){const e=[];let i,s;for(let r=0,o=t.length;r<o;r++)(s=(i=t[r]).indexOf("/"))>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),e.push(i);return e.join("\n")}class U{constructor(t,e){this.id=V.addItem({}),this.source=e,this.init(t)}init(t){if(this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new I(t,t.VERTEX_SHADER,z(this.source.vertex)),this._fragmentShader=new I(t,t.FRAGMENT_SHADER,z(this.source.fragment)),!this._vertexShader.allocated)return void(this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors));if(!this._fragmentShader.allocated)return void(this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors));if(!this._fragmentShader.compiled)return void(this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors));let e,i,s,r,o;if(this.compiled=!0,this.handle=t.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(t.attachShader(this.handle,this._vertexShader.handle),t.attachShader(this.handle,this._fragmentShader.handle),t.linkProgram(this.handle),this.linked=t.getProgramParameter(this.handle,t.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(t.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(this.source.fragment));const n=t.getProgramParameter(this.handle,t.ACTIVE_UNIFORMS);for(i=0;i<n;++i)(s=t.getActiveUniform(this.handle,i))&&("\0"===(r=s.name)[r.length-1]&&(r=r.substr(0,r.length-1)),o=t.getUniformLocation(this.handle,r),s.type===t.SAMPLER_2D||s.type===t.SAMPLER_CUBE||35682===s.type?this.samplers[r]=new N(t,o):this.uniforms[r]=o);const a=t.getProgramParameter(this.handle,t.ACTIVE_ATTRIBUTES);for(i=0;i<a;i++)(e=t.getActiveAttrib(this.handle,i))&&(o=t.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new O(t,o));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(t){if(this.allocated)return this.uniforms[t]}getAttribute(t){if(this.allocated)return this.attributes[t]}bindTexture(t,e,i){if(!this.allocated)return!1;const s=this.samplers[t];return!!s&&s.bindTexture(e,i)}destroy(){this.allocated&&(V.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class j{constructor(t,e,i,s,r,o,n,a,l){switch(this._gl=t,this.type=e,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!n,this.stride=a||0,this.offset=l||0,this._allocate(i)}_allocate(t){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,t.length>this.dataLength?t.slice(0,this.dataLength):t,this.usage),this._gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(t,e){this.allocated&&(t.length+(e||0)>this.length?(this.destroy(),this._allocate(t)):(this._gl.bindBuffer(this.type,this._handle),e||0===e?this._gl.bufferSubData(this.type,e*this.itemByteSize,t):this._gl.bufferData(this.type,t,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}const Y=!1,G=M.vec3([1,0,0]),H=20;class K{constructor(t){this._scene=t,this._markers={},this._markerList=[],this._markerIndices={},this._numMarkers=0,this._positions=[],this._indices=[],this._positionsBuf=null,this._indicesBuf=null,this._occlusionTestList=[],this._lenOcclusionTestList=0,this._pixels=[],this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markerListDirty=!1,this._positionsDirty=!1,this._vbosDirty=!1,this._occlusionTestListDirty=!1,this._lenPositionsBuf=0,t.camera.on("viewMatrix",()=>{this._occlusionTestListDirty=!0}),t.camera.on("projMatrix",()=>{this._occlusionTestListDirty=!0}),t.canvas.on("boundary",()=>{this._occlusionTestListDirty=!0})}addMarker(t){this._markers[t.id]=t,this._markerListDirty=!0}markerWorldPosUpdated(t){if(!this._markers[t.id])return;const e=this._markerIndices[t.id];this._positions[3*e+0]=t.worldPos[0],this._positions[3*e+1]=t.worldPos[1],this._positions[3*e+2]=t.worldPos[2],this._positionsDirty=!0}removeMarker(t){delete this._markers[t.id],this._markerListDirty=!0}bindRenderBuf(){const t=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");t!==this._shaderSourceHash&&(this._shaderSourceHash=t,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._markerListDirty&&(this._buildMarkerList(),this._markerListDirty=!1,this._positionsDirty=!0,this._occlusionTestListDirty=!0),this._positionsDirty&&(this._buildPositions(),this._positionsDirty=!1,this._vbosDirty=!0),this._vbosDirty&&(this._buildVBOs(),this._vbosDirty=!1),this._occlusionTestListDirty&&this._buildOcclusionTestList(),Y||(this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new T(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear())}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const t=this._scene._sectionPlanesState.sectionPlanes.length>0,e=[];return e.push("// Mesh occlusion vertex shader"),e.push("attribute vec3 position;"),e.push("uniform mat4 modelMatrix;"),e.push("uniform mat4 viewMatrix;"),e.push("uniform mat4 projMatrix;"),t&&e.push("varying vec4 vWorldPosition;"),e.push("void main(void) {"),e.push("vec4 worldPosition = vec4(position, 1.0); "),e.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&e.push("   vWorldPosition = worldPosition;"),e.push("   gl_Position = projMatrix * viewPosition;"),e.push("   gl_PointSize = "+H+".0;"),e.push("}"),e}_buildFragmentShaderSource(){const t=this._scene._sectionPlanesState,e=t.sectionPlanes.length>0,i=[];if(i.push("// Mesh occlusion fragment shader"),i.push("precision lowp float;"),e){i.push("uniform bool clippable;"),i.push("varying vec4 vWorldPosition;");for(var s=0;s<t.sectionPlanes.length;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("void main(void) {"),e){i.push("if (clippable) {"),i.push("  float dist = 0.0;");for(s=0;s<t.sectionPlanes.length;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return i.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),i.push("}"),i}_buildProgram(){this._program&&this._program.destroy();const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new U(e,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,o=i.sectionPlanes.length;r<o;r++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+r),pos:s.getLocation("sectionPlanePos"+r),dir:s.getLocation("sectionPlaneDir"+r)});this._aPosition=s.getAttribute("position")}_buildMarkerList(){for(var t in this._numMarkers=0,this._markers)this._markers.hasOwnProperty(t)&&(this._markerList[this._numMarkers]=this._markers[t],this._markerIndices[t]=this._numMarkers,this._numMarkers++);this._markerList.length=this._numMarkers}_buildPositions(){for(var t=0,e=0;e<this._numMarkers;e++)if(this._markerList[e]){const i=this._markerList[e].worldPos;this._positions[t++]=i[0],this._positions[t++]=i[1],this._positions[t++]=i[2],this._indices[e]=e}this._positions.length=3*this._numMarkers}_buildVBOs(){if(this._positionsBuf){if(this._lenPositionsBuf===this._positions.length)return void this._positionsBuf.setData(this._positions);this._positionsBuf.destroy(),this._positionsBuf=null,this._indicesBuf.destroy(),this._indicesBuf=null}const t=this._scene.canvas.gl,e=3*this._numMarkers,i=this._numMarkers;this._positionsBuf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._positions),e,3,t.STATIC_DRAW),this._indicesBuf=new j(t,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._indices),i,1,t.STATIC_DRAW),this._lenPositionsBuf=this._positions.length}_buildOcclusionTestList(){let t,e,i,s,r,o=0;const n=this._scene.canvas.boundary,a=n[2],l=n[3];for(this._lenOcclusionTestList=0,r=0;r<this._numMarkers;r++)i=(e=(t=this._markerList[r]).canvasPos)[0],s=e[1],i+10<0||s+10<0||i-10>a||s-10>l?t._setVisible(!1):!t.entity||t.entity.visible?t.occludable?(this._occlusionTestList[this._lenOcclusionTestList++]=t,this._pixels[o++]=i,this._pixels[o++]=s):t._setVisible(!0):t._setVisible(!1)}drawMarkers(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._sectionPlanesState,o=e.camera,n=o._state;if(s.bind(),r.sectionPlanes.length>0){const t=e._sectionPlanesState.sectionPlanes;let s,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(s=this._uSectionPlanes[a]).active,o=t[a],r&&i.uniform1i(r,o.active),(n=s.pos)&&i.uniform3fv(s.pos,o.pos),(h=s.dir)&&i.uniform3fv(s.dir,o.dir)}i.uniformMatrix4fv(this._uViewMatrix,!1,n.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.POINTS,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}doOcclusionTest(){if(!Y){const e=255*G[0],i=255*G[1],s=255*G[2];for(var t=0;t<this._lenOcclusionTestList;t++){const r=this._occlusionTestList[t],o=2*t,n=this._readPixelBuf.read(this._pixels[o],this._pixels[o+1]),a=n[0]===e&&n[1]===i&&n[2]===s;r._setVisible(a)}}}unbindRenderBuf(){Y||this._readPixelBuf.unbind()}destroy(){this._markers={},this._markerList.length=0,this._positionsBuf&&this._positionsBuf.destroy(),this._indicesBuf&&this._indicesBuf.destroy(),this._program&&this._program.destroy()}}const X=function(t,e){e=e||{};const i=new R,o=t.canvas.canvas,n=t.canvas.gl,a=!0===e.transparent,l=new s({});var h={},c={};let d=!0,u=!0,_=!0,p=!0,f=!0,g=null,m=null;function v(){d&&(!function(){for(var t in h)if(h.hasOwnProperty(t)){const s=h[t],r=s.drawableMap,o=s.drawableList;var e=0;for(var i in r)r.hasOwnProperty(i)&&(o[e++]=r[i]);o.length=e,s.lenDrawableList=e}}(),d=!1,u=!0),u&&(!function(){for(var t in h)if(h.hasOwnProperty(t)){const e=h[t];e.isStateSortable&&e.drawableList.sort(e.stateSortCompare)}}(),u=!1,_=!0)}this._occlusionTester=null,this.needStateSort=function(){u=!0},this.shadowsDirty=function(){p=!0},this.imageDirty=function(){_=!0},this.setBlendOneMinusSrcAlpha=function(t){f=t},this.webglContextLost=function(){},this.webglContextRestored=function(t){g&&g.webglContextRestored(t),m&&m.webglContextRestored(t),_=!0},this.addDrawable=function(t,e){var i=e.type;if(i){var s=h[i];s||(s={type:e.type,count:0,isStateSortable:e.isStateSortable,stateSortCompare:e.stateSortCompare,drawableMap:{},drawableList:[],lenDrawableList:0},h[i]=s),s.count++,s.drawableMap[t]=e,c[t]=e,d=!0}else console.error("Renderer#addDrawable() : drawable with ID "+t+" has no 'type' - ignoring")},this.removeDrawable=function(t){const e=c[t];if(!e)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+t+" - ignoring");const i=e.type,s=h[i];--s.count<=0?delete h[i]:delete s.drawableMap[t],delete c[t],d=!0},this.getPickID=function(t){return l.addItem(t)},this.putPickID=function(t){l.removeItem(t)},this.clear=function(e){e=e||{};const i=t.viewport.boundary;if(n.viewport(i[0],i[1],i[2],i[3]),a)n.clearColor(0,0,0,0);else{const i=e.ambientColor||t.canvas.backgroundColor||this.lights.getAmbientColor();n.clearColor(i[0],i[1],i[2],1)}n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)},this.render=function(t){t=t||{},v(),(_||t.force)&&(b(t),r.frame.frameCount++,_=!1)};var b=function(){const e=[],s=[],o=[],l=[],c=[],d=[],u=[],_=[],p=[],g=[],m=[],v=[],b=[],y=[],w=[],P=new B;return function(M){M.opaqueOnly;C.SUPPORTED_EXTENSIONS.OES_element_index_uint&&n.getExtension("OES_element_index_uint");const x=t._lightsState.getAmbientColor();i.reset(),i.pass=M.pass;const A=t.viewport.boundary;if(n.viewport(A[0],A[1],A[2],A[3]),a)n.clearColor(0,0,0,0);else{const e=t.canvas.backgroundColor||x;n.clearColor(e[0],e[1],e[2],1)}let E,L,k;n.enable(n.DEPTH_TEST),n.frontFace(n.CCW),n.enable(n.CULL_FACE),n.depthMask(!0),n.lineWidth(1),i.lineWidth=1;const D=Date.now();!1!==M.clear&&n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT);let S=0,R=0,B=0,T=0,F=0,I=0,N=0,O=0,V=0,z=0,U=0,j=0,Y=0,G=0,H=0;for(var K in h)if(h.hasOwnProperty(K)){const t=h[K].drawableList;for(E=0,L=t.length;E<L;E++)!0!==(k=t[E]).culled&&!1!==k.visible&&(k.getRenderFlags(P),P.normalFillOpaque&&k.drawNormalFillOpaque(i),P.normalEdgesOpaque&&(e[S++]=k),P.normalFillTransparent&&(s[R++]=k),P.normalEdgesTransparent&&(o[B++]=k),P.xrayedFillTransparent&&(d[I++]=k),P.xrayedFillOpaque&&(l[T++]=k),P.xrayedEdgesTransparent&&(u[N++]=k),P.xrayedEdgesOpaque&&(c[F++]=k),P.highlightedFillTransparent&&(g[z++]=k),P.highlightedFillOpaque&&(_[O++]=k),P.highlightedEdgesTransparent&&(m[U++]=k),P.highlightedEdgesOpaque&&(p[V++]=k),P.selectedFillTransparent&&(y[G++]=k),P.selectedFillOpaque&&(v[j++]=k),P.selectedEdgesTransparent&&(w[H++]=k),P.selectedEdgesOpaque&&(b[Y++]=k))}if(S>0)for(E=0;E<S;E++)e[E].drawNormalEdgesOpaque(i);if(T>0)for(E=0;E<T;E++)l[E].drawXRayedFillOpaque(i);if(F>0)for(E=0;E<F;E++)c[E].drawXRayedEdgesOpaque(i);if(I>0||N>0||R>0){if(n.enable(n.CULL_FACE),n.enable(n.BLEND),f?n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA):(n.blendEquation(n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,N>0)for(E=0;E<N;E++)u[E].drawXRayedEdgesTransparent(i);if(I>0)for(E=0;E<I;E++)d[E].drawXRayedFillTransparent(i);if(R>0)for(E=0;E<R;E++)(k=s[E]).drawNormalFillTransparent(i);if(B>0)for(E=0;E<B;E++)(k=o[E]).drawNormalEdgesTransparent(i);n.disable(n.BLEND)}if(O>0||V>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),V>0)for(E=0;E<V;E++)p[E].drawHighlightedEdgesOpaque(i);if(O>0)for(E=0;E<O;E++)_[E].drawHighlightedFillOpaque(i)}if(z>0||U>0||O>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.CULL_FACE),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),U>0)for(E=0;E<U;E++)m[E].drawHighlightedEdgesTransparent(i);if(z>0)for(E=0;E<z;E++)g[E].drawHighlightedFillTransparent(i);n.disable(n.BLEND)}if(j>0||Y>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),Y>0)for(E=0;E<Y;E++)b[E].drawSelectedEdgesOpaque(i);if(j>0)for(E=0;E<j;E++)v[E].drawSelectedFillOpaque(i)}if(G>0||H>0){if(i.lastProgramId=null,n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.CULL_FACE),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),H>0)for(E=0;E<H;E++)w[E].drawSelectedEdgesTransparent(i);if(G>0)for(E=0;E<G;E++)y[E].drawSelectedFillTransparent(i);n.disable(n.BLEND)}const X=Date.now(),W=r.frame;W.renderTime=(X-D)/1e3,W.drawElements=i.drawElements,W.drawElements=i.drawElements,W.useProgram=i.useProgram,W.bindTexture=i.bindTexture,W.bindArray=i.bindArray;const q=C.MAX_TEXTURE_UNITS;for(let t=0;t<q;t++)n.activeTexture(n.TEXTURE0+t);n.bindTexture(n.TEXTURE_CUBE_MAP,null),n.bindTexture(n.TEXTURE_2D,null)}}();this.pick=function(){const e=M.vec3(),s=M.mat4(),r=M.vec3([0,1,0]),a=M.frustumMat4(-1,1,-1,1,.1,1e4),c=new F;return function(d,u=c){let _,p,f,m,b;u.reset(),v(),C.SUPPORTED_EXTENSIONS.OES_element_index_uint&&n.getExtension("OES_element_index_uint");let w=null,P=null;u.pickSurface=d.pickSurface,d.canvasPos?(_=d.canvasPos[0],p=d.canvasPos[1],w=t.camera.viewMatrix,P=t.camera.projMatrix,u.canvasPos=d.canvasPos):(f=d.origin||M.vec3([0,0,0]),m=d.direction||M.vec3([0,0,1]),b=M.addVec3(f,m,e),w=M.lookAtMat4v(f,b,r,s),P=a,_=.5*o.clientWidth,p=.5*o.clientHeight,u.origin=f,u.direction=m),(g=g||new T(o,n)).bind();const x=function(e,s,r,o,a){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=o;const c=t.viewport.boundary;let d,u;n.viewport(c[0],c[1],c[2],c[3]),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const _=a.includeEntityIds,p=a.excludeEntityIds;for(var f in h)if(h.hasOwnProperty(f)){const t=h[f].drawableList;for(d=0,u=t.length;d<u;d++){const e=t[d];e.drawPickMesh&&!0!==e.culled&&!1!==e.visible&&!1!==e.pickable&&(_&&!_[e.id]||p&&p[e.id]||e.drawPickMesh(i))}}const m=g.read(Math.round(e),Math.round(s));let v=m[0]+256*m[1]+256*m[2]*256+256*m[3]*256*256;if(v<0)return;return l.items[v]}(_,p,w,P,d);return x?(d.pickSurface&&(x.canPickTriangle&&x.canPickTriangle()?(!function(e,s,r,o,a,l){if(!e.drawPickTriangles)return;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=o,i.pickProjMatrix=a;const h=t.viewport.boundary;n.viewport(h[0],h[1],h[2],h[3]),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),e.drawPickTriangles(i);const c=g.read(s,r);let d=c[0]+256*c[1]+256*c[2]*256+256*c[3]*256*256;d*=3,l.primIndex=d}(x,_,p,w,P,u),x.pickTriangleSurface(w,P,u)):x.canPickWorldPos&&x.canPickWorldPos()&&(y(x,_,p,w,P,u),function(e,s,r,o,a,l){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=o,i.pickProjMatrix=a;const h=t.viewport.boundary;n.viewport(h[0],h[1],h[2],h[3]),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),e.drawPickNormals(i);const c=g.read(Math.round(s),Math.round(r)),d=[c[0]/256-.5,c[1]/256-.5,c[2]/256-.5];M.normalizeVec3(d),l.worldNormal=d}(x,_,p,w,P,u))),g.unbind(),u.entity=x.delegatePickedEntity?x.delegatePickedEntity():x,u):(g.unbind(),null)}}();var y=function(){const e=M.vec4(),s=M.vec4(),r=M.vec4(),a=M.vec4(),l=M.vec4(),h=M.mat4(),c=M.mat4();return function(d,u,_,p,f,m){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=p,i.pickProjMatrix=f;const v=t.viewport.boundary;n.viewport(v[0],v[1],v[2],v[3]),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),d.drawPickDepths(i);const b=g.read(Math.round(u),Math.round(_)),y=(P=[(w=b)[0]/256,w[1]/256,w[2]/256,w[3]/256],M.dotVec4(P,[1/16777216,1/65536,1/256,1]));var w,P,x=(u-o.width/2)/(o.width/2),A=-(_-o.height/2)/(o.height/2),E=M.mulMat4(f,p,h),L=M.inverseMat4(E,c);e[0]=x,e[1]=A,e[2]=-1,e[3]=1;var C=M.transformVec4(L,e);C=M.mulVec4Scalar(C,1/C[3]),s[0]=x,s[1]=A,s[2]=1,s[3]=1;var k=M.transformVec4(L,s);k=M.mulVec4Scalar(k,1/k[3]);var D=M.subVec3(k,C,r),S=M.addVec3(C,M.mulVec4Scalar(D,y,a),l);m.worldPos=S}}();this.addMarker=function(e){this._occlusionTester=this._occlusionTester||new K(t),this._occlusionTester.addMarker(e)},this.markerWorldPosUpdated=function(t){this._occlusionTester.markerWorldPosUpdated(t)},this.removeMarker=function(t){this._occlusionTester.removeMarker(t)},this.doOcclusionTest=function(){if(this._occlusionTester){v(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0;const o=t.viewport.boundary;for(var e in n.viewport(o[0],o[1],o[2],o[3]),n.clearColor(0,0,0,0),n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),n.disable(n.BLEND),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(var s=0,r=t.length;s<r;s++){const e=t[s];e.drawOcclusion&&!0!==e.culled&&!1!==e.visible&&!1!==e.pickable&&e.drawOcclusion(i)}}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(t,e,i,s){let r,a,l,h;for((m=m||(m=new T(o,n))).bind(),m.clear(),this.render({force:!0,opaqueOnly:s}),a=0;a<i;a++)l=2*a,h=4*a,r=m.read(t[l],t[l+1]),e[h]=r[0],e[h+1]=r[1],e[h+2]=r[2],e[h+3]=r[3];m.unbind(),_=!0},this.destroy=function(){h={},c={},g&&g.destroy(),m&&m.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class W extends x{get type(){return"Input"}constructor(t,e={}){super(t,e);const i=this;this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this._element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(t){i.enabled&&("INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.ctrlKey?i.ctrlDown=!0:t.altKey?i.altDown=!0:(i.keyDown[t.keyCode]=!0,i.fire("keydown",t.keyCode,!0))),i.mouseover&&t.preventDefault())},!1),document.addEventListener("keyup",this._keyUpListener=function(t){i.enabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.ctrlKey?i.ctrlDown=!1:t.altKey?i.altDown=!1:(i.keyDown[t.keyCode]=!1,i.fire("keyup",t.keyCode,!0)))}),e.element.addEventListener("mouseenter",this._mouseEnterListener=function(t){if(!i.enabled)return;i.mouseover=!0;const e=i._getClickCoordsWithinElement(t);i.fire("mouseenter",e,!0)}),e.element.addEventListener("mouseleave",this._mouseLeaveListener=function(t){if(!i.enabled)return;i.mouseover=!1;const e=i._getClickCoordsWithinElement(t);i.fire("mouseleave",e,!0)}),e.element.addEventListener("mousedown",this._mouseDownListener=function(t){if(!i.enabled)return;switch(t.which){case 1:i.mouseDownLeft=!0;break;case 2:i.mouseDownMiddle=!0;break;case 3:i.mouseDownRight=!0}const s=i._getClickCoordsWithinElement(t);e.element.focus(),i.fire("mousedown",s,!0),i.mouseover&&t.preventDefault()}),document.addEventListener("mouseup",this._mouseUpListener=function(t){if(!i.enabled)return;switch(t.which){case 1:i.mouseDownLeft=!1;break;case 2:i.mouseDownMiddle=!1;break;case 3:i.mouseDownRight=!1}const e=i._getClickCoordsWithinElement(t);i.fire("mouseup",e,!0),i.mouseover&&t.preventDefault()},!0),document.addEventListener("dblclick",this._dblClickListener=function(t){if(!i.enabled)return;switch(t.which){case 1:i.mouseDownLeft=!1,i.mouseDownRight=!1;break;case 2:i.mouseDownMiddle=!1;break;case 3:i.mouseDownLeft=!1,i.mouseDownRight=!1}const e=i._getClickCoordsWithinElement(t);i.fire("dblclick",e,!0),i.mouseover&&t.preventDefault()}),e.element.addEventListener("mousemove",this._mouseMoveListener=function(t){if(!i.enabled)return;const e=i._getClickCoordsWithinElement(t);i.fire("mousemove",e,!0),i.mouseover&&t.preventDefault()}),e.element.addEventListener("wheel",this._mouseWheelListener=function(t,e){if(!i.enabled)return;const s=Math.max(-1,Math.min(1,40*-t.deltaY));i.fire("mousewheel",s,!0)},{passive:!0}),function(){let t,e;i.on("mousedown",function(i){t=i[0],e=i[1]}),i.on("mouseup",function(s){t>=s[0]-2&&t<=s[0]+2&&e>=s[1]-2&&e<=s[1]+2&&i.fire("mouseclicked",s,!0)})}(),function(){const t={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0};let e,s;const r=M.vec3(),o=M.vec3(),n={orientation:null,orientationAngle:0},a={orientationAngle:0,acceleration:null,accelerationIncludingGravity:o,rotationRate:M.vec3(),interval:0},l={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",i._orientationchangedListener=function(){e=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=e&&t[e]||0,n.orientation=e,n.orientationAngle=s,i.fire("orientationchange",n)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",i._deviceMotionListener=function(t){a.interval=t.interval,a.orientationAngle=s;const e=t.acceleration;e?(r[0]=e.x,r[1]=e.y,r[2]=e.z,a.acceleration=r):a.acceleration=null;const n=t.accelerationIncludingGravity;n?(o[0]=n.x,o[1]=n.y,o[2]=n.z,a.accelerationIncludingGravity=o):a.accelerationIncludingGravity=null,a.rotationRate=t.rotationRate,i.fire("devicemotion",a)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",i._deviceOrientListener=function(t){l.gamma=t.gamma,l.beta=t.beta,l.alpha=t.alpha,l.absolute=t.absolute,i.fire("deviceorientation",l)},!1)}()}_getClickCoordsWithinElement(t){const e=[0,0];if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e.x=t.x,e.y=t.y;return e}setEnabled(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)}destroy(){super.destroy(),document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this._element.removeEventListener("mouseenter",this._mouseEnterListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("dblclick",this._dblClickListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener)}}const q=new s({});class Z{constructor(t){this.id=q.addItem({});for(const e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}destroy(){q.removeItem(this.id)}}class $ extends x{get type(){return"Viewport"}constructor(t,e={}){super(t,e),this._state=new Z({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary}set boundary(t){if(!this._autoBoundary){if(!t){const e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(t){const e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.glRedraw(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Q extends x{get type(){return"Perspective"}constructor(t,e={}){super(t,e),this._state=new Z({matrix:M.mat4(),near:.1,far:1e4}),this._dirty=!1,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far}_update(){const t=this.scene.viewport.boundary,e=t[2]/t[3];let i=this._fov;const s=this._fovAxis;("x"===s||"min"===s&&e<1||"max"===s&&e>1)&&(i/=e),i=Math.min(i,120),M.perspectiveMat4(i*(Math.PI/180),e,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(t){this._fov=null!=t?t:60,this._needUpdate(0),this.fire("fov",this._fov)}get fov(){return this._fov}set fovAxis(t){t=t||"min",this._fovAxis!==t&&("x"!==t&&"y"!==t&&"min"!==t&&(this.error("Unsupported value for 'fovAxis': "+t+" - defaulting to 'min'"),t="min"),this._fovAxis=t,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(t){this._state.near=null!=t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=null!=t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy(),this.scene.canvas.off(this._canvasResized)}}class J extends x{get type(){return"Ortho"}constructor(t,e={}){super(t,e),this._state=new Z({matrix:M.mat4(),near:.1,far:1e4}),this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const t=this.scene,e=.5*this._scale,i=t.viewport.boundary,s=i[2],r=i[3],o=s/r;let n,a,l,h;s>r?(n=-e,a=e,l=e/o,h=-e/o):(n=-e*o,a=e*o,l=e,h=-e),M.orthoMat4c(n,a,h,l,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(t){null==t&&(t=1),t<=0&&(t=.01),this._scale=t,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(t){this._state.near=null!=t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=null!=t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class tt extends x{get type(){return"Frustum"}constructor(t,e={}){super(t,e),this._state=new Z({matrix:M.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far}_update(){M.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(t){this._left=null!=t?t:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(t){this._right=null!=t?t:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(t){this._top=null!=t?t:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(t){this._bottom=null!=t?t:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(t){this._state.near=null!=t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=null!=t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class et extends x{get type(){return"CustomProjection"}constructor(t,e={}){super(t,e),this._state=new Z({matrix:M.mat4()}),this.matrix=e.matrix}set matrix(t){this._state.matrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.glRedraw(),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}destroy(){super.destroy(),this._state.destroy()}}const it=M.vec3(),st=M.vec3(),rt=M.vec3(),ot=M.vec3(),nt=M.vec3(),at=M.vec3(),lt=M.mat4(),ht=M.mat4(),ct=M.vec3(),dt=M.vec3(),ut=M.vec3(),_t=M.vec3();class pt extends x{get type(){return"Camera"}constructor(t,e={}){super(t,e),this._state=new Z({deviceMatrix:M.mat4(),hasDeviceMatrix:!1,matrix:M.mat4(),normalMatrix:M.mat4()}),this._perspective=new Q(this),this._ortho=new J(this),this._frustum=new tt(this),this._customProjection=new et(this),this._project=this._perspective,this._eye=M.vec3([0,0,10]),this._look=M.vec3([0,0,0]),this._up=M.vec3([0,1,0]),this._worldUp=M.vec3([0,1,0]),this._worldRight=M.vec3([1,0,0]),this._worldForward=M.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const t=this._state;let e;"ortho"===this.projection?(M.subVec3(this._eye,this._look,ct),M.normalizeVec3(ct,dt),M.mulVec3Scalar(dt,1e3,ut),M.addVec3(this._look,ut,_t),e=_t):e=this._eye,t.hasDeviceMatrix?(M.lookAtMat4v(e,this._look,this._up,ht),M.mulMat4(t.deviceMatrix,ht,t.matrix)):M.lookAtMat4v(e,this._look,this._up,t.matrix),M.inverseMat4(this._state.matrix,this._state.normalMatrix),M.transposeMat4(this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(t){let e=M.subVec3(this._eye,this._look,it);M.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,lt),e=M.transformPoint3(lt,e,st),this.eye=M.addVec3(this._look,e,rt),this.up=M.transformPoint3(lt,this._up,ot)}orbitPitch(t){if(this._constrainPitch&&(t=M.dotVec3(this._up,this._worldUp)/M.DEGTORAD)<1)return;let e=M.subVec3(this._eye,this._look,it);const i=M.cross3Vec3(M.normalizeVec3(e,st),M.normalizeVec3(this._up,rt));M.rotationMat4v(.0174532925*t,i,lt),e=M.transformPoint3(lt,e,ot),this.up=M.transformPoint3(lt,this._up,nt),this.eye=M.addVec3(e,this._look,at)}yaw(t){let e=M.subVec3(this._look,this._eye,it);M.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,lt),e=M.transformPoint3(lt,e,st),this.look=M.addVec3(e,this._eye,rt),this._gimbalLock&&(this.up=M.transformPoint3(lt,this._up,ot))}pitch(t){if(this._constrainPitch&&(t=M.dotVec3(this._up,this._worldUp)/M.DEGTORAD)<1)return;let e=M.subVec3(this._look,this._eye,it);const i=M.cross3Vec3(M.normalizeVec3(e,st),M.normalizeVec3(this._up,rt));M.rotationMat4v(.0174532925*t,i,lt),this.up=M.transformPoint3(lt,this._up,at),e=M.transformPoint3(lt,e,ot),this.look=M.addVec3(e,this._eye,nt)}pan(t){const e=M.subVec3(this._eye,this._look,it),i=[0,0,0];let s;if(0!==t[0]){const r=M.cross3Vec3(M.normalizeVec3(e,[]),M.normalizeVec3(this._up,st));s=M.mulVec3Scalar(r,t[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==t[1]&&(s=M.mulVec3Scalar(M.normalizeVec3(this._up,rt),t[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==t[2]&&(s=M.mulVec3Scalar(M.normalizeVec3(e,ot),t[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=M.addVec3(this._eye,i,nt),this.look=M.addVec3(this._look,i,at)}zoom(t){const e=M.subVec3(this._eye,this._look,it),i=Math.abs(M.lenVec3(e,st)),s=Math.abs(i+t);if(s<.5)return;const r=M.normalizeVec3(e,rt);this.eye=M.addVec3(this._look,M.mulVec3Scalar(r,s),ot)}set eye(t){this._eye.set(t||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(t){this._look.set(t||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(t){this._up.set(t||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(t){this._state.deviceMatrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!t,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(t){t=t||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(t):this._worldAxis=new Float32Array(t),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(t){this._gimbalLock=!1!==t,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(t){this._constrainPitch=!!t,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return M.lenVec3(M.subVec3(this._look,this._eye,it))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(t){t=t||"perspective",this._projectionType!==t&&("perspective"===t?this._project=this._perspective:"ortho"===t?this._project=this._ortho:"frustum"===t?this._project=this._frustum:"customProjection"===t?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+t+" defaulting to 'perspective'"),this._project=this._perspective,t="perspective"),this._project._update(),this._projectionType=t,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}class ft extends x{get type(){return"Light"}get isLight(){return!0}constructor(t,e={}){super(t,e)}}class gt extends ft{get type(){return"DirLight"}constructor(t,e={}){super(t,e);const i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new Z({type:"dir",dir:M.vec3([1,1,1]),color:M.vec3([.7,.7,.8]),intensity:1,space:e.space||"view",castsShadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){M.vec3();const t=M.vec3([0,1,0]);return function(){if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=M.identityMat4());const e=i._state.dir;M.lookAtMat4v([-e[0],-e[1],-e[2]],[0,0,0],t,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix}}(),getShadowProjMatrix:function(){return i._shadowProjMatrixDirty&&(i._shadowProjMatrix||(i._shadowProjMatrix=M.identityMat4()),M.orthoMat4c(-10,10,-10,10,0,500,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1),i._shadowProjMatrix},getShadowRenderBuf:function(){return i._shadowRenderBuf||(i._shadowRenderBuf=new T(i.scene.canvas.canvas,i.scene.canvas.gl,{size:[1024,1024]})),i._shadowRenderBuf}}),this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.castsShadow=e.castsShadow,this.scene._lightCreated(this)}set dir(t){this._state.dir.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class mt extends ft{get type(){return"AmbientLight"}constructor(t,e={}){super(t,e),this._state={type:"ambient",color:M.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){this._state.intensity=void 0!==t?t:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy()}}class vt extends x{get type(){return"Geometry"}get isGeometry(){return!0}constructor(t,e={}){super(t,e),r.memory.meshes++}destroy(){super.destroy(),r.memory.meshes--}}var bt=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),h=M.vec3(),c=M.vec3(),d=M.vec3(),u=M.vec3(),_=M.vec3(),p=M.vec3(),f=M.vec3();return function(g,m,v,b){!function(r,o){const n={};let a,l,h,c;const d=Math.pow(10,4);let u,_,p=0;for(u=0,_=r.length;u<_;u+=3)a=r[u],l=r[u+1],h=r[u+2],void 0===n[c=Math.round(a*d)+"_"+Math.round(l*d)+"_"+Math.round(h*d)]&&(n[c]=p/3,t[p++]=a,t[p++]=l,t[p++]=h),e[u/3]=n[c];for(u=0,_=o.length;u<_;u++)s[u]=e[o[u]],i[s[u]]=o[u]}(g,m),function(e,i){o=0;for(let g=0,m=e;g<m;g+=3){const e=3*s[g],m=3*s[g+1],v=3*s[g+2];i?(n[0]=t[e],n[1]=t[e+1],n[2]=t[e+2],a[0]=t[m],a[1]=t[m+1],a[2]=t[m+2],l[0]=t[v],l[1]=t[v+1],l[2]=t[v+2],M.decompressPosition(n,i,h),M.decompressPosition(a,i,c),M.decompressPosition(l,i,d)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],c[0]=t[m],c[1]=t[m+1],c[2]=t[m+2],d[0]=t[v],d[1]=t[v+1],d[2]=t[v+2]),M.subVec3(d,c,u),M.subVec3(h,c,_),M.cross3Vec3(u,_,p),M.normalizeVec3(p,f);const b=r[o]||(r[o]={normal:M.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],o++}}(m.length,v);const y=[],w=Math.cos(M.DEGTORAD*b),P={};let x,A,E,L,C,k,D,S,R,B,T,F=!1;for(let t=0,e=m.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)x=s[t+i],A=s[t+(i+1)%3],void 0===P[C=(E=Math.min(x,A))+","+(L=Math.max(x,A))]?P[C]={index1:E,index2:L,face1:e,face2:void 0}:P[C].face2=e}for(C in P)void 0!==(k=P[C]).face2&&(D=r[k.face1].normal,S=r[k.face2].normal,(R=M.dotVec3(D,S))>w)||(B=i[k.index1],T=i[k.index2],(!F&&B>65535||T>65535)&&(F=!0),y.push(B),y.push(T));return F?new Uint32Array(y):new Uint16Array(y)}}();function yt(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1);r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function wt(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function Pt(t,e,i){return t[e]*i[0]+t[e+1]*i[1]+t[e+2]*i[2]}const Mt={getPositionsBounds:function(t){const e=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=3)for(r=0;r<3;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},compressPositions:function(){const t=M.mat4(),e=M.mat4();return function(i,s,r){const o=new Uint16Array(i.length);var n=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let a;for(a=0;a<i.length;a+=3)o[a+0]=Math.floor((i[a+0]-s[0])*n[0]),o[a+1]=Math.floor((i[a+1]-s[1])*n[1]),o[a+2]=Math.floor((i[a+2]-s[2])*n[2]);return M.identityMat4(t),M.translationMat4v(s,t),M.identityMat4(e),M.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],e),{quantized:o,decodeMatrix:M.mulMat4(t,e,M.identityMat4())}}}(),decompressPositions:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressPosition:function(t,e,i){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i},decompressAABB:function(t,e,i=t){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i[3]=t[3]*e[0]+e[12],i[4]=t[4]*e[5]+e[13],i[5]=t[5]*e[10]+e[14],i},getUVBounds:function(t){const e=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=2)for(r=0;r<2;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},compressUVs:function(){const t=M.mat3(),e=M.mat3();return function(i,s,r){const o=new Uint16Array(i.length),n=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let a;for(a=0;a<i.length;a+=2)o[a+0]=Math.floor((i[a+0]-s[0])*n[0]),o[a+1]=Math.floor((i[a+1]-s[1])*n[1]);return M.identityMat3(t),M.translationMat3v(s,t),M.identityMat3(e),M.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],e),{quantized:o,decodeMatrix:M.mulMat3(t,e,M.identityMat3())}}}(),decompressUVs:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},decompressUV:function(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},compressNormals:function(t){const e=new Int8Array(t.length);let i,s,r,o,n;for(let a=0;a<t.length;a+=3)r=i=yt(t,a,"floor","floor"),o=n=Pt(t,a,s=wt(i)),(o=Pt(t,a,s=wt(i=yt(t,a,"ceil","floor"))))>n&&(r=i,n=o),(o=Pt(t,a,s=wt(i=yt(t,a,"floor","ceil"))))>n&&(r=i,n=o),(o=Pt(t,a,s=wt(i=yt(t,a,"ceil","ceil"))))>n&&(r=i,n=o),e[a]=r[0],e[a+1]=r[1];return e},decompressNormals:function(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);e[s+0]=r/a,e[s+1]=o/a,e[s+2]=n/a,s+=3}return e},decompressNormal:function(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e}},xt=r.memory,At=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,Et=At?Uint32Array:Uint16Array,Lt=M.AABB3();class Ct extends vt{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(t,e={}){super(t,e),this._state=new Z({compressGeometry:!!e.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._edgeThreshold=e.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=e.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=e.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=e.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=e.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=e.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=e.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=e.primitive}if(e.positions)if(this._state.compressGeometry){const t=Mt.getPositionsBounds(e.positions),s=Mt.compressPositions(e.positions,t.min,t.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=e.positions.constructor===Float32Array?e.positions:new Float32Array(e.positions);if(e.colors&&(i.colors=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors)),e.uv)if(this._state.compressGeometry){const t=Mt.getUVBounds(e.uv),s=Mt.compressUVs(e.uv,t.min,t.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=e.uv.constructor===Float32Array?e.uv:new Float32Array(e.uv);if(e.normals&&(this._state.compressGeometry?i.normals=Mt.compressNormals(e.normals):i.normals=e.normals.constructor===Float32Array?e.normals:new Float32Array(e.normals)),e.indices){if(!At&&e.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");i.indices=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new Et(e.indices)}this._buildHash(),xt.meshes++,this._buildVBOs()}_buildVBOs(){const t=this._state,e=this.scene.canvas.gl;if(t.indices&&(t.indicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,t.indices,t.indices.length,1,e.STATIC_DRAW),xt.indices+=t.indicesBuf.numItems),t.positions&&(t.positionsBuf=new j(e,e.ARRAY_BUFFER,t.positions,t.positions.length,3,e.STATIC_DRAW),xt.positions+=t.positionsBuf.numItems),t.normals){let i=t.compressGeometry;t.normalsBuf=new j(e,e.ARRAY_BUFFER,t.normals,t.normals.length,3,e.STATIC_DRAW,i),xt.normals+=t.normalsBuf.numItems}t.colors&&(t.colorsBuf=new j(e,e.ARRAY_BUFFER,t.colors,t.colors.length,4,e.STATIC_DRAW),xt.colors+=t.colorsBuf.numItems),t.uv&&(t.uvBuf=new j(e,e.ARRAY_BUFFER,t.uv,t.uv.length,2,e.STATIC_DRAW),xt.uvs+=t.uvBuf.numItems)}_buildHash(){const t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positions&&e.push("p"),t.colors&&e.push("c"),(t.normals||t.autoVertexNormals)&&e.push("n"),t.uv&&e.push("u"),t.compressGeometry&&e.push("cp"),e.push(";"),t.hash=e.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=bt(t.positions,t.indices,t.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,i,i.length,1,e.STATIC_DRAW),xt.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=M.buildPickTriangles(t.positions,t.indices,t.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new j(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this._pickTriangleColorsBuf=new j(e,e.ARRAY_BUFFER,r,r.length,4,e.STATIC_DRAW,!0),xt.positions+=this._pickTrianglePositionsBuf.numItems,xt.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),Mt.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(t){const e=this._state,i=e.positions;if(i)if(i.length===t.length){if(this._state.compressGeometry){const i=Mt.getPositionsBounds(t),s=Mt.compressPositions(t,i.min,i.max);t=s.quantized,e.positionsDecodeMatrix=s.decodeMatrix}i.set(t),e.positionsBuf&&e.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const t=this._state.normals.length,e=t+t/2;this._decompressedNormals=new Float32Array(e),Mt.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(t){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const e=this._state,i=e.normals;i?i.length===t.length?(i.set(t),e.normalsBuf&&e.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),Mt.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(t){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const e=this._state,i=e.uv;i?i.length===t.length?(i.set(t),e.uvBuf&&e.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(t){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const e=this._state,i=e.colors;i?i.length===t.length?(i.set(t),e.colorsBuf&&e.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=M.AABB3()),M.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=M.OBB3()),M.positions3ToAABB3(this._state.positions,Lt,this._state.positionsDecodeMatrix),M.AABB3ToOBB3(Lt,this._obb),this._obbDirty=!1),this._obb}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const t=this._state;t.indicesBuf&&t.indicesBuf.destroy(),t.positionsBuf&&t.positionsBuf.destroy(),t.normalsBuf&&t.normalsBuf.destroy(),t.uvBuf&&t.uvBuf.destroy(),t.colorsBuf&&t.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),t.destroy(),xt.meshes--}}class kt extends x{get type(){return"Material"}constructor(t,e={}){super(t,e),r.memory.materials++}destroy(){super.destroy(),r.memory.materials--}}const Dt={opaque:0,mask:1,blend:2},St=["opaque","mask","blend"];class Rt extends kt{get type(){return"PhongMaterial"}constructor(t,e={}){super(t,e),this._state=new Z({type:"PhongMaterial",ambient:M.vec3([1,1,1]),diffuse:M.vec3([1,1,1]),specular:M.vec3([1,1,1]),emissive:M.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.alpha=e.alpha,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,e.ambientMap&&(this._ambientMap=this._checkComponent("Texture",e.ambientMap)),e.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",e.diffuseMap)),e.specularMap&&(this._specularMap=this._checkComponent("Texture",e.specularMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",e.reflectivityMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",e.diffuseFresnel)),e.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",e.specularFresnel)),e.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",e.emissiveFresnel)),e.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",e.alphaFresnel)),e.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",e.reflectivityFresnel)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this._makeHash()}_makeHash(){const t=this._state,e=["/p"];this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._ambientMap&&(e.push("/am"),this._ambientMap.hasMatrix&&e.push("/mat"),e.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat"),e.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),this._reflectivityMap&&(e.push("/rm"),this._reflectivityMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._diffuseFresnel&&e.push("/df"),this._specularFresnel&&e.push("/sf"),this._emissiveFresnel&&e.push("/ef"),this._alphaFresnel&&e.push("/of"),this._reflectivityFresnel&&e.push("/rf"),e.push(";"),t.hash=e.join("")}set ambient(t){let e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(t){let e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(t){let e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(t){this._state.shininess=void 0!==t?t:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(t){this._state.reflectivity=void 0!==t?t:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(t){let e=Dt[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" - defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return St[this._state.alphaMode]}set alphaCutoff(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const Bt={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Tt extends kt{get type(){return"EmphasisMaterial"}get presets(){return Bt}constructor(t,e={}){super(t,e),this._state=new Z({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,void 0!==e.fill&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),void 0!==e.fillAlpha&&(this.fillAlpha=e.fillAlpha),void 0!==e.edges&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth),void 0!==e.backfaces&&(this.backfaces=e.backfaces)):(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.backfaces=e.backfaces)}set fill(t){t=!1!==t,this._state.fill!==t&&(this._state.fill=t,this.glRedraw())}get fill(){return this._state.fill}set fillColor(t){let e=this._state.fillColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.fillColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.4,e[1]=.4,e[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(t){t=null!=t?t:.2,this._state.fillAlpha!==t&&(this._state.fillAlpha=t,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=null!=t?t:.5,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set preset(t){if(t=t||"default",this._preset===t)return;const e=Bt[t];e?(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Bt).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Ft={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class It extends kt{get type(){return"EdgeMaterial"}get presets(){return Ft}constructor(t,e={}){super(t,e),this._state=new Z({type:"EdgeMaterial",edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth)}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=null!=t?t:1,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=Ft[t];e?(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Ft).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}function Nt(t,e){const i={};let s,r;for(let o=0,n=e.length;o<n;o++)s=e[o],(r=t.component[s])?r.isEntity?i[s]=!0:t.warn("pick(): Component is not an Entity: "+s):t.warn("pick(): Component not found: "+s);return i}class Ot extends x{get type(){return"Scene"}constructor(t={}){if(super(null,t),!t.canvasId)throw"Mandatory config expected: canvasId";const e=document.getElementById(t.canvasId);if(!e)throw"Canvas not found: '"+t.canvasId+"'";const i=!!t.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this.visibleObjects={},this.xrayedObjects={},this.highlightedObjects={},this.selectedObjects={},this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.canvas=new S(this,{dontClear:!0,canvas:e,spinnerElementId:t.spinnerElementId,transparent:i,backgroundColor:t.backgroundColor,webgl2:!1!==t.webgl2,contextAttr:t.contextAttr||{},clearColorAmbient:t.clearColorAmbient}),this.canvas.on("boundary",()=>{this.glRedraw()}),this.canvas.on("webglContextFailed",()=>{alert("xeokit failed to find WebGL!")}),this._renderer=new X(this,{transparent:i}),this._sectionPlanesState=new function(){this.sectionPlanes=[];let t=null;this.getHash=function(){if(t)return t;const e=this.sectionPlanes;if(0===e.length)return this.hash=";";let i;const s=[];for(let t=0,r=e.length;t<r;t++)i=e[t],s.push("cp");return s.push(";"),t=s.join("")},this.addSectionPlane=function(e){this.sectionPlanes.push(e),t=null},this.removeSectionPlane=function(e){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===e.id)return this.sectionPlanes.splice(i,1),void(t=null)}},this._lightsState=new function(){const t=M.vec3([0,0,0]),e=M.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const t=[],e=this.lights;let s;for(let i=0,r=e.length;i<r;i++)s=e[i],t.push("/"),t.push(s.type),t.push("world"===s.space?"w":"v"),s.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join("")},this.addLight=function(t){this.lights.push(t),s=null,i=null},this.removeLight=function(t){for(let e=0,r=this.lights.length;e<r;e++){if(this.lights[e].id===t.id)return this.lights.splice(e,1),s&&s.id===t.id&&(s=null),void(i=null)}},this.addReflectionMap=function(t){this.reflectionMaps.push(t),i=null},this.removeReflectionMap=function(t){for(let e=0,s=this.reflectionMaps.length;e<s;e++)if(this.reflectionMaps[e].id===t.id)return this.reflectionMaps.splice(e,1),void(i=null)},this.addLightMap=function(t){this.lightMaps.push(t),i=null},this.removeLightMap=function(t){for(let e=0,s=this.lightMaps.length;e<s;e++)if(this.lightMaps[e].id===t.id)return this.lightMaps.splice(e,1),void(i=null)},this.getAmbientColor=function(){if(!s)for(let t=0,e=this.lights.length;t<e;t++){const e=this.lights[t];if("ambient"===e.type){s=e;break}}if(s){const t=s.color,i=s.intensity;return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}return t}},this.input=new W(this,{dontClear:!0,element:this.canvas.canvas}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,v._addScene(this),this._initDefaults(),this._viewport=new $(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new pt(this,{id:"default.camera",dontClear:!0}),new mt(this,{color:[.3,.3,.3],intensity:1}),new gt(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new gt(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new gt(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"}),this._camera.on("dirty",()=>{this._renderer.imageDirty()})}_initDefaults(){let t;t=this.geometry,t=this.material,t=this.xrayMaterial,t=this.edgeMaterial,t=this.selectedMaterial,t=this.highlightMaterial}_addComponent(t){if(t.id&&this.components[t.id]&&(this.error("Component "+a.inQuotes(t.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),t.id=null),!t.id)for(void 0===window.nextID&&(window.nextID=0),t.id="_"+window.nextID++;this.components[t.id];)t.id=M.createUUID();this.components[t.id]=t;const e=t.type;let i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.compile&&(this._compilables[t.id]=t),t.isDrawable&&(this._renderer.addDrawable(t.id,t),this._collidables[t.id]=t)}_removeComponent(t){var e=t.id,i=t.type;delete this.components[e];const s=this.types[i];s&&(delete s[e],a.isEmptyObject(s)&&delete this.types[i]),t.compile&&delete this._compilables[t.id],t.isDrawable&&(this._renderer.removeDrawable(t.id),delete this._collidables[t.id])}_sectionPlaneCreated(t){this.sectionPlanes[t.id]=t,this.scene._sectionPlanesState.addSectionPlane(t._state),this.scene.fire("sectionPlaneCreated",t,!0),this._needRecompile=!0}_lightCreated(t){this.lights[t.id]=t,this.scene._lightsState.addLight(t._state),this._needRecompile=!0}_lightMapCreated(t){this.lightMaps[t.id]=t,this.scene._lightsState.addLightMap(t._state),this._needRecompile=!0}_reflectionMapCreated(t){this.reflectionMaps[t.id]=t,this.scene._lightsState.addReflectionMap(t._state),this._needRecompile=!0}_sectionPlaneDestroyed(t){delete this.sectionPlanes[t.id],this.scene._sectionPlanesState.removeSectionPlane(t._state),this._needRecompile=!0}_lightDestroyed(t){delete this.lights[t.id],this.scene._lightsState.removeLight(t._state),this._needRecompile=!0}_lightMapDestroyed(t){delete this.lightMaps[t.id],this.scene._lightsState.removeLightMap(t._state),this._needRecompile=!0}_reflectionMapDestroyed(t){delete this.reflectionMaps[t.id],this.scene._lightsState.removeReflectionMap(t._state),this._needRecompile=!0}_registerModel(t){this.models[t.id]=t,this._modelIds=null}_deregisterModel(t){delete this.models[t.id],this._modelIds=null}_registerObject(t){this.objects[t.id]=t,this._objectIds=null}_deregisterObject(t){delete this.objects[t.id],this._objectIds=null}_objectVisibilityUpdated(t){t.visible?this.visibleObjects[t.id]=t:delete this.visibleObjects[t.id],this._visibleObjectIds=null}_objectXRayedUpdated(t){t.xrayed?this.xrayedObjects[t.id]=t:delete this.xrayedObjects[t.id],this._xrayedObjectIds=null}_objectHighlightedUpdated(t){t.highlighted?this.highlightedObjects[t.id]=t:delete this.highlightedObjects[t.id],this._highlightedObjectIds=null}_objectSelectedUpdated(t){t.selected?this.selectedObjects[t.id]=t:delete this.selectedObjects[t.id],this._selectedObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const t in this.components)if(this.components.hasOwnProperty(t)){const e=this.components[t];e._webglContextLost&&e._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const t=this.canvas.gl;for(const e in this.components)if(this.components.hasOwnProperty(e)){const i=this.components[e];i._webglContextRestored&&i._webglContextRestored(t)}this._renderer.webglContextRestored(t),this.canvas.spinner.processes--}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(t){t&&v.runTasks();const e={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,o;for(r=0;r<i;r++)e.pass=r,this.fire("rendering",e,!0),o=s||0===r,this._renderer.render({pass:r,clear:o,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()}_recompile(){for(const t in this._compilables)this._compilables.hasOwnProperty(t)&&this._compilables[t].compile()}_saveAmbientColor(){const t=this.canvas;if(t.transparent||t.backgroundImage||t.backgroundColor)this._lastAmbientColor=null;else{const e=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===e[0]&&this._lastAmbientColor[1]===e[1]&&this._lastAmbientColor[2]===e[2]&&this._lastAmbientColor[3]===e[3]||(t.backgroundColor=e,this._lastAmbientColor||(this._lastAmbientColor=M.vec4([0,0,0,1])),this._lastAmbientColor.set(e))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}set ticksPerRender(t){null==t?t=1:(!a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(t){null==t?t=20:(!a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+t+"' - should be an integer greater than zero."),t=20),t!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=t)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(t){null==t?t=1:(!a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this.glRedraw())}get passes(){return this._passes}set clearEachPass(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(t){(t=!1!==t)!==this._renderer.gammaInput&&(this._renderer.gammaInput=t,this._needRecompile=!0)}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(t){(t=!1!==t)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=t,this._needRecompile=!0)}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(t){(t=null==t?2.2:t)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=t,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||function(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=t.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=t.center,o=r?r[0]:0,n=r?r[1]:0,l=r?r[2]:0,h=-e+o,c=-i+n,d=-s+l,u=e+o,_=i+n,p=s+l;return a.apply(t,{positions:[u,_,p,h,_,p,h,c,p,u,c,p,u,_,p,u,c,p,u,c,d,u,_,d,u,_,p,u,_,d,h,_,d,h,_,p,h,_,p,h,_,d,h,c,d,h,c,p,h,c,d,u,c,d,u,c,p,h,c,p,u,c,d,h,c,d,h,_,d,u,_,d],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}(Ct)}get material(){return this.components["default.material"]||new Rt(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Tt(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Tt(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Tt(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new It(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=M.vec3());const t=this.aabb;this._center[0]=(t[0]+t[3])/2,this._center[1]=(t[1]+t[4])/2,this._center[2]=(t[2]+t[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=M.AABB3());let t,e=M.MAX_DOUBLE,i=M.MAX_DOUBLE,s=M.MAX_DOUBLE,r=-M.MAX_DOUBLE,o=-M.MAX_DOUBLE,n=-M.MAX_DOUBLE;const a=this._collidables;let l,h=!1;for(const c in a)if(a.hasOwnProperty(c)){if(!1===(l=a[c]).collidable)continue;(t=l.aabb)[0]<e&&(e=t[0]),t[1]<i&&(i=t[1]),t[2]<s&&(s=t[2]),t[3]>r&&(r=t[3]),t[4]>o&&(o=t[4]),t[5]>n&&(n=t[5]),h=!0}h||(e=-1,i=-1,s=-1,r=1,o=1,n=1),this._aabb[0]=e,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(t,e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(t=t||{}).pickSurface=t.pickSurface||t.rayPick,t.canvasPos||t.origin&&t.direction||this.warn("picking without canvasPos or ray origin and direction");const i=t.includeEntities||t.include;i&&(t.includeEntityIds=Nt(this,i));const s=t.excludeEntities||t.exclude;return s&&(t.excludeEntityIds=Nt(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(e=this._renderer.pick(t,e))?(e.entity.fire&&e.entity.fire("picked",e),e):void 0}clear(){var t;for(const e in this.components)this.components.hasOwnProperty(e)&&((t=this.components[e])._dontClear||t.destroy())}clearLights(){const t=Object.keys(this.lights);for(let e=0,i=t.length;e<i;e++)this.lights[t[e]].destroy()}clearClips(){const t=Object.keys(this.sectionPlanes);for(let e=0,i=t.length;e<i;e++)this.sectionPlanes[t[e]].destroy()}getAABB(t){if(void 0===t)return this.aabb;if(a.isString(t)){const e=this.objects[t];if(e&&e.aabb)return e.aabb;t=[t]}if(0===t.length)return this.aabb;let e,i=1e5,s=1e5,r=1e5,o=-1e5,n=-1e5,l=-1e5;if(this._withEntities(t,this.objects,t=>{if(t.collidable){const a=t.aabb;a[0]<i&&(i=a[0]),a[1]<s&&(s=a[1]),a[2]<r&&(r=a[2]),a[3]>o&&(o=a[3]),a[4]>n&&(n=a[4]),a[5]>l&&(l=a[5]),e=!0}}),e){const t=M.AABB3();return t[0]=i,t[1]=s,t[2]=r,t[3]=o,t[4]=n,t[5]=l,t}return this.aabb}setObjectsVisible(t,e){return this._withEntities(t,this.objects,t=>{const i=t.visible!==e;return t.visible=e,i})}setObjectsCollidable(t,e){return this._withEntities(t,this.objects,t=>{const i=t.collidable!==e;return t.collidable=e,i})}setObjectsCulled(t,e){return this._withEntities(t,this.objects,t=>{const i=t.culled!==e;return t.culled=e,i})}setObjectsSelected(t,e){return this._withEntities(t,this.objects,t=>{const i=t.selected!==e;return t.selected=e,i})}setObjectsHighlighted(t,e){return this._withEntities(t,this.objects,t=>{const i=t.highlighted!==e;return t.highlighted=e,i})}setObjectsXRayed(t,e){return this._withEntities(t,this.objects,t=>{const i=t.xrayed!==e;return t.xrayed=e,i})}setObjectsEdges(t,e){return this._withEntities(t,this.objects,t=>{const i=t.edges!==e;return t.edges=e,i})}setObjectsColorized(t,e){return this._withEntities(t,this.objects,t=>{t.colorize=e})}setObjectsOpacity(t,e){return this._withEntities(t,this.objects,t=>{const i=t.opacity!==e;return t.opacity=e,i})}setObjectsPickable(t,e){return this._withEntities(t,this.objects,t=>{const i=t.pickable!==e;return t.pickable=e,i})}_withEntities(t,e,i){a.isString(t)&&(t=[t]);let s=!1;for(let r=0,o=t.length;r<o;r++){let o=e[t[r]];o&&(s=i(o)||s)}return s}destroy(){super.destroy();for(const t in this.components)this.components.hasOwnProperty(t)&&this.components[t].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Vt=M.vec3(),zt=M.vec3(),Ut=M.vec3(),jt=M.vec3(),Yt=M.vec3();class Gt extends x{get type(){return"CameraFlightAnimation"}constructor(t,e={}){super(t,e),this._look1=M.vec3(),this._eye1=M.vec3(),this._up1=M.vec3(),this._look2=M.vec3(),this._eye2=M.vec3(),this._up2=M.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail}flyTo(t,e,i){t=t||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=e,this._callbackScope=i;const s=this.scene.camera,r=!!t.projection&&t.projection!==s.projection;let o,n,l,h,c;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=t.orthoScale||this._orthoScale1,t.aabb)o=t.aabb;else if(6===t.length)o=t;else if(t.eye&&t.look||t.up)n=t.eye,l=t.look,h=t.up;else if(t.eye)n=t.eye;else if(t.look)l=t.look;else{let s=t;if((a.isNumeric(s)||a.isString(s))&&(c=s,!(s=this.scene.components[c])))return this.error("Component not found: "+a.inQuotes(c)),void(e&&(i?e.call(i):e()));r||(o=s.aabb||this.scene.aabb)}const d=t.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const e=M.getAABB3Center(o);this._look2=d||e;const i=M.subVec3(this._eye1,this._look1,Vt),s=M.normalizeVec3(i),r=d?M.getAABB3DiagPoint(o,d):M.getAABB3Diag(o),n=t.fitFOV||this._fitFOV,a=Math.abs(r/Math.tan(n*M.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*a,this._eye2[1]=this._look2[1]+s[1]*a,this._eye2[2]=this._look2[2]+s[2]*a,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||l||h)&&(this._flyingEyeLookUp=!!n&&!!l&&!!h,this._flyingEye=!!n&&!l,this._flyingLook=!!l&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),l&&(this._look2[0]=l[0],this._look2[1]=l[1],this._look2[2]=l[2]),h&&(this._up2[0]=h[0],this._up2[1]=h[1],this._up2[2]=h[2]));r&&("ortho"===t.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),s.ortho.scale=this._orthoScale2,this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===t.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")),this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,v.scheduleTask(this._update,this)}jumpTo(t){this._jumpTo(t)}_jumpTo(t){this._flying&&this.stop();const e=this.scene.camera;var i,s,r,o,n;if(t.aabb)i=t.aabb;else if(6===t.length)i=t;else if(t.eye||t.look||t.up)r=t.eye,o=t.look,n=t.up;else{let e=t;if((a.isNumeric(e)||a.isString(e))&&(s=e,!(e=this.scene.components[s])))return void this.error("Component not found: "+a.inQuotes(s));i=e.aabb||this.scene.aabb}const l=t.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var h=l?M.getAABB3DiagPoint(i,l):M.getAABB3Diag(i);let s;o=l||M.getAABB3Center(i,o),this._trail?M.subVec3(e.look,o,Yt):M.subVec3(e.eye,e.look,Yt),M.normalizeVec3(Yt),s=(void 0!==t.fit?t.fit:this._fit)?Math.abs(h/Math.tan((t.fitFOV||this._fitFOV)*M.DEGTORAD)):M.lenVec3(M.subVec3(e.eye,e.look,Vt)),M.mulVec3Scalar(Yt,s),e.eye=M.addVec3(o,Yt,Vt),e.look=o,this.scene.camera.ortho.scale=1.1*h}else(r||o||n)&&(r&&(e.eye=r),o&&(e.look=o),n&&(e.up=n))}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const e=t>=1;t>1&&(t=1);const i=this.easing?Gt._ease(t,0,1,1):t,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(M.subVec3(s.eye,s.look,Yt),s.eye=M.lerpVec3(i,0,1,this._eye1,this._eye2,Ut),s.look=M.subVec3(Ut,Yt,zt)):this._flyingLook&&(s.look=M.lerpVec3(i,0,1,this._look1,this._look2,zt),s.up=M.lerpVec3(i,0,1,this._up1,this._up2,jt)):this._flyingEyeLookUp&&(s.eye=M.lerpVec3(i,0,1,this._eye1,this._eye2,Ut),s.look=M.lerpVec3(i,0,1,this._look1,this._look2,zt),s.up=M.lerpVec3(i,0,1,this._up1,this._up2,jt)),this._projection2){const e="ortho"===this._projection2?Gt._easeOutExpo(t,0,1,1):Gt._easeInCubic(t,0,1,1);s.customProjection.matrix=M.lerpMat4(e,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);e?this.stop():v.scheduleTask(this._update,this)}static _ease(t,e,i,s){return-i*(t/=s)*(t-2)+e}static _easeInCubic(t,e,i,s){return i*(t/=s)*t*t+e}static _easeOutExpo(t,e,i,s){return i*(1-Math.pow(2,-10*t/s))+e}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(t){this._duration=t?1e3*t:500,this.stop()}get duration(){return this._duration/1e3}set fit(t){this._fit=!1!==t}get fit(){return this._fit}set fitFOV(t){this._fitFOV=t||45}get fitFOV(){return this._fitFOV}set trail(t){this._trail=!!t}get trail(){return this._trail}}class Ht extends x{get type(){return"CameraControl"}constructor(t,e={}){super(t,e);const i=this;this._pivoter=new function(){const t=i.scene,e=t.camera,s=t.canvas,r=new Float32Array(3);let o,n=0,a=0,l=0,h=!1;const c=document.createElement("div");c.innerText=" ",c.style.color="#ffffff",c.style.position="absolute",c.style.width="25px",c.style.height="25px",c.style.left="0px",c.style.top="0px",c.style["border-radius"]="15px",c.style.border="2px solid #ffffff",c.style.background="black",c.style.visibility="hidden",c.style["box-shadow"]="5px 5px 15px 1px #000000",c.style["z-index"]=0,c.style["pointer-events"]="none",document.body.appendChild(c),function(){const i=M.vec4(),o=M.vec4(),n=M.vec2();let a=!0;e.on("viewMatrix",function(){a=!0}),e.on("projMatrix",function(){a=!0}),t.on("tick",function(){if(h&&a){M.transformPoint3(e.viewMatrix,r,i),i[3]=1,M.transformPoint4(e.projMatrix,i,o);const t=s.boundary;n[0]=Math.floor((1+o[0]/o[3])*t[2]/2),n[1]=Math.floor((1-o[1]/o[3])*t[3]/2);const l=s.canvas.getBoundingClientRect();c.style.left=Math.floor(l.left+n[0])-12+"px",c.style.top=Math.floor(l.top+n[1])-12+"px",c.style.visibility="visible",a=!1}})}(),this.startPivot=function(t){t&&r.set(t);let i=M.lookAtMat4v(e.eye,e.look,e.worldUp);(o=M.transformPoint3(i,r))[2]+=M.distVec3(e.eye,r),i=M.inverseMat4(i);const s=M.transformVec3(i,o),c=M.vec3();if(M.subVec3(e.eye,r,c),M.addVec3(c,s),1===e.worldUp[2]){const t=c[1];c[1]=c[2],c[2]=t}l=M.lenVec3(c),a=Math.acos(c[1]/l),n=Math.atan2(c[0],c[2]),h=!0},this.getPivoting=function(){return h},this.getPivotPos=function(){return r},this.continuePivot=function(t,i){if(!h)return;if(0===t&&0===i)return;1===e.worldUp[2]&&(s=-s);var s=-t;n+=.01*-s,a+=.01*-i,a=M.clamp(a,.001,Math.PI-.001);const d=[l*Math.sin(a)*Math.sin(n),l*Math.cos(a),l*Math.sin(a)*Math.cos(n)];if(1===e.worldUp[2]){const t=d[1];d[1]=d[2],d[2]=t}const u=M.lenVec3(M.subVec3(e.look,e.eye,M.vec3()));M.addVec3(d,r);let _=M.lookAtMat4v(d,r,e.worldUp);_=M.inverseMat4(_);const p=M.transformVec3(_,o);_[12]-=p[0],_[13]-=p[1],_[14]-=p[2];const f=[_[8],_[9],_[10]];e.eye=[_[12],_[13],_[14]],M.subVec3(e.eye,M.mulVec3Scalar(f,u),e.look),e.up=[_[4],_[5],_[6]],c.style.visibility="visible"},this.endPivot=function(){c.style.visibility="hidden",h=!1}},this._cameraFlight=new Gt(this,{duration:.5}),this.planView=e.planView,this.firstPerson=e.firstPerson,this.walking=e.walking,this.keyboardLayout=e.keyboardLayout,this.doublePickFlyTo=e.doublePickFlyTo,this.active=e.active,this.pivoting=e.pivoting,this.panToPointer=e.panToPointer,this.panToPivot=e.panToPivot,this.inertia=e.inertia,this.pointerEnabled=!0,this._initEvents()}set active(t){this._active=!1!==t}get active(){return this._active}set pivoting(t){this._pivoting=!!t}get pivoting(){return this._pivoting}set panToPointer(t){this._panToPointer=!!t,this._panToPointer&&(this._panToPivot=!1)}get panToPointer(){return this._panToPointer}set panToPivot(t){this._panToPivot=!!t,this._panToPivot&&(this._panToPointer=!1)}get panToPivot(){return this._panToPivot}set planView(t){this._planView=!!t}get planView(){return this._planView}set firstPerson(t){this._firstPerson=!!t}get firstPerson(){return this._firstPerson}set walking(t){this._walking=!!t}get walking(){return this._walking}set doublePickFlyTo(t){this._doublePickFlyTo=!1!==t}get doublePickFlyTo(){return this._doublePickFlyTo}set inertia(t){this._inertia=void 0===t?.5:t}get inertia(){return this._inertia}set pointerEnabled(t){this._pointerEnabled=!!t}get pointerEnabled(){return this._pointerEnabled}set keyboardLayout(t){this._keyboardLayout=t||"qwerty"}get keyboardLayout(){return this._keyboardLayout}_initEvents(){const t=this,e=this.scene,i=e.input,s=e.camera,r=this.scene.canvas.canvas;let o=!1;r.oncontextmenu=function(t){t.preventDefault()};const n=function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e},a=[0,0];let l,h,c=!1,d=!1,u=!1,_=!1;function p(){if(t._pointerEnabled&&(c||d)){if(u=!1,_=!1,h=d||t.hasSubs("hoverSurface")?e.pick({pickSurface:!0,canvasPos:a}):e.pick({canvasPos:a})){u=!0;const i=h.entity.id;l!==i&&(void 0!==l&&t.fire("hoverOut",{entity:e.components[l]}),t.fire("hoverEnter",h),l=i),t.fire("hover",h),h.worldPos&&(_=!0,t.fire("hoverSurface",h))}else void 0!==l&&(t.fire("hoverOut",{entity:e.components[l]}),l=void 0),t.fire("hoverOff",{canvasPos:a});c=!1,d=!1}}e.on("tick",p),function(){let a=0,l=0,c=0,u=0,f=0,g=0;const m=M.vec2();let v=!1,b=!1,y=!1,w=!1;const P={},x=function(){const t=new Float32Array(3);return function(){return M.lenVec3(M.subVec3(s.look,s.eye,t))}}(),A=function(){let t=!0;s.on("projMatrix",function(){t=!0});const e=M.mat4();return function(){return t&&M.inverseMat4(s.projMatrix,e),e}}(),E=function(){let t=!0;s.on("projMatrix",function(){t=!0});const e=M.mat4();return function(){return t&&M.transposeMat4(s.projMatrix,e),e}}(),L=function(){let t=!0;s.on("viewMatrix",function(){t=!0});const e=M.mat4();return function(){return t&&M.inverseMat4(s.viewMatrix,e),e}}(),C=function(){let t=!0,i=1;return e.on("boundary",function(){t=!0}),function(){return t&&(i=M.getAABB3Diag(e.aabb)),i}}(),k=function(){const t=M.vec4(),i=M.vec4(),r=M.vec4(),o=M.vec3();return function(n,a){const l=A(),h=L(),c=E(),d=c.subarray(8,12),u=c.subarray(12),_=[0,0,-C(),1];!function(i,s,r,o,n,a){const l=e.canvas.canvas,h=l.offsetWidth/2,c=l.offsetHeight/2;t[0]=(r[0]-h)/h,t[1]=(r[1]-c)/c,t[2]=o,t[3]=1,M.mulMat4v4(i,t,n),M.mulVec3Scalar(n,1/n[3]),n[3]=1,n[1]*=-1,M.mulMat4v4(s,n,a)}(l,h,n,M.dotVec4(_,d)/M.dotVec4(_,u),i,r),M.subVec3(r,s.eye,o),M.normalizeVec3(o);const p=o[0]*a,f=o[1]*a,g=o[2]*a,m=s.eye,v=s.look;s.eye=[m[0]+p,m[1]+f,m[2]+g],s.look=[v[0]+p,v[1]+f,v[2]+g]}}(),D=function(){const t=M.vec3();return function(e,i){M.subVec3(e,s.eye,t),M.normalizeVec3(t);const r=t[0]*i,o=t[1]*i,n=t[2]*i,a=s.eye,l=s.look;s.eye=[a[0]+r,a[1]+o,a[2]+n],s.look=[l[0]+r,l[1]+o,l[2]+n]}}();function S(){const t=e.aabb,i=t[3]-t[0],s=t[4]-t[1],r=t[5]-t[2];let o=i>s?i:s;return(o=r>o?r:o)/30}e.on("tick",function(){const e=t._inertia;if(Math.abs(a)<.001&&(a=0),Math.abs(l)<.001&&(l=0),0===l&&0===a||(t._pivoter.getPivoting()?t._pivoter.continuePivot(l,a):(0!==a&&(t._firstPerson?s.pitch(-a):s.orbitPitch(a)),0!==l&&(t._firstPerson?s.yaw(l):s.orbitYaw(l))),a*=e,l*=e),Math.abs(c)<.001&&(c=0),Math.abs(u)<.001&&(u=0),Math.abs(f)<.001&&(f=0),0!==c||0!==u||0!==f){const e=x()/80;if(t._walking){let t=s.eye[1];s.pan([c*e,u*e,f*e]);let i=s.eye;i[1]=t,s.eye=i}else s.pan([c*e,u*e,f*e])}if(c*=e,u*=e,f*=e,Math.abs(g)<.001&&(g=0),0!==g){if(t._firstPerson){let e;if(t._walking&&(e=s.eye[1]),v?k(m,2*-g):s.pan([0,0,g]),t._walking){let t=s.eye;t[1]=e,s.eye=t}}else t._panToPointer?(p(),_&&h.worldPos?D(h.worldPos,-g):s.zoom(g)):t._panToPivot?D(t._pivoter.getPivotPos(),-g):s.zoom(g),s.ortho.scale=s.ortho.scale+g;g*=e}}),document.addEventListener("keyDown",function(e){t._active&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(b=e.ctrlKey||17===e.keyCode||e.metaKey,y=e.altKey||18===e.keyCode,w=16===e.keyCode,P[e.keyCode]=!0)},!0),document.addEventListener("keyup",function(e){t._active&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&((e.ctrlKey||17===e.keyCode)&&(b=!1),(e.altKey||18===e.keyCode)&&(y=!1),16===e.keyCode&&(w=!1),P[e.keyCode]=!1)}),function(){let s,h,_,p,b,y=0,P=0,M=!1;r.addEventListener("mousedown",function(e){if(t._active&&t._pointerEnabled)switch(o=!0,e.which){case 1:_=!0,M=!0,y=0,P=0,n(e,m),s=m[0],h=m[1];break;case 2:p=!0;break;case 3:b=!0,M=!0,y=0,P=0,n(e,m),s=m[0],h=m[1]}}),r.addEventListener("mouseup",function(e){if(t._active&&t._pointerEnabled){switch(e.which){case 1:_=!1;break;case 2:p=!1;break;case 3:b=!1}M=!1,y=0,P=0}}),document.addEventListener("mouseup",function(e){if(t._active&&t._pointerEnabled){switch(e.which){case 1:_=!1;break;case 2:p=!1;break;case 3:b=!1}M=!1,y=0,P=0}}),r.addEventListener("mouseenter",function(){t._active&&t._pointerEnabled&&(o=!0,y=0,P=0)}),r.addEventListener("mouseleave",function(){t._active&&t._pointerEnabled&&(o=!1,y=0,P=0)}),r.addEventListener("mousemove",function(e){if(!t._active||!t._pointerEnabled)return;if(!o)return;if(n(e,m),v=!0,!M)return;const i=m[0],r=m[1];y+=.4*(i-s),P+=.4*(r-h),s=i,h=r}),e.on("tick",function(){if(!t._active||!t._pointerEnabled)return;if(0===Math.abs(y)&&0===Math.abs(P))return;w||b?(c=.4*y,u=.4*P):t._planView||(l=.4*-y,a=.4*P),y=0,P=0}),r.addEventListener("wheel",function(e){if(!t._active||!t._pointerEnabled)return;t._panToPointer&&(d=!0);const i=Math.max(-1,Math.min(1,40*-e.deltaY));if(0===i)return;const s=i/Math.abs(i);g=-s*S()*.8,e.preventDefault()}),e.on("tick",function(e){if(!t._active||!t._pointerEnabled)return;if(!o)return;const s=e.deltaTime;if(!t.ctrlDown&&!t.altDown){const t=i.keyDown[i.KEY_ADD],e=i.keyDown[i.KEY_SUBTRACT];(t||e)&&(e?g=s*S()*.02:t&&(g=-s*S()*.02))}}),e.on("tick",function(e){if(!t._active||!t._pointerEnabled)return;if(!o)return;const s=e.deltaTime;let r,n,a,l,h,d;"azerty"===t._keyboardLayout?(r=i.keyDown[i.KEY_Z],n=i.keyDown[i.KEY_S],a=i.keyDown[i.KEY_Q],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_W],d=i.keyDown[i.KEY_X]):(r=i.keyDown[i.KEY_W],n=i.keyDown[i.KEY_S],a=i.keyDown[i.KEY_A],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_Z],d=i.keyDown[i.KEY_X]),(r||n||a||l||h||d)&&(d?u+=.02*s:h&&(u+=.02*-s),l?c+=.02*-s:a&&(c+=.02*s),n?f=.02*s:r&&(f=.02*-s))})}(),function(){let e;const i=new Float32Array(2);let s=-1;const o=[];let n=0;const h=new Float32Array(2),d=new Float32Array(2),_=50,p=0;let f=p,m=Date.now();function v(t){const e=Date.now();return f===p?(f=t,!0):f===t?e-m>_:(f=t,m=e,!1)}r.addEventListener("touchstart",function(r){if(!t._active||!t._pointerEnabled)return;const a=r.touches,l=r.changedTouches;for(e=Date.now(),1===a.length&&1===l.length?(s=e,i[0]=a[0].pageX,i[1]=a[0].pageY):s=-1;o.length<a.length;)o.push(new Float32Array(2));for(let t=0,e=a.length;t<e;++t)o[t][0]=a[t].pageX,o[t][1]=a[t].pageY;f=p,n=a.length,r.stopPropagation()},{passive:!0}),r.addEventListener("touchmove",function(e){if(!t._active||!t._pointerEnabled)return;const i=e.touches;if(1===n){var s=i[0];if(v(1)){const t=s.pageX-o[0][0],e=s.pageY-o[0][1];a+=.3*e,l+=-(.3*t)}}else if(2===n){s=i[0];const t=i[1];M.subVec2([s.pageX,s.pageY],o[0],h),M.subVec2([t.pageX,t.pageY],o[1],d);const e=M.dotVec2(h,d)>0;if(e&&v(2)&&(M.subVec2([s.pageX,s.pageY],o[0],h),c+=.2*h[0],u+=.2*h[1]),!e&&v(4)){const e=M.distVec2([s.pageX,s.pageY],[t.pageX,t.pageY]),i=M.distVec2(o[0],o[1]);g=(i-e)*S()*.05}}for(let t=0;t<n;++t)o[t][0]=i[t].pageX,o[t][1]=i[t].pageY;e.stopPropagation()},{passive:!0})}(),e.on("tick",function(e){if(!t._active||!t._pointerEnabled)return;if(!o)return;if(t._planView)return;const s=e.deltaTime,r=i.keyDown[i.KEY_LEFT_ARROW],n=i.keyDown[i.KEY_RIGHT_ARROW],h=i.keyDown[i.KEY_UP_ARROW],c=i.keyDown[i.KEY_DOWN_ARROW];(r||n||h||c)&&(n?l+=.02*-s:r&&(l+=.02*s),c?a+=.02*s:h&&(a+=.02*-s))}),e.on("tick",function(e){if(!t._active||!t._pointerEnabled)return;if(!o)return;const s=e.deltaTime;let r,n;"azerty"===t._keyboardLayout?(r=i.keyDown[i.KEY_A],n=i.keyDown[i.KEY_E]):(r=i.keyDown[i.KEY_Q],n=i.keyDown[i.KEY_E]),(n||r)&&(r?l+=.02*s:n&&(l+=.02*-s))})}(),function(){let e,i,s,o;r.addEventListener("mousemove",function(e){t._active&&t._pointerEnabled&&(n(e,a),(t.hasSubs("hover")||t.hasSubs("hoverOut")||t.hasSubs("hoverOff")||t.hasSubs("hoverSurface"))&&(c=!0))}),r.addEventListener("mousedown",function(r){t._active&&t._pointerEnabled&&(e=r.clientX,i=r.clientY,s=a[0],o=a[1],d=t._pivoting,p(),t._pivoting&&(h?t._pivoter.startPivot(h.worldPos):t._pivoter.startPivot()))}),r.addEventListener("mouseup",function(r){let n,l=0;return function(r){if(t._active&&t._pointerEnabled&&(t._pivoter.endPivot(),!(Math.abs(r.clientX-e)>3||Math.abs(r.clientY-i)>3))){if(!(t._doublePickFlyTo||t.hasSubs("doublePicked")||t.hasSubs("doublePickedSurface")||t.hasSubs("doublePickedNothing")))return d=!!t.hasSubs("pickedSurface"),p(),void(h?(t.fire("picked",h),_&&t.fire("pickedSurface",h)):t.fire("pickedNothing"));1==++l?n=setTimeout(function(){c=t._doublePickFlyTo,d=c||!!t.hasSubs("pickedSurface"),a[0]=s,a[1]=o,p(),h?(t.fire("picked",h),_&&t.fire("pickedSurface",h)):t.fire("pickedNothing"),l=0},250):(clearTimeout(n),c=t._doublePickFlyTo,d=c&&!!t.hasSubs("doublePickedSurface"),p(),h?(t.fire("doublePicked",h),_&&t.fire("doublePickedSurface",h),t._doublePickFlyTo&&t._flyTo(h)):(t.fire("doublePickedNothing"),t._doublePickFlyTo&&t._flyTo()),l=0)}}}(),!1)}(),function(){let e;const i=[],s=new Float32Array(2);let o=-1,n=-1;r.addEventListener("touchstart",function(r){if(!t._active||!t._pointerEnabled)return;const n=r.touches,a=r.changedTouches;for(e=Date.now(),1===n.length&&1===a.length?(o=e,s[0]=n[0].pageX,s[1]=n[0].pageY):o=-1;i.length<n.length;)i.push(new Float32Array(2));for(let t=0,e=n.length;t<e;++t)i[t][0]=n[t].pageX,i[t][1]=n[t].pageY;i.length=n.length,r.stopPropagation()},{passive:!0}),r.addEventListener("touchend",function(e){if(!t._active||!t._pointerEnabled)return;const r=Date.now(),l=e.touches,u=e.changedTouches;0===l.length&&1===u.length&&o>-1&&r-o<150&&(n>-1&&o-n<325?(a[0]=Math.round(u[0].clientX),a[1]=Math.round(u[0].clientY),c=!0,d=!!t.hasSubs("pickedSurface"),p(),h?(t.fire("doublePicked",h),_&&t.fire("doublePickedSurface",h),t._doublePickFlyTo&&t._flyTo(h)):(t.fire("doublePickedNothing"),t._doublePickFlyTo&&t._flyTo()),n=-1):M.distVec2(i[0],s)<4&&(a[0]=Math.round(u[0].clientX),a[1]=Math.round(u[0].clientY),c=!0,d=!!t.hasSubs("pickedSurface"),p(),h?(t.fire("picked",h),_&&t.fire("pickedSurface",h)):t.fire("pickedNothing"),n=r),o=-1),i.length=l.length;for(let t=0,e=l.length;t<e;++t)i[t][0]=l[t].pageX,i[t][1]=l[t].pageY;e.stopPropagation()},{passive:!0})}(),function(){const i=M.vec3(),r=M.vec3(),n=M.vec3(),a=M.vec3(),l={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)};document.addEventListener("keydown",function(h){if(!t._active||!t._pointerEnabled)return;if(!o)return;const c=h.keyCode;if(49!==c&&50!==c&&51!==c&&52!==c&&53!==c&&54!==c)return;const d=e.aabb,u=M.getAABB3Diag(d);i[0]=d[0]+d[3]/2,i[1]=d[1]+d[4]/2,i[2]=d[2]+d[5]/2;const _=Math.abs(u/Math.tan(t._cameraFlight.fitFOV/2));switch(c){case 49:l.eye.set(M.mulVec3Scalar(s.worldRight,_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 50:l.eye.set(M.mulVec3Scalar(s.worldForward,_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 51:l.eye.set(M.mulVec3Scalar(s.worldRight,-_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 52:l.eye.set(M.mulVec3Scalar(s.worldForward,-_,r)),l.look.set(i),l.up.set(s.worldUp);break;case 53:l.eye.set(M.mulVec3Scalar(s.worldUp,_,r)),l.look.set(i),l.up.set(M.normalizeVec3(M.mulVec3Scalar(s.worldForward,1,n),a));break;case 54:l.eye.set(M.mulVec3Scalar(s.worldUp,-_,r)),l.look.set(i),l.up.set(M.normalizeVec3(M.mulVec3Scalar(s.worldForward,-1,n)));break;default:return}t._cameraFlight.duration>0?t._cameraFlight.flyTo(l):t._cameraFlight.jumpTo(l)})}()}_flyTo(t){let e;t&&t.worldPos&&(e=t.worldPos);const i=t?t.entity.aabb:this.scene.aabb;if(e){const t=this.scene.camera;M.subVec3(t.eye,t.look,[]);this._cameraFlight.flyTo({aabb:i})}else this._cameraFlight.flyTo({aabb:i})}destroy(){this.active=!1,super.destroy()}}class Kt{constructor(t,e,i,s,r){this.id=e,this.projectId=i,this.revisionId=s,this.metaScene=t,this.rootMetaObject=r}getJSON(){var t=[];return function e(i){var s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),t.push(s);var r=i.children;if(r)for(var o=0,n=r.length;o<n;o++)e(r[o])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:t}}}class Xt{constructor(t,e,i,s,r,o,n,a){this.metaModel=t,this.id=e,this.name=i,this.type=s,r&&(this.properties=r),null!=o&&(this.parent=o),null!=n&&(this.children=n),null!=a&&(this.external=a)}getObjectIDsInSubtree(){const t=[];return function e(i){if(!i)return;t.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this),t}getObjectIDsInSubtreeByType(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=t[i];const r=[];return function t(i){if(!i)return;e[i.type]&&r.push(i.id);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)t(s[o])}(this),r}getJSON(){var t={id:this.id,type:this.type,name:this.name};return this.parent&&(t.parent=this.parent.id),t}}class Wt{constructor(t,e){this.viewer=t,this.scene=e,this.metaModels={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}createMetaModel(t,e,i={}){const s=e.projectId||"none",r=e.revisionId||"none",o=e.metaObjects;const n=new Kt(this,t,s,r,null);this.metaModels[t]=n;for(let t=0,e=o.length;t<e;t++){const e=o[t],i=e.type;void 0;const s=e.id,r=e.name,a=e.properties,l=null,h=null,c=e.external,d=new Xt(n,s,r,i,a,l,h,c);this.metaObjects[s]=d,(this.metaObjectsByType[i]||(this.metaObjectsByType[i]={}))[s]=d,void 0===this._typeCounts[i]?this._typeCounts[i]=1:this._typeCounts[i]++}for(let t=0,e=o.length;t<e;t++){const e=o[t],i=e.id,s=this.metaObjects[i];if(s)if(void 0===e.parent||null===e.parent)n.rootMetaObject=s;else{let t=this.metaObjects[e.parent];s.parent=t,t.children=t.children||[],t.children.push(s)}}return n}destroyMetaModel(t){const e=this.metaModels[t];if(!e)return;const i=this.metaObjects,s=this.metaObjectsByType;let r=t=>{delete i[t.id];const e=s[t.type];e&&e[t.id]&&(delete e[t.id],0==--this._typeCounts[t.type]&&(delete this._typeCounts[t.type],delete s[t.type]));const o=t.children;if(o)for(let t=0,e=o.length;t<e;t++){const e=o[t];r(e)}};r(e.rootMetaObject),delete this.metaModels[t],this.fire("metaModelDestroyed",t)}getObjectIDsByType(t){const e=this.metaObjectsByType[t];return e?Object.keys(e):[]}getObjectIDsInSubtree(t){const e=[];return function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)t(s[r])}(this.metaObjects[t]),e}}class qt{constructor(t){this.language="en",this.scene=new Ot({viewer:this,canvasId:t.canvasId,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!0,clearColorAmbient:t.clearColorAmbient,ticksPerRender:1,ticksPerOcclusionTest:20}),this.metaScene=new Wt(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new Gt(this.scene,{duration:.5}),this.cameraControl=new Ht(this.scene,{doublePickFlyTo:!0}),this.plugins={},this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}log(t){console.log(`[xeokit viewer ${this.id}]: ${t}`)}error(t){console.error(`[xeokit viewer ${this.id}]: ${t}`)}addPlugin(t){this.plugins[t.id]&&this.error(`Plugin with this ID already installed: ${t.id}`),this.plugins[t.id]=t,this.log(`Installed plugin: ${t.id}`)}removePlugin(t){const e=this.plugins[t.id];e?e===t?(e.clear&&e.clear(),delete this.plugins[t.id],this.log(`Removed plugin: ${t.id}`)):this.error(`Can't remove plugin - a different plugin is installed with this ID: ${t.id}`):this.error(`Can't remove plugin - no plugin with this ID is installed: ${t.id}`)}sendToPlugins(t,e){const i=this.plugins;for(const s in i)i.hasOwnProperty(s)&&i[s].send(t,e)}clear(){this.sendToPlugins("clear")}resetView(){this.sendToPlugins("resetView")}getSnapshot(t={}){this.sendToPlugins("snapshotStarting"),this.scene.render();const e=this.scene.canvas._getSnapshot(t);return this.sendToPlugins("snapshotFinished"),e}destroy(){for(let t in this.plugins)this.plugins.hasOwnProperty(t)&&this.plugins[t].destroy();this.scene.destroy()}}const Zt=new Uint16Array([0,0,0,0]);class $t{constructor(t,e,i,s,r=null,o=0){this.model=t,this.object=null,this.parent=null,this.id=e,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=M.AABB3(),this._layer=r,this._portionId=o,this._color=[i[0],i[1],i[2],s]}_initFlags(t){this._layer.initFlags(this._portionId,t)}_setVisible(t){this._layer.setVisible(this._portionId,t)}_setColor(t,e){Zt[0]=Math.floor(this._color[0]/255*(t[0]/255)*255),Zt[1]=Math.floor(this._color[1]/255*(t[1]/255)*255),Zt[2]=Math.floor(this._color[2]/255*(t[2]/255)*255),Zt[3]=Math.floor(this._color[3]/255*(t[3]/255)*255),this._layer.setColor(this._portionId,Zt,e)}_setHighlighted(t){this._layer.setHighlighted(this._portionId,t)}_setXRayed(t){this._layer.setXRayed(this._portionId,t)}_setSelected(t){this._layer.setSelected(this._portionId,t)}_setEdges(t){this._layer.setEdges(this._portionId,t)}_setClippable(t){this._layer.setClippable(this._portionId,t)}_setCollidable(t){this._layer.setCollidable(this._portionId,t)}_setPickable(t){this._layer.setPickable(this._portionId,t)}canPickTriangle(){return!1}drawPickTriangles(t){}pickTriangleSurface(t){}canPickWorldPos(){return!0}drawPickDepths(t){this.model.drawPickDepths(t)}drawPickNormals(t){this.model.drawPickNormals(t)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const Qt={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096},Jt=new Float32Array([0,0,0]);class te{constructor(t,e,i,s,r,o){this._isObject=e,this.model=t,this.meshes=s;for(var n=0,a=this.meshes.length;n<a;n++){this.meshes[n].parent=this}this.id=i,this._flags=r,this._colorize=new Uint8Array([255,255,255,255]),this._aabb=o,this._isObject&&t.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._aabb}set visible(t){if(!!(this._flags&Qt.VISIBLE)!==t){this._flags=t?this._flags|Qt.VISIBLE:this._flags&~Qt.VISIBLE;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get visible(){return this._getFlag(Qt.VISIBLE)}_getFlag(t){return!!(this._flags&t)}set highlighted(t){if(!!(this._flags&Qt.HIGHLIGHTED)!==t){this._flags=t?this._flags|Qt.HIGHLIGHTED:this._flags&~Qt.HIGHLIGHTED;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(Qt.HIGHLIGHTED)}set xrayed(t){if(!!(this._flags&Qt.XRAYED)!==t){this._flags=t?this._flags|Qt.XRAYED:this._flags&~Qt.XRAYED;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(Qt.XRAYED)}set selected(t){if(!!(this._flags&Qt.SELECTED)!==t){this._flags=t?this._flags|Qt.SELECTED:this._flags&~Qt.SELECTED;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(Qt.SELECTED)}set edges(t){if(!!(this._flags&Qt.EDGES)!==t){this._flags=t?this._flags|Qt.EDGES:this._flags&~Qt.EDGES;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setEdges(this._flags);this.model.glRedraw()}}get edges(){return this._getFlag(Qt.EDGES)}set culled(t){}get culled(){return!1}set clippable(t){if(!!(this._flags&Qt.CLIPPABLE)!==t){this._flags=t?this._flags|Qt.CLIPPABLE:this._flags&~Qt.CLIPPABLE;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setClippable(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(Qt.CLIPPABLE)}set collidable(t){if(!!(this._flags&Qt.COLLIDABLE)!==t){this._flags=t?this._flags|Qt.COLLIDABLE:this._flags&~Qt.COLLIDABLE;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCollidable(this._flags)}}get collidable(){return this._getFlag(Qt.COLLIDABLE)}set pickable(t){if(!!(this._flags&Qt.PICKABLE)!==t){this._flags=t?this._flags|Qt.PICKABLE:this._flags&~Qt.PICKABLE;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setPickable(this._flags)}}get pickable(){return this._getFlag(Qt.PICKABLE)}set colorize(t){this._colorize[0]=Math.floor(255*t[0]),this._colorize[1]=Math.floor(255*t[1]),this._colorize[2]=Math.floor(255*t[2]);for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setColor(this._colorize,!1);this.model.glRedraw()}get colorize(){return Jt[0]=this._colorize[0]/255,Jt[1]=this._colorize[1]/255,Jt[2]=this._colorize[2]/255,Jt}set opacity(t){if(t<0?t=0:t>1&&(t=1),t=Math.floor(255*t),this._colorize[3]===t)return;this._colorize[3]=t;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setColor(this._colorize,!0);this.model.glRedraw()}get opacity(){return this._colorize[3]/255}set castsShadow(t){}get castsShadow(){return!1}set receivesShadow(t){}get receivesShadow(){return!1}_finalize(){const t=this.model.scene;this._isObject&&(this.visible&&t._objectVisibilityUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this));for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._initFlags(this._flags)}_destroy(){const t=this.model.scene;this._isObject&&(t._deregisterObject(this),this.visible&&t._objectVisibilityUpdated(this),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this));for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._destroy();t._aabbDirty=!0}}const ee=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,ie=!0,se=ie?ee?5e6:65530:5e6;class re{constructor(){this.slicing=ie,this.maxVerts=se,this.positions=new Float32Array(3*se),this.colors=new Uint8Array(4*se),this.quantizedPositions=new Uint16Array(3*se),this.normals=new Int8Array(3*se),this.pickColors=new Uint8Array(4*se),this.flags=new Uint8Array(4*se),this.flags2=new Uint8Array(4*se),this.indices=ee?new Uint32Array(6*se):new Uint16Array(6*se),this.edgeIndices=ee?new Uint32Array(6*se):new Uint16Array(6*se),this.lenPositions=0,this.lenColors=0,this.lenNormals=0,this.lenPickColors=0,this.lenFlags=0,this.lenIndices=0,this.lenEdgeIndices=0}}const oe=[];function ne(t){oe.push(t)}const ae={NORMAL_OPAQUE:0,NORMAL_TRANSPARENT:1,NORMAL_EDGES:2,HIGHLIGHTED:3,HIGHLIGHTED_EDGES:4,XRAYED:5,XRAYED_EDGES:6,SELECTED:7,SELECTED_EDGES:8},le=function(t){this.vertex=function(t){var e=t.model.scene;const i=e._sectionPlanesState,s=e._lightsState,r=i.sectionPlanes.length>0;let o,n,a;const l=[];for(l.push("// Batched geometry drawing vertex shader"),l.push("uniform int renderPass;"),l.push("attribute vec3 position;"),l.push("attribute vec3 normal;"),l.push("attribute vec4 color;"),l.push("attribute vec4 flags;"),l.push("attribute vec4 flags2;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),l.push("uniform mat4 positionsDecodeMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec4 lightAmbient;"),o=0,n=s.lights.length;o<n;o++)"ambient"!==(a=s.lights[o]).type&&(l.push("uniform vec4 lightColor"+o+";"),"dir"===a.type&&l.push("uniform vec3 lightDir"+o+";"),"point"===a.type&&l.push("uniform vec3 lightPos"+o+";"),"spot"===a.type&&(l.push("uniform vec3 lightPos"+o+";"),l.push("uniform vec3 lightDir"+o+";")));l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"),r&&(l.push("varying vec4 vWorldPosition;"),l.push("varying vec4 vFlags2;"));for(l.push("varying vec4 vColor;"),l.push("void main(void) {"),l.push("bool visible      = (float(flags.x) > 0.0);"),l.push("bool xrayed       = (float(flags.y) > 0.0);"),l.push("bool highlighted  = (float(flags.z) > 0.0);"),l.push("bool selected     = (float(flags.w) > 0.0);"),l.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),l.push(`if (\n    !visible ||  \n    (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${ae.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),l.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),l.push("} else {"),l.push("vec4 worldPosition = (positionsDecodeMatrix * vec4(position, 1.0)); "),l.push("vec4 viewPosition  = viewMatrix * worldPosition; "),l.push("vec4 worldNormal =  vec4(octDecode(normal.xy), 0.0); "),l.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),o=0,n=s.lights.length;o<n;o++)if("ambient"!==(a=s.lights[o]).type){if("dir"===a.type)"view"===a.space?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if("point"===a.type)"view"===a.space?l.push("viewLightDir = normalize(lightPos"+o+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else{if("spot"!==a.type)continue;"view"===a.space?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}l.push("vColor = colorize *  vec4(reflectedColor * ((lightAmbient.rgb * lightAmbient.a) + vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0)), float(color.a) / 255.0);"),r&&(l.push("vWorldPosition = worldPosition;"),l.push("vFlags2 = flags2;"));return l.push("gl_Position = projMatrix * viewPosition;"),l.push("}"),l.push("}"),l}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Batched geometry drawing fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = vColor;"),o.push("}"),o}(t)};const he=new s({}),ce=function(t,e){this.id=he.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new le(e),this._allocate(e)},de={},ue=new Float32Array([1,1,1,1]);function _e(t){return[t.canvas.canvas.id,"",t._lightsState.getHash(),t._sectionPlanesState.getHash()].join(";")}ce.get=function(t){const e=_e(t.model.scene);let i=de[e];if(!i){if((i=new ce(e,t)).errors)return console.log(i.errors.join("\n")),null;de[e]=i,r.memory.programs++}return i._useCount++,i},ce.prototype.getValid=function(){return this._hash===_e(this._scene)},ce.prototype.put=function(){0==--this._useCount&&(he.removeItem(this.id),this._program&&this._program.destroy(),delete de[this._hash],r.memory.programs--)},ce.prototype.webglContextRestored=function(){this._program=null},ce.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state;if(this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),o.uniform1i(this._uRenderPass,i),this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aNormal&&(this._aNormal.bindArrayBuffer(n.normalsBuf),t.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),t.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),t.bindArray++),n.indicesBuf.bind(),t.bindArray++,i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColorize,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColorize,e[0],e[1],e[2],i)}else o.uniform4fv(this._uColorize,ue);o.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),t.drawElements++},ce.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._lightsState,r=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uRenderPass=o.getLocation("renderPass"),this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uColorize=o.getLocation("colorize"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const n=s.lights;let a;for(let t=0,e=n.length;t<e;t++)switch((a=n[t]).type){case"ambient":this._uLightAmbient[t]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=o.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=o.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=o.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=o.getLocation("lightPos"+t),this._uLightDir[t]=o.getLocation("lightDir"+t),this._uLightAttenuation[t]=o.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let t=0,e=r.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+t),pos:o.getLocation("sectionPlanePos"+t),dir:o.getLocation("sectionPlaneDir"+t)});this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._aColor=o.getAttribute("color"),this._aFlags=o.getAttribute("flags"),this._aFlags2=o.getAttribute("flags2")},ce.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._lightsState,n=i._sectionPlanesState,a=o.lights;let l;r.bind(),t.useProgram++;const h=i.camera;s.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix);for(var c=0,d=a.length;c<d;c++)l=a[c],this._uLightAmbient[c]?s.uniform4f(this._uLightAmbient[c],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[c]&&s.uniform4f(this._uLightColor[c],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[c]&&(s.uniform3fv(this._uLightPos[c],l.pos),this._uLightAttenuation[c]&&s.uniform1f(this._uLightAttenuation[c],l.attenuation)),this._uLightDir[c]&&s.uniform3fv(this._uLightDir[c],l.dir));if(n.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,a;for(c=0,d=this._uSectionPlanes.length;c<d;c++)r=(e=this._uSectionPlanes[c]).active,o=t[c],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(a=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const pe=function(t){this.vertex=function(t){const e=t.model.scene,i=e._sectionPlanesState,s=(e._lightsState,i.sectionPlanes.length>0);const r=[];r.push("// Batched fill vertex shader"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform vec4 color;"),s&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;"));r.push("void main(void) {"),r.push("bool visible      = (float(flags.x) > 0.0);"),r.push("bool xrayed       = (float(flags.y) > 0.0);"),r.push("bool highlighted  = (float(flags.z) > 0.0);"),r.push("bool selected     = (float(flags.w) > 0.0);"),r.push("bool clippable    = (float(flags2.x) > 0.0);"),r.push("bool transparent  = (color.a < 1.0);"),r.push(`if (\n    !visible || \n    (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${ae.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;"));return r.push("gl_Position = projMatrix * viewPosition;"),r.push("}"),r.push("}"),r}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Batched fill fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = color;"),o.push("}"),o}(t)};const fe=new s({}),ge=function(t,e){this.id=fe.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new pe(e),this._allocate(e)},me={},ve=new Float32Array([1,1,1,1]);function be(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}ge.get=function(t){const e=be(t.model.scene);let i=me[e];if(!i){if((i=new ge(e,t)).errors)return console.log(i.errors.join("\n")),null;me[e]=i,r.memory.programs++}return i._useCount++,i},ge.prototype.getValid=function(){return this._hash===be(this._scene)},ge.prototype.put=function(){0==--this._useCount&&(fe.removeItem(this.id),this._program&&this._program.destroy(),delete me[this._hash],r.memory.programs--)},ge.prototype.webglContextRestored=function(){this._program=null},ge.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,s.worldMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),t.bindArray++),n.indicesBuf.bind(),t.bindArray++,i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.SELECTED){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else o.uniform4fv(this._uColor,ve);o.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),t.drawElements++}},ge.prototype._allocate=function(t){const e=t.model.scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},ge.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;r.bind(),t.useProgram++;const n=i.camera;if(s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const ye=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry edges drawing vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("uniform vec4 color;"),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = false;"),i.push("bool edges        = (float(flags2.y) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`if (\n    !visible || !edges ||\n    (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) ||\n    (renderPass == ${ae.NORMAL_TRANSPARENT} &&  (!transparent || xrayed || highlighted || selected)) ||\n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) ||\n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;"));return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Batched geometry edges drawing fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = color;"),o.push("}"),o}(t)};const we=new s({}),Pe=function(t,e){this.id=we.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new ye(e),this._allocate(e)},Me={};new Float32Array([1,1,1,1]);function xe(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Pe.get=function(t){const e=xe(t.model.scene);let i=Me[e];if(!i){if((i=new Pe(e,t)).errors)return console.log(i.errors.join("\n")),null;Me[e]=i,r.memory.programs++}return i._useCount++,i},Pe.prototype.getValid=function(){return this._hash===xe(this._scene)},Pe.prototype.put=function(){0==--this._useCount&&(we.removeItem(this.id),this._program&&this._program.destroy(),delete Me[this._hash],r.memory.programs--)},Pe.prototype.webglContextRestored=function(){this._program=null},Pe.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.SELECTED){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else{const t=r.edgeMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),o.uniform1i(this._uRenderPass,i),this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),t.bindArray++),n.edgeIndicesBuf.bind(),t.bindArray++,o.drawElements(o.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0),t.drawElements++}},Pe.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uColor=r.getLocation("color"),this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},Pe.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;r.bind(),t.useProgram++;const n=i.camera;if(s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};class Ae{constructor(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry picking vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}(t)}}const Ee=new s({}),Le=function(t,e){this.id=Ee.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new Ae(e),this._allocate(e)},Ce={};function ke(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Le.get=function(t){const e=ke(t.model.scene);let i=Ce[e];if(!i){if((i=new Le(e,t)).errors)return console.log(i.errors.join("\n")),null;Ce[e]=i,r.memory.programs++}return i._useCount++,i},Le.prototype.getValid=function(){return this._hash===ke(this._scene)},Le.prototype.put=function(){0==--this._useCount&&(Ee.removeItem(this.id),this._program&&this._program.destroy(),delete Ce[this._hash],r.memory.programs--)},Le.prototype.webglContextRestored=function(){this._program=null},Le.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene.canvas.gl,r=e._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),this._aPosition.bindArrayBuffer(r.positionsBuf),t.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(r.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),t.bindArray++),this._aPickColor&&(this._aPickColor.bindArrayBuffer(r.pickColorsBuf),t.bindArray++),r.indicesBuf.bind(),t.bindArray++,s.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),t.drawElements++},Le.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},Le.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState,n=i.camera;if(r.bind(),t.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix||n.project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};class De{constructor(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry depth vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),s.push("precision highp float;"),s.push("uniform float zNear;"),s.push("uniform float zFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float zNormalizedDepth = abs((zNear + vViewPosition.z) / (zFar - zNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}(t)}}const Se=new s({}),Re=function(t,e){this.id=Se.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new De(e),this._allocate(e)},Be={};function Te(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Re.get=function(t){const e=Te(t.model.scene);let i=Be[e];if(!i){if((i=new Re(e,t)).errors)return console.log(i.errors.join("\n")),null;Be[e]=i,r.memory.programs++}return i._useCount++,i},Re.prototype.getValid=function(){return this._hash===Te(this._scene)},Re.prototype.put=function(){0==--this._useCount&&(Se.removeItem(this.id),this._program&&this._program.destroy(),delete Be[this._hash],r.memory.programs--)},Re.prototype.webglContextRestored=function(){this._program=null},Re.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,n=s.camera.project._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.uniform1f(this._uZNear,n.near),r.uniform1f(this._uZFar,n.far),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),t.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),t.bindArray++),o.indicesBuf.bind(),t.bindArray++,r.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),t.drawElements++},Re.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._uZNear=r.getLocation("zNear"),this._uZFar=r.getLocation("zFar")},Re.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._sectionPlanesState;e.camera;if(s.bind(),t.useProgram++,r.sectionPlanes.length>0){const t=e._sectionPlanesState.sectionPlanes;let s,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(s=this._uSectionPlanes[o]).active,a=t[o],r&&i.uniform1i(r,a.active),(l=s.pos)&&i.uniform3fv(s.pos,a.pos),(h=s.dir)&&i.uniform3fv(s.dir,a.dir)}};class Fe{constructor(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry normals vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),s.push("precision highp float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}(t)}}const Ie=new s({}),Ne=function(t,e){this.id=Ie.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new Fe(e),this._allocate(e)},Oe={};function Ve(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Ne.get=function(t){const e=Ve(t.model.scene);let i=Oe[e];if(!i){if((i=new Ne(e,t)).errors)return console.log(i.errors.join("\n")),null;Oe[e]=i,r.memory.programs++}return i._useCount++,i},Ne.prototype.getValid=function(){return this._hash===Ve(this._scene)},Ne.prototype.put=function(){0==--this._useCount&&(Ie.removeItem(this.id),this._program&&this._program.destroy(),delete Oe[this._hash],r.memory.programs--)},Ne.prototype.webglContextRestored=function(){this._program=null},Ne.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene.canvas.gl,r=e._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(r.positionsBuf),t.bindArray++,this._aNormal&&(this._aNormal.bindArrayBuffer(r.normalsBuf),t.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(r.flagsBuf),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),t.bindArray++),r.indicesBuf.bind(),t.bindArray++,s.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),t.drawElements++},Ne.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},Ne.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;i.camera;if(r.bind(),t.useProgram++,o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,l,h;for(var n=0,a=this._uSectionPlanes.length;n<a;n++)r=(e=this._uSectionPlanes[n]).active,o=t[n],r&&s.uniform1i(r,o.active),(l=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};class ze{constructor(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched occlusion vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched occlusion fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}(t)}}const Ue=new s({}),je=function(t,e){this.id=Ue.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new ze(e),this._allocate(e)},Ye={};function Ge(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}je.get=function(t){const e=Ge(t.model.scene);let i=Ye[e];if(!i){if((i=new je(e,t)).errors)return console.log(i.errors.join("\n")),null;Ye[e]=i,r.memory.programs++}return i._useCount++,i},je.prototype.getValid=function(){return this._hash===Ge(this._scene)},je.prototype.put=function(){0==--this._useCount&&(Ue.removeItem(this.id),this._program&&this._program.destroy(),delete Ye[this._hash],r.memory.programs--)},je.prototype.webglContextRestored=function(){this._program=null},je.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,n=s.camera;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uViewMatrix,!1,i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(o.colorsBuf),this._aFlags.bindArrayBuffer(o.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(o.flags2Buf),o.indicesBuf.bind(),t.bindArray+=5,r.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),t.drawElements++},je.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},je.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._sectionPlanesState;if(s.bind(),t.useProgram++,r.sectionPlanes.length>0){const t=e._sectionPlanesState.sectionPlanes;let s,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(s=this._uSectionPlanes[o]).active,a=t[o],r&&i.uniform1i(r,a.active),(l=s.pos)&&i.uniform3fv(s.pos,a.pos),(h=s.dir)&&i.uniform3fv(s.dir,a.dir)}};const He=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ke=new Uint8Array(4*(He?5e6:65530)),Xe=M.mat4(),We=M.mat4(),qe=M.vec4([0,0,0,1]),Ze=M.vec4([0,0,0,1]);class $e{constructor(t,e){this.model=t,this._buffer=e.buffer;var i,s=e.primitive||"triangles";const r=t.scene.canvas.gl;switch(s){case"points":i=r.POINTS;break;case"lines":i=r.LINES;break;case"line-loop":i=r.LINE_LOOP;break;case"line-strip":i=r.LINE_STRIP;break;case"triangles":i=r.TRIANGLES;break;case"triangle-strip":i=r.TRIANGLE_STRIP;break;case"triangle-fan":i=r.TRIANGLE_FAN;break;default:throw`Unsupported value for 'primitive': '${s}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`}this._state=new Z({primitiveName:s,primitive:i,positionsBuf:null,normalsBuf:null,colorsbuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:M.mat4()}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._aabb=M.collapseAABB3(),this._portions=[],this._finalized=!1,this._preCompressed=!!e.preCompressed,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this.compileShaders()}canCreatePortion(t){if(this._finalized)throw"Already finalized";return(!this._finalized&&this._buffer.lenPositions+t)<3*this._buffer.maxVerts}createPortion(t,e,i,s,r,o,n,a,l,h){if(this._finalized)throw"Already finalized";const c=this._buffer,d=c.lenPositions/3,u=t.length/3,_=t.length;if(this._preCompressed)c.positions.set(t,c.lenPositions),c.lenPositions+=_,M.collapseAABB3(l),M.expandAABB3Points3(l,t),Mt.decompressAABB(l,this._positionsDecodeMatrix),M.expandAABB3(this._aabb,l);else{if(c.positions.set(t,c.lenPositions),a)for(let t=c.lenPositions,e=c.lenPositions+_;t<e;t+=3)qe[0]=c.positions[t+0],qe[1]=c.positions[t+1],qe[2]=c.positions[t+2],M.transformPoint4(a,qe,Ze),M.expandAABB3Point3(l,Ze),M.expandAABB3Point3(this._aabb,Ze),c.positions[t+0]=Ze[0],c.positions[t+1]=Ze[1],c.positions[t+2]=Ze[2];else for(let t=c.lenPositions,e=c.lenPositions+_;t<e;t+=3)qe[0]=c.positions[t+0],qe[1]=c.positions[t+1],qe[2]=c.positions[t+2],M.expandAABB3Point3(l,qe),M.expandAABB3Point3(this._aabb,qe);c.lenPositions+=_}if(e)if(this._preCompressed)c.normals.set(e,c.lenNormals),c.lenNormals+=e.length;else{var p=Xe;a?M.inverseMat4(M.transposeMat4(a,We),p):M.identityMat4(p,p),c.lenNormals=function(t,e,i,s,r){let o,n,a,l,h,c,d=new Float32Array([0,0,0,0]),u=new Float32Array([0,0,0,0]);for(c=0;c<i;c+=3)d[0]=e[c],d[1]=e[c+1],d[2]=e[c+2],M.transformVec3(t,d,u),M.normalizeVec3(u,u),a=o=Je(u,"floor","floor"),n=ti(o),l=h=ei(u,n),o=Je(u,"ceil","floor"),n=ti(o),(l=ei(u,n))>h&&(a=o,h=l),o=Je(u,"floor","ceil"),n=ti(o),(l=ei(u,n))>h&&(a=o,h=l),o=Je(u,"ceil","ceil"),n=ti(o),(l=ei(u,n))>h&&(a=o,h=l),s[r+c+0]=a[0],s[r+c+1]=a[1],s[r+c+2]=0;return r+=i}(p,e,e.length,c.normals,c.lenNormals)}if(void 0!==r){const t=4*u,e=r&Qt.VISIBLE?255:0,i=r&Qt.XRAYED?255:0,s=r&Qt.HIGHLIGHTED?255:0,o=r&Qt.SELECTED?255:0,n=r&Qt.CLIPPABLE?255:0,a=r&Qt.EDGES?255:0,l=r&Qt.PICKABLE?255:0;for(var f=c.lenFlags,g=c.lenFlags+t;f<g;f+=4)c.flags[f+0]=e,c.flags[f+1]=i,c.flags[f+2]=s,c.flags[f+3]=o,c.flags2[f+0]=n,c.flags2[f+1]=a,c.flags2[f+2]=l;c.lenFlags+=t,e&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),s&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),o&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),a&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),l&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++)}if(o){const t=4*u,e=o[0],i=o[1],s=o[2],r=n;for(f=c.lenColors,g=c.lenColors+t;f<g;f+=4)c.colors[f+0]=e,c.colors[f+1]=i,c.colors[f+2]=s,c.colors[f+3]=n;c.lenColors+=t,r<255&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++)}if(i){for(f=0,g=i.length;f<g;f++)c.indices[c.lenIndices+f]=i[f]+d;c.lenIndices+=i.length}if(s){for(f=0,g=s.length;f<g;f++)c.edgeIndices[c.lenEdgeIndices+f]=s[f]+d;c.lenEdgeIndices+=s.length}{const t=4*u;for(f=c.lenPickColors,g=c.lenPickColors+t;f<g;f+=4)c.pickColors[f+0]=h[0],c.pickColors[f+1]=h[1],c.pickColors[f+2]=h[2],c.pickColors[f+3]=h[3];c.lenPickColors+=t}var m=this._portions.length/2;return this._portions.push(d),this._portions.push(u),this._numPortions++,this.model.numPortions++,m}finalize(){if(this._finalized)return void this.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(this._preCompressed?(t.positionsDecodeMatrix=this._positionsDecodeMatrix,t.positionsBuf=new j(e,e.ARRAY_BUFFER,i.positions,i.lenPositions,3,e.STATIC_DRAW)):(Qe(i.positions,i.lenPositions,this._aabb,i.quantizedPositions,t.positionsDecodeMatrix),i.lenPositions>0&&(t.positionsBuf=new j(e,e.ARRAY_BUFFER,i.quantizedPositions.slice(0,i.lenPositions),i.lenPositions,3,e.STATIC_DRAW))),i.lenNormals>0){let s=!0;t.normalsBuf=new j(e,e.ARRAY_BUFFER,i.normals.slice(0,i.lenNormals),i.lenNormals,3,e.STATIC_DRAW,s)}if(i.lenColors>0){let s=!1;t.colorsBuf=new j(e,e.ARRAY_BUFFER,i.colors.slice(0,i.lenColors),i.lenColors,4,e.STATIC_DRAW,s)}if(i.lenFlags>0){let s=!0;t.flagsBuf=new j(e,e.ARRAY_BUFFER,i.flags.slice(0,i.lenFlags),i.lenFlags,4,e.STATIC_DRAW,s),t.flags2Buf=new j(e,e.ARRAY_BUFFER,i.flags2.slice(0,i.lenFlags),i.lenFlags,4,e.STATIC_DRAW,s)}if(i.lenPickColors>0){let s=!1;t.pickColorsBuf=new j(e,e.ARRAY_BUFFER,i.pickColors.slice(0,i.lenPickColors),i.lenPickColors,4,e.STATIC_DRAW,s)}i.lenIndices>0&&(t.indicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,i.indices.slice(0,i.lenIndices),i.lenIndices,1,e.STATIC_DRAW)),i.lenEdgeIndices>0&&(t.edgeIndicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,i.edgeIndices.slice(0,i.lenEdgeIndices),i.lenEdgeIndices,1,e.STATIC_DRAW)),i.lenPositions=0,i.lenColors=0,i.lenNormals=0,i.lenFlags=0,i.lenPickColors=0,i.lenIndices=0,i.lenEdgeIndices=0,this._buffer=null,this._finalized=!0}initFlags(t,e){e&Qt.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&Qt.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&Qt.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Qt.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&Qt.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&Qt.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),this._setFlags(t,e),this._setFlags2(t,e)}setVisible(t,e){if(!this._finalized)throw"Not finalized";e&Qt.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e)}setHighlighted(t,e){if(!this._finalized)throw"Not finalized";e&Qt.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e)}setXRayed(t,e){if(!this._finalized)throw"Not finalized";e&Qt.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e)}setSelected(t,e){if(!this._finalized)throw"Not finalized";e&Qt.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e)}setEdges(t,e){if(!this._finalized)throw"Not finalized";e&Qt.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags2(t,e)}setClippable(t,e){if(!this._finalized)throw"Not finalized";this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e){if(!this._finalized)throw"Not finalized";e&Qt.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e)}setColor(t,e,i=!1){if(!this._finalized)throw"Not finalized";var s=2*t,r=4*this._portions[s],o=4*this._portions[s+1];const n=e[0],a=e[1],l=e[2],h=e[3];for(var c=0;c<o;c+=4)Ke[c+0]=n,Ke[c+1]=a,Ke[c+2]=l,Ke[c+3]=h;if(i){e[3]<255?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--)}this._state.colorsBuf.setData(Ke.slice(0,o),r,o)}_setFlags(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=e&Qt.VISIBLE?255:0,n=e&Qt.XRAYED?255:0,a=e&Qt.HIGHLIGHTED?255:0,l=e&Qt.SELECTED?255:0,h=0;h<r;h+=4)Ke[h+0]=o,Ke[h+1]=n,Ke[h+2]=a,Ke[h+3]=l;this._state.flagsBuf.setData(Ke.slice(0,r),s,r)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=e&Qt.CLIPPABLE?255:0,n=e&Qt.EDGES?255:0,a=e&Qt.PICKABLE?255:0,l=0;l<r;l+=4)Ke[l+0]=o,Ke[l+1]=n,Ke[l+2]=a;this._state.flags2Buf.setData(Ke.slice(0,r),s,r)}drawNormalFillOpaque(t){0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(t,this,ae.NORMAL_OPAQUE)}drawNormalEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.NORMAL_OPAQUE)}drawNormalFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(t,this,ae.NORMAL_TRANSPARENT)}drawNormalTransparentEdges(t){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.NORMAL_TRANSPARENT)}drawXRayedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.XRAYED)}drawHighlightedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawSelectedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.SELECTED)}drawPickMesh(t){0!==this._numVisibleLayerPortions&&this._pickMeshRenderer&&this._pickMeshRenderer.drawLayer(t,this)}drawPickDepths(t){0!==this._numVisibleLayerPortions&&this._pickDepthRenderer&&this._pickDepthRenderer.drawLayer(t,this)}drawPickNormals(t){0!==this._numVisibleLayerPortions&&this._pickNormalsRenderer&&this._pickNormalsRenderer.drawLayer(t,this)}drawOcclusion(t){0!==this._numVisibleLayerPortions&&(this._occlusionRenderer||(this._occlusionRenderer=je.get(this)),this._occlusionRenderer&&this._occlusionRenderer.drawLayer(t,this))}compileShaders(){this._drawRenderer&&!1===this._drawRenderer.getValid()&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&!1===this._fillRenderer.getValid()&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&!1===this._edgesRenderer.getValid()&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&!1===this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!1===this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.put(),this._occlusionRenderer=null),this._drawRenderer||(this._drawRenderer=ce.get(this)),this._fillRenderer||(this._fillRenderer=ge.get(this)),this._edgesRenderer||(this._edgesRenderer=Pe.get(this)),this._pickMeshRenderer||(this._pickMeshRenderer=Le.get(this)),this._pickDepthRenderer||(this._pickDepthRenderer=Re.get(this)),this._pickNormalsRenderer||(this._pickNormalsRenderer=Ne.get(this))}destroy(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null);const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.destroy()}}var Qe=function(){const t=M.mat4(),e=M.mat4();return function(i,s,r,o,n){const a=r[0],l=r[1],h=r[2],c=r[3]-a,d=r[4]-l,u=r[5]-h,_=65525/c,p=65525/d,f=65525/u;let g;for(g=0;g<s;g+=3)o[g+0]=Math.floor((i[g+0]-a)*_),o[g+1]=Math.floor((i[g+1]-l)*p),o[g+2]=Math.floor((i[g+2]-h)*f);M.identityMat4(t),M.translationMat4v(r,t),M.identityMat4(e),M.scalingMat4v([c/65525,d/65525,u/65525],e),M.mulMat4(t,e,n)}}();function Je(t,e,i){let s=t[0]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2])),r=t[1]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]));if(t[2]<0){let t=s,e=r;t=(1-Math.abs(r))*(s>=0?1:-1),e=(1-Math.abs(s))*(r>=0?1:-1),s=t,r=e}return new Int8Array([Math[e](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function ti(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function ei(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}const ii=function(t){this.vertex=function(t){var e=t.model.scene;const i=e._sectionPlanesState,s=e._lightsState,r=i.sectionPlanes.length>0;let o,n,a;const l=[];for(l.push("// Instancing geometry drawing vertex shader"),l.push("uniform int renderPass;"),l.push("attribute vec3 position;"),l.push("attribute vec2 normal;"),l.push("attribute vec4 color;"),l.push("attribute vec4 flags;"),l.push("attribute vec4 flags2;"),l.push("attribute vec4 modelMatrixCol0;"),l.push("attribute vec4 modelMatrixCol1;"),l.push("attribute vec4 modelMatrixCol2;"),l.push("attribute vec4 modelNormalMatrixCol0;"),l.push("attribute vec4 modelNormalMatrixCol1;"),l.push("attribute vec4 modelNormalMatrixCol2;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),l.push("uniform mat4 positionsDecodeMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec4 lightAmbient;"),o=0,n=s.lights.length;o<n;o++)"ambient"!==(a=s.lights[o]).type&&(l.push("uniform vec4 lightColor"+o+";"),"dir"===a.type&&l.push("uniform vec3 lightDir"+o+";"),"point"===a.type&&l.push("uniform vec3 lightPos"+o+";"),"spot"===a.type&&(l.push("uniform vec3 lightPos"+o+";"),l.push("uniform vec3 lightDir"+o+";")));l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"),r&&(l.push("varying vec4 vWorldPosition;"),l.push("varying vec4 vFlags2;"));for(l.push("varying vec4 vColor;"),l.push("void main(void) {"),l.push("bool visible      = (float(flags.x) > 0.0);"),l.push("bool xrayed       = (float(flags.y) > 0.0);"),l.push("bool highlighted  = (float(flags.z) > 0.0);"),l.push("bool selected     = (float(flags.w) > 0.0);"),l.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),l.push(`if \n    (!visible || \n    (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${ae.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),l.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),l.push("} else {"),l.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),l.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),l.push("vec4 viewPosition  = viewMatrix * worldPosition; "),l.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),l.push("vec4 worldNormal = vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),l.push("vec3 viewNormal = normalize(vec4(worldNormal * viewNormalMatrix).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),o=0,n=s.lights.length;o<n;o++)if("ambient"!==(a=s.lights[o]).type){if("dir"===a.type)"view"===a.space?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if("point"===a.type)"view"===a.space?l.push("viewLightDir = normalize(lightPos"+o+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else{if("spot"!==a.type)continue;"view"===a.space?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}l.push("vColor = colorize *  vec4(reflectedColor * ((lightAmbient.rgb * lightAmbient.a) + vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0)), float(color.a) / 255.0);"),r&&(l.push("vWorldPosition = worldPosition;"),l.push("vFlags2 = flags2;"));return l.push("gl_Position = projMatrix * viewPosition;"),l.push("}"),l.push("}"),l}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Instancing geometry drawing fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = vColor;"),o.push("}"),o}(t)};const si=new s({}),ri=function(t,e){this.id=si.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new ii(e),this._allocate(e)},oi={},ni=new Float32Array([1,1,1,1]);function ai(t){return[t.canvas.canvas.id,"",t._lightsState.getHash(),t._sectionPlanesState.getHash()].join(";")}ri.get=function(t){const e=ai(t.model.scene);let i=oi[e];if(!i){if((i=new ri(e,t)).errors)return console.log(i.errors.join("\n")),null;oi[e]=i,r.memory.programs++}return i._useCount++,i},ri.prototype.getValid=function(){return this._hash===ai(this._scene)},ri.prototype.put=function(){0==--this._useCount&&(si.removeItem(this.id),this._program&&this._program.destroy(),delete oi[this._hash],r.memory.programs--)},ri.prototype.webglContextRestored=function(){this._program=null},ri.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state,a=this._instanceExt;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),t.bindArray+=3,this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aNormal.bindArrayBuffer(n.normalsBuf),t.bindArray++,this._aColor.bindArrayBuffer(n.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),t.bindArray++,this._aFlags.bindArrayBuffer(n.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),n.indicesBuf.bind(),t.bindArray++,i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColorize,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColorize,e[0],e[1],e[2],i)}else o.uniform4fv(this._uColorize,ni);a.drawElementsInstancedANGLE(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++}},ri.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._lightsState,r=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const o=this._program;this._uRenderPass=o.getLocation("renderPass"),this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uColorize=o.getLocation("colorize"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const n=s.lights;let a;for(var l=0,h=n.length;l<h;l++)switch((a=n[l]).type){case"ambient":this._uLightAmbient[l]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[l]=o.getLocation("lightColor"+l),this._uLightPos[l]=null,this._uLightDir[l]=o.getLocation("lightDir"+l);break;case"point":this._uLightColor[l]=o.getLocation("lightColor"+l),this._uLightPos[l]=o.getLocation("lightPos"+l),this._uLightDir[l]=null,this._uLightAttenuation[l]=o.getLocation("lightAttenuation"+l);break;case"spot":this._uLightColor[l]=o.getLocation("lightColor"+l),this._uLightPos[l]=o.getLocation("lightPos"+l),this._uLightDir[l]=o.getLocation("lightDir"+l),this._uLightAttenuation[l]=o.getLocation("lightAttenuation"+l)}this._uSectionPlanes=[];for(l=0,h=r.sectionPlanes.length;l<h;l++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+l),pos:o.getLocation("sectionPlanePos"+l),dir:o.getLocation("sectionPlaneDir"+l)});this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._aColor=o.getAttribute("color"),this._aFlags=o.getAttribute("flags"),this._aFlags2=o.getAttribute("flags2"),this._aModelMatrixCol0=o.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=o.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=o.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=o.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=o.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=o.getAttribute("modelNormalMatrixCol2")},ri.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._lightsState,n=i._sectionPlanesState,a=o.lights;let l;r.bind(),t.useProgram++;const h=i.camera;h._state;s.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix);for(var c=0,d=a.length;c<d;c++)l=a[c],this._uLightAmbient[c]?s.uniform4f(this._uLightAmbient[c],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[c]&&s.uniform4f(this._uLightColor[c],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[c]&&(s.uniform3fv(this._uLightPos[c],l.pos),this._uLightAttenuation[c]&&s.uniform1f(this._uLightAttenuation[c],l.attenuation)),this._uLightDir[c]&&s.uniform3fv(this._uLightDir[c],l.dir));if(n.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,a;for(c=0,d=this._uSectionPlanes.length;c<d;c++)r=(e=this._uSectionPlanes[c]).active,o=t[c],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(a=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const li=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing fill vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = (float(flags.w) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`if\n    (!visible ||\n    (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${ae.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Instancing fill fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = color;"),o.push("}"),o}(t)};const hi=new s({}),ci=function(t,e){this.id=hi.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new li(e),this._allocate(e)},di={},ui=new Float32Array([1,1,1,1]);function _i(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}ci.get=function(t){const e=_i(t.model.scene);let i=di[e];if(!i){if((i=new ci(e,t)).errors)return console.log(i.errors.join("\n")),null;di[e]=i,r.memory.programs++}return i._useCount++,i},ci.prototype.getValid=function(){return this._hash===_i(this._scene)},ci.prototype.put=function(){0==--this._useCount&&(hi.removeItem(this.id),this._program&&this._program.destroy(),delete di[this._hash],r.memory.programs--)},ci.prototype.webglContextRestored=function(){this._program=null},ci.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state,a=this._instanceExt;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aFlags.bindArrayBuffer(n.flagsBuf,o.UNSIGNED_BYTE,!0),a.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,o.UNSIGNED_BYTE,!0),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),n.indicesBuf.bind(),t.bindArray++,i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.SELECTED){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else o.uniform4fv(this._uColor,ui);a.drawElementsInstancedANGLE(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++}},ci.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},ci.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;r.bind(),t.useProgram++;const n=i.camera;n._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const pi=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing edges vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("uniform vec4 color;"),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = (float(flags.w) > 0.0);"),i.push("bool edges        = (float(flags2.y) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`\n     if (!visible || !edges ||\n        (renderPass == ${ae.NORMAL_OPAQUE} && (transparent || xrayed || selected)) ||\n    (renderPass == ${ae.NORMAL_TRANSPARENT} &&  (!transparent || xrayed || highlighted || selected)) ||\n    (renderPass == ${ae.XRAYED} && (!xrayed || highlighted || selected)) ||\n    (renderPass == ${ae.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${ae.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0;let s,r;const o=[];if(o.push("// Instancing edges fragment shader"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("uniform vec4 color;"),i)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),s=0,r=e.sectionPlanes.length;s<r;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("void main(void) {"),i){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,r=e.sectionPlanes.length;s<r;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("gl_FragColor = color;"),o.push("}"),o}(t)};const fi=new s({}),gi=function(t,e){this.id=fi.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new pi(e),this._allocate(e)},mi={};function vi(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}gi.get=function(t){const e=vi(t.model.scene);let i=mi[e];if(!i){if((i=new gi(e,t)).errors)return console.log(i.errors.join("\n")),null;mi[e]=i,r.memory.programs++}return i._useCount++,i},gi.prototype.getValid=function(){return this._hash===vi(this._scene)},gi.prototype.put=function(){0==--this._useCount&&(fi.removeItem(this.id),this._program&&this._program.destroy(),delete mi[this._hash],r.memory.programs--)},gi.prototype.webglContextRestored=function(){this._program=null},gi.prototype.drawLayer=function(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,n=e._state,a=this._instanceExt;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),i===ae.XRAYED){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.HIGHLIGHTED){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===ae.SELECTED){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}else{const t=r.edgeMaterial._state,e=t.edgeColor,i=t.edgeAlpha;o.uniform4f(this._uColor,e[0],e[1],e[2],i)}o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),o.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aPosition.bindArrayBuffer(n.positionsBuf),t.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,o.UNSIGNED_BYTE,!0),a.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,o.UNSIGNED_BYTE,!0),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),n.edgeIndicesBuf.bind(),t.bindArray++,a.drawElementsInstancedANGLE(o.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aFlags&&a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++}},gi.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uColor=r.getLocation("color"),this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},gi.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl;this._program.bind(),t.useProgram++;const r=i.camera;r._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),i._sectionPlanesState.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(e=this._uSectionPlanes[o]).active,a=t[o],r&&s.uniform1i(r,a.active),(l=e.pos)&&s.uniform3fv(e.pos,a.pos),(h=e.dir)&&s.uniform3fv(e.dir,a.dir)}};const bi=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry picking vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("gl_FragColor = vPickColor; "),s.push("}"),s}(t)};const yi=new s({}),wi=function(t,e){this.id=yi.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new bi(e),this._allocate(e)},Pi={};function Mi(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}wi.get=function(t){const e=Mi(t.model.scene);let i=Pi[e];if(!i){if((i=new wi(e,t)).errors)return console.log(i.errors.join("\n")),null;Pi[e]=i,r.memory.programs++}return i._useCount++,i},wi.prototype.getValid=function(){return this._hash===Mi(this._scene)},wi.prototype.put=function(){0==--this._useCount&&(yi.removeItem(this.id),this._program&&this._program.destroy(),delete Pi[this._hash],r.memory.programs--)},wi.prototype.webglContextRestored=function(){this._program=null},wi.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene.canvas.gl,r=e._state,o=this._instanceExt;!this._program&&(this._allocate(e),this.errors)||(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aPickColor.bindArrayBuffer(r.pickColorsBuf),o.vertexAttribDivisorANGLE(this._aPickColor.location,1),t.bindArray++,this._aPosition.bindArrayBuffer(r.positionsBuf),t.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),r.indicesBuf.bind(),t.bindArray++,o.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aPickColor.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++)},wi.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},wi.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=(i._lightsState,i._sectionPlanesState);r.bind(),t.useProgram++;const n=i.camera;n._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const xi=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry depth vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&i.push("  vWorldPosition = worldPosition;");return i.push("  vViewPosition = viewPosition;"),i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),s.push("precision highp float;"),s.push("uniform float zNear;"),s.push("uniform float zFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float zNormalizedDepth = abs((zNear + vViewPosition.z) / (zFar - zNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}(t)};const Ai=new s({}),Ei=function(t,e){this.id=Ai.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new xi(e),this._allocate(e)},Li={};function Ci(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Ei.get=function(t){const e=Ci(t.model.scene);let i=Li[e];if(!i){if((i=new Ei(e,t)).errors)return console.log(i.errors.join("\n")),null;Li[e]=i,r.memory.programs++}return i._useCount++,i},Ei.prototype.getValid=function(){return this._hash===Ci(this._scene)},Ei.prototype.put=function(){0==--this._useCount&&(Ai.removeItem(this.id),this._program&&this._program.destroy(),delete Li[this._hash],r.memory.programs--)},Ei.prototype.webglContextRestored=function(){this._program=null},Ei.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,n=this._instanceExt;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e));const a=s.camera.project._state;r.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.uniform1f(this._uZNear,a.near),r.uniform1f(this._uZFar,a.far),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aPosition.bindArrayBuffer(o.positionsBuf),t.bindArray++,this._aFlags.bindArrayBuffer(o.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),o.indicesBuf.bind(),t.bindArray++,n.drawElementsInstancedANGLE(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++},Ei.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uZNear=r.getLocation("zNear"),this._uZFar=r.getLocation("zFar")},Ei.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;if(r.bind(),t.useProgram++,o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,l,h;for(var n=0,a=this._uSectionPlanes.length;n<a;n++)r=(e=this._uSectionPlanes[n]).active,o=t[n],r&&s.uniform1i(r,o.active),(l=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const ki=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry normals vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),e&&i.push("  vWorldPosition = worldPosition;");return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),s.push("precision highp float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}(t)};const Di=new s({}),Si=function(t,e){this.id=Di.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new ki(e),this._allocate(e)},Ri={};function Bi(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Si.get=function(t){const e=Bi(t.model.scene);let i=Ri[e];if(!i){if((i=new Si(e,t)).errors)return console.log(i.errors.join("\n")),null;Ri[e]=i,r.memory.programs++}return i._useCount++,i},Si.prototype.getValid=function(){return this._hash===Bi(this._scene)},Si.prototype.put=function(){0==--this._useCount&&(Di.removeItem(this.id),this._program&&this._program.destroy(),delete Ri[this._hash],r.memory.programs--)},Si.prototype.webglContextRestored=function(){this._program=null},Si.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene.canvas.gl,r=e._state,o=this._instanceExt;!this._program&&(this._allocate(e),this.errors)||(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uViewMatrix,!1,t.pickViewMatrix?i.getPickViewMatrix(t.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aModelNormalMatrixCol0.bindArrayBuffer(r.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(r.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(r.modelNormalMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),t.bindArray+=3,this._aPosition.bindArrayBuffer(r.positionsBuf),t.bindArray++,this._aNormal.bindArrayBuffer(r.normalsBuf),t.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),r.indicesBuf.bind(),t.bindArray++,o.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++)},Si.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2")},Si.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._sectionPlanesState;if(s.bind(),t.useProgram++,r.sectionPlanes.length>0){const t=e._sectionPlanesState.sectionPlanes;let s,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(s=this._uSectionPlanes[o]).active,a=t[o],r&&i.uniform1i(r,a.active),(l=s.pos)&&i.uniform3fv(s.pos,a.pos),(h=s.dir)&&i.uniform3fv(s.dir,a.dir)}};const Ti=function(t){this.vertex=function(t){const e=t.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing occlusion vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&i.push("  vWorldPosition = worldPosition;");return i.push("  vViewPosition = viewPosition;"),i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(t),this.fragment=function(t){const e=t.model.scene._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched occlusion fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}(t)};const Fi=new s({}),Ii=function(t,e){this.id=Fi.addItem({}),this._hash=t,this._scene=e.model.scene,this._useCount=0,this._shaderSource=new Ti(e),this._allocate(e)},Ni={};function Oi(t){return[t.canvas.canvas.id,"",t._sectionPlanesState.getHash()].join(";")}Ii.get=function(t){const e=Oi(t.model.scene);let i=Ni[e];if(!i){if((i=new Ii(e,t)).errors)return console.log(i.errors.join("\n")),null;Ni[e]=i,r.memory.programs++}return i._useCount++,i},Ii.prototype.getValid=function(){return this._hash===Oi(this._scene)},Ii.prototype.put=function(){0==--this._useCount&&(Fi.removeItem(this.id),this._program&&this._program.destroy(),delete Ni[this._hash],r.memory.programs--)},Ii.prototype.webglContextRestored=function(){this._program=null},Ii.prototype.drawLayer=function(t,e){const i=e.model,s=i.scene.canvas.gl,r=e._state,o=this._instanceExt;!this._program&&(this._allocate(e),this.errors)||(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,i.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),t.bindArray+=3,this._aColor&&(this._aColor.bindArrayBuffer(r.colorsBuf),o.vertexAttribDivisorANGLE(this._aColor.location,1),t.bindArray++),this._aPosition.bindArrayBuffer(r.positionsBuf),t.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),t.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1),t.bindArray++),r.indicesBuf.bind(),t.bindArray++,o.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&o.vertexAttribDivisorANGLE(this._aColor.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),t.drawElements++)},Ii.prototype._allocate=function(t){var e=t.model.scene;const i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new U(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,n=s.sectionPlanes.length;o<n;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},Ii.prototype._bindProgram=function(t,e){const i=this._scene,s=i.canvas.gl,r=this._program,o=i._sectionPlanesState;r.bind(),t.useProgram++;const n=i.camera;n._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),o.sectionPlanes.length>0){const t=i._sectionPlanesState.sectionPlanes;let e,r,o,n,h;for(var a=0,l=this._uSectionPlanes.length;a<l;a++)r=(e=this._uSectionPlanes[a]).active,o=t[a],r&&s.uniform1i(r,o.active),(n=e.pos)&&s.uniform3fv(e.pos,o.pos),(h=e.dir)&&s.uniform3fv(e.dir,o.dir)}};const Vi=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,zi=Vi?5e6:65530,Ui=new Uint16Array(3*zi),ji=new Int8Array(3*zi),Yi=new Uint8Array(4),Gi=M.vec4([0,0,0,1]),Hi=M.vec4([0,0,0,1]);class Ki{constructor(t,e){this.model=t,this._aabb=M.collapseAABB3();var i,s=e.primitive||"triangles";const r=t.scene.canvas.gl;switch(s){case"points":i=r.POINTS;break;case"lines":i=r.LINES;break;case"line-loop":i=r.LINE_LOOP;break;case"line-strip":i=r.LINE_STRIP;break;case"triangles":i=r.TRIANGLES;break;case"triangle-strip":i=r.TRIANGLE_STRIP;break;case"triangle-fan":i=r.TRIANGLE_FAN;break;default:throw`Unsupported value for 'primitive': '${s}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`}var o={primitiveName:s,primitive:i,positionsDecodeMatrix:M.mat4(),numInstances:0,obb:M.OBB3()};if(e.positions)if(e.preCompressed){let t=!1;o.positionsBuf=new j(r,r.ARRAY_BUFFER,e.positions,e.positions.length,3,r.STATIC_DRAW,t),o.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let i=M.collapseAABB3();M.expandAABB3Points3(i,e.positions),Mt.decompressAABB(i,o.positionsDecodeMatrix),M.AABB3ToOBB3(i,o.obb)}else{let t=e.positions.length,i=M.collapseAABB3();M.expandAABB3Points3(i,e.positions),M.AABB3ToOBB3(i,o.obb),Xi(e.positions,t,i,Ui,o.positionsDecodeMatrix);let s=!1;o.positionsBuf=new j(r,r.ARRAY_BUFFER,Ui,t,3,r.STATIC_DRAW,s)}if(e.normals)if(e.preCompressed){let t=!0;o.normalsBuf=new j(r,r.ARRAY_BUFFER,e.normals,e.normals.length,3,r.STATIC_DRAW,t)}else{var n=function(t,e,i,s){let r,o,n,a,l;for(let h=0;h<e;h+=3)n=r=Wi(t,h,"floor","floor"),o=qi(r),a=l=Zi(t,h,o),r=Wi(t,h,"ceil","floor"),o=qi(r),(a=Zi(t,h,o))>l&&(n=r,l=a),r=Wi(t,h,"floor","ceil"),o=qi(r),(a=Zi(t,h,o))>l&&(n=r,l=a),r=Wi(t,h,"ceil","ceil"),o=qi(r),(a=Zi(t,h,o))>l&&(n=r,l=a),i[s+h+0]=n[0],i[s+h+1]=n[1],i[s+h+2]=0;return s+=e}(e.normals,e.normals.length,ji,0);let t=!0;o.normalsBuf=new j(r,r.ARRAY_BUFFER,ji,n,3,r.STATIC_DRAW,t)}e.indices&&(o.indicesBuf=new j(r,r.ELEMENT_ARRAY_BUFFER,Vi?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,r.STATIC_DRAW));var a=e.edgeIndices;a||(a=bt(e.positions,e.indices,null,10)),o.edgeIndicesBuf=new j(r,r.ELEMENT_ARRAY_BUFFER,Vi?new Uint32Array(a):new Uint16Array(a),a.length,1,r.STATIC_DRAW),this._state=new Z(o),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this.numIndices=e.indices?e.indices/3:0,this._flags=[],this._flags2=[],this._colors=[],this._pickColors=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._finalized=!1,this._preCompressed=!!e.preCompressed,this.compileShaders()}createPortion(t,e,i,s,r,o){if(this._finalized)throw"Already finalized";var n=t&Qt.VISIBLE?255:0,a=t&Qt.XRAYED?255:0,l=t&Qt.HIGHLIGHTED?255:0,h=t&Qt.HIGHLIGHTED?255:0,c=t&Qt.CLIPPABLE?255:0,d=t&Qt.EDGES?255:0,u=t&Qt.PICKABLE?255:0;this._flags.push(n),this._flags.push(a),this._flags.push(l),this._flags.push(h),this._flags2.push(c),this._flags2.push(d),this._flags2.push(u),this._flags2.push(0),n&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),a&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),l&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),h&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),d&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),u&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++);const _=e[0],p=e[1],f=e[2];e[3];i<255&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._colors.push(_),this._colors.push(p),this._colors.push(f),this._colors.push(i),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]);let g=M.transposeMat4(s,M.mat4()),m=M.inverseMat4(g);this._modelNormalMatrixCol0.push(m[0]),this._modelNormalMatrixCol0.push(m[4]),this._modelNormalMatrixCol0.push(m[8]),this._modelNormalMatrixCol0.push(m[12]),this._modelNormalMatrixCol1.push(m[1]),this._modelNormalMatrixCol1.push(m[5]),this._modelNormalMatrixCol1.push(m[9]),this._modelNormalMatrixCol1.push(m[13]),this._modelNormalMatrixCol2.push(m[2]),this._modelNormalMatrixCol2.push(m[6]),this._modelNormalMatrixCol2.push(m[10]),this._modelNormalMatrixCol2.push(m[14]),this._pickColors.push(o[0]),this._pickColors.push(o[1]),this._pickColors.push(o[2]),this._pickColors.push(o[3]),M.collapseAABB3(r);for(var v=this._state.obb,b=v.length,y=0;y<b;y+=4)Gi[0]=v[y+0],Gi[1]=v[y+1],Gi[2]=v[y+2],M.transformPoint4(s,Gi,Hi),M.expandAABB3Point3(r,Hi);this._state.numInstances++;var w=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,w}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl;if(this._colors.length>0){let e=!1;this._state.colorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.STATIC_DRAW,e),this._colors=[]}if(this._flags.length>0){let e=!0;this._state.flagsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._flags),this._flags.length,4,t.STATIC_DRAW,e),this._state.flags2Buf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._flags2),this._flags2.length,4,t.STATIC_DRAW,e),this._flags=[],this._flags2=[]}if(this._modelMatrixCol0.length>0){let e=!1;this._state.modelMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.modelNormalMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[]}if(this._pickColors.length>0){let e=!1;this._state.pickColorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,e),this._pickColors=[]}this._finalized=!0}initFlags(t,e){e&Qt.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&Qt.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&Qt.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Qt.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&Qt.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&Qt.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),this._setFlags(t,e),this._setFlags2(t,e)}setVisible(t,e){if(!this._finalized)throw"Not finalized";e&Qt.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e)}setHighlighted(t,e){if(!this._finalized)throw"Not finalized";e&Qt.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e)}setXRayed(t,e){if(!this._finalized)throw"Not finalized";e&Qt.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e)}setSelected(t,e){if(!this._finalized)throw"Not finalized";e&Qt.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e)}setEdges(t,e){if(!this._finalized)throw"Not finalized";e&Qt.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags2(t,e)}setClippable(t,e){if(!this._finalized)throw"Not finalized";this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e){if(!this._finalized)throw"Not finalized";e&Qt.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e)}setColor(t,e,i=!1){if(!this._finalized)throw"Not finalized";if(Yi[0]=e[0],Yi[1]=e[1],Yi[2]=e[2],Yi[3]=e[3],i){e[3]<255?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--)}this._state.colorsBuf.setData(Yi,4*t,4)}_setFlags(t,e){if(!this._finalized)throw"Not finalized";var i=e&Qt.VISIBLE?255:0,s=e&Qt.XRAYED?255:0,r=e&Qt.HIGHLIGHTED?255:0,o=e&Qt.SELECTED?255:0;Yi[0]=i,Yi[1]=s,Yi[2]=r,Yi[3]=o,this._state.flagsBuf.setData(Yi,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";var i=e&Qt.CLIPPABLE?255:0,s=e&Qt.EDGES?255:0,r=e&Qt.PICKABLE?255:0;Yi[0]=i,Yi[1]=s,Yi[2]=r,this._state.flags2Buf.setData(Yi,4*t,4)}drawNormalFillOpaque(t){0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(t,this,ae.NORMAL_OPAQUE)}drawNormalEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.NORMAL_OPAQUE)}drawNormalFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(t,this,ae.NORMAL_TRANSPARENT)}drawNormalTransparentEdges(t){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.NORMAL_TRANSPARENT)}drawXRayedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.XRAYED)}drawXRayedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.XRAYED)}drawHighlightedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawHighlightedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.HIGHLIGHTED)}drawSelectedFillOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedEdgesOpaque(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedFillTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(t,this,ae.SELECTED)}drawSelectedEdgesTransparent(t){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(t,this,ae.SELECTED)}drawPickMesh(t){0!==this._numVisibleLayerPortions&&this._pickMeshRenderer&&this._pickMeshRenderer.drawLayer(t,this)}drawPickDepths(t){0!==this._numVisibleLayerPortions&&this._pickDepthRenderer&&this._pickDepthRenderer.drawLayer(t,this)}drawPickNormals(t){0!==this._numVisibleLayerPortions&&this._pickNormalsRenderer&&this._pickNormalsRenderer.drawLayer(t,this)}drawOcclusion(t){0!==this._numVisibleLayerPortions&&(this._occlusionRenderer||(this._occlusionRenderer=Ii.get(this)),this._occlusionRenderer&&this._occlusionRenderer.drawLayer(t,this))}compileShaders(){this._drawRenderer&&!1===this._drawRenderer.getValid()&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&!1===this._fillRenderer.getValid()&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&!1===this._edgesRenderer.getValid()&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&!1===this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!1===this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.put(),this._occlusionRenderer=null),this._drawRenderer||(this._drawRenderer=ri.get(this)),this._fillRenderer||(this._fillRenderer=ci.get(this)),this._edgesRenderer||(this._edgesRenderer=gi.get(this)),this._pickMeshRenderer||(this._pickMeshRenderer=wi.get(this)),this._pickDepthRenderer||(this._pickDepthRenderer=Ei.get(this)),this._pickNormalsRenderer||(this._pickNormalsRenderer=Si.get(this))}destroy(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null);const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.modelNormalMatrixCol0Buf&&(t.modelNormalMatrixCol0Buf.destroy(),t.modelNormalMatrixCol0Buf=null),t.modelNormalMatrixCol1Buf&&(t.modelNormalMatrixCol1Buf.destroy(),t.modelNormalMatrixCol1Buf=null),t.modelNormalMatrixCol2Buf&&(t.modelNormalMatrixCol2Buf.destroy(),t.modelNormalMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}var Xi=function(){const t=M.mat4(),e=M.mat4(),i=M.vec3();return function(s,r,o,n,a){const l=o[0],h=o[1],c=o[2],d=o[3],u=o[4],_=o[5],p=o[3]-l,f=o[4]-h,g=o[5]-c,m=d!==l?65535/(d-l):0,v=u!==h?65535/(u-h):0,b=_!==c?65535/(_-c):0;let y;for(y=0;y<r;y+=3)n[y+0]=Math.floor((s[y+0]-l)*m),n[y+1]=Math.floor((s[y+1]-h)*v),n[y+2]=Math.floor((s[y+2]-c)*b);M.identityMat4(t),M.translationMat4v(o,t),M.identityMat4(e),i[0]=p/65535,i[1]=f/65535,i[2]=g/65535,M.scalingMat4v(i,e),M.mulMat4(t,e,a)}}();function Wi(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=r,e=o;t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1),r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function qi(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function Zi(t,e,i){return t[e]*i[0]+t[e+1]*i[1]+t[e+2]*i[2]}const $i=C.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays;var Qi=M.mat4(),Ji=M.mat4();const ts=M.vec3([1,1,1]),es=M.vec3([0,0,0]),is=M.vec3([0,0,0]),ss=M.identityQuaternion(),rs="__default";class os extends x{constructor(t,e={}){super(t,e),this._preCompressed=!!e.preCompressed,this._tiles={},this._aabb=M.collapseAABB3(),this._layers=[],this._nodes=[],this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numEntities=0,this.numTriangles=0,this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.colorize=e.colorize,this.opacity=e.opacity,this._position=new Float32Array(e.position||[0,0,0]),this._rotation=new Float32Array(e.rotation||[0,0,0]),this._quaternion=new Float32Array(e.quaternion||[0,0,0,1]),e.rotation&&M.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=new Float32Array(e.scale||[1,1,1]),this._worldMatrix=M.mat4(),M.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=M.mat4(),(e.position||e.rotation||e.scale||e.quaternion)&&(this._viewMatrix=M.mat4(),this._viewNormalMatrix=M.mat4(),this._viewMatrixDirty=!0),this._opacity=1,this._colorize=[1,1,1],this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this.createTile({id:rs}),this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewMatrixDirty=!0})}get isPerformanceModel(){return!0}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(M.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),M.inverseMat4(this._viewMatrix,this._viewNormalMatrix),M.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}getPickViewMatrix(t){return this._viewMatrix?this._viewMatrix:t}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(M.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),M.inverseMat4(this._viewMatrix,this._viewNormalMatrix),M.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}createTile(t){if(this._tiles[t.id])return void this.warn("Tile already exists: "+t.id);const e={id:t.id,layers:[],instancingLayers:{},currentBatchingLayer:null,buffer:oe.length>0?oe.pop():new re,meshes:{},nodes:[]};this._tiles[t.id]=e}createGeometry(t){if(!$i)return void this.error("WebGL instanced arrays not supported");const e=t.id;if(null==e)return void this.error("Config missing: id");const i=t.tileId||rs;var s=this._tiles[i];if(s||(this.error("Tile not found: "+i+" - using default tile"),s=this._tiles[rs]),s.instancingLayers[e])this.error("Geometry already created: "+e);else{t.preCompressed=this._preCompressed;var r=new Ki(this,t);s.layers.push(r),s.instancingLayers[e]=r,this.numGeometries++,this.numTriangles+=t.indices?t.indices.length/3:0}}createMesh(t){var e=t.id;if(null==e)return void this.error("Config missing: id");this.scene.components[e]&&(this.error("Scene already has a Component with this ID: "+e+" - will assign random ID"),e=M.createUUID());const i=t.geometryId,s=void 0!==i,r=t.tileId||rs;var o=this._tiles[r];if(o||(this.error("Tile not found: "+r+" - using default tile"),o=this._tiles[rs]),s){if(!$i)return void this.error("WebGL instanced arrays not supported");if(!o.instancingLayers[i])return void this.error("Geometry not found: "+i+" - ensure that you create it first with createGeometry()")}var n,a,l;if(t.matrix)l=t.matrix;else{const e=t.scale||ts,i=t.position||es,s=t.rotation||is;M.eulerToQuaternion(s,"XYZ",ss),l=M.composeMat4(i,ss,e,Qi)}l=M.mulMat4(this._worldMatrix,l,Ji);const h=t.color?new Uint8Array([Math.floor(255*t.color[0]),Math.floor(255*t.color[1]),Math.floor(255*t.color[2])]):[255,255,255],c=void 0!==t.opacity&&null!==t.opacity?Math.floor(255*t.opacity):255;c<255&&this.numTransparentLayerPortions++;var d=new $t(this,e,h,c),u=d.pickId;const _=new Uint8Array([255&u,u>>8&255,u>>16&255,u>>24&255]),p=M.collapseAABB3();if(s){var f=o.instancingLayers[i];n=f,a=f.createPortion(0,h,c,l,p,_),M.expandAABB3(this._aabb,p),this.numTriangles+=n.numIndices.length/3}else{var g=t.primitive||"triangles";"points"!==g&&"lines"!==g&&"line-loop"!==g&&"line-strip"!==g&&"triangles"!==g&&"triangle-strip"!==g&&"triangle-fan"!==g&&(this.error(`Unsupported value for 'primitive': '${g}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`),g="triangles");var m=t.indices,v=t.edgeIndices,b=t.positions;if(!b)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;var y=t.normals;if(!y)return this.error("Config missing: normals (no meshIds provided, so expecting geometry arrays instead)"),null;if(!v&&!m)return this.error("Config missing: must have one or both of indices and edgeIndices  (no meshIds provided, so expecting geometry arrays instead)"),null;if(o.currentBatchingLayer&&(o.currentBatchingLayer.canCreatePortion(b.length)||(o.currentBatchingLayer.finalize(),o.currentBatchingLayer=null)),o.currentBatchingLayer||(o.currentBatchingLayer=new $e(this,{primitive:"triangles",buffer:o.buffer,preCompressed:this._preCompressed,positionsDecodeMatrix:t.positionsDecodeMatrix}),o.layers.push(o.currentBatchingLayer)),n=o.currentBatchingLayer,!v&&m&&(v=bt(b,m,null,10)),this._preCompressed){const e=Mt.getPositionsBounds(b),i=Mt.decompressPosition(e.min,t.positionsDecodeMatrix,[]),s=Mt.decompressPosition(e.max,t.positionsDecodeMatrix,[]);p[0]=i[0],p[1]=i[1],p[2]=i[2],p[3]=s[0],p[4]=s[1],p[5]=s[2]}a=o.currentBatchingLayer.createPortion(b,y,m,v,0,h,c,l,p,_),M.expandAABB3(this._aabb,p),this.numGeometries++,this.numTriangles+=m.length/3}d.parent=null,d._layer=n,d._portionId=a,d.aabb=p,o.meshes[e]=d}createEntity(t){var e=t.id;void 0===e?e=M.createUUID():this.scene.components[e]&&(this.error("Scene already has a Component with this ID: "+e+" - will assign random ID"),e=M.createUUID());var i=t.meshIds;if(void 0===i)return void this.error("Config missing: meshIds");const s=t.tileId||rs;var r,o,n,a,l=this._tiles[s];l||(this.error("Tile not found: "+s+" - using default tile"),l=this._tiles[rs]);var h=[];for(r=0,o=i.length;r<o;r++)n=i[r],(a=l.meshes[n])?a.parent?this.error("Mesh with ID "+n+" already belongs to object with ID "+a.parent.id+" - ignoring this mesh"):(delete l.meshes[n],h.push(a)):this.error("Mesh with this ID not found: "+n+" - ignoring this mesh");var c,d=0;if(this._visible&&!1!==t.visible&&(d|=Qt.VISIBLE),this._pickable&&!1!==t.pickable&&(d|=Qt.PICKABLE),this._clippable&&!1!==t.clippable&&(d|=Qt.CLIPPABLE),this._collidable&&!1!==t.collidable&&(d|=Qt.COLLIDABLE),this._edges&&!1!==t.edges&&(d|=Qt.EDGES),this._xrayed&&!1!==t.xrayed&&(d|=Qt.XRAYED),this._highlighted&&!1!==t.highlighted&&(d|=Qt.HIGHLIGHTED),this._selected&&!1!==t.selected&&(d|=Qt.SELECTED),1===h.length)c=h[0].aabb;else for(c=M.collapseAABB3(),r=0,o=h.length;r<o;r++)M.expandAABB3(c,h[r].aabb);var u=new te(this,t.isObject,e,h,d,c);return l.nodes.push(u),this.numEntities++,u}finalizeTile(t){const e=this._tiles[t];if(e){e.currentBatchingLayer&&(e.currentBatchingLayer.finalize(),e.currentBatchingLayer=null),e.buffer&&(ne(e.buffer),e.buffer=null);for(const t in e.instancingLayers)e.instancingLayers.hasOwnProperty(t)&&e.instancingLayers[t].finalize();for(var i=0,s=e.nodes.length;i<s;i++){const t=e.nodes[i];t._finalize(),this._nodes.push(t)}for(i=0,s=e.layers.length;i<s;i++){const t=e.layers[i];t instanceof Ki?this._layers.unshift(t):this._layers.push(t)}delete this._tiles[t],this.glRedraw(),this.scene._aabbDirty=!0}else this.warn("Tile not found: "+t)}finalize(){for(var t in this._tiles)this._tiles.hasOwnProperty(t)&&this.finalizeTile(t)}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabb}set visible(t){t=!1!==t,this._visible=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].visible=t;this.glRedraw()}get visible(){return this.numVisibleLayerPortions>0}set xrayed(t){t=!!t,this._xrayed=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].xrayed=t;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set highlighted(t){t=!!t,this._highlighted=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].highlighted=t;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set selected(t){t=!!t,this._selected=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].selected=t;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set edges(t){t=!!t,this._edges=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].edges=t;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set culled(t){t=!!t,this._culled=t,this.glRedraw()}get culled(){return this._culled}set clippable(t){t=!1!==t,this._clippable=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].clippable=t;this.glRedraw()}get clippable(){return this._clippable}set collidable(t){t=!1!==t,this._collidable=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].collidable=t}get collidable(){return this._collidable}set pickable(t){t=!1!==t,this._pickable=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].pickable=t}get pickable(){return this._pickable}set colorize(t){this._colorize=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].colorize=t}get colorize(){return this._colorize}set opacity(t){this._opacity=t;for(var e=0,i=this._nodes.length;e<i;e++)this._nodes[e].opacity=t}get opacity(){return this._opacity}set castsShadow(t){}get castsShadow(){return!1}set receivesShadow(t){}get receivesShadow(){return!1}get isDrawable(){return!0}get isStateSortable(){return!1}stateSortCompare(t,e){}getRenderFlags(t){if(t.reset(),0!==this.numVisibleLayerPortions){if(this.numXRayedLayerPortions>0){const e=this.scene.xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedFillTransparent=!0:t.xrayedFillOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.alpha<1?t.normalEdgesTransparent=!0:t.normalEdgesOpaque=!0}if(this.numXRayedLayerPortions<this.numVisibleLayerPortions&&this.numHighlightedLayerPortions<this.numVisibleLayerPortions&&this.numSelectedLayerPortions<this.numVisibleLayerPortions&&this.numTransparentLayerPortions<this.numVisibleLayerPortions&&(t.normalFillOpaque=!0),this.numTransparentLayerPortions>0&&(t.normalFillTransparent=!0),this.numSelectedLayerPortions>0){const e=this.scene.selectedMaterial._state;e.fill&&(e.fillAlpha<1?t.selectedFillTransparent=!0:t.selectedFillOpaque=!0),e.edges&&(e.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const e=this.scene.highlightMaterial._state;e.fill&&(e.fillAlpha<1?t.highlightedFillTransparent=!0:t.highlightedFillOpaque=!0),e.edges&&(e.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}drawNormalFillOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawNormalFillOpaque(t)}drawNormalEdgesOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawNormalEdgesOpaque(t)}drawNormalFillTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawNormalFillTransparent(t)}drawNormalEdgesTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawNormalEdgesTransparent(t)}drawXRayedFillOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawXRayedFillOpaque(t)}drawXRayedEdgesOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawXRayedEdgesOpaque(t)}drawXRayedFillTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawXRayedFillTransparent(t)}drawXRayedEdgesTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawXRayedEdgesTransparent(t)}drawHighlightedFillOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawHighlightedFillOpaque(t)}drawHighlightedEdgesOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawHighlightedEdgesOpaque(t)}drawHighlightedFillTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawHighlightedFillTransparent(t)}drawHighlightedEdgesTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawHighlightedEdgesTransparent(t)}drawSelectedFillOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawSelectedFillOpaque(t)}drawSelectedEdgesOpaque(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawSelectedEdgesOpaque(t)}drawSelectedFillTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawSelectedFillTransparent(t)}drawSelectedEdgesTransparent(t){for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawSelectedEdgesTransparent(t)}drawPickMesh(t){if(0!==this.numVisibleLayerPortions)for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawPickMesh(t)}drawPickDepths(t){if(0!==this.numVisibleLayerPortions)for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawPickDepths(t)}drawPickNormals(t){if(0!==this.numVisibleLayerPortions)for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawPickNormals(t)}drawOcclusion(t){if(0!==this.numVisibleLayerPortions)for(var e=0,i=this._layers.length;e<i;e++)this._layers[e].drawOcclusion(t)}compile(){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t].compileShaders()}destroy(){for(var t in this._tiles)if(this._tiles.hasOwnProperty(t)){const s=this._tiles[t];var e=0;for(s.nodes.length;e<i;e++){s.nodes[e]._destroy()}ne(s.buffer)}this.scene.camera.off(this._onCameraViewMatrix),super.destroy();e=0;for(var i=this._layers.length;e<i;e++)this._layers[e].destroy();for(e=0,i=this._nodes.length;e<i;e++)this._nodes[e]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this)}}class ns{constructor(t,e,i){this.id=i&&i.id?i.id:t,this.viewer=e,this._eventSubs={},e.addPlugin(this)}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}log(t){console.log(`[xeokit plugin ${this.id}]: ${t}`)}warn(t){console.warn(`[xeokit plugin ${this.id}]: ${t}`)}error(t){console.error(`[xeokit plugin ${this.id}]: ${t}`)}send(t,e){}destroy(){this.viewer.removePlugin(this)}}class as{constructor(){}getMetaModel(t,e,i){a.loadJSON(t,t=>{e(t)},function(t){i(t)})}getXKT(t,e,i){var s=()=>{};e=e||s,i=i||s;const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const t=!!r[2];var o=r[3];o=window.decodeURIComponent(o),t&&(o=window.atob(o));try{const t=new ArrayBuffer(o.length),s=new Uint8Array(t);for(var n=0;n<o.length;n++)s[n]=o.charCodeAt(n);e(t)}catch(t){i(t)}}else{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(s.response):i("getXKT error : "+s.response))},s.send(null)}}}const ls={IfcRoof:{colorize:[.837255,.203922,.270588],priority:0},IfcSlab:{colorize:[.637255,.603922,.670588],priority:0},IfcWall:{colorize:[.537255,.337255,.237255],priority:0},IfcWallStandardCase:{colorize:[.537255,.337255,.237255],priority:0},IfcCovering:{colorize:[.8470588235,.427450980392,0],priority:0},IfcDoor:{colorize:[.637255,.603922,.670588],priority:1},IfcStair:{colorize:[.637255,.603922,.670588],priority:2},IfcStairFlight:{colorize:[.637255,.603922,.670588],priority:2},IfcProxy:{colorize:[.137255,.403922,.870588],priority:2},IfcRamp:{colorize:[.8470588235,.427450980392,0],priority:2},IfcColumn:{colorize:[.137255,.403922,.870588],priority:3},IfcBeam:{colorize:[.137255,.403922,.870588],priority:3},IfcCurtainWall:{colorize:[.137255,.403922,.870588],priority:3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.5,priority:3},IfcTransportElement:{colorize:[.8470588235,.427450980392,0],priority:3},IfcFooting:{colorize:[.8470588235,.427450980392,0],priority:3},IfcRailing:{colorize:[.137255,.403922,.870588],priority:4},IfcFurnishingElement:{colorize:[.137255,.403922,.870588],priority:4},IfcFurniture:{colorize:[.8470588235,.427450980392,0],priority:4},IfcSystemFurnitureElement:{colorize:[.8470588235,.427450980392,0],priority:4},IfcFlowSegment:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowitting:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowTerminal:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowController:{colorize:[.8470588235,.427450980392,0],priority:5},IfcFlowFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctSegment:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDistributionFlowElement:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcLightFixture:{colorize:[.8470588235,.8470588235,.870588],priority:5},IfcAirTerminal:{colorize:[.8470588235,.427450980392,0],priority:6},IfcOpeningElement:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,priority:6},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.5,priority:6},IfcWindow:{colorize:[.137255,.403922,.870588],pickable:!1,opacity:.4,priority:6},IfcBuildingElementProxy:{colorize:[.5,.5,.5]},IfcSite:{colorize:[.137255,.403922,.870588]},IfcMember:{colorize:[.8470588235,.427450980392,0]},DEFAULT:{colorize:[.5,.5,.5],priority:10}};var hs=i(0);const cs=window.pako||hs,ds=1,us=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();class _s extends ns{constructor(t,e={}){super("XKTLoader",t,e),this.dataSource=e.dataSource,this.objectDefaults=e.objectDefaults,this.includeTypes=e.includeTypes,this.excludeTypes=e.excludeTypes}static get XKTVersion(){return ds}set dataSource(t){this._dataSource=t||new as}get dataSource(){return this._dataSource}set objectDefaults(t){this._objectDefaults=t||ls}get objectDefaults(){return this._objectDefaults}set includeTypes(t){this._includeTypes=t}get includeTypes(){return this._includeTypes}set excludeTypes(t){this._excludeTypes=t}get excludeTypes(){return this._excludeTypes}load(t={}){t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);const e=new os(this.viewer.scene,a.apply(t,{isModel:!0,preCompressed:!0})),i=e.id;if(!t.src&&!t.xkt)return this.error("load() param expected: src or xkt"),e;const s={};if(t.metaModelSrc||t.metaModelData){const r=t.includeTypes||this._includeTypes,o=t.excludeTypes||this._excludeTypes,n=t.objectDefaults||this._objectDefaults;if(r){s.includeTypesMap={};for(let t=0,e=r.length;t<e;t++)s.includeTypesMap[r[t]]=!0}if(o){s.excludeTypesMap={};for(let t=0,e=o.length;t<e;t++)s.excludeTypesMap[o[t]]=!0}n&&(s.objectDefaults=n);const a=n=>{this.viewer.metaScene.createMetaModel(i,n,{includeTypes:r,excludeTypes:o}),this.viewer.scene.canvas.spinner.processes--,t.src?this._loadModel(t.src,t,s,e):this._parseModel(t.xkt,t,s,e)};if(t.metaModelSrc){const e=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(e,t=>{this.viewer.scene.canvas.spinner.processes--,a(t)},t=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${e}' - ${t}`),this.viewer.scene.canvas.spinner.processes--})}else t.metaModelData&&a(t.metaModelData)}else t.src?this._loadModel(t.src,t,s,e):this._parseModel(t.xkt,t,s,e);return e.once("destroyed",()=>{this.viewer.metaScene.destroyMetaModel(i)}),e}_loadModel(t,e,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getXKT(e.src,t=>{this._parseModel(t,e,i,s),r.processes--,this.viewer.scene.once("tick",()=>{s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!0)})},t=>{r.processes--,this.error(t),s.fire("error",t)})}_parseModel(t,e,i,s){const r=this._extractData(t);if(!r)return;const o=this._inflateData(r);this._loadDataIntoModel(o,i,s)}_extractData(t){const e=new DataView(t),i=new Uint8Array(t);if(e.getUint32(0,!0)>ds)return void this.error("Incompatible .XKT file version; this XKTLoaderPlugin supports versions <= V"+ds);const s=e.getUint32(4,!0),r=[];let o=4*(s+2);for(let t=0;t<s;t++){const s=e.getUint32(4*(t+2),!0);r.push(i.slice(o,o+s)),o+=s}return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11]}}_inflateData(t){return{positions:new Uint16Array(cs.inflate(t.positions.buffer).buffer),normals:new Int8Array(cs.inflate(t.normals.buffer).buffer),indices:new Uint32Array(cs.inflate(t.indices.buffer).buffer),edgeIndices:new Uint32Array(cs.inflate(t.edgeIndices.buffer).buffer),meshPositions:new Uint32Array(cs.inflate(t.meshPositions.buffer).buffer),meshIndices:new Uint32Array(cs.inflate(t.meshIndices.buffer).buffer),meshEdgesIndices:new Uint32Array(cs.inflate(t.meshEdgesIndices.buffer).buffer),meshColors:new Uint8Array(cs.inflate(t.meshColors.buffer).buffer),entityIDs:cs.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(cs.inflate(t.entityMeshes.buffer).buffer),entityIsObjects:new Uint8Array(cs.inflate(t.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(cs.inflate(t.positionsDecodeMatrix).buffer)}}_loadDataIntoModel(t,e,i){const s=t.positions,r=t.normals,o=t.indices,n=t.edgeIndices,l=t.meshPositions,h=t.meshIndices,c=t.meshEdgesIndices,d=t.meshColors,u=JSON.parse(t.entityIDs),_=t.entityMeshes,p=t.entityIsObjects,f=l.length,g=_.length;for(let m=0;m<g;m++){const v=u[m],b=this.viewer.metaScene.metaObjects[v],y={},w={};if(b){if(e.excludeTypesMap&&b.type&&e.excludeTypesMap[b.type])continue;if(e.includeTypesMap&&b.type&&!e.includeTypesMap[b.type])continue;const t=e.objectDefaults?e.objectDefaults[b.type||"DEFAULT"]:null;t&&(!1===t.visible&&(y.visible=!1),!1===t.pickable&&(y.pickable=!1),t.colorize&&(w.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(w.opacity=t.opacity))}else this.warn("metaobject not found for entity: "+v);const P=m===g-1,M=[];for(let e=_[m],u=P?_.length:_[m+1];e<u;e++){const u=e===f-1,_=v+".mesh."+e,p=us(d.slice(4*e,4*e+3)),g=d[4*e+3]/255;i.createMesh(a.apply(w,{id:_,primitive:"triangles",positions:s.slice(l[e],u?s.length:l[e+1]),normals:r.slice(l[e],u?s.length:l[e+1]),indices:o.slice(h[e],u?o.length:h[e+1]),edgeIndices:n.slice(c[e],u?n.length:c[e+1]),positionsDecodeMatrix:t.positionsDecodeMatrix,color:p,opacity:g})),M.push(_)}i.createEntity(a.apply(y,{id:v,isObject:1===p[m],meshIds:M}))}i.finalize()}}document.body.onload=function(){const t=new qt({canvasId:"myCanvas",transparent:!0});t.scene.camera.eye=[10.45,17.38,-98.31],t.scene.camera.look=[43.09,.5,-26.76],t.scene.camera.up=[.06,.96,.16],t.scene.selectedMaterial.fillAlpha=.1;new _s(t).load({id:"myModel",src:"./models/xkt/OTCConferenceCenter/OTCConferenceCenter.xkt",metaModelSrc:"./metaModels/OTCConferenceCenter/metaModel.json",edges:!0})}}]);