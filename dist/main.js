!function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t,i){var s;e.exports=function e(t,i,r){function a(n,l){if(!i[n]){if(!t[n]){if(!l&&"function"==typeof s&&s)return s(n,!0);if(o)return o(n,!0);var h=new Error("Cannot find module '"+n+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[n]={exports:{}};t[n][0].call(c.exports,function(e){return a(t[n][1][e]||e)},c,c.exports,e,t,i,r)}return i[n].exports}for(var o="function"==typeof s&&s,n=0;n<r.length;n++)a(r[n]);return a}({1:[function(e,t,i){"use strict";var s=e("./zlib/deflate"),r=e("./utils/common"),a=e("./utils/strings"),o=e("./zlib/messages"),n=e("./zlib/zstream"),l=Object.prototype.toString,h=0,c=-1,u=0,d=8;function p(e){if(!(this instanceof p))return new p(e);this.options=r.assign({level:c,method:d,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new n,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==h)throw new Error(o[i]);if(t.header&&s.deflateSetHeader(this.strm,t.header),t.dictionary){var _;if(_="string"==typeof t.dictionary?a.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(i=s.deflateSetDictionary(this.strm,_))!==h)throw new Error(o[i]);this._dict_set=!0}}function _(e,t){var i=new p(t);if(i.push(e,!0),i.err)throw i.msg||o[i.err];return i.result}p.prototype.push=function(e,t){var i,o,n=this.strm,c=this.options.chunkSize;if(this.ended)return!1;o=t===~~t?t:!0===t?4:0,"string"==typeof e?n.input=a.string2buf(e):"[object ArrayBuffer]"===l.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;do{if(0===n.avail_out&&(n.output=new r.Buf8(c),n.next_out=0,n.avail_out=c),1!==(i=s.deflate(n,o))&&i!==h)return this.onEnd(i),this.ended=!0,!1;0!==n.avail_out&&(0!==n.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(a.buf2binstring(r.shrinkBuf(n.output,n.next_out))):this.onData(r.shrinkBuf(n.output,n.next_out)))}while((n.avail_in>0||0===n.avail_out)&&1!==i);return 4===o?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===h):2!==o||(this.onEnd(h),n.avail_out=0,!0)},p.prototype.onData=function(e){this.chunks.push(e)},p.prototype.onEnd=function(e){e===h&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Deflate=p,i.deflate=_,i.deflateRaw=function(e,t){return(t=t||{}).raw=!0,_(e,t)},i.gzip=function(e,t){return(t=t||{}).gzip=!0,_(e,t)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(e,t,i){"use strict";var s=e("./zlib/inflate"),r=e("./utils/common"),a=e("./utils/strings"),o=e("./zlib/constants"),n=e("./zlib/messages"),l=e("./zlib/zstream"),h=e("./zlib/gzheader"),c=Object.prototype.toString;function u(e){if(!(this instanceof u))return new u(e);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,t.windowBits);if(i!==o.Z_OK)throw new Error(n[i]);if(this.header=new h,s.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=a.string2buf(t.dictionary):"[object ArrayBuffer]"===c.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=s.inflateSetDictionary(this.strm,t.dictionary))!==o.Z_OK))throw new Error(n[i])}function d(e,t){var i=new u(t);if(i.push(e,!0),i.err)throw i.msg||n[i.err];return i.result}u.prototype.push=function(e,t){var i,n,l,h,u,d=this.strm,p=this.options.chunkSize,_=this.options.dictionary,f=!1;if(this.ended)return!1;n=t===~~t?t:!0===t?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof e?d.input=a.binstring2buf(e):"[object ArrayBuffer]"===c.call(e)?d.input=new Uint8Array(e):d.input=e,d.next_in=0,d.avail_in=d.input.length;do{if(0===d.avail_out&&(d.output=new r.Buf8(p),d.next_out=0,d.avail_out=p),(i=s.inflate(d,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&_&&(i=s.inflateSetDictionary(this.strm,_)),i===o.Z_BUF_ERROR&&!0===f&&(i=o.Z_OK,f=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),this.ended=!0,!1;d.next_out&&(0!==d.avail_out&&i!==o.Z_STREAM_END&&(0!==d.avail_in||n!==o.Z_FINISH&&n!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(l=a.utf8border(d.output,d.next_out),h=d.next_out-l,u=a.buf2string(d.output,l),d.next_out=h,d.avail_out=p-h,h&&r.arraySet(d.output,d.output,l,h,0),this.onData(u)):this.onData(r.shrinkBuf(d.output,d.next_out)))),0===d.avail_in&&0===d.avail_out&&(f=!0)}while((d.avail_in>0||0===d.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(n=o.Z_FINISH),n===o.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):n!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),d.avail_out=0,!0)},u.prototype.onData=function(e){this.chunks.push(e)},u.prototype.onEnd=function(e){e===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},i.Inflate=u,i.inflate=d,i.inflateRaw=function(e,t){return(t=t||{}).raw=!0,d(e,t)},i.ungzip=d},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(e,t,i){"use strict";var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}i.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)r(i,s)&&(e[s]=i[s])}}return e},i.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,i,s,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+s),r);else for(var a=0;a<s;a++)e[r+a]=t[i+a]},flattenChunks:function(e){var t,i,s,r,a,o;for(s=0,t=0,i=e.length;t<i;t++)s+=e[t].length;for(o=new Uint8Array(s),r=0,t=0,i=e.length;t<i;t++)a=e[t],o.set(a,r),r+=a.length;return o}},o={arraySet:function(e,t,i,s,r){for(var a=0;a<s;a++)e[r+a]=t[i+a]},flattenChunks:function(e){return[].concat.apply([],e)}};i.setTyped=function(e){e?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,a)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,o))},i.setTyped(s)},{}],4:[function(e,t,i){"use strict";var s=e("./common"),r=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(e){r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){a=!1}for(var o=new s.Buf8(256),n=0;n<256;n++)o[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;function l(e,t){if(t<65534&&(e.subarray&&a||!e.subarray&&r))return String.fromCharCode.apply(null,s.shrinkBuf(e,t));for(var i="",o=0;o<t;o++)i+=String.fromCharCode(e[o]);return i}o[254]=o[254]=1,i.string2buf=function(e){var t,i,r,a,o,n=e.length,l=0;for(a=0;a<n;a++)55296==(64512&(i=e.charCodeAt(a)))&&a+1<n&&56320==(64512&(r=e.charCodeAt(a+1)))&&(i=65536+(i-55296<<10)+(r-56320),a++),l+=i<128?1:i<2048?2:i<65536?3:4;for(t=new s.Buf8(l),o=0,a=0;o<l;a++)55296==(64512&(i=e.charCodeAt(a)))&&a+1<n&&56320==(64512&(r=e.charCodeAt(a+1)))&&(i=65536+(i-55296<<10)+(r-56320),a++),i<128?t[o++]=i:i<2048?(t[o++]=192|i>>>6,t[o++]=128|63&i):i<65536?(t[o++]=224|i>>>12,t[o++]=128|i>>>6&63,t[o++]=128|63&i):(t[o++]=240|i>>>18,t[o++]=128|i>>>12&63,t[o++]=128|i>>>6&63,t[o++]=128|63&i);return t},i.buf2binstring=function(e){return l(e,e.length)},i.binstring2buf=function(e){for(var t=new s.Buf8(e.length),i=0,r=t.length;i<r;i++)t[i]=e.charCodeAt(i);return t},i.buf2string=function(e,t){var i,s,r,a,n=t||e.length,h=new Array(2*n);for(s=0,i=0;i<n;)if((r=e[i++])<128)h[s++]=r;else if((a=o[r])>4)h[s++]=65533,i+=a-1;else{for(r&=2===a?31:3===a?15:7;a>1&&i<n;)r=r<<6|63&e[i++],a--;a>1?h[s++]=65533:r<65536?h[s++]=r:(r-=65536,h[s++]=55296|r>>10&1023,h[s++]=56320|1023&r)}return l(h,s)},i.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0?t:0===i?t:i+o[e[i]]>t?i:t}},{"./common":3}],5:[function(e,t,i){"use strict";t.exports=function(e,t,i,s){for(var r=65535&e|0,a=e>>>16&65535|0,o=0;0!==i;){i-=o=i>2e3?2e3:i;do{a=a+(r=r+t[s++]|0)|0}while(--o);r%=65521,a%=65521}return r|a<<16|0}},{}],6:[function(e,t,i){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(e,t,i){"use strict";var s=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var s=0;s<8;s++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();t.exports=function(e,t,i,r){var a=s,o=r+i;e^=-1;for(var n=r;n<o;n++)e=e>>>8^a[255&(e^t[n])];return-1^e}},{}],8:[function(e,t,i){"use strict";var s,r=e("../utils/common"),a=e("./trees"),o=e("./adler32"),n=e("./crc32"),l=e("./messages"),h=0,c=1,u=3,d=4,p=5,_=0,f=1,m=-2,g=-3,v=-5,b=-1,y=1,M=2,x=3,w=4,P=0,A=2,E=8,C=9,L=15,R=8,D=286,F=30,S=19,k=2*D+1,T=15,B=3,N=258,I=N+B+1,O=32,V=42,U=69,z=73,G=91,j=103,Y=113,H=666,X=1,W=2,K=3,q=4,Z=3;function $(e,t){return e.msg=l[t],t}function Q(e){return(e<<1)-(e>4?9:0)}function J(e){for(var t=e.length;--t>=0;)e[t]=0}function ee(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(r.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function te(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,ee(e.strm)}function ie(e,t){e.pending_buf[e.pending++]=t}function se(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function re(e,t){var i,s,r=e.max_chain_length,a=e.strstart,o=e.prev_length,n=e.nice_match,l=e.strstart>e.w_size-I?e.strstart-(e.w_size-I):0,h=e.window,c=e.w_mask,u=e.prev,d=e.strstart+N,p=h[a+o-1],_=h[a+o];e.prev_length>=e.good_match&&(r>>=2),n>e.lookahead&&(n=e.lookahead);do{if(h[(i=t)+o]===_&&h[i+o-1]===p&&h[i]===h[a]&&h[++i]===h[a+1]){a+=2,i++;do{}while(h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&h[++a]===h[++i]&&a<d);if(s=N-(d-a),a=d-N,s>o){if(e.match_start=t,o=s,s>=n)break;p=h[a+o-1],_=h[a+o]}}}while((t=u[t&c])>l&&0!=--r);return o<=e.lookahead?o:e.lookahead}function ae(e){var t,i,s,a,l,h,c,u,d,p,_=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=_+(_-I)){r.arraySet(e.window,e.window,_,_,0),e.match_start-=_,e.strstart-=_,e.block_start-=_,t=i=e.hash_size;do{s=e.head[--t],e.head[t]=s>=_?s-_:0}while(--i);t=i=_;do{s=e.prev[--t],e.prev[t]=s>=_?s-_:0}while(--i);a+=_}if(0===e.strm.avail_in)break;if(h=e.strm,c=e.window,u=e.strstart+e.lookahead,d=a,p=void 0,(p=h.avail_in)>d&&(p=d),i=0===p?0:(h.avail_in-=p,r.arraySet(c,h.input,h.next_in,p,u),1===h.state.wrap?h.adler=o(h.adler,c,p,u):2===h.state.wrap&&(h.adler=n(h.adler,c,p,u)),h.next_in+=p,h.total_in+=p,p),e.lookahead+=i,e.lookahead+e.insert>=B)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+B-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<B)););}while(e.lookahead<I&&0!==e.strm.avail_in)}function oe(e,t){for(var i,s;;){if(e.lookahead<I){if(ae(e),e.lookahead<I&&t===h)return X;if(0===e.lookahead)break}if(i=0,e.lookahead>=B&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+B-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-I&&(e.match_length=re(e,i)),e.match_length>=B)if(s=a._tr_tally(e,e.strstart-e.match_start,e.match_length-B),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=B){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+B-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else s=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(te(e,!1),0===e.strm.avail_out))return X}return e.insert=e.strstart<B-1?e.strstart:B-1,t===d?(te(e,!0),0===e.strm.avail_out?K:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?X:W}function ne(e,t){for(var i,s,r;;){if(e.lookahead<I){if(ae(e),e.lookahead<I&&t===h)return X;if(0===e.lookahead)break}if(i=0,e.lookahead>=B&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+B-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=B-1,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-I&&(e.match_length=re(e,i),e.match_length<=5&&(e.strategy===y||e.match_length===B&&e.strstart-e.match_start>4096)&&(e.match_length=B-1)),e.prev_length>=B&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-B,s=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-B),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+B-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=B-1,e.strstart++,s&&(te(e,!1),0===e.strm.avail_out))return X}else if(e.match_available){if((s=a._tr_tally(e,0,e.window[e.strstart-1]))&&te(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return X}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<B-1?e.strstart:B-1,t===d?(te(e,!0),0===e.strm.avail_out?K:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?X:W}function le(e,t,i,s,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=s,this.func=r}function he(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=E,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*k),this.dyn_dtree=new r.Buf16(2*(2*F+1)),this.bl_tree=new r.Buf16(2*(2*S+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(T+1),this.heap=new r.Buf16(2*D+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*D+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function ce(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=A,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?V:Y,e.adler=2===t.wrap?0:1,t.last_flush=h,a._tr_init(t),_):$(e,m)}function ue(e){var t,i=ce(e);return i===_&&((t=e.state).window_size=2*t.w_size,J(t.head),t.max_lazy_match=s[t.level].max_lazy,t.good_match=s[t.level].good_length,t.nice_match=s[t.level].nice_length,t.max_chain_length=s[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=B-1,t.match_available=0,t.ins_h=0),i}function de(e,t,i,s,a,o){if(!e)return m;var n=1;if(t===b&&(t=6),s<0?(n=0,s=-s):s>15&&(n=2,s-=16),a<1||a>C||i!==E||s<8||s>15||t<0||t>9||o<0||o>w)return $(e,m);8===s&&(s=9);var l=new he;return e.state=l,l.strm=e,l.wrap=n,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+B-1)/B),l.window=new r.Buf8(2*l.w_size),l.head=new r.Buf16(l.hash_size),l.prev=new r.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new r.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=o,l.method=i,ue(e)}s=[new le(0,0,0,0,function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(ae(e),0===e.lookahead&&t===h)return X;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var s=e.block_start+i;if((0===e.strstart||e.strstart>=s)&&(e.lookahead=e.strstart-s,e.strstart=s,te(e,!1),0===e.strm.avail_out))return X;if(e.strstart-e.block_start>=e.w_size-I&&(te(e,!1),0===e.strm.avail_out))return X}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?K:q):(e.strstart>e.block_start&&(te(e,!1),e.strm.avail_out),X)}),new le(4,4,8,4,oe),new le(4,5,16,8,oe),new le(4,6,32,32,oe),new le(4,4,16,16,ne),new le(8,16,32,32,ne),new le(8,16,128,128,ne),new le(8,32,128,256,ne),new le(32,128,258,1024,ne),new le(32,258,258,4096,ne)],i.deflateInit=function(e,t){return de(e,t,E,L,R,P)},i.deflateInit2=de,i.deflateReset=ue,i.deflateResetKeep=ce,i.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?m:(e.state.gzhead=t,_):m},i.deflate=function(e,t){var i,r,o,l;if(!e||!e.state||t>p||t<0)return e?$(e,m):m;if(r=e.state,!e.output||!e.input&&0!==e.avail_in||r.status===H&&t!==d)return $(e,0===e.avail_out?v:m);if(r.strm=e,i=r.last_flush,r.last_flush=t,r.status===V)if(2===r.wrap)e.adler=0,ie(r,31),ie(r,139),ie(r,8),r.gzhead?(ie(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),ie(r,255&r.gzhead.time),ie(r,r.gzhead.time>>8&255),ie(r,r.gzhead.time>>16&255),ie(r,r.gzhead.time>>24&255),ie(r,9===r.level?2:r.strategy>=M||r.level<2?4:0),ie(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(ie(r,255&r.gzhead.extra.length),ie(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=n(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=U):(ie(r,0),ie(r,0),ie(r,0),ie(r,0),ie(r,0),ie(r,9===r.level?2:r.strategy>=M||r.level<2?4:0),ie(r,Z),r.status=Y);else{var g=E+(r.w_bits-8<<4)<<8;g|=(r.strategy>=M||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(g|=O),g+=31-g%31,r.status=Y,se(r,g),0!==r.strstart&&(se(r,e.adler>>>16),se(r,65535&e.adler)),e.adler=1}if(r.status===U)if(r.gzhead.extra){for(o=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),ee(e),o=r.pending,r.pending!==r.pending_buf_size));)ie(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=z)}else r.status=z;if(r.status===z)if(r.gzhead.name){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),ee(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,ie(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.gzindex=0,r.status=G)}else r.status=G;if(r.status===G)if(r.gzhead.comment){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),ee(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,ie(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=n(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.status=j)}else r.status=j;if(r.status===j&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&ee(e),r.pending+2<=r.pending_buf_size&&(ie(r,255&e.adler),ie(r,e.adler>>8&255),e.adler=0,r.status=Y)):r.status=Y),0!==r.pending){if(ee(e),0===e.avail_out)return r.last_flush=-1,_}else if(0===e.avail_in&&Q(t)<=Q(i)&&t!==d)return $(e,v);if(r.status===H&&0!==e.avail_in)return $(e,v);if(0!==e.avail_in||0!==r.lookahead||t!==h&&r.status!==H){var b=r.strategy===M?function(e,t){for(var i;;){if(0===e.lookahead&&(ae(e),0===e.lookahead)){if(t===h)return X;break}if(e.match_length=0,i=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(te(e,!1),0===e.strm.avail_out))return X}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?K:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?X:W}(r,t):r.strategy===x?function(e,t){for(var i,s,r,o,n=e.window;;){if(e.lookahead<=N){if(ae(e),e.lookahead<=N&&t===h)return X;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=B&&e.strstart>0&&(s=n[r=e.strstart-1])===n[++r]&&s===n[++r]&&s===n[++r]){o=e.strstart+N;do{}while(s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&r<o);e.match_length=N-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=B?(i=a._tr_tally(e,1,e.match_length-B),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(te(e,!1),0===e.strm.avail_out))return X}return e.insert=0,t===d?(te(e,!0),0===e.strm.avail_out?K:q):e.last_lit&&(te(e,!1),0===e.strm.avail_out)?X:W}(r,t):s[r.level].func(r,t);if(b!==K&&b!==q||(r.status=H),b===X||b===K)return 0===e.avail_out&&(r.last_flush=-1),_;if(b===W&&(t===c?a._tr_align(r):t!==p&&(a._tr_stored_block(r,0,0,!1),t===u&&(J(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),ee(e),0===e.avail_out))return r.last_flush=-1,_}return t!==d?_:r.wrap<=0?f:(2===r.wrap?(ie(r,255&e.adler),ie(r,e.adler>>8&255),ie(r,e.adler>>16&255),ie(r,e.adler>>24&255),ie(r,255&e.total_in),ie(r,e.total_in>>8&255),ie(r,e.total_in>>16&255),ie(r,e.total_in>>24&255)):(se(r,e.adler>>>16),se(r,65535&e.adler)),ee(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?_:f)},i.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==V&&t!==U&&t!==z&&t!==G&&t!==j&&t!==Y&&t!==H?$(e,m):(e.state=null,t===Y?$(e,g):_):m},i.deflateSetDictionary=function(e,t){var i,s,a,n,l,h,c,u,d=t.length;if(!e||!e.state)return m;if(2===(n=(i=e.state).wrap)||1===n&&i.status!==V||i.lookahead)return m;for(1===n&&(e.adler=o(e.adler,t,d,0)),i.wrap=0,d>=i.w_size&&(0===n&&(J(i.head),i.strstart=0,i.block_start=0,i.insert=0),u=new r.Buf8(i.w_size),r.arraySet(u,t,d-i.w_size,i.w_size,0),t=u,d=i.w_size),l=e.avail_in,h=e.next_in,c=e.input,e.avail_in=d,e.next_in=0,e.input=t,ae(i);i.lookahead>=B;){s=i.strstart,a=i.lookahead-(B-1);do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+B-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++}while(--a);i.strstart=s,i.lookahead=B-1,ae(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=B-1,i.match_available=0,e.next_in=h,e.input=c,e.avail_in=l,i.wrap=n,_},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(e,t,i){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(e,t,i){"use strict";t.exports=function(e,t){var i,s,r,a,o,n,l,h,c,u,d,p,_,f,m,g,v,b,y,M,x,w,P,A,E;i=e.state,s=e.next_in,A=e.input,r=s+(e.avail_in-5),a=e.next_out,E=e.output,o=a-(t-e.avail_out),n=a+(e.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,u=i.wnext,d=i.window,p=i.hold,_=i.bits,f=i.lencode,m=i.distcode,g=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{_<15&&(p+=A[s++]<<_,_+=8,p+=A[s++]<<_,_+=8),b=f[p&g];t:for(;;){if(p>>>=y=b>>>24,_-=y,0==(y=b>>>16&255))E[a++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=f[(65535&b)+(p&(1<<y)-1)];continue t}if(32&y){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}M=65535&b,(y&=15)&&(_<y&&(p+=A[s++]<<_,_+=8),M+=p&(1<<y)-1,p>>>=y,_-=y),_<15&&(p+=A[s++]<<_,_+=8,p+=A[s++]<<_,_+=8),b=m[p&v];i:for(;;){if(p>>>=y=b>>>24,_-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=m[(65535&b)+(p&(1<<y)-1)];continue i}e.msg="invalid distance code",i.mode=30;break e}if(x=65535&b,_<(y&=15)&&(p+=A[s++]<<_,(_+=8)<y&&(p+=A[s++]<<_,_+=8)),(x+=p&(1<<y)-1)>l){e.msg="invalid distance too far back",i.mode=30;break e}if(p>>>=y,_-=y,x>(y=a-o)){if((y=x-y)>c&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(w=0,P=d,0===u){if(w+=h-y,y<M){M-=y;do{E[a++]=d[w++]}while(--y);w=a-x,P=E}}else if(u<y){if(w+=h+u-y,(y-=u)<M){M-=y;do{E[a++]=d[w++]}while(--y);if(w=0,u<M){M-=y=u;do{E[a++]=d[w++]}while(--y);w=a-x,P=E}}}else if(w+=u-y,y<M){M-=y;do{E[a++]=d[w++]}while(--y);w=a-x,P=E}for(;M>2;)E[a++]=P[w++],E[a++]=P[w++],E[a++]=P[w++],M-=3;M&&(E[a++]=P[w++],M>1&&(E[a++]=P[w++]))}else{w=a-x;do{E[a++]=E[w++],E[a++]=E[w++],E[a++]=E[w++],M-=3}while(M>2);M&&(E[a++]=E[w++],M>1&&(E[a++]=E[w++]))}break}}break}}while(s<r&&a<n);s-=M=_>>3,p&=(1<<(_-=M<<3))-1,e.next_in=s,e.next_out=a,e.avail_in=s<r?r-s+5:5-(s-r),e.avail_out=a<n?n-a+257:257-(a-n),i.hold=p,i.bits=_}},{}],11:[function(e,t,i){"use strict";var s=e("../utils/common"),r=e("./adler32"),a=e("./crc32"),o=e("./inffast"),n=e("./inftrees"),l=0,h=1,c=2,u=4,d=5,p=6,_=0,f=1,m=2,g=-2,v=-3,b=-4,y=-5,M=8,x=1,w=2,P=3,A=4,E=5,C=6,L=7,R=8,D=9,F=10,S=11,k=12,T=13,B=14,N=15,I=16,O=17,V=18,U=19,z=20,G=21,j=22,Y=23,H=24,X=25,W=26,K=27,q=28,Z=29,$=30,Q=31,J=32,ee=852,te=592,ie=15;function se(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function re(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ae(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=x,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new s.Buf32(ee),t.distcode=t.distdyn=new s.Buf32(te),t.sane=1,t.back=-1,_):g}function oe(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,ae(e)):g}function ne(e,t){var i,s;return e&&e.state?(s=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?g:(null!==s.window&&s.wbits!==t&&(s.window=null),s.wrap=i,s.wbits=t,oe(e))):g}function le(e,t){var i,s;return e?(s=new re,e.state=s,s.window=null,(i=ne(e,t))!==_&&(e.state=null),i):g}var he,ce,ue=!0;function de(e){if(ue){var t;for(he=new s.Buf32(512),ce=new s.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(n(h,e.lens,0,288,he,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;n(c,e.lens,0,32,ce,0,e.work,{bits:5}),ue=!1}e.lencode=he,e.lenbits=9,e.distcode=ce,e.distbits=5}function pe(e,t,i,r){var a,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),r>=o.wsize?(s.arraySet(o.window,t,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((a=o.wsize-o.wnext)>r&&(a=r),s.arraySet(o.window,t,i-r,a,o.wnext),(r-=a)?(s.arraySet(o.window,t,i-r,r,0),o.wnext=r,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0}i.inflateReset=oe,i.inflateReset2=ne,i.inflateResetKeep=ae,i.inflateInit=function(e){return le(e,ie)},i.inflateInit2=le,i.inflate=function(e,t){var i,ee,te,ie,re,ae,oe,ne,le,he,ce,ue,_e,fe,me,ge,ve,be,ye,Me,xe,we,Pe,Ae,Ee=0,Ce=new s.Buf8(4),Le=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return g;(i=e.state).mode===k&&(i.mode=T),re=e.next_out,te=e.output,oe=e.avail_out,ie=e.next_in,ee=e.input,ae=e.avail_in,ne=i.hold,le=i.bits,he=ae,ce=oe,we=_;e:for(;;)switch(i.mode){case x:if(0===i.wrap){i.mode=T;break}for(;le<16;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(2&i.wrap&&35615===ne){i.check=0,Ce[0]=255&ne,Ce[1]=ne>>>8&255,i.check=a(i.check,Ce,2,0),ne=0,le=0,i.mode=w;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&ne)<<8)+(ne>>8))%31){e.msg="incorrect header check",i.mode=$;break}if((15&ne)!==M){e.msg="unknown compression method",i.mode=$;break}if(le-=4,xe=8+(15&(ne>>>=4)),0===i.wbits)i.wbits=xe;else if(xe>i.wbits){e.msg="invalid window size",i.mode=$;break}i.dmax=1<<xe,e.adler=i.check=1,i.mode=512&ne?F:k,ne=0,le=0;break;case w:for(;le<16;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(i.flags=ne,(255&i.flags)!==M){e.msg="unknown compression method",i.mode=$;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=$;break}i.head&&(i.head.text=ne>>8&1),512&i.flags&&(Ce[0]=255&ne,Ce[1]=ne>>>8&255,i.check=a(i.check,Ce,2,0)),ne=0,le=0,i.mode=P;case P:for(;le<32;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.head&&(i.head.time=ne),512&i.flags&&(Ce[0]=255&ne,Ce[1]=ne>>>8&255,Ce[2]=ne>>>16&255,Ce[3]=ne>>>24&255,i.check=a(i.check,Ce,4,0)),ne=0,le=0,i.mode=A;case A:for(;le<16;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.head&&(i.head.xflags=255&ne,i.head.os=ne>>8),512&i.flags&&(Ce[0]=255&ne,Ce[1]=ne>>>8&255,i.check=a(i.check,Ce,2,0)),ne=0,le=0,i.mode=E;case E:if(1024&i.flags){for(;le<16;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.length=ne,i.head&&(i.head.extra_len=ne),512&i.flags&&(Ce[0]=255&ne,Ce[1]=ne>>>8&255,i.check=a(i.check,Ce,2,0)),ne=0,le=0}else i.head&&(i.head.extra=null);i.mode=C;case C:if(1024&i.flags&&((ue=i.length)>ae&&(ue=ae),ue&&(i.head&&(xe=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,ee,ie,ue,xe)),512&i.flags&&(i.check=a(i.check,ee,ue,ie)),ae-=ue,ie+=ue,i.length-=ue),i.length))break e;i.length=0,i.mode=L;case L:if(2048&i.flags){if(0===ae)break e;ue=0;do{xe=ee[ie+ue++],i.head&&xe&&i.length<65536&&(i.head.name+=String.fromCharCode(xe))}while(xe&&ue<ae);if(512&i.flags&&(i.check=a(i.check,ee,ue,ie)),ae-=ue,ie+=ue,xe)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=R;case R:if(4096&i.flags){if(0===ae)break e;ue=0;do{xe=ee[ie+ue++],i.head&&xe&&i.length<65536&&(i.head.comment+=String.fromCharCode(xe))}while(xe&&ue<ae);if(512&i.flags&&(i.check=a(i.check,ee,ue,ie)),ae-=ue,ie+=ue,xe)break e}else i.head&&(i.head.comment=null);i.mode=D;case D:if(512&i.flags){for(;le<16;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(ne!==(65535&i.check)){e.msg="header crc mismatch",i.mode=$;break}ne=0,le=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=k;break;case F:for(;le<32;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}e.adler=i.check=se(ne),ne=0,le=0,i.mode=S;case S:if(0===i.havedict)return e.next_out=re,e.avail_out=oe,e.next_in=ie,e.avail_in=ae,i.hold=ne,i.bits=le,m;e.adler=i.check=1,i.mode=k;case k:if(t===d||t===p)break e;case T:if(i.last){ne>>>=7&le,le-=7&le,i.mode=K;break}for(;le<3;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}switch(i.last=1&ne,le-=1,3&(ne>>>=1)){case 0:i.mode=B;break;case 1:if(de(i),i.mode=z,t===p){ne>>>=2,le-=2;break e}break;case 2:i.mode=O;break;case 3:e.msg="invalid block type",i.mode=$}ne>>>=2,le-=2;break;case B:for(ne>>>=7&le,le-=7&le;le<32;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if((65535&ne)!=(ne>>>16^65535)){e.msg="invalid stored block lengths",i.mode=$;break}if(i.length=65535&ne,ne=0,le=0,i.mode=N,t===p)break e;case N:i.mode=I;case I:if(ue=i.length){if(ue>ae&&(ue=ae),ue>oe&&(ue=oe),0===ue)break e;s.arraySet(te,ee,ie,ue,re),ae-=ue,ie+=ue,oe-=ue,re+=ue,i.length-=ue;break}i.mode=k;break;case O:for(;le<14;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(i.nlen=257+(31&ne),ne>>>=5,le-=5,i.ndist=1+(31&ne),ne>>>=5,le-=5,i.ncode=4+(15&ne),ne>>>=4,le-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=$;break}i.have=0,i.mode=V;case V:for(;i.have<i.ncode;){for(;le<3;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.lens[Le[i.have++]]=7&ne,ne>>>=3,le-=3}for(;i.have<19;)i.lens[Le[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,Pe={bits:i.lenbits},we=n(l,i.lens,0,19,i.lencode,0,i.work,Pe),i.lenbits=Pe.bits,we){e.msg="invalid code lengths set",i.mode=$;break}i.have=0,i.mode=U;case U:for(;i.have<i.nlen+i.ndist;){for(;ge=(Ee=i.lencode[ne&(1<<i.lenbits)-1])>>>16&255,ve=65535&Ee,!((me=Ee>>>24)<=le);){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(ve<16)ne>>>=me,le-=me,i.lens[i.have++]=ve;else{if(16===ve){for(Ae=me+2;le<Ae;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(ne>>>=me,le-=me,0===i.have){e.msg="invalid bit length repeat",i.mode=$;break}xe=i.lens[i.have-1],ue=3+(3&ne),ne>>>=2,le-=2}else if(17===ve){for(Ae=me+3;le<Ae;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}le-=me,xe=0,ue=3+(7&(ne>>>=me)),ne>>>=3,le-=3}else{for(Ae=me+7;le<Ae;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}le-=me,xe=0,ue=11+(127&(ne>>>=me)),ne>>>=7,le-=7}if(i.have+ue>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=$;break}for(;ue--;)i.lens[i.have++]=xe}}if(i.mode===$)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=$;break}if(i.lenbits=9,Pe={bits:i.lenbits},we=n(h,i.lens,0,i.nlen,i.lencode,0,i.work,Pe),i.lenbits=Pe.bits,we){e.msg="invalid literal/lengths set",i.mode=$;break}if(i.distbits=6,i.distcode=i.distdyn,Pe={bits:i.distbits},we=n(c,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,Pe),i.distbits=Pe.bits,we){e.msg="invalid distances set",i.mode=$;break}if(i.mode=z,t===p)break e;case z:i.mode=G;case G:if(ae>=6&&oe>=258){e.next_out=re,e.avail_out=oe,e.next_in=ie,e.avail_in=ae,i.hold=ne,i.bits=le,o(e,ce),re=e.next_out,te=e.output,oe=e.avail_out,ie=e.next_in,ee=e.input,ae=e.avail_in,ne=i.hold,le=i.bits,i.mode===k&&(i.back=-1);break}for(i.back=0;ge=(Ee=i.lencode[ne&(1<<i.lenbits)-1])>>>16&255,ve=65535&Ee,!((me=Ee>>>24)<=le);){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(ge&&0==(240&ge)){for(be=me,ye=ge,Me=ve;ge=(Ee=i.lencode[Me+((ne&(1<<be+ye)-1)>>be)])>>>16&255,ve=65535&Ee,!(be+(me=Ee>>>24)<=le);){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}ne>>>=be,le-=be,i.back+=be}if(ne>>>=me,le-=me,i.back+=me,i.length=ve,0===ge){i.mode=W;break}if(32&ge){i.back=-1,i.mode=k;break}if(64&ge){e.msg="invalid literal/length code",i.mode=$;break}i.extra=15&ge,i.mode=j;case j:if(i.extra){for(Ae=i.extra;le<Ae;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.length+=ne&(1<<i.extra)-1,ne>>>=i.extra,le-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=Y;case Y:for(;ge=(Ee=i.distcode[ne&(1<<i.distbits)-1])>>>16&255,ve=65535&Ee,!((me=Ee>>>24)<=le);){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(0==(240&ge)){for(be=me,ye=ge,Me=ve;ge=(Ee=i.distcode[Me+((ne&(1<<be+ye)-1)>>be)])>>>16&255,ve=65535&Ee,!(be+(me=Ee>>>24)<=le);){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}ne>>>=be,le-=be,i.back+=be}if(ne>>>=me,le-=me,i.back+=me,64&ge){e.msg="invalid distance code",i.mode=$;break}i.offset=ve,i.extra=15&ge,i.mode=H;case H:if(i.extra){for(Ae=i.extra;le<Ae;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}i.offset+=ne&(1<<i.extra)-1,ne>>>=i.extra,le-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=$;break}i.mode=X;case X:if(0===oe)break e;if(ue=ce-oe,i.offset>ue){if((ue=i.offset-ue)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=$;break}ue>i.wnext?(ue-=i.wnext,_e=i.wsize-ue):_e=i.wnext-ue,ue>i.length&&(ue=i.length),fe=i.window}else fe=te,_e=re-i.offset,ue=i.length;ue>oe&&(ue=oe),oe-=ue,i.length-=ue;do{te[re++]=fe[_e++]}while(--ue);0===i.length&&(i.mode=G);break;case W:if(0===oe)break e;te[re++]=i.length,oe--,i.mode=G;break;case K:if(i.wrap){for(;le<32;){if(0===ae)break e;ae--,ne|=ee[ie++]<<le,le+=8}if(ce-=oe,e.total_out+=ce,i.total+=ce,ce&&(e.adler=i.check=i.flags?a(i.check,te,ce,re-ce):r(i.check,te,ce,re-ce)),ce=oe,(i.flags?ne:se(ne))!==i.check){e.msg="incorrect data check",i.mode=$;break}ne=0,le=0}i.mode=q;case q:if(i.wrap&&i.flags){for(;le<32;){if(0===ae)break e;ae--,ne+=ee[ie++]<<le,le+=8}if(ne!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=$;break}ne=0,le=0}i.mode=Z;case Z:we=f;break e;case $:we=v;break e;case Q:return b;case J:default:return g}return e.next_out=re,e.avail_out=oe,e.next_in=ie,e.avail_in=ae,i.hold=ne,i.bits=le,(i.wsize||ce!==e.avail_out&&i.mode<$&&(i.mode<K||t!==u))&&pe(e,e.output,e.next_out,ce-e.avail_out)?(i.mode=Q,b):(he-=e.avail_in,ce-=e.avail_out,e.total_in+=he,e.total_out+=ce,i.total+=ce,i.wrap&&ce&&(e.adler=i.check=i.flags?a(i.check,te,ce,e.next_out-ce):r(i.check,te,ce,e.next_out-ce)),e.data_type=i.bits+(i.last?64:0)+(i.mode===k?128:0)+(i.mode===z||i.mode===N?256:0),(0===he&&0===ce||t===u)&&we===_&&(we=y),we)},i.inflateEnd=function(e){if(!e||!e.state)return g;var t=e.state;return t.window&&(t.window=null),e.state=null,_},i.inflateGetHeader=function(e,t){var i;return e&&e.state?0==(2&(i=e.state).wrap)?g:(i.head=t,t.done=!1,_):g},i.inflateSetDictionary=function(e,t){var i,s=t.length;return e&&e.state?0!==(i=e.state).wrap&&i.mode!==S?g:i.mode===S&&r(1,t,s,0)!==i.check?v:pe(e,t,s,s)?(i.mode=Q,b):(i.havedict=1,_):g},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(e,t,i){"use strict";var s=e("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],n=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,i,l,h,c,u,d){var p,_,f,m,g,v,b,y,M,x=d.bits,w=0,P=0,A=0,E=0,C=0,L=0,R=0,D=0,F=0,S=0,k=null,T=0,B=new s.Buf16(16),N=new s.Buf16(16),I=null,O=0;for(w=0;w<=15;w++)B[w]=0;for(P=0;P<l;P++)B[t[i+P]]++;for(C=x,E=15;E>=1&&0===B[E];E--);if(C>E&&(C=E),0===E)return h[c++]=20971520,h[c++]=20971520,d.bits=1,0;for(A=1;A<E&&0===B[A];A++);for(C<A&&(C=A),D=1,w=1;w<=15;w++)if(D<<=1,(D-=B[w])<0)return-1;if(D>0&&(0===e||1!==E))return-1;for(N[1]=0,w=1;w<15;w++)N[w+1]=N[w]+B[w];for(P=0;P<l;P++)0!==t[i+P]&&(u[N[t[i+P]]++]=P);if(0===e?(k=I=u,v=19):1===e?(k=r,T-=257,I=a,O-=257,v=256):(k=o,I=n,v=-1),S=0,P=0,w=A,g=c,L=C,R=0,f=-1,m=(F=1<<C)-1,1===e&&F>852||2===e&&F>592)return 1;for(;;){b=w-R,u[P]<v?(y=0,M=u[P]):u[P]>v?(y=I[O+u[P]],M=k[T+u[P]]):(y=96,M=0),p=1<<w-R,A=_=1<<L;do{h[g+(S>>R)+(_-=p)]=b<<24|y<<16|M|0}while(0!==_);for(p=1<<w-1;S&p;)p>>=1;if(0!==p?(S&=p-1,S+=p):S=0,P++,0==--B[w]){if(w===E)break;w=t[i+u[P]]}if(w>C&&(S&m)!==f){for(0===R&&(R=C),g+=A,D=1<<(L=w-R);L+R<E&&!((D-=B[L+R])<=0);)L++,D<<=1;if(F+=1<<L,1===e&&F>852||2===e&&F>592)return 1;h[f=S&m]=C<<24|L<<16|g-c|0}}return 0!==S&&(h[g+S]=w-R<<24|64<<16|0),d.bits=C,0}},{"../utils/common":3}],13:[function(e,t,i){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(e,t,i){"use strict";var s=e("../utils/common"),r=4,a=0,o=1,n=2;function l(e){for(var t=e.length;--t>=0;)e[t]=0}var h=0,c=1,u=2,d=29,p=256,_=p+1+d,f=30,m=19,g=2*_+1,v=15,b=16,y=7,M=256,x=16,w=17,P=18,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],E=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],C=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],R=new Array(2*(_+2));l(R);var D=new Array(2*f);l(D);var F=new Array(512);l(F);var S=new Array(256);l(S);var k=new Array(d);l(k);var T,B,N,I=new Array(f);function O(e,t,i,s,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=s,this.max_length=r,this.has_stree=e&&e.length}function V(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function U(e){return e<256?F[e]:F[256+(e>>>7)]}function z(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function G(e,t,i){e.bi_valid>b-i?(e.bi_buf|=t<<e.bi_valid&65535,z(e,e.bi_buf),e.bi_buf=t>>b-e.bi_valid,e.bi_valid+=i-b):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function j(e,t,i){G(e,i[2*t],i[2*t+1])}function Y(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function H(e,t,i){var s,r,a=new Array(v+1),o=0;for(s=1;s<=v;s++)a[s]=o=o+i[s-1]<<1;for(r=0;r<=t;r++){var n=e[2*r+1];0!==n&&(e[2*r]=Y(a[n]++,n))}}function X(e){var t;for(t=0;t<_;t++)e.dyn_ltree[2*t]=0;for(t=0;t<f;t++)e.dyn_dtree[2*t]=0;for(t=0;t<m;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*M]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function W(e){e.bi_valid>8?z(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function K(e,t,i,s){var r=2*t,a=2*i;return e[r]<e[a]||e[r]===e[a]&&s[t]<=s[i]}function q(e,t,i){for(var s=e.heap[i],r=i<<1;r<=e.heap_len&&(r<e.heap_len&&K(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!K(t,s,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=s}function Z(e,t,i){var s,r,a,o,n=0;if(0!==e.last_lit)do{s=e.pending_buf[e.d_buf+2*n]<<8|e.pending_buf[e.d_buf+2*n+1],r=e.pending_buf[e.l_buf+n],n++,0===s?j(e,r,t):(j(e,(a=S[r])+p+1,t),0!==(o=A[a])&&G(e,r-=k[a],o),j(e,a=U(--s),i),0!==(o=E[a])&&G(e,s-=I[a],o))}while(n<e.last_lit);j(e,M,t)}function $(e,t){var i,s,r,a=t.dyn_tree,o=t.stat_desc.static_tree,n=t.stat_desc.has_stree,l=t.stat_desc.elems,h=-1;for(e.heap_len=0,e.heap_max=g,i=0;i<l;i++)0!==a[2*i]?(e.heap[++e.heap_len]=h=i,e.depth[i]=0):a[2*i+1]=0;for(;e.heap_len<2;)a[2*(r=e.heap[++e.heap_len]=h<2?++h:0)]=1,e.depth[r]=0,e.opt_len--,n&&(e.static_len-=o[2*r+1]);for(t.max_code=h,i=e.heap_len>>1;i>=1;i--)q(e,a,i);r=l;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],q(e,a,1),s=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=s,a[2*r]=a[2*i]+a[2*s],e.depth[r]=(e.depth[i]>=e.depth[s]?e.depth[i]:e.depth[s])+1,a[2*i+1]=a[2*s+1]=r,e.heap[1]=r++,q(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,s,r,a,o,n,l=t.dyn_tree,h=t.max_code,c=t.stat_desc.static_tree,u=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,_=t.stat_desc.max_length,f=0;for(a=0;a<=v;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<g;i++)(a=l[2*l[2*(s=e.heap[i])+1]+1]+1)>_&&(a=_,f++),l[2*s+1]=a,s>h||(e.bl_count[a]++,o=0,s>=p&&(o=d[s-p]),n=l[2*s],e.opt_len+=n*(a+o),u&&(e.static_len+=n*(c[2*s+1]+o)));if(0!==f){do{for(a=_-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[_]--,f-=2}while(f>0);for(a=_;0!==a;a--)for(s=e.bl_count[a];0!==s;)(r=e.heap[--i])>h||(l[2*r+1]!==a&&(e.opt_len+=(a-l[2*r+1])*l[2*r],l[2*r+1]=a),s--)}}(e,t),H(a,h,e.bl_count)}function Q(e,t,i){var s,r,a=-1,o=t[1],n=0,l=7,h=4;for(0===o&&(l=138,h=3),t[2*(i+1)+1]=65535,s=0;s<=i;s++)r=o,o=t[2*(s+1)+1],++n<l&&r===o||(n<h?e.bl_tree[2*r]+=n:0!==r?(r!==a&&e.bl_tree[2*r]++,e.bl_tree[2*x]++):n<=10?e.bl_tree[2*w]++:e.bl_tree[2*P]++,n=0,a=r,0===o?(l=138,h=3):r===o?(l=6,h=3):(l=7,h=4))}function J(e,t,i){var s,r,a=-1,o=t[1],n=0,l=7,h=4;for(0===o&&(l=138,h=3),s=0;s<=i;s++)if(r=o,o=t[2*(s+1)+1],!(++n<l&&r===o)){if(n<h)do{j(e,r,e.bl_tree)}while(0!=--n);else 0!==r?(r!==a&&(j(e,r,e.bl_tree),n--),j(e,x,e.bl_tree),G(e,n-3,2)):n<=10?(j(e,w,e.bl_tree),G(e,n-3,3)):(j(e,P,e.bl_tree),G(e,n-11,7));n=0,a=r,0===o?(l=138,h=3):r===o?(l=6,h=3):(l=7,h=4)}}l(I);var ee=!1;function te(e,t,i,r){G(e,(h<<1)+(r?1:0),3),function(e,t,i,r){W(e),r&&(z(e,i),z(e,~i)),s.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}(e,t,i,!0)}i._tr_init=function(e){ee||(function(){var e,t,i,s,r,a=new Array(v+1);for(i=0,s=0;s<d-1;s++)for(k[s]=i,e=0;e<1<<A[s];e++)S[i++]=s;for(S[i-1]=s,r=0,s=0;s<16;s++)for(I[s]=r,e=0;e<1<<E[s];e++)F[r++]=s;for(r>>=7;s<f;s++)for(I[s]=r<<7,e=0;e<1<<E[s]-7;e++)F[256+r++]=s;for(t=0;t<=v;t++)a[t]=0;for(e=0;e<=143;)R[2*e+1]=8,e++,a[8]++;for(;e<=255;)R[2*e+1]=9,e++,a[9]++;for(;e<=279;)R[2*e+1]=7,e++,a[7]++;for(;e<=287;)R[2*e+1]=8,e++,a[8]++;for(H(R,_+1,a),e=0;e<f;e++)D[2*e+1]=5,D[2*e]=Y(e,5);T=new O(R,A,p+1,_,v),B=new O(D,E,0,f,v),N=new O(new Array(0),C,0,m,y)}(),ee=!0),e.l_desc=new V(e.dyn_ltree,T),e.d_desc=new V(e.dyn_dtree,B),e.bl_desc=new V(e.bl_tree,N),e.bi_buf=0,e.bi_valid=0,X(e)},i._tr_stored_block=te,i._tr_flush_block=function(e,t,i,s){var l,h,d=0;e.level>0?(e.strm.data_type===n&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return o;for(t=32;t<p;t++)if(0!==e.dyn_ltree[2*t])return o;return a}(e)),$(e,e.l_desc),$(e,e.d_desc),d=function(e){var t;for(Q(e,e.dyn_ltree,e.l_desc.max_code),Q(e,e.dyn_dtree,e.d_desc.max_code),$(e,e.bl_desc),t=m-1;t>=3&&0===e.bl_tree[2*L[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),l=e.opt_len+3+7>>>3,(h=e.static_len+3+7>>>3)<=l&&(l=h)):l=h=i+5,i+4<=l&&-1!==t?te(e,t,i,s):e.strategy===r||h===l?(G(e,(c<<1)+(s?1:0),3),Z(e,R,D)):(G(e,(u<<1)+(s?1:0),3),function(e,t,i,s){var r;for(G(e,t-257,5),G(e,i-1,5),G(e,s-4,4),r=0;r<s;r++)G(e,e.bl_tree[2*L[r]+1],3);J(e,e.dyn_ltree,t-1),J(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,d+1),Z(e,e.dyn_ltree,e.dyn_dtree)),X(e),s&&W(e)},i._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(S[i]+p+1)]++,e.dyn_dtree[2*U(t)]++),e.last_lit===e.lit_bufsize-1},i._tr_align=function(e){G(e,c<<1,3),j(e,M,R),function(e){16===e.bi_valid?(z(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},{"../utils/common":3}],15:[function(e,t,i){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(e,t,i){"use strict";var s={};(0,e("./lib/utils/common").assign)(s,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=s},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")},function(e,t,i){"use strict";i.r(t);class s{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const r={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var a=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(e){for(var t=[],i=e[0].charCodeAt(0),s=i+e[1],r=i;r<s;++r)t.push(r);return String.fromCharCode.apply(null,t)}).join("");function o(e,t){return(t&&4!==t?[0,6]:[0,6,12,18]).map(function(t){return a.substr(parseInt(e/(1<<t))%64,1)}).reverse().join("")}const n={xmlToJson:function e(t,i){if(t.nodeType===t.TEXT_NODE){var s=t.nodeValue;if(null===s.match(/^\s+$/))return s}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var r={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var a=0;a<t.attributes.length;a++){var o=t.attributes[a];r[i[o.nodeName]||o.nodeName]=o.nodeValue}for(var n=0;n<t.childNodes.length;n++)(a=e(t.childNodes[n],i))&&r.children.push(a);return r}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(t){return parseInt(e.substr(t,2),16)});return o(t[0],2)+[1,4,7,10,13].map(function(e){return o((t[e]<<16)+(t[e+1]<<8)+t[e+2])}).join("")},findNodeOfType:function(e,t){var i=[],s=function(e){e.type===t&&i.push(e),(e.children||[]).forEach(function(e){s(e)})};return s(e),i},timeout:function(e){return new Promise(function(t,i){setTimeout(t,e)})},httpRequest:function(e){return new Promise(function(t,i){var s=new XMLHttpRequest;s.open(e.method||"GET",e.url,!0),s.onload=function(r){console.log(e.url,s.readyState,s.status),4===s.readyState&&(200===s.status?t(s.responseXML):i(s.statusText))},s.send(null)})},loadJSON:function(e,t,i){var s=e=>void 0;t=t||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.addEventListener("load",function(e){var s=e.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}t(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(s))}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}}else i(e)},!1),r.addEventListener("error",function(e){i(e)},!1),r.send(null)},loadArraybuffer:function(e,t,i){var s=e=>void 0;t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var a=r[3];a=window.decodeURIComponent(a),e&&(a=window.atob(a));try{const e=new ArrayBuffer(a.length),s=new Uint8Array(e);for(var o=0;o<a.length;o++)s[o]=a.charCodeAt(o);window.setTimeout(function(){t(e)},0)}catch(e){window.setTimeout(function(){i(e)},0)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:function(){for(var e={},t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(void 0===e[s[0]])e[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof e[s[0]]){var r=[e[s[0]],decodeURIComponent(s[1])];e[s[0]]=r}else e[s[0]].push(decodeURIComponent(s[1]))}return e}(),isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},isString:function(e){return"string"==typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return n.isString(e)||n.isNumeric(e)},isSameComponent:function(e,t){return!(!e||!t)&&(n.isNumeric(e)||n.isString(e)?`${e}`:e.id)===(n.isNumeric(t)||n.isString(t)?`${t}`:t.id)},isFunction:function(e){return"function"==typeof e},isObject:function(e){const t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return n.apply(e,{})},apply:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(const i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return n.isNumeric(e)?`${e}`:`'${e}'`},concat:function(e,t){const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},flattenParentChildHierarchy:function(e){var t=[];return function e(i){i.id=i.uuid,delete i.oid,t.push(i);var s=i.children;if(s)for(var r=0,a=s.length;r<a;r++)s[r].parent=i.id,e(s[r]);i.children=[]}(e),console.log(JSON.stringify(t,null,"\t")),t}},l={},h=new s,c=new class{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}},u={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},d=10,p=[];let _,f=null,m=0,g=0;const v=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this.getDefaultScene=function(){return f||(f=new Oe({id:"default.scene"})),f},this.setDefaultScene=function(e){return f=e},this._addScene=function(e){if(e.id){if(v.scenes[e.id])return void console.error(`[ERROR] Scene ${n.inQuotes(e.id)} already exists`)}else e.id=h.addItem({});v.scenes[e.id]=e;const t=e.ticksPerOcclusionTest,i=e.ticksPerRender;l[e.id]={ticksPerOcclusionTest:t,occlusionTestCountdown:t,ticksPerRender:i,renderCountdown:i},r.components.scenes++,e.once("destroyed",()=>{h.removeItem(e.id),delete v.scenes[e.id],delete l[e.id],r.components.scenes--})},this.clear=function(){let e;for(const t in v.scenes)v.scenes.hasOwnProperty(t)&&(e=v.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete v.scenes[e.id]))},this.scheduleTask=function(e,t){c.push(e),c.push(t)},this.runTasks=function(e=-1){let t,i,s=(new Date).getTime(),r=0;for(;c.length>0&&(e<0||s<e);)t=c.shift(),(i=c.shift())?t.call(i):t(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return c.length}},b=function(){let e=Date.now();if(m>0){var t=1e3/(_=e-m);g+=t,p.push(t),p.length>=30&&(g-=p.shift()),r.frame.fps=Math.round(g/p.length)}!function(e){const t=v.runTasks(e+d),i=v.getNumTasks();r.frame.tasksRun=t,r.frame.tasksScheduled=i,r.frame.tasksBudget=d}(e),function(e){for(var t in u.time=e,v.scenes)if(v.scenes.hasOwnProperty(t)){var i=v.scenes[t];u.sceneId=t,u.startTime=i.startTime,u.deltaTime=null!=u.prevTime?u.time-u.prevTime:0,i.fire("tick",u,!0)}u.prevTime=e}(e),function(){const e=v.scenes;let t,i,s,r,a;for(a in e)e.hasOwnProperty(a)&&(t=e[a],(i=l[a])||(i=l[a]={}),s=t.ticksPerOcclusionTest,i.ticksPerOcclusionTest!==s&&(i.ticksPerOcclusionTest=s,i.renderCountdown=s),0==--i.occlusionTestCountdown&&(t.doOcclusionTest(),i.occlusionTestCountdown=s),r=t.ticksPerRender,i.ticksPerRender!==r&&(i.ticksPerRender=r,i.renderCountdown=r),0==--i.renderCountdown&&(t.render(!1),i.renderCountdown=r))}(),m=e,window.requestAnimationFrame(b)};window.requestAnimationFrame(b);const y=new Float32Array(16),M=new Float32Array(16),x=new Float32Array(4),w={MAX_DOUBLE:Number.MAX_VALUE,MIN_DOUBLE:Number.MIN_VALUE,DEGTORAD:.0174532925,RADTODEG:57.295779513,vec2:e=>new Float32Array(e||2),vec3:e=>new Float32Array(e||3),vec4:e=>new Float32Array(e||4),mat3:e=>new Float32Array(e||9),mat3ToMat4:(e,t=new Float32Array(16))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),mat4:e=>new Float32Array(e||16),mat4ToMat3(e,t){},createUUID:(()=>{const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return()=>{const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]}-${e[255&i]}${e[i>>8&255]}-${e[i>>16&15|64]}${e[i>>24&255]}-${e[63&s|128]}${e[s>>8&255]}-${e[s>>16&255]}${e[s>>24&255]}${e[255&r]}${e[r>>8&255]}${e[r>>16&255]}${e[r>>24&255]}`}})(),clamp:(e,t,i)=>Math.max(t,Math.min(i,e)),fmod(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},negateVec4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t),addVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i),addVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i),addVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i),addVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i),subVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i),subVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i),subVec2:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i),subVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i),subScalarVec4:(e,t,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i),mulVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i),mulVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i),mulVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i),mulVec2Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i),divVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i),divVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i),divScalarVec3:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i),divVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i),divVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i),divScalarVec4:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i),dotVec4:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],cross3Vec4(e,t){const i=e[0],s=e[1],r=e[2],a=t[0],o=t[1],n=t[2];return[s*n-r*o,r*a-i*n,i*o-s*a,0]},cross3Vec3(e,t,i){i||(i=e);const s=e[0],r=e[1],a=e[2],o=t[0],n=t[1],l=t[2];return i[0]=r*l-a*n,i[1]=a*o-s*l,i[2]=s*n-r*o,i},sqLenVec4:e=>w.dotVec4(e,e),lenVec4:e=>Math.sqrt(w.sqLenVec4(e)),dotVec3:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],dotVec2:(e,t)=>e[0]*t[0]+e[1]*t[1],sqLenVec3:e=>w.dotVec3(e,e),sqLenVec2:e=>w.dotVec2(e,e),lenVec3:e=>Math.sqrt(w.sqLenVec3(e)),distVec3:(()=>{const e=new Float32Array(3);return(t,i)=>w.lenVec3(w.subVec3(t,i,e))})(),lenVec2:e=>Math.sqrt(w.sqLenVec2(e)),distVec2:(()=>{const e=new Float32Array(2);return(t,i)=>w.lenVec2(w.subVec2(t,i,e))})(),rcpVec3:(e,t)=>w.divScalarVec3(1,e,t),normalizeVec4(e,t){const i=1/w.lenVec4(e);return w.mulVec4Scalar(e,i,t)},normalizeVec3(e,t){const i=1/w.lenVec3(e);return w.mulVec3Scalar(e,i,t)},normalizeVec2(e,t){const i=1/w.lenVec2(e);return w.mulVec2Scalar(e,i,t)},angleVec3(e,t){let i=w.dotVec3(e,t)/Math.sqrt(w.sqLenVec3(e)*w.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const e=new Float32Array(3);return(t,i)=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=w.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=w.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=w.lenVec3(e),i)})(),vecToArray:(()=>{function e(e){return Math.round(1e5*e)/1e5}return t=>{for(let i=0,s=(t=Array.prototype.slice.call(t)).length;i<s;i++)t[i]=e(t[i]);return t}})(),xyzArrayToObject:e=>({x:e[0],y:e[1],z:e[2]}),xyzObjectToArray:(e,t)=>((t=t||new Float32Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t),dupMat4:e=>e.slice(0,16),mat4To3:e=>[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],m4s:e=>[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],setMat4ToZeroes:()=>w.m4s(0),setMat4ToOnes:()=>w.m4s(1),diagonalMat4v:e=>new Float32Array([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]),diagonalMat4c:(e,t,i,s)=>w.diagonalMat4v([e,t,i,s]),diagonalMat4s:e=>w.diagonalMat4c(e,e,e,e),identityMat4:(e=new Float32Array(16))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),identityMat3:(e=new Float32Array(9))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e),isIdentityMat4:e=>1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15],negateMat4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t),addMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i),addMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i),addScalarMat4:(e,t,i)=>w.addMat4Scalar(t,e,i),subMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i),subMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i),subScalarMat4:(e,t,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i),mulMat4(e,t,i){i||(i=e);const s=e[0],r=e[1],a=e[2],o=e[3],n=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],p=e[10],_=e[11],f=e[12],m=e[13],g=e[14],v=e[15],b=t[0],y=t[1],M=t[2],x=t[3],w=t[4],P=t[5],A=t[6],E=t[7],C=t[8],L=t[9],R=t[10],D=t[11],F=t[12],S=t[13],k=t[14],T=t[15];return i[0]=b*s+y*n+M*u+x*f,i[1]=b*r+y*l+M*d+x*m,i[2]=b*a+y*h+M*p+x*g,i[3]=b*o+y*c+M*_+x*v,i[4]=w*s+P*n+A*u+E*f,i[5]=w*r+P*l+A*d+E*m,i[6]=w*a+P*h+A*p+E*g,i[7]=w*o+P*c+A*_+E*v,i[8]=C*s+L*n+R*u+D*f,i[9]=C*r+L*l+R*d+D*m,i[10]=C*a+L*h+R*p+D*g,i[11]=C*o+L*c+R*_+D*v,i[12]=F*s+S*n+k*u+T*f,i[13]=F*r+S*l+k*d+T*m,i[14]=F*a+S*h+k*p+T*g,i[15]=F*o+S*c+k*_+T*v,i},mulMat3(e,t,i){i||(i=new Float32Array(9));const s=e[0],r=e[3],a=e[6],o=e[1],n=e[4],l=e[7],h=e[2],c=e[5],u=e[8],d=t[0],p=t[3],_=t[6],f=t[1],m=t[4],g=t[7],v=t[2],b=t[5],y=t[8];return i[0]=s*d+r*f+a*v,i[3]=s*p+r*m+a*b,i[6]=s*_+r*g+a*y,i[1]=o*d+n*f+l*v,i[4]=o*p+n*m+l*b,i[7]=o*_+n*g+l*y,i[2]=h*d+c*f+u*v,i[5]=h*p+c*m+u*b,i[8]=h*_+c*g+u*y,i},mulMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i),mulMat4v4(e,t,i=w.vec4()){const s=t[0],r=t[1],a=t[2],o=t[3];return i[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*o,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*o,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*o,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*o,i},transposeMat4(e,t){const i=e[4],s=e[14],r=e[8],a=e[13],o=e[12],n=e[9];if(!t||e===t){const t=e[1],l=e[2],h=e[3],c=e[6],u=e[7],d=e[11];return e[1]=i,e[2]=r,e[3]=o,e[4]=t,e[6]=n,e[7]=a,e[8]=l,e[9]=c,e[11]=s,e[12]=h,e[13]=u,e[14]=d,e}return t[0]=e[0],t[1]=i,t[2]=r,t[3]=o,t[4]=e[1],t[5]=e[5],t[6]=n,t[7]=a,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=s,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3(e,t){if(t===e){const i=e[1],s=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4(e){const t=e[0],i=e[1],s=e[2],r=e[3],a=e[4],o=e[5],n=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],p=e[12],_=e[13],f=e[14],m=e[15];return p*c*n*r-h*_*n*r-p*o*u*r+a*_*u*r+h*o*f*r-a*c*f*r-p*c*s*l+h*_*s*l+p*i*u*l-t*_*u*l-h*i*f*l+t*c*f*l+p*o*s*d-a*_*s*d-p*i*n*d+t*_*n*d+a*i*f*d-t*o*f*d-h*o*s*m+a*c*s*m+h*i*n*m-t*c*n*m-a*i*u*m+t*o*u*m},inverseMat4(e,t){t||(t=e);const i=e[0],s=e[1],r=e[2],a=e[3],o=e[4],n=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],_=e[12],f=e[13],m=e[14],g=e[15],v=i*n-s*o,b=i*l-r*o,y=i*h-a*o,M=s*l-r*n,x=s*h-a*n,w=r*h-a*l,P=c*f-u*_,A=c*m-d*_,E=c*g-p*_,C=u*m-d*f,L=u*g-p*f,R=d*g-p*m,D=1/(v*R-b*L+y*C+M*E-x*A+w*P);return t[0]=(n*R-l*L+h*C)*D,t[1]=(-s*R+r*L-a*C)*D,t[2]=(f*w-m*x+g*M)*D,t[3]=(-u*w+d*x-p*M)*D,t[4]=(-o*R+l*E-h*A)*D,t[5]=(i*R-r*E+a*A)*D,t[6]=(-_*w+m*y-g*b)*D,t[7]=(c*w-d*y+p*b)*D,t[8]=(o*L-n*E+h*P)*D,t[9]=(-i*L+s*E-a*P)*D,t[10]=(_*x-f*y+g*v)*D,t[11]=(-c*x+u*y-p*v)*D,t[12]=(-o*C+n*A-l*P)*D,t[13]=(i*C-s*A+r*P)*D,t[14]=(-_*M+f*b-m*v)*D,t[15]=(c*M-u*b+d*v)*D,t},traceMat4:e=>e[0]+e[5]+e[10]+e[15],translationMat4v(e,t){const i=t||w.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v(e,t){const i=t||w.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(()=>{const e=new Float32Array(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,w.translationMat4v(e,r))})(),translationMat4s:(e,t)=>w.translationMat4c(e,e,e,t),translateMat4v:(e,t)=>w.translateMat4c(e[0],e[1],e[2],t),OLDtranslateMat4c(e,t,i,s){const r=s[12];s[0]+=r*e,s[4]+=r*t,s[8]+=r*i;const a=s[13];s[1]+=a*e,s[5]+=a*t,s[9]+=a*i;const o=s[14];s[2]+=o*e,s[6]+=o*t,s[10]+=o*i;const n=s[15];return s[3]+=n*e,s[7]+=n*t,s[11]+=n*i,s},translateMat4c(e,t,i,s){const r=s[3];s[0]+=r*e,s[1]+=r*t,s[2]+=r*i;const a=s[7];s[4]+=a*e,s[5]+=a*t,s[6]+=a*i;const o=s[11];s[8]+=o*e,s[9]+=o*t,s[10]+=o*i;const n=s[15];return s[12]+=n*e,s[13]+=n*t,s[14]+=n*i,s},rotationMat4v(e,t,i){const s=w.normalizeVec4([t[0],t[1],t[2],0],[]),r=Math.sin(e),a=Math.cos(e),o=1-a,n=s[0],l=s[1],h=s[2];let c,u,d,p,_,f;return c=n*l,u=l*h,d=h*n,p=n*r,_=l*r,f=h*r,(i=i||w.mat4())[0]=o*n*n+a,i[1]=o*c+f,i[2]=o*d-_,i[3]=0,i[4]=o*c-f,i[5]=o*l*l+a,i[6]=o*u+p,i[7]=0,i[8]=o*d+_,i[9]=o*u-p,i[10]=o*h*h+a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(e,t,i,s,r)=>w.rotationMat4v(e,[t,i,s],r),scalingMat4v:(e,t=w.identityMat4())=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scalingMat3v:(e,t=w.identityMat3())=>(t[0]=e[0],t[4]=e[1],t),scalingMat4c:(()=>{const e=new Float32Array(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,w.scalingMat4v(e,r))})(),scaleMat4c:(e,t,i,s)=>(s[0]*=e,s[4]*=t,s[8]*=i,s[1]*=e,s[5]*=t,s[9]*=i,s[2]*=e,s[6]*=t,s[10]*=i,s[3]*=e,s[7]*=t,s[11]*=i,s),scaleMat4v(e,t){const i=e[0],s=e[1],r=e[2];return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,t},scalingMat4s:e=>w.scalingMat4c(e,e,e),rotationTranslationMat4(e,t,i=w.mat4()){const s=e[0],r=e[1],a=e[2],o=e[3],n=s+s,l=r+r,h=a+a,c=s*n,u=s*l,d=s*h,p=r*l,_=r*h,f=a*h,m=o*n,g=o*l,v=o*h;return i[0]=1-(p+f),i[1]=u+v,i[2]=d-g,i[3]=0,i[4]=u-v,i[5]=1-(c+f),i[6]=_+m,i[7]=0,i[8]=d+g,i[9]=_-m,i[10]=1-(c+p),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler(e,t,i=w.vec4()){const s=w.clamp,r=e[0],a=e[4],o=e[8],n=e[1],l=e[5],h=e[9],c=e[2],u=e[6],d=e[10];return"XYZ"===t?(i[1]=Math.asin(s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-h,d),i[2]=Math.atan2(-a,r)):(i[0]=Math.atan2(u,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(o,d),i[2]=Math.atan2(n,l)):(i[1]=Math.atan2(-c,r),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(s(u,-1,1)),Math.abs(u)<.99999?(i[1]=Math.atan2(-c,d),i[2]=Math.atan2(-a,l)):(i[1]=0,i[2]=Math.atan2(n,r))):"ZYX"===t?(i[1]=Math.asin(-s(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(u,d),i[2]=Math.atan2(n,r)):(i[0]=0,i[2]=Math.atan2(-a,l))):"YZX"===t?(i[2]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-c,r)):(i[0]=0,i[1]=Math.atan2(o,d))):"XZY"===t&&(i[2]=Math.asin(-s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(u,l),i[1]=Math.atan2(o,r)):(i[0]=Math.atan2(-h,d),i[1]=0)),i},composeMat4:(e,t,i,s=w.mat4())=>(w.quaternionToRotationMat4(t,s),w.scaleMat4v(i,s),w.translateMat4v(e,s),s),decomposeMat4:(()=>{const e=new Float32Array(3),t=new Float32Array(16);return function(i,s,r,a){e[0]=i[0],e[1]=i[1],e[2]=i[2];let o=w.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];const n=w.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];const l=w.lenVec3(e);w.determinantMat4(i)<0&&(o=-o),s[0]=i[12],s[1]=i[13],s[2]=i[14],t.set(i);const h=1/o,c=1/n,u=1/l;return t[0]*=h,t[1]*=h,t[2]*=h,t[4]*=c,t[5]*=c,t[6]*=c,t[8]*=u,t[9]*=u,t[10]*=u,w.mat4ToQuaternion(t,r),a[0]=o,a[1]=n,a[2]=l,this}})(),lookAtMat4v(e,t,i,s){s||(s=w.mat4());const r=e[0],a=e[1],o=e[2],n=i[0],l=i[1],h=i[2],c=t[0],u=t[1],d=t[2];if(r===c&&a===u&&o===d)return w.identityMat4();let p,_,f,m,g,v,b,y,M,x;return p=r-c,_=a-u,f=o-d,m=l*(f*=x=1/Math.sqrt(p*p+_*_+f*f))-h*(_*=x),g=h*(p*=x)-n*f,v=n*_-l*p,(x=Math.sqrt(m*m+g*g+v*v))?(m*=x=1/x,g*=x,v*=x):(m=0,g=0,v=0),b=_*v-f*g,y=f*m-p*v,M=p*g-_*m,(x=Math.sqrt(b*b+y*y+M*M))?(b*=x=1/x,y*=x,M*=x):(b=0,y=0,M=0),s[0]=m,s[1]=b,s[2]=p,s[3]=0,s[4]=g,s[5]=y,s[6]=_,s[7]=0,s[8]=v,s[9]=M,s[10]=f,s[11]=0,s[12]=-(m*r+g*a+v*o),s[13]=-(b*r+y*a+M*o),s[14]=-(p*r+_*a+f*o),s[15]=1,s},lookAtMat4c:(e,t,i,s,r,a,o,n,l)=>w.lookAtMat4v([e,t,i],[s,r,a],[o,n,l],[]),orthoMat4c(e,t,i,s,r,a,o){o||(o=w.mat4());const n=t-e,l=s-i,h=a-r;return o[0]=2/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/h,o[11]=0,o[12]=-(e+t)/n,o[13]=-(s+i)/l,o[14]=-(a+r)/h,o[15]=1,o},frustumMat4v(e,t,i){i||(i=w.mat4());const s=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];w.addVec4(r,s,y),w.subVec4(r,s,M);const a=2*s[2],o=M[0],n=M[1],l=M[2];return i[0]=a/o,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a/n,i[6]=0,i[7]=0,i[8]=y[0]/o,i[9]=y[1]/n,i[10]=-y[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-a*r[2]/l,i[15]=0,i},frustumMat4(e,t,i,s,r,a,o){o||(o=w.mat4());const n=t-e,l=s-i,h=a-r;return o[0]=2*r/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*r/l,o[6]=0,o[7]=0,o[8]=(t+e)/n,o[9]=(s+i)/l,o[10]=-(a+r)/h,o[11]=-1,o[12]=0,o[13]=0,o[14]=-a*r*2/h,o[15]=0,o},perspectiveMat4(e,t,i,s,r){const a=[],o=[];return a[2]=i,o[2]=s,o[1]=a[2]*Math.tan(e/2),a[1]=-o[1],o[0]=o[1]*t,a[0]=-o[0],w.frustumMat4v(a,o,r)},transformPoint3(e,t,i=w.vec3()){const s=t[0],r=t[1],a=t[2];return i[0]=e[0]*s+e[4]*r+e[8]*a+e[12],i[1]=e[1]*s+e[5]*r+e[9]*a+e[13],i[2]=e[2]*s+e[6]*r+e[10]*a+e[14],i},transformPoint4:(e,t,i=w.vec4())=>(i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i),transformPoints3(e,t,i){const s=i||[],r=t.length;let a,o,n,l;const h=e[0],c=e[1],u=e[2],d=e[3],p=e[4],_=e[5],f=e[6],m=e[7],g=e[8],v=e[9],b=e[10],y=e[11],M=e[12],x=e[13],w=e[14],P=e[15];let A;for(let e=0;e<r;++e)a=(l=t[e])[0],o=l[1],n=l[2],(A=s[e]||(s[e]=[0,0,0]))[0]=h*a+p*o+g*n+M,A[1]=c*a+_*o+v*n+x,A[2]=u*a+f*o+b*n+w,A[3]=d*a+m*o+y*n+P;return s.length=r,s},transformPositions3(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],c=e[2],u=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],b=e[11],y=e[12],M=e[13],x=e[14],w=e[15];for(s=0;s<r;s+=3)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+m*n+y,i[s+1]=h*a+p*o+g*n+M,i[s+2]=c*a+_*o+v*n+x,i[s+3]=u*a+f*o+b*n+w;return i},transformPositions4(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],c=e[2],u=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],b=e[11],y=e[12],M=e[13],x=e[14],w=e[15];for(s=0;s<r;s+=4)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+m*n+y,i[s+1]=h*a+p*o+g*n+M,i[s+2]=c*a+_*o+v*n+x,i[s+3]=u*a+f*o+b*n+w;return i},transformVec3(e,t,i){const s=t[0],r=t[1],a=t[2];return(i=i||this.vec3())[0]=e[0]*s+e[4]*r+e[8]*a,i[1]=e[1]*s+e[5]*r+e[9]*a,i[2]=e[2]*s+e[6]*r+e[10]*a,i},transformVec4(e,t,i){const s=t[0],r=t[1],a=t[2],o=t[3];return(i=i||w.vec4())[0]=e[0]*s+e[4]*r+e[8]*a+e[12]*o,i[1]=e[1]*s+e[5]*r+e[9]*a+e[13]*o,i[2]=e[2]*s+e[6]*r+e[10]*a+e[14]*o,i[3]=e[3]*s+e[7]*r+e[11]*a+e[15]*o,i},rotateVec3X(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0],a[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),a[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Y(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),a[1]=r[1],a[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},rotateVec3Z(e,t,i,s){const r=[],a=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],a[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),a[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),a[2]=r[2],s[0]=a[0]+t[0],s[1]=a[1]+t[1],s[2]=a[2]+t[2],s},projectVec4(e,t){const i=1/e[3];return(t=t||w.vec2())[0]=e[0]*i,t[1]=e[1]*i,t},unprojectVec3:(()=>{const e=new Float32Array(16),t=new Float32Array(16),i=new Float32Array(16);return function(s,r,a,o){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(a,t),i),s,o)}})(),lerpVec3(e,t,i,s,r,a){const o=a||w.vec3(),n=(e-t)/(i-t);return o[0]=s[0]+n*(r[0]-s[0]),o[1]=s[1]+n*(r[1]-s[1]),o[2]=s[2]+n*(r[2]-s[2]),o},lerpMat4(e,t,i,s,r,a){const o=a||w.mat4(),n=(e-t)/(i-t);return o[0]=s[0]+n*(r[0]-s[0]),o[1]=s[1]+n*(r[1]-s[1]),o[2]=s[2]+n*(r[2]-s[2]),o[3]=s[3]+n*(r[3]-s[3]),o[4]=s[4]+n*(r[4]-s[4]),o[5]=s[5]+n*(r[5]-s[5]),o[6]=s[6]+n*(r[6]-s[6]),o[7]=s[7]+n*(r[7]-s[7]),o[8]=s[8]+n*(r[8]-s[8]),o[9]=s[9]+n*(r[9]-s[9]),o[10]=s[10]+n*(r[10]-s[10]),o[11]=s[11]+n*(r[11]-s[11]),o[12]=s[12]+n*(r[12]-s[12]),o[13]=s[13]+n*(r[13]-s[13]),o[14]=s[14]+n*(r[14]-s[14]),o[15]=s[15]+n*(r[15]-s[15]),o},flatten(e){const t=[];let i,s,r,a,o;for(i=0,s=e.length;i<s;i++)for(r=0,a=(o=e[i]).length;r<a;r++)t.push(o[r]);return t},identityQuaternion:(e=w.vec4())=>(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e),eulerToQuaternion(e,t,i=w.vec4()){const s=e[0]*w.DEGTORAD/2,r=e[1]*w.DEGTORAD/2,a=e[2]*w.DEGTORAD/2,o=Math.cos(s),n=Math.cos(r),l=Math.cos(a),h=Math.sin(s),c=Math.sin(r),u=Math.sin(a);return"XYZ"===t?(i[0]=h*n*l+o*c*u,i[1]=o*c*l-h*n*u,i[2]=o*n*u+h*c*l,i[3]=o*n*l-h*c*u):"YXZ"===t?(i[0]=h*n*l+o*c*u,i[1]=o*c*l-h*n*u,i[2]=o*n*u-h*c*l,i[3]=o*n*l+h*c*u):"ZXY"===t?(i[0]=h*n*l-o*c*u,i[1]=o*c*l+h*n*u,i[2]=o*n*u+h*c*l,i[3]=o*n*l-h*c*u):"ZYX"===t?(i[0]=h*n*l-o*c*u,i[1]=o*c*l+h*n*u,i[2]=o*n*u-h*c*l,i[3]=o*n*l+h*c*u):"YZX"===t?(i[0]=h*n*l+o*c*u,i[1]=o*c*l+h*n*u,i[2]=o*n*u-h*c*l,i[3]=o*n*l-h*c*u):"XZY"===t&&(i[0]=h*n*l-o*c*u,i[1]=o*c*l-h*n*u,i[2]=o*n*u+h*c*l,i[3]=o*n*l+h*c*u),i},mat4ToQuaternion(e,t=w.vec4()){const i=e[0],s=e[4],r=e[8],a=e[1],o=e[5],n=e[9],l=e[2],h=e[6],c=e[10];let u;const d=i+o+c;return d>0?(u=.5/Math.sqrt(d+1),t[3]=.25/u,t[0]=(h-n)*u,t[1]=(r-l)*u,t[2]=(a-s)*u):i>o&&i>c?(u=2*Math.sqrt(1+i-o-c),t[3]=(h-n)/u,t[0]=.25*u,t[1]=(s+a)/u,t[2]=(r+l)/u):o>c?(u=2*Math.sqrt(1+o-i-c),t[3]=(r-l)/u,t[0]=(s+a)/u,t[1]=.25*u,t[2]=(n+h)/u):(u=2*Math.sqrt(1+c-i-o),t[3]=(a-s)/u,t[0]=(r+l)/u,t[1]=(n+h)/u,t[2]=.25*u),t},vec3PairToQuaternion(e,t,i=w.vec4()){const s=Math.sqrt(w.dotVec3(e,e)*w.dotVec3(t,t));let r=s+w.dotVec3(e,t);return r<1e-8*s?(r=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):w.cross3Vec3(e,t,i),i[3]=r,w.normalizeQuaternion(i)},angleAxisToQuaternion(e,t=w.vec4()){const i=e[3]/2,s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t},quaternionToEuler:(()=>{const e=new Float32Array(16);return(t,i,s)=>(s=s||w.vec3(),w.quaternionToRotationMat4(t,e),w.mat4ToEuler(e,i,s),s)})(),mulQuaternions(e,t,i=w.vec4()){const s=e[0],r=e[1],a=e[2],o=e[3],n=t[0],l=t[1],h=t[2],c=t[3];return i[0]=o*n+s*c+r*h-a*l,i[1]=o*l+r*c+a*n-s*h,i[2]=o*h+a*c+s*l-r*n,i[3]=o*c-s*n-r*l-a*h,i},vec3ApplyQuaternion(e,t,i=w.vec3()){const s=t[0],r=t[1],a=t[2],o=e[0],n=e[1],l=e[2],h=e[3],c=h*s+n*a-l*r,u=h*r+l*s-o*a,d=h*a+o*r-n*s,p=-o*s-n*r-l*a;return i[0]=c*h+p*-o+u*-l-d*-n,i[1]=u*h+p*-n+d*-o-c*-l,i[2]=d*h+p*-l+c*-n-u*-o,i},quaternionToMat4(e,t){t=w.identityMat4(t);const i=e[0],s=e[1],r=e[2],a=e[3],o=2*i,n=2*s,l=2*r,h=o*a,c=n*a,u=l*a,d=o*i,p=n*i,_=l*i,f=n*s,m=l*s,g=l*r;return t[0]=1-(f+g),t[1]=p+u,t[2]=_-c,t[4]=p-u,t[5]=1-(d+g),t[6]=m+h,t[8]=_+c,t[9]=m-h,t[10]=1-(d+f),t},quaternionToRotationMat4(e,t){const i=e[0],s=e[1],r=e[2],a=e[3],o=i+i,n=s+s,l=r+r,h=i*o,c=i*n,u=i*l,d=s*n,p=s*l,_=r*l,f=a*o,m=a*n,g=a*l;return t[0]=1-(d+_),t[4]=c-g,t[8]=u+m,t[1]=c+g,t[5]=1-(h+_),t[9]=p-f,t[2]=u-m,t[6]=p+f,t[10]=1-(h+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion(e,t=e){const i=w.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:(e,t=e)=>(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t),inverseQuaternion:(e,t)=>w.normalizeQuaternion(w.conjugateQuaternion(e,t)),quaternionToAngleAxis(e,t=w.vec4()){const i=(e=w.normalizeQuaternion(e,x))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=s,t},AABB3:e=>new Float32Array(e||6),AABB2:e=>new Float32Array(e||4),OBB3:e=>new Float32Array(e||32),OBB2:e=>new Float32Array(e||16),Sphere3:(e,t,i,s)=>new Float32Array([e,t,i,s]),transformOBB3(e,t,i=t){let s;const r=t.length;let a,o,n;const l=e[0],h=e[1],c=e[2],u=e[3],d=e[4],p=e[5],_=e[6],f=e[7],m=e[8],g=e[9],v=e[10],b=e[11],y=e[12],M=e[13],x=e[14],w=e[15];for(s=0;s<r;s+=4)a=t[s+0],o=t[s+1],n=t[s+2],i[s+0]=l*a+d*o+m*n+y,i[s+1]=h*a+p*o+g*n+M,i[s+2]=c*a+_*o+v*n+x,i[s+3]=u*a+f*o+b*n+w;return i},getAABB3Diag:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return s=>(e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],w.subVec3(t,e,i),Math.abs(w.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return(s,r)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];const a=w.subVec3(t,e,i),o=r[0]-s[0],n=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],c=r[2]-s[2],u=s[5]-r[2];return a[0]+=o>n?o:n,a[1]+=l>h?l:h,a[2]+=c>u?c:u,Math.abs(w.lenVec3(a))}})(),getAABB3Center(e,t){const i=t||w.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center(e,t){const i=t||w.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:(e=w.AABB3())=>(e[0]=w.MAX_DOUBLE,e[1]=w.MAX_DOUBLE,e[2]=w.MAX_DOUBLE,e[3]=-w.MAX_DOUBLE,e[4]=-w.MAX_DOUBLE,e[5]=-w.MAX_DOUBLE,e),AABB3ToOBB3:(e,t=w.OBB3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t),positions3ToAABB3:(()=>{const e=new Float32Array(3);return(t,i,s)=>{i=i||w.AABB3();let r,a,o,n=w.MAX_DOUBLE,l=w.MAX_DOUBLE,h=w.MAX_DOUBLE,c=-w.MAX_DOUBLE,u=-w.MAX_DOUBLE,d=-w.MAX_DOUBLE;for(let i=0,p=t.length;i<p;i+=3)s?(e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2],w.decompressPosition(e,s,e),r=e[0],a=e[1],o=e[2]):(r=t[i+0],a=t[i+1],o=t[i+2]),r<n&&(n=r),a<l&&(l=a),o<h&&(h=o),r>c&&(c=r),a>u&&(u=a),o>d&&(d=o);return i[0]=n,i[1]=l,i[2]=h,i[3]=c,i[4]=u,i[5]=d,i}})(),OBB3ToAABB3(e,t=w.AABB3()){let i,s,r,a=w.MAX_DOUBLE,o=w.MAX_DOUBLE,n=w.MAX_DOUBLE,l=-w.MAX_DOUBLE,h=-w.MAX_DOUBLE,c=-w.MAX_DOUBLE;for(let t=0,u=e.length;t<u;t+=4)(i=e[t+0])<a&&(a=i),(s=e[t+1])<o&&(o=s),(r=e[t+2])<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return t[0]=a,t[1]=o,t[2]=n,t[3]=l,t[4]=h,t[5]=c,t},points3ToAABB3(e,t=w.AABB3()){let i,s,r,a=w.MAX_DOUBLE,o=w.MAX_DOUBLE,n=w.MAX_DOUBLE,l=-w.MAX_DOUBLE,h=-w.MAX_DOUBLE,c=-w.MAX_DOUBLE;for(let t=0,u=e.length;t<u;t++)(i=e[t][0])<a&&(a=i),(s=e[t][1])<o&&(o=s),(r=e[t][2])<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return t[0]=a,t[1]=o,t[2]=n,t[3]=l,t[4]=h,t[5]=c,t},points3ToSphere3:(()=>{const e=new Float32Array(3);return(t,i)=>{i=i||w.vec4();let s,r=0,a=0,o=0;const n=t.length;for(s=0;s<n;s++)r+=t[s][0],a+=t[s][1],o+=t[s][2];i[0]=r/n,i[1]=a/n,i[2]=o/n;let l,h=0;for(s=0;s<n;s++)(l=Math.abs(w.lenVec3(w.subVec3(t[s],i,e))))>h&&(h=l);return i[3]=h,i}})(),positions3ToSphere3:(()=>{const e=new Float32Array(3),t=new Float32Array(3);return(i,s)=>{s=s||w.vec4();let r,a=0,o=0,n=0;const l=i.length;let h=0;for(r=0;r<l;r+=3)a+=i[r],o+=i[r+1],n+=i[r+2];const c=l/3;let u;for(s[0]=a/c,s[1]=o/c,s[2]=n/c,r=0;r<l;r+=3)e[0]=i[r],e[1]=i[r+1],e[2]=i[r+2],(u=Math.abs(w.lenVec3(w.subVec3(e,s,t))))>h&&(h=u);return s[3]=h,s}})(),OBB3ToSphere3:(()=>{const e=new Float32Array(3),t=new Float32Array(3);return(i,s)=>{s=s||w.vec4();let r,a=0,o=0,n=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)a+=i[r+0],o+=i[r+1],n+=i[r+2];s[0]=a/h,s[1]=o/h,s[2]=n/h;let c,u=0;for(r=0;r<l;r+=4)e[0]=i[r+0],e[1]=i[r+1],e[2]=i[r+2],(c=Math.abs(w.lenVec3(w.subVec3(e,s,t))))>u&&(u=c);return s[3]=u,s}})(),getSphere3Center:(e,t=w.vec3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),expandAABB3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e),expandAABB3Point3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e),expandAABB3Points3(e,t){for(var i,s,r,a=0,o=t.length;a<o;a+=3)i=t[a],s=t[a+1],r=t[a+2],e[0]>i&&(e[0]=i),e[1]>s&&(e[1]=s),e[2]>r&&(e[2]=r),e[3]<i&&(e[3]=i),e[4]<s&&(e[4]=s),e[5]<r&&(e[5]=r);return e},collapseAABB2:(e=w.AABB2())=>(e[0]=w.MAX_DOUBLE,e[1]=w.MAX_DOUBLE,e[2]=-w.MAX_DOUBLE,e[3]=-w.MAX_DOUBLE,e),OBB3ToAABB2(e,t=w.AABB2()){let i,s,r,a,o=w.MAX_DOUBLE,n=w.MAX_DOUBLE,l=-w.MAX_DOUBLE,h=-w.MAX_DOUBLE;for(let t=0,c=e.length;t<c;t+=4)i=e[t+0],s=e[t+1],(i*=a=1/(r=e[t+3]||1))<o&&(o=i),(s*=a)<n&&(n=s),i>l&&(l=i),s>h&&(h=s);return t[0]=o,t[1]=n,t[2]=l,t[3]=h,t},expandAABB2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e),expandAABB2Point2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e),AABB2ToCanvas(e,t,i,s=e){const r=.5*(e[0]+1),a=.5*(e[1]+1),o=.5*(e[2]+1),n=.5*(e[3]+1);return s[0]=Math.floor(r*t),s[1]=i-Math.floor(n*i),s[2]=Math.floor(o*t),s[3]=i-Math.floor(a*i),s},tangentQuadraticBezier:(e,t,i,s)=>2*(1-e)*(i-t)+2*e*(s-i),tangentQuadraticBezier3:(e,t,i,s,r)=>-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*s*(1-e)-3*e*e*s+3*e*e*r,tangentSpline:e=>6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e),catmullRomInterpolate(e,t,i,s,r){const a=.5*(i-e),o=.5*(s-t),n=r*r;return(2*t-2*i+a+o)*(r*n)+(-3*t+3*i-2*a-o)*n+a*r+t},b2p0(e,t){const i=1-e;return i*i*t},b2p1:(e,t)=>2*(1-e)*e*t,b2p2:(e,t)=>e*e*t,b2(e,t,i,s){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,s)},b3p0(e,t){const i=1-e;return i*i*i*t},b3p1(e,t){const i=1-e;return 3*i*i*e*t},b3p2:(e,t)=>3*(1-e)*e*e*t,b3p3:(e,t)=>e*e*e*t,b3(e,t,i,s,r){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,s)+this.b3p3(e,r)},triangleNormal(e,t,i,s=w.vec3()){const r=t[0]-e[0],a=t[1]-e[1],o=t[2]-e[2],n=i[0]-e[0],l=i[1]-e[1],h=i[2]-e[2],c=a*h-o*l,u=o*n-r*h,d=r*l-a*n,p=Math.sqrt(c*c+u*u+d*d);return 0===p?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/p,s[1]=u/p,s[2]=d/p),s},rayTriangleIntersect:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3);return(a,o,n,l,h,c)=>{c=c||w.vec3();const u=w.subVec3(l,n,e),d=w.subVec3(h,n,t),p=w.cross3Vec3(o,d,i),_=w.dotVec3(u,p);if(_<1e-6)return null;const f=w.subVec3(a,n,s),m=w.dotVec3(f,p);if(m<0||m>_)return null;const g=w.cross3Vec3(f,u,r),v=w.dotVec3(o,g);if(v<0||m+v>_)return null;const b=w.dotVec3(d,g)/_;return c[0]=a[0]+b*o[0],c[1]=a[1]+b*o[1],c[2]=a[2]+b*o[2],c}})(),rayPlaneIntersect:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3);return(r,a,o,n,l,h)=>{h=h||w.vec3(),a=w.normalizeVec3(a,e);const c=w.subVec3(n,o,t),u=w.subVec3(l,o,i),d=w.cross3Vec3(c,u,s);w.normalizeVec3(d,d);const p=-w.dotVec3(o,d),_=-(w.dotVec3(r,d)+p)/w.dotVec3(a,d);return h[0]=r[0]+_*a[0],h[1]=r[1]+_*a[1],h[2]=r[2]+_*a[2],h}})(),cartesianToBarycentric:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3);return(s,r,a,o,n)=>{const l=w.subVec3(o,r,e),h=w.subVec3(a,r,t),c=w.subVec3(s,r,i),u=w.dotVec3(l,l),d=w.dotVec3(l,h),p=w.dotVec3(l,c),_=w.dotVec3(h,h),f=w.dotVec3(h,c),m=u*_-d*d;if(0===m)return null;const g=1/m,v=(_*p-d*f)*g,b=(u*f-d*p)*g;return n[0]=1-v-b,n[1]=b,n[2]=v,n}})(),barycentricInsideTriangle(e){const t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian(e,t,i,s,r=w.vec3()){const a=e[0],o=e[1],n=e[2];return r[0]=t[0]*a+i[0]*o+s[0]*n,r[1]=t[1]*a+i[1]*o+s[1]*n,r[2]=t[2]*a+i[2]*o+s[2]*n,r},mergeVertices(e,t,i,s){const r={},a=[],o=[],n=t?[]:null,l=i?[]:null,h=[];let c,u,d,p;let _,f,m=0;for(_=0,f=e.length;_<f;_+=3)c=e[_],u=e[_+1],d=e[_+2],void 0===r[p=`${Math.round(1e4*c)}_${Math.round(1e4*u)}_${Math.round(1e4*d)}`]&&(r[p]=o.length/3,o.push(c),o.push(u),o.push(d),t&&(n.push(t[_]),n.push(t[_+1]),n.push(t[_+2])),i&&(l.push(i[m]),l.push(i[m+1]))),a[_/3]=r[p],m+=2;for(_=0,f=s.length;_<f;_++)h[_]=a[s[_]];const g={positions:o,indices:h};return n&&(g.normals=n),l&&(g.uv=l),g},buildNormals:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),a=new Float32Array(3);return(o,n,l)=>{let h,c;const u=new Array(o.length/3);let d,p,_,f,m,g,v;for(h=0,c=n.length;h<c;h+=3){d=n[h],p=n[h+1],_=n[h+2],e[0]=o[3*d],e[1]=o[3*d+1],e[2]=o[3*d+2],t[0]=o[3*p],t[1]=o[3*p+1],t[2]=o[3*p+2],i[0]=o[3*_],i[1]=o[3*_+1],i[2]=o[3*_+2],w.subVec3(t,e,s),w.subVec3(i,e,r);const l=new Float32Array(3);w.normalizeVec3(w.cross3Vec3(s,r,a),l),u[d]||(u[d]=[]),u[p]||(u[p]=[]),u[_]||(u[_]=[]),u[d].push(l),u[p].push(l),u[_].push(l)}for(l=l&&l.length===o.length?l:new Float32Array(o.length),h=0,c=u.length;h<c;h++){f=u[h].length,m=0,g=0,v=0;for(let e=0;e<f;e++)m+=u[h][e][0],g+=u[h][e][1],v+=u[h][e][2];l[3*h]=m/f,l[3*h+1]=g/f,l[3*h+2]=v/f}return l}})(),buildTangents:(()=>{const e=new Float32Array(3),t=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),a=new Float32Array(3),o=new Float32Array(3);return(n,l,h)=>{const c=new Float32Array(n.length);for(let u=0;u<l.length;u+=3){let d=l[u];const p=n.subarray(3*d,3*d+3),_=h.subarray(2*d,2*d+2);d=l[u+1];const f=n.subarray(3*d,3*d+3),m=h.subarray(2*d,2*d+2);d=l[u+2];const g=n.subarray(3*d,3*d+3),v=h.subarray(2*d,2*d+2),b=w.subVec3(f,p,e),y=w.subVec3(g,p,t),M=w.subVec2(m,_,i),x=w.subVec2(v,_,s),P=1/(M[0]*x[1]-M[1]*x[0]),A=w.mulVec3Scalar(w.subVec3(w.mulVec3Scalar(b,x[1],r),w.mulVec3Scalar(y,M[1],a),o),P,a);let E;for(let e=0;e<3;e++)c[E=3*l[u+e]]+=A[0],c[E+1]+=A[1],c[E+2]+=A[2]}return c}})(),buildPickTriangles(e,t,i){const s=t.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),a=new Uint8Array(12*s);let o,n,l,h,c,u,d=0,p=0,_=0;for(let i=0;i<s;i+=3)u=d>>24&255,c=d>>16&255,h=d>>8&255,l=255&d,o=3*(n=t[i]),r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=c,a[_++]=u,o=3*(n=t[i+1]),r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=c,a[_++]=u,o=3*(n=t[i+2]),r[p++]=e[o],r[p++]=e[o+1],r[p++]=e[o+2],a[_++]=l,a[_++]=h,a[_++]=c,a[_++]=u,d++;return{positions:r,colors:a}},faceToVertexNormals(e,t,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},a=[],o={};let n,l,h,c,u;let d,p,_,f,m,g;for(p=0,f=e.length;p<f;p+=3){d=p/3,l=e[p],h=e[p+1],c=e[p+2],void 0===r[u=`${Math.round(1e4*l)}_${Math.round(1e4*h)}_${Math.round(1e4*c)}`]?r[u]=[d]:r[u].push(d);const i=w.normalizeVec3([t[p],t[p+1],t[p+2]]);a[d]=i,n=w.vec4([i[0],i[1],i[2],1]),o[d]=n}for(u in r)if(r.hasOwnProperty(u)){const e=r[u],t=e.length;for(p=0;p<t;p++){const i=e[p];for(n=o[i],_=0;_<t;_++){if(p===_)continue;const t=e[_];m=a[i],g=a[t],Math.abs(w.angleVec3(m,g)/w.DEGTORAD)<s&&(n[0]+=g[0],n[1]+=g[1],n[2]+=g[2],n[3]+=1)}}}for(p=0,f=t.length;p<f;p+=3)n=o[p/3],t[p+0]=n[0]/n[3],t[p+1]=n[1]/n[3],t[p+2]=n[2]/n[3]},canvasPosToWorldRay:(()=>{const e=new Float32Array(16),t=new Float32Array(16),i=new Float32Array(4),s=new Float32Array(4),r=new Float32Array(4),a=new Float32Array(4);return(o,n,l,h,c,u)=>{const d=w.mulMat4(l,n,e),p=w.inverseMat4(d,t),_=o.width,f=o.height,m=(h[0]-_/2)/(_/2),g=-(h[1]-f/2)/(f/2);i[0]=m,i[1]=g,i[2]=-1,i[3]=1,w.transformVec4(p,i,s),w.mulVec4Scalar(s,1/s[3]),r[0]=m,r[1]=g,r[2]=1,r[3]=1,w.transformVec4(p,r,a),w.mulVec4Scalar(a,1/a[3]),c[0]=a[0],c[1]=a[1],c[2]=a[2],w.subVec3(a,s,u),w.normalizeVec3(u)}})(),canvasPosToLocalRay:(()=>{const e=new Float32Array(3),t=new Float32Array(3);return(i,s,r,a,o,n,l)=>{w.canvasPosToWorldRay(i,s,r,o,e,t),w.worldRayToLocalRay(a,e,t,n,l)}})(),worldRayToLocalRay:(()=>{const e=new Float32Array(16),t=new Float32Array(4),i=new Float32Array(4);return(s,r,a,o,n)=>{const l=w.inverseMat4(s,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,w.transformVec4(l,t,i),o[0]=i[0],o[1]=i[1],o[2]=i[2],w.transformVec3(l,a,n)}})(),buildKDTree:(()=>{const e=10,t=20,i=new Float32Array;return(s,r)=>{const a=s.length/3,o=new Array(a);for(let e=0;e<a;++e)o[e]=e;return function s(r,a,o,n){const l=new Float32Array(6),h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};let c,u;for(l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY,c=0,u=r.length;c<u;++c){var d=3*r[c];for(let e=0;e<3;++e){const t=3*a[d+e];o[t]<l[0]&&(l[0]=o[t]),o[t]>l[3]&&(l[3]=o[t]),o[t+1]<l[1]&&(l[1]=o[t+1]),o[t+1]>l[4]&&(l[4]=o[t+1]),o[t+2]<l[2]&&(l[2]=o[t+2]),o[t+2]>l[5]&&(l[5]=o[t+2])}}if(r.length<t||n>e)return h.triangles=r,h.leaf=!0,h;i[0]=l[3]-l[0],i[1]=l[4]-l[1],i[2]=l[5]-l[2];let p=0;i[1]>i[p]&&(p=1),i[2]>i[p]&&(p=2),h.splitDim=p;const _=(l[p]+l[p+3])/2,f=new Array(r.length);let m=0;const g=new Array(r.length);let v=0;for(c=0,u=r.length;c<u;++c){const e=a[d=3*r[c]],t=3*a[d+1],i=3*a[d+2];o[3*e+p]<=_||o[t+p]<=_||o[i+p]<=_?f[m++]=r[c]:g[v++]=r[c]}return f.length=m,g.length=v,h.left=s(f,a,o,n+1),h.right=s(g,a,o,n+1),h}(o,s,r,0)}})(),decompressPosition(e,t,i){i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressUV(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},octDecodeVec2(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const a=Math.sqrt(i*i+s*s+r*r);return t[0]=i/a,t[1]=s/a,t[2]=r/a,t},octDecodeVec2s(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],a=e[i+1];r=(2*r+1)/255,a=(2*a+1)/255;const o=1-Math.abs(r)-Math.abs(a);o<0&&(r=(1-Math.abs(a))*(r>=0?1:-1),a=(1-Math.abs(r))*(a>=0?1:-1));const n=Math.sqrt(r*r+a*a+o*o);t[s+0]=r/n,t[s+1]=a/n,t[s+2]=o/n,s+=3}return t}};w.buildEdgeIndices=function(){const e=[],t=[],i=[],s=[],r=[];let a=0;const o=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=w.vec3(),c=w.vec3(),u=w.vec3(),d=w.vec3(),p=w.vec3(),_=w.vec3(),f=w.vec3();return function(m,g,v,b){!function(r,a){const o={};let n,l,h,c;const u=Math.pow(10,4);let d,p,_=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],void 0===o[c=Math.round(n*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u)]&&(o[c]=_/3,e[_++]=n,e[_++]=l,e[_++]=h),t[d/3]=o[c];for(d=0,p=a.length;d<p;d++)s[d]=t[a[d]],i[s[d]]=a[d]}(m,g),function(t,i){a=0;for(let m=0,g=t;m<g;m+=3){const t=3*s[m],g=3*s[m+1],v=3*s[m+2];i?(o[0]=e[t],o[1]=e[t+1],o[2]=e[t+2],n[0]=e[g],n[1]=e[g+1],n[2]=e[g+2],l[0]=e[v],l[1]=e[v+1],l[2]=e[v+2],w.decompressPosition(o,i,h),w.decompressPosition(n,i,c),w.decompressPosition(l,i,u)):(h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],c[0]=e[g],c[1]=e[g+1],c[2]=e[g+2],u[0]=e[v],u[1]=e[v+1],u[2]=e[v+2]),w.subVec3(u,c,d),w.subVec3(h,c,p),w.cross3Vec3(d,p,_),w.normalizeVec3(_,f);const b=r[a]||(r[a]={normal:w.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],a++}}(g.length,v);const y=[],M=Math.cos(w.DEGTORAD*b),x={};let P,A,E,C,L,R,D,F,S,k,T,B=!1;for(let e=0,t=g.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)P=s[e+i],A=s[e+(i+1)%3],void 0===x[L=(E=Math.min(P,A))+","+(C=Math.max(P,A))]?x[L]={index1:E,index2:C,face1:t,face2:void 0}:x[L].face2=t}for(L in x)void 0!==(R=x[L]).face2&&(D=r[R.face1].normal,F=r[R.face2].normal,(S=w.dotVec3(D,F))>M)||(k=i[R.index1],T=i[R.index2],(!B&&k>65535||T>65535)&&(B=!0),y.push(k),y.push(T));return B?new Uint32Array(y):new Uint16Array(y)}}();class P{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,t={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=t.viewer;else{if("Scene"===e.type)this.scene=e;else{if(!(e instanceof P))throw"Invalid param: owner must be a Component";this.scene=e.scene}this._owner=e,this._renderer=this.scene._renderer}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty()}glResort(){this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new s),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});let r=this._eventSubs[e];r||(r={},this._eventSubs[e]=r);const a=this._subIdMap.addItem();r[a]={callback:t,scope:i||this},this._subIdEvents[a]=e;const o=this._events[e];return void 0!==o&&t.call(i||this,o),a}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,function(e){s.off(r),t.call(i||this,e)},i)}hasSubs(e){return this._eventSubs&&!!this._eventSubs[e]}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+n.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t)return void this.error("Component 'name' expected");let i=e.component;const s=e.sceneDefault,r=e.sceneSingleton,a=e.type,o=e.on,l=!1!==e.recompiles;if(i&&(n.isNumeric(i)||n.isString(i))){const e=i;if(!(i=this.scene.components[e]))return void this.error("Component not found: "+n.inQuotes(e))}if(!i)if(!0===r){const e=this.scene.types[a];for(const t in e)if(e.hasOwnProperty){i=e[t];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===s&&!(i=this.scene[t]))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+n.inQuotes(i.id));if(a&&!i.isType(a))return void this.error("Expected a "+a+" type or subtype: "+i.type+" "+n.inQuotes(i.id))}this._attachments||(this._attachments={});const h=this._attached[t];let c,u,d;if(h){if(i&&h.id===i.id)return;const e=this._attachments[h.id];for(u=0,d=(c=e.subs).length;u<d;u++)h.off(c[u]);delete this._attached[t],delete this._attachments[h.id];const s=e.params.onDetached;s&&(n.isFunction(s)?s(h):s.scope?s.callback.call(s.scope,h):s.callback(h)),e.managingLifecycle&&h.destroy()}if(i){const s={params:e,component:i,subs:[],managingLifecycle:!1};s.subs.push(i.once("destroyed",function(){s.params.component=null,this._attach(s.params)},this)),l&&s.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[t]=i,this._attachments[i.id]=s;const r=e.onAttached;if(r&&(n.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),o){let e,t,r,a;for(e in o)if(o.hasOwnProperty(e)){if(t=o[e],n.isFunction(t)?(r=t,a=null):(r=t.callback,a=t.scope),!r)continue;s.subs.push(i.on(e,r,a))}}}return l&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(!t.isComponent){if(!n.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type)}else this.error("Expected a "+e+" Component")}_checkComponent2(e,t){if(!t.isComponent){if(!n.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(t.scene.id===this.scene.id){for(var i=0,s=e.length;i<s;i++)if(e[i]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type)}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",()=>{delete this._ownedComponents[e.id]},this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():v.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(e)){this._ownedComponents[e].destroy(),delete this._ownedComponents[e]}}destroy(){if(this.destroyed)return;let e,t,i,s,r,a;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(i=(t=this._attachments[e]).component,r=0,a=(s=t.subs).length;r<a;r++)i.off(s[r]);t.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&((i=this._ownedComponents[e]).destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const A=function(){const e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!e.getContext("2d").getImageData,s=!!e.toDataURL,r=!!window.btoa,a=function(e){let i="";const s=e.width,r=e.height;i+="BM";let a=s*r*4+54;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);let o=s;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256);let n=r;i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),i+=t(1,0,32,0),i+=t(0,0,0,0);let l=s*r*4;i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=e.data;let c,u,d,p,_="",f=r;do{for(d=s*(f-1)*4,p="",c=0;c<s;c++)p+=t(h[d+(u=4*c)+2],h[d+u+1],h[d+u],h[d+u+3]);_+=p}while(--f);return function(e){let i,s,r="";if("string"==typeof e)r=e;else for(s=e,i=0;i<s.length;i++)r+=t(s[i]);return btoa(r)}(i+_)},o=function(e){window.open(e)||(document.location.href=e)},n=function(e,t){return"data:"+t+";base64,"+e},l=function(e){const t=document.createElement("img");return t.src=e,t},h=function(e,t,i){if(t&&i){const s=document.createElement("canvas");return s.width=t,s.height=i,s.style.width=t+"px",s.style.height=i+"px",s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,i),s}return e};return{saveAsPNG:function(e,t,i,r){if(!s)return!1;const a=h(e,i,r).toDataURL("image/png");return t?l(a):(o(a),!0)},saveAsJPEG:function(e,t,i,r){if(!s)return!1;const a=h(e,i,r).toDataURL("image/jpeg");return 5==a.indexOf("image/jpeg")&&(t?l(a):(o(a),!0))},saveAsBMP:function(e,t,c,u){if(!(s&&i&&r))return!1;const d=function(e){const t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(h(e,c,u)),p=a(d);return t?l(n(p,"image/bmp")):(o(n(p,"image/bmp")),!0)}}}(),E=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }";class C extends P{get type(){return"Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){if(document.getElementById("xeokit-spinner-css"))return;const e=document.createElement("style");e.innerHTML=E,e.id="xeokit-spinner-css",document.body.appendChild(e)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}set processes(e){if(e=e||0,this._processes===e)return;if(e<0)return;const t=this._processes;this._processes=e;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null)}}const L={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},R=document.createElement("canvas");if(R){const e=R.getContext("webgl",{antialias:!0})||R.getContext("experimental-webgl",{antialias:!0});L.WEBGL=!!e,L.WEBGL&&(L.ANTIALIAS=e.getContextAttributes().antialias,e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?L.FS_MAX_FLOAT_PRECISION="highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?L.FS_MAX_FLOAT_PRECISION="mediump":L.FS_MAX_FLOAT_PRECISION="lowp":L.FS_MAX_FLOAT_PRECISION="mediump",L.DEPTH_BUFFER_BITS=e.getParameter(e.DEPTH_BITS),L.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),L.MAX_CUBE_MAP_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),L.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE),L.MAX_TEXTURE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),L.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),L.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS),L.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),L.MAX_FRAGMENT_UNIFORM_VECTORS=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),L.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS),e.getSupportedExtensions().forEach(function(e){L.SUPPORTED_EXTENSIONS[e]=!0}))}const D=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class F extends P{get type(){return"Canvas"}constructor(e,t={}){super(e,t),this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!0),this.contextAttr.stencil=!1,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=null,a=null,o=null,n=null,l=null,h=null,c=null;this._tick=this.scene.on("tick",function(){const e=i.canvas,t=window.innerWidth!==s||window.innerHeight!==a,u=e.clientWidth!==o||e.clientHeight!==n,d=e.offsetLeft!==l||e.offsetTop!==h,p=e.parentElement;if(t||u||d||p!==c){if(i._spinner._adjustPosition(),u||d){const t=e.clientWidth,s=e.clientHeight;if(u){let t,i=0;for(const e in v.scenes)v.scenes.hasOwnProperty(e)&&(i+=(t=v.scenes[e]).canvas.canvas.clientWidth*t.canvas.canvas.clientHeight);r.memory.pixels=i,e.width=e.clientWidth,e.height=e.clientHeight}const a=i.boundary;a[0]=e.offsetLeft,a[1]=e.offsetTop,a[2]=t,a[3]=s,i.fire("boundary",a),o=t,n=s}t&&(s=window.innerWidth,a=window.innerHeight),d&&(l=e.offsetLeft,h=e.offsetTop),c=p}}),this.canvas.oncontextmenu=function(e){e.preventDefault()},this._spinner=new C(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId}),this.clearColorAmbient=t.clearColorAmbient}_createCanvas(){const e="xeokit-canvas-"+w.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<D.length;e++)try{this.gl=this.canvas.getContext(D[e],this.contextAttr)}catch(e){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else if(L.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const e=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}}set clearColorAmbient(e){this._clearColorAmbient=!!e}get clearColorAmbient(){return this._clearColorAmbient}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}_getSnapshot(e){const t=(e=e||{}).width||this.canvas.width,i=e.height||this.canvas.height,s=e.format||"jpeg";let r;switch(s){case"jpeg":r=A.saveAsJPEG(this.canvas,!0,t,i);break;case"png":r=A.saveAsPNG(this.canvas,!0,t,i);break;case"bmp":r=A.saveAsBMP(this.canvas,!0,t,i);break;default:this.error("Unsupported snapshot format: '"+s+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),r=A.saveAsJPEG(this.canvas,!0,t,i)}return r.src}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}get spinner(){return this._spinner}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.canvas=null,this.gl=null,super.destroy()}}class S{constructor(){this.reset()}reset(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.lineWidth=1}}class k{constructor(){this.reset()}reset(){this.normalFillOpaque=!1,this.normalEdgesOpaque=!1,this.normalFillTransparent=!1,this.normalEdgesTransparent=!1,this.xrayedFillOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedFillTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedFillOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedFillTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedFillOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedFillTransparent=!1,this.selectedEdgesTransparent=!1}}class T{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let e,t;const i=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=this.canvas.clientWidth,t=this.canvas.clientHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);const r=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t);const a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,r),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(o){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+o}this.buffer={framebuf:a,renderbuf:r,texture:s,width:e,height:t},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t){const i=e,s=this.canvas.height-t,r=new Uint8Array(4),a=this.gl;return a.readPixels(i,s,1,1,a.RGBA,a.UNSIGNED_BYTE,r),r}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(){const e=this;return{renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}}}destroy(){if(this.allocated){const e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}}}class B{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float32Array([0,0,0]),this._direction=new Float32Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float32Array([0,0,0]),this._worldPos=new Float32Array([0,0,0]),this._viewPos=new Float32Array([0,0,0]),this._bary=new Float32Array([0,0,0]),this._worldNormal=new Float32Array([0,0,0]),this._uv=new Float32Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}class N{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=i.split("\n"),s=[];for(let e=0;e<t.length;e++)s.push(e+1+": "+t[e]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class I{constructor(e,t){this.bindTexture=function(i,s){return!!i.bind(s)&&(e.uniform1i(t,s),!0)}}}class O{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const V=new s({});function U(e){const t=[];let i,s;for(let r=0,a=e.length;r<a;r++)(s=(i=e[r]).indexOf("/"))>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),t.push(i);return t.join("\n")}class z{constructor(e,t){this.id=V.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new N(e,e.VERTEX_SHADER,U(this.source.vertex)),this._fragmentShader=new N(e,e.FRAGMENT_SHADER,U(this.source.fragment)),!this._vertexShader.allocated)return void(this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors));if(!this._fragmentShader.allocated)return void(this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors));if(!this._fragmentShader.compiled)return void(this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors));let t,i,s,r,a;if(this.compiled=!0,this.handle=e.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(this.source.fragment));const o=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<o;++i)(s=e.getActiveUniform(this.handle,i))&&("\0"===(r=s.name)[r.length-1]&&(r=r.substr(0,r.length-1)),a=e.getUniformLocation(this.handle,r),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||35682===s.type?this.samplers[r]=new I(e,a):this.uniforms[r]=a);const n=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<n;i++)(t=e.getActiveAttrib(this.handle,i))&&(a=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new O(e,a));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return!!s&&s.bindTexture(t,i)}destroy(){this.allocated&&(V.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class G{constructor(e,t,i,s,r,a,o,n,l){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=a,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!o,this.stride=n||0,this.offset=l||0,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}const j=!1,Y=w.vec3([1,0,0]),H=20;class X{constructor(e){this._scene=e,this._markers={},this._markerList=[],this._markerIndices={},this._numMarkers=0,this._positions=[],this._indices=[],this._positionsBuf=null,this._indicesBuf=null,this._occlusionTestList=[],this._lenOcclusionTestList=0,this._pixels=[],this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markerListDirty=!1,this._positionsDirty=!1,this._vbosDirty=!1,this._occlusionTestListDirty=!1,this._lenPositionsBuf=0,e.camera.on("viewMatrix",()=>{this._occlusionTestListDirty=!0}),e.camera.on("projMatrix",()=>{this._occlusionTestListDirty=!0}),e.canvas.on("boundary",()=>{this._occlusionTestListDirty=!0})}addMarker(e){this._markers[e.id]=e,this._markerListDirty=!0}markerWorldPosUpdated(e){if(!this._markers[e.id])return;const t=this._markerIndices[e.id];this._positions[3*t+0]=e.worldPos[0],this._positions[3*t+1]=e.worldPos[1],this._positions[3*t+2]=e.worldPos[2],this._positionsDirty=!0}removeMarker(e){delete this._markers[e.id],this._markerListDirty=!0}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._markerListDirty&&(this._buildMarkerList(),this._markerListDirty=!1,this._positionsDirty=!0,this._occlusionTestListDirty=!0),this._positionsDirty&&(this._buildPositions(),this._positionsDirty=!1,this._vbosDirty=!0),this._vbosDirty&&(this._buildVBOs(),this._vbosDirty=!1),this._occlusionTestListDirty&&this._buildOcclusionTestList(),j||(this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new T(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear())}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene._sectionPlanesState.sectionPlanes.length>0,t=[];return t.push("// Mesh occlusion vertex shader"),t.push("attribute vec3 position;"),t.push("uniform mat4 modelMatrix;"),t.push("uniform mat4 viewMatrix;"),t.push("uniform mat4 projMatrix;"),e&&t.push("varying vec4 vWorldPosition;"),t.push("void main(void) {"),t.push("vec4 worldPosition = vec4(position, 1.0); "),t.push("   vec4 viewPosition = viewMatrix * worldPosition;"),e&&t.push("   vWorldPosition = worldPosition;"),t.push("   gl_Position = projMatrix * viewPosition;"),t.push("   gl_PointSize = "+H+".0;"),t.push("}"),t}_buildFragmentShaderSource(){const e=this._scene._sectionPlanesState,t=e.sectionPlanes.length>0,i=[];if(i.push("// Mesh occlusion fragment shader"),i.push("precision lowp float;"),t){i.push("uniform bool clippable;"),i.push("varying vec4 vWorldPosition;");for(var s=0;s<e.sectionPlanes.length;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("void main(void) {"),t){i.push("if (clippable) {"),i.push("  float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return i.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),i.push("}"),i}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new z(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,a=i.sectionPlanes.length;r<a;r++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+r),pos:s.getLocation("sectionPlanePos"+r),dir:s.getLocation("sectionPlaneDir"+r)});this._aPosition=s.getAttribute("position")}_buildMarkerList(){for(var e in this._numMarkers=0,this._markers)this._markers.hasOwnProperty(e)&&(this._markerList[this._numMarkers]=this._markers[e],this._markerIndices[e]=this._numMarkers,this._numMarkers++);this._markerList.length=this._numMarkers}_buildPositions(){for(var e=0,t=0;t<this._numMarkers;t++)if(this._markerList[t]){const i=this._markerList[t].worldPos;this._positions[e++]=i[0],this._positions[e++]=i[1],this._positions[e++]=i[2],this._indices[t]=t}this._positions.length=3*this._numMarkers}_buildVBOs(){if(this._positionsBuf){if(this._lenPositionsBuf===this._positions.length)return void this._positionsBuf.setData(this._positions);this._positionsBuf.destroy(),this._positionsBuf=null,this._indicesBuf.destroy(),this._indicesBuf=null}const e=this._scene.canvas.gl,t=3*this._numMarkers,i=this._numMarkers;this._positionsBuf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._positions),t,3,e.STATIC_DRAW),this._indicesBuf=new G(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._indices),i,1,e.STATIC_DRAW),this._lenPositionsBuf=this._positions.length}_buildOcclusionTestList(){let e,t,i,s,r,a=0;const o=this._scene.canvas.boundary,n=o[2],l=o[3];for(this._lenOcclusionTestList=0,r=0;r<this._numMarkers;r++)i=(t=(e=this._markerList[r]).canvasPos)[0],s=t[1],i+10<0||s+10<0||i-10>n||s-10>l?e._setVisible(!1):!e.entity||e.entity.visible?e.occludable?(this._occlusionTestList[this._lenOcclusionTestList++]=e,this._pixels[a++]=i,this._pixels[a++]=s):e._setVisible(!0):e._setVisible(!1)}drawMarkers(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._sectionPlanesState,a=t.camera,o=a._state;if(s.bind(),r.sectionPlanes.length>0){const e=t._sectionPlanesState.sectionPlanes;let s,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(s=this._uSectionPlanes[n]).active,a=e[n],r&&i.uniform1i(r,a.active),(o=s.pos)&&i.uniform3fv(s.pos,a.pos),(h=s.dir)&&i.uniform3fv(s.dir,a.dir)}i.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),i.uniformMatrix4fv(this._uProjMatrix,!1,a._project._state.matrix),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.POINTS,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}doOcclusionTest(){if(!j){const t=255*Y[0],i=255*Y[1],s=255*Y[2];for(var e=0;e<this._lenOcclusionTestList;e++){const r=this._occlusionTestList[e],a=2*e,o=this._readPixelBuf.read(this._pixels[a],this._pixels[a+1]),n=o[0]===t&&o[1]===i&&o[2]===s;r._setVisible(n)}}}unbindRenderBuf(){j||this._readPixelBuf.unbind()}destroy(){this._markers={},this._markerList.length=0,this._positionsBuf&&this._positionsBuf.destroy(),this._indicesBuf&&this._indicesBuf.destroy(),this._program&&this._program.destroy()}}const W=function(e,t){t=t||{};const i=new S,a=e.canvas.canvas,o=e.canvas.gl,n=!0===t.transparent,l=new s({});var h={},c={};let u=!0,d=!0,p=!0,_=!0,f=!0,m=null,g=null;function v(){u&&(!function(){for(var e in h)if(h.hasOwnProperty(e)){const s=h[e],r=s.drawableMap,a=s.drawableList;var t=0;for(var i in r)r.hasOwnProperty(i)&&(a[t++]=r[i]);a.length=t,s.lenDrawableList=t}}(),u=!1,d=!0),d&&(!function(){for(var e in h)if(h.hasOwnProperty(e)){const t=h[e];t.isStateSortable&&t.drawableList.sort(t.stateSortCompare)}}(),d=!1,p=!0)}this._occlusionTester=null,this.needStateSort=function(){d=!0},this.shadowsDirty=function(){_=!0},this.imageDirty=function(){p=!0},this.setBlendOneMinusSrcAlpha=function(e){f=e},this.webglContextLost=function(){},this.webglContextRestored=function(e){m&&m.webglContextRestored(e),g&&g.webglContextRestored(e),p=!0},this.addDrawable=function(e,t){var i=t.type;if(i){var s=h[i];s||(s={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableList:[],lenDrawableList:0},h[i]=s),s.count++,s.drawableMap[e]=t,c[e]=t,u=!0}else console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring")},this.removeDrawable=function(e){const t=c[e];if(!t)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring");const i=t.type,s=h[i];--s.count<=0?delete h[i]:delete s.drawableMap[e],delete c[e],u=!0},this.getPickID=function(e){return l.addItem(e)},this.putPickID=function(e){l.removeItem(e)},this.clear=function(t){t=t||{};const i=e.viewport.boundary;if(o.viewport(i[0],i[1],i[2],i[3]),n)o.clearColor(0,0,0,0);else{const i=t.ambientColor||e.canvas.backgroundColor||this.lights.getAmbientColor();o.clearColor(i[0],i[1],i[2],1)}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT|o.STENCIL_BUFFER_BIT)},this.render=function(e){e=e||{},v(),(p||e.force)&&(b(e),r.frame.frameCount++,p=!1)};var b=function(){const t=[],s=[],a=[],l=[],c=[],u=[],d=[],p=[],_=[],m=[],g=[],v=[],b=[],y=[],M=[],x=new k;return function(w){w.opaqueOnly;L.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint");const P=e._lightsState.getAmbientColor();i.reset(),i.pass=w.pass;const A=e.viewport.boundary;if(o.viewport(A[0],A[1],A[2],A[3]),n)o.clearColor(0,0,0,0);else{const t=e.canvas.backgroundColor||P;o.clearColor(t[0],t[1],t[2],1)}let E,C,R;o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),i.lineWidth=1;const D=Date.now();!1!==w.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT|o.STENCIL_BUFFER_BIT);let F=0,S=0,k=0,T=0,B=0,N=0,I=0,O=0,V=0,U=0,z=0,G=0,j=0,Y=0,H=0;for(var X in h)if(h.hasOwnProperty(X)){const e=h[X].drawableList;for(E=0,C=e.length;E<C;E++)!0!==(R=e[E]).culled&&!1!==R.visible&&(R.getRenderFlags(x),x.normalFillOpaque&&R.drawNormalFillOpaque(i),x.normalEdgesOpaque&&(t[F++]=R),x.normalFillTransparent&&(s[S++]=R),x.normalEdgesTransparent&&(a[k++]=R),x.xrayedFillTransparent&&(u[N++]=R),x.xrayedFillOpaque&&(l[T++]=R),x.xrayedEdgesTransparent&&(d[I++]=R),x.xrayedEdgesOpaque&&(c[B++]=R),x.highlightedFillTransparent&&(m[U++]=R),x.highlightedFillOpaque&&(p[O++]=R),x.highlightedEdgesTransparent&&(g[z++]=R),x.highlightedEdgesOpaque&&(_[V++]=R),x.selectedFillTransparent&&(y[Y++]=R),x.selectedFillOpaque&&(v[G++]=R),x.selectedEdgesTransparent&&(M[H++]=R),x.selectedEdgesOpaque&&(b[j++]=R))}if(F>0)for(E=0;E<F;E++)t[E].drawNormalEdgesOpaque(i);if(T>0)for(E=0;E<T;E++)l[E].drawXRayedFillOpaque(i);if(B>0)for(E=0;E<B;E++)c[E].drawXRayedEdgesOpaque(i);if(N>0||I>0||S>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),f?o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA):(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,I>0)for(E=0;E<I;E++)d[E].drawXRayedEdgesTransparent(i);if(N>0)for(E=0;E<N;E++)u[E].drawXRayedFillTransparent(i);if(S>0)for(E=0;E<S;E++)(R=s[E]).drawNormalFillTransparent(i);if(k>0)for(E=0;E<k;E++)(R=a[E]).drawNormalEdgesTransparent(i);o.disable(o.BLEND)}if(O>0||V>0){if(i.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),V>0)for(E=0;E<V;E++)_[E].drawHighlightedEdgesOpaque(i);if(O>0)for(E=0;E<O;E++)p[E].drawHighlightedFillOpaque(i)}if(U>0||z>0||O>0){if(i.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),z>0)for(E=0;E<z;E++)g[E].drawHighlightedEdgesTransparent(i);if(U>0)for(E=0;E<U;E++)m[E].drawHighlightedFillTransparent(i);o.disable(o.BLEND)}if(G>0||j>0){if(i.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),j>0)for(E=0;E<j;E++)b[E].drawSelectedEdgesOpaque(i);if(G>0)for(E=0;E<G;E++)v[E].drawSelectedFillOpaque(i)}if(Y>0||H>0){if(i.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),H>0)for(E=0;E<H;E++)M[E].drawSelectedEdgesTransparent(i);if(Y>0)for(E=0;E<Y;E++)y[E].drawSelectedFillTransparent(i);o.disable(o.BLEND)}const W=Date.now(),K=r.frame;K.renderTime=(W-D)/1e3,K.drawElements=i.drawElements,K.drawElements=i.drawElements,K.useProgram=i.useProgram,K.bindTexture=i.bindTexture,K.bindArray=i.bindArray;const q=L.MAX_TEXTURE_UNITS;for(let e=0;e<q;e++)o.activeTexture(o.TEXTURE0+e);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null)}}();this.pick=function(){const t=w.vec3(),s=w.mat4(),r=w.vec3([0,1,0]),n=w.frustumMat4(-1,1,-1,1,.1,1e4),c=new B;return function(u,d=c){let p,_,f,g,b;d.reset(),v(),L.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint");let M=null,x=null;d.pickSurface=u.pickSurface,u.canvasPos?(p=u.canvasPos[0],_=u.canvasPos[1],M=e.camera.viewMatrix,x=e.camera.projMatrix,d.canvasPos=u.canvasPos):(f=u.origin||w.vec3([0,0,0]),g=u.direction||w.vec3([0,0,1]),b=w.addVec3(f,g,t),M=w.lookAtMat4v(f,b,r,s),x=n,p=.5*a.clientWidth,_=.5*a.clientHeight,d.origin=f,d.direction=g),(m=m||new T(a,o)).bind();const P=function(t,s,r,a,n){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=a;const c=e.viewport.boundary;let u,d;o.viewport(c[0],c[1],c[2],c[3]),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const p=n.includeEntityIds,_=n.excludeEntityIds;for(var f in h)if(h.hasOwnProperty(f)){const e=h[f].drawableList;for(u=0,d=e.length;u<d;u++){const t=e[u];t.drawPickMesh&&!0!==t.culled&&!1!==t.visible&&!1!==t.pickable&&(p&&!p[t.id]||_&&_[t.id]||t.drawPickMesh(i))}}const g=m.read(Math.round(t),Math.round(s));let v=g[0]+256*g[1]+256*g[2]*256+256*g[3]*256*256;if(v<0)return;return l.items[v]}(p,_,M,x,u);return P?(u.pickSurface&&(P.canPickTriangle&&P.canPickTriangle()?(!function(t,s,r,a,n,l){if(!t.drawPickTriangles)return;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=a,i.pickProjMatrix=n;const h=e.viewport.boundary;o.viewport(h[0],h[1],h[2],h[3]),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.drawPickTriangles(i);const c=m.read(s,r);let u=c[0]+256*c[1]+256*c[2]*256+256*c[3]*256*256;u*=3,l.primIndex=u}(P,p,_,M,x,d),P.pickTriangleSurface(M,x,d)):P.canPickWorldPos&&P.canPickWorldPos()&&(y(P,p,_,M,x,d),function(t,s,r,a,n,l){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=a,i.pickProjMatrix=n;const h=e.viewport.boundary;o.viewport(h[0],h[1],h[2],h[3]),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.drawPickNormals(i);const c=m.read(Math.round(s),Math.round(r)),u=[c[0]/256-.5,c[1]/256-.5,c[2]/256-.5];w.normalizeVec3(u),l.worldNormal=u}(P,p,_,M,x,d))),m.unbind(),d.entity=P.delegatePickedEntity?P.delegatePickedEntity():P,d):(m.unbind(),null)}}();var y=function(){const t=w.vec4(),s=w.vec4(),r=w.vec4(),n=w.vec4(),l=w.vec4(),h=w.mat4(),c=w.mat4();return function(u,d,p,_,f,g){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=_,i.pickProjMatrix=f;const v=e.viewport.boundary;o.viewport(v[0],v[1],v[2],v[3]),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),u.drawPickDepths(i);const b=m.read(Math.round(d),Math.round(p)),y=(x=[(M=b)[0]/256,M[1]/256,M[2]/256,M[3]/256],w.dotVec4(x,[1/16777216,1/65536,1/256,1]));var M,x,P=(d-a.width/2)/(a.width/2),A=-(p-a.height/2)/(a.height/2),E=w.mulMat4(f,_,h),C=w.inverseMat4(E,c);t[0]=P,t[1]=A,t[2]=-1,t[3]=1;var L=w.transformVec4(C,t);L=w.mulVec4Scalar(L,1/L[3]),s[0]=P,s[1]=A,s[2]=1,s[3]=1;var R=w.transformVec4(C,s);R=w.mulVec4Scalar(R,1/R[3]);var D=w.subVec3(R,L,r),F=w.addVec3(L,w.mulVec4Scalar(D,y,n),l);g.worldPos=F}}();this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new X(e),this._occlusionTester.addMarker(t)},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e)},this.removeMarker=function(e){this._occlusionTester.removeMarker(e)},this.doOcclusionTest=function(){if(this._occlusionTester){v(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0;const a=e.viewport.boundary;for(var t in o.viewport(a[0],a[1],a[2],a[3]),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),h)if(h.hasOwnProperty(t)){const e=h[t].drawableList;for(var s=0,r=e.length;s<r;s++){const t=e[s];t.drawOcclusion&&!0!==t.culled&&!1!==t.visible&&!1!==t.pickable&&t.drawOcclusion(i)}}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(e,t,i,s){let r,n,l,h;for((g=g||(g=new T(a,o))).bind(),g.clear(),this.render({force:!0,opaqueOnly:s}),n=0;n<i;n++)l=2*n,h=4*n,r=g.read(e[l],e[l+1]),t[h]=r[0],t[h+1]=r[1],t[h+2]=r[2],t[h+3]=r[3];g.unbind(),p=!0},this.destroy=function(){h={},c={},m&&m.destroy(),g&&g.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class K extends P{get type(){return"Input"}constructor(e,t={}){super(e,t);const i=this;this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this._element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(e){i.enabled&&("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?i.ctrlDown=!0:e.altKey?i.altDown=!0:(i.keyDown[e.keyCode]=!0,i.fire("keydown",e.keyCode,!0))),i.mouseover&&e.preventDefault())},!1),document.addEventListener("keyup",this._keyUpListener=function(e){i.enabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey?i.ctrlDown=!1:e.altKey?i.altDown=!1:(i.keyDown[e.keyCode]=!1,i.fire("keyup",e.keyCode,!0)))}),t.element.addEventListener("mouseenter",this._mouseEnterListener=function(e){if(!i.enabled)return;i.mouseover=!0;const t=i._getClickCoordsWithinElement(e);i.fire("mouseenter",t,!0)}),t.element.addEventListener("mouseleave",this._mouseLeaveListener=function(e){if(!i.enabled)return;i.mouseover=!1;const t=i._getClickCoordsWithinElement(e);i.fire("mouseleave",t,!0)}),t.element.addEventListener("mousedown",this._mouseDownListener=function(e){if(!i.enabled)return;switch(e.which){case 1:i.mouseDownLeft=!0;break;case 2:i.mouseDownMiddle=!0;break;case 3:i.mouseDownRight=!0}const s=i._getClickCoordsWithinElement(e);t.element.focus(),i.fire("mousedown",s,!0),i.mouseover&&e.preventDefault()}),document.addEventListener("mouseup",this._mouseUpListener=function(e){if(!i.enabled)return;switch(e.which){case 1:i.mouseDownLeft=!1;break;case 2:i.mouseDownMiddle=!1;break;case 3:i.mouseDownRight=!1}const t=i._getClickCoordsWithinElement(e);i.fire("mouseup",t,!0),i.mouseover&&e.preventDefault()},!0),document.addEventListener("dblclick",this._dblClickListener=function(e){if(!i.enabled)return;switch(e.which){case 1:i.mouseDownLeft=!1,i.mouseDownRight=!1;break;case 2:i.mouseDownMiddle=!1;break;case 3:i.mouseDownLeft=!1,i.mouseDownRight=!1}const t=i._getClickCoordsWithinElement(e);i.fire("dblclick",t,!0),i.mouseover&&e.preventDefault()}),t.element.addEventListener("mousemove",this._mouseMoveListener=function(e){if(!i.enabled)return;const t=i._getClickCoordsWithinElement(e);i.fire("mousemove",t,!0),i.mouseover&&e.preventDefault()}),t.element.addEventListener("wheel",this._mouseWheelListener=function(e,t){if(!i.enabled)return;const s=Math.max(-1,Math.min(1,40*-e.deltaY));i.fire("mousewheel",s,!0)},{passive:!0}),function(){let e,t;i.on("mousedown",function(i){e=i[0],t=i[1]}),i.on("mouseup",function(s){e>=s[0]-2&&e<=s[0]+2&&t>=s[1]-2&&t<=s[1]+2&&i.fire("mouseclicked",s,!0)})}(),function(){const e={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0};let t,s;const r=w.vec3(),a=w.vec3(),o={orientation:null,orientationAngle:0},n={orientationAngle:0,acceleration:null,accelerationIncludingGravity:a,rotationRate:w.vec3(),interval:0},l={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",i._orientationchangedListener=function(){t=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=t&&e[t]||0,o.orientation=t,o.orientationAngle=s,i.fire("orientationchange",o)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",i._deviceMotionListener=function(e){n.interval=e.interval,n.orientationAngle=s;const t=e.acceleration;t?(r[0]=t.x,r[1]=t.y,r[2]=t.z,n.acceleration=r):n.acceleration=null;const o=e.accelerationIncludingGravity;o?(a[0]=o.x,a[1]=o.y,a[2]=o.z,n.accelerationIncludingGravity=a):n.accelerationIncludingGravity=null,n.rotationRate=e.rotationRate,i.fire("devicemotion",n)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",i._deviceOrientListener=function(e){l.gamma=e.gamma,l.beta=e.beta,l.alpha=e.alpha,l.absolute=e.absolute,i.fire("deviceorientation",l)},!1)}()}_getClickCoordsWithinElement(e){const t=[0,0];if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t.x=e.x,t.y=e.y;return t}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}destroy(){super.destroy(),document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this._element.removeEventListener("mouseenter",this._mouseEnterListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("dblclick",this._dblClickListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener)}}const q=new s({});class Z{constructor(e){this.id=q.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){q.removeItem(this.id)}}class $ extends P{get type(){return"Viewport"}constructor(e,t={}){super(e,t),this._state=new Z({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(e){const t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.glRedraw(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Q extends P{get type(){return"Perspective"}constructor(e,t={}){super(e,t),this._state=new Z({matrix:w.mat4(),near:.1,far:1e4}),this._dirty=!1,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far}_update(){const e=this.scene.viewport.boundary,t=e[2]/e[3];let i=this._fov;const s=this._fovAxis;("x"===s||"min"===s&&t<1||"max"===s&&t>1)&&(i/=t),i=Math.min(i,120),w.perspectiveMat4(i*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(e){this._fov=null!=e?e:60,this._needUpdate(0),this.fire("fov",this._fov)}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy(),this.scene.canvas.off(this._canvasResized)}}class J extends P{get type(){return"Ortho"}constructor(e,t={}){super(e,t),this._state=new Z({matrix:w.mat4(),near:.1,far:1e4}),this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const e=this.scene,t=.5*this._scale,i=e.viewport.boundary,s=i[2],r=i[3],a=s/r;let o,n,l,h;s>r?(o=-t,n=t,l=t/a,h=-t/a):(o=-t*a,n=t*a,l=t,h=-t),w.orthoMat4c(o,n,h,l,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class ee extends P{get type(){return"Frustum"}constructor(e,t={}){super(e,t),this._state=new Z({matrix:w.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far}_update(){w.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=null!=e?e:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=null!=e?e:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=null!=e?e:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=null!=e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class te extends P{get type(){return"CustomProjection"}constructor(e,t={}){super(e,t),this._state=new Z({matrix:w.mat4()}),this.matrix=t.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.glRedraw(),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}destroy(){super.destroy(),this._state.destroy()}}const ie=w.vec3(),se=w.vec3(),re=w.vec3(),ae=w.vec3(),oe=w.vec3(),ne=w.vec3(),le=w.mat4(),he=w.mat4(),ce=w.vec3(),ue=w.vec3(),de=w.vec3(),pe=w.vec3();class _e extends P{get type(){return"Camera"}constructor(e,t={}){super(e,t),this._state=new Z({deviceMatrix:w.mat4(),hasDeviceMatrix:!1,matrix:w.mat4(),normalMatrix:w.mat4()}),this._perspective=new Q(this),this._ortho=new J(this),this._frustum=new ee(this),this._customProjection=new te(this),this._project=this._perspective,this._eye=w.vec3([0,0,10]),this._look=w.vec3([0,0,0]),this._up=w.vec3([0,1,0]),this._worldUp=w.vec3([0,1,0]),this._worldRight=w.vec3([1,0,0]),this._worldForward=w.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const e=this._state;let t;"ortho"===this.projection?(w.subVec3(this._eye,this._look,ce),w.normalizeVec3(ce,ue),w.mulVec3Scalar(ue,1e3,de),w.addVec3(this._look,de,pe),t=pe):t=this._eye,e.hasDeviceMatrix?(w.lookAtMat4v(t,this._look,this._up,he),w.mulMat4(e.deviceMatrix,he,e.matrix)):w.lookAtMat4v(t,this._look,this._up,e.matrix),w.inverseMat4(this._state.matrix,this._state.normalMatrix),w.transposeMat4(this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=w.subVec3(this._eye,this._look,ie);w.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,le),t=w.transformPoint3(le,t,se),this.eye=w.addVec3(this._look,t,re),this.up=w.transformPoint3(le,this._up,ae)}orbitPitch(e){if(this._constrainPitch&&(e=w.dotVec3(this._up,this._worldUp)/w.DEGTORAD)<1)return;let t=w.subVec3(this._eye,this._look,ie);const i=w.cross3Vec3(w.normalizeVec3(t,se),w.normalizeVec3(this._up,re));w.rotationMat4v(.0174532925*e,i,le),t=w.transformPoint3(le,t,ae),this.up=w.transformPoint3(le,this._up,oe),this.eye=w.addVec3(t,this._look,ne)}yaw(e){let t=w.subVec3(this._look,this._eye,ie);w.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,le),t=w.transformPoint3(le,t,se),this.look=w.addVec3(t,this._eye,re),this._gimbalLock&&(this.up=w.transformPoint3(le,this._up,ae))}pitch(e){if(this._constrainPitch&&(e=w.dotVec3(this._up,this._worldUp)/w.DEGTORAD)<1)return;let t=w.subVec3(this._look,this._eye,ie);const i=w.cross3Vec3(w.normalizeVec3(t,se),w.normalizeVec3(this._up,re));w.rotationMat4v(.0174532925*e,i,le),this.up=w.transformPoint3(le,this._up,ne),t=w.transformPoint3(le,t,ae),this.look=w.addVec3(t,this._eye,oe)}pan(e){const t=w.subVec3(this._eye,this._look,ie),i=[0,0,0];let s;if(0!==e[0]){const r=w.cross3Vec3(w.normalizeVec3(t,[]),w.normalizeVec3(this._up,se));s=w.mulVec3Scalar(r,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==e[1]&&(s=w.mulVec3Scalar(w.normalizeVec3(this._up,re),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==e[2]&&(s=w.mulVec3Scalar(w.normalizeVec3(t,ae),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=w.addVec3(this._eye,i,oe),this.look=w.addVec3(this._look,i,ne)}zoom(e){const t=w.subVec3(this._eye,this._look,ie),i=Math.abs(w.lenVec3(t,se)),s=Math.abs(i+e);if(s<.5)return;const r=w.normalizeVec3(t,re);this.eye=w.addVec3(this._look,w.mulVec3Scalar(r,s),ae)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=new Float32Array(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return w.lenVec3(w.subVec3(this._look,this._eye,ie))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}class fe extends P{get type(){return"Light"}get isLight(){return!0}constructor(e,t={}){super(e,t)}}class me extends fe{get type(){return"DirLight"}constructor(e,t={}){super(e,t);const i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new Z({type:"dir",dir:w.vec3([1,1,1]),color:w.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){w.vec3();const e=w.vec3([0,1,0]);return function(){if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=w.identityMat4());const t=i._state.dir;w.lookAtMat4v([-t[0],-t[1],-t[2]],[0,0,0],e,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix}}(),getShadowProjMatrix:function(){return i._shadowProjMatrixDirty&&(i._shadowProjMatrix||(i._shadowProjMatrix=w.identityMat4()),w.orthoMat4c(-10,10,-10,10,0,500,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1),i._shadowProjMatrix},getShadowRenderBuf:function(){return i._shadowRenderBuf||(i._shadowRenderBuf=new T(i.scene.canvas.canvas,i.scene.canvas.gl,{size:[1024,1024]})),i._shadowRenderBuf}}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class ge extends fe{get type(){return"AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:w.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=void 0!==e?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy()}}class ve extends P{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,t={}){super(e,t),r.memory.meshes++}destroy(){super.destroy(),r.memory.meshes--}}var be=function(){const e=[],t=[],i=[],s=[],r=[];let a=0;const o=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=w.vec3(),c=w.vec3(),u=w.vec3(),d=w.vec3(),p=w.vec3(),_=w.vec3(),f=w.vec3();return function(m,g,v,b){!function(r,a){const o={};let n,l,h,c;const u=Math.pow(10,4);let d,p,_=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],void 0===o[c=Math.round(n*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u)]&&(o[c]=_/3,e[_++]=n,e[_++]=l,e[_++]=h),t[d/3]=o[c];for(d=0,p=a.length;d<p;d++)s[d]=t[a[d]],i[s[d]]=a[d]}(m,g),function(t,i){a=0;for(let m=0,g=t;m<g;m+=3){const t=3*s[m],g=3*s[m+1],v=3*s[m+2];i?(o[0]=e[t],o[1]=e[t+1],o[2]=e[t+2],n[0]=e[g],n[1]=e[g+1],n[2]=e[g+2],l[0]=e[v],l[1]=e[v+1],l[2]=e[v+2],w.decompressPosition(o,i,h),w.decompressPosition(n,i,c),w.decompressPosition(l,i,u)):(h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],c[0]=e[g],c[1]=e[g+1],c[2]=e[g+2],u[0]=e[v],u[1]=e[v+1],u[2]=e[v+2]),w.subVec3(u,c,d),w.subVec3(h,c,p),w.cross3Vec3(d,p,_),w.normalizeVec3(_,f);const b=r[a]||(r[a]={normal:w.vec3()});b.normal[0]=f[0],b.normal[1]=f[1],b.normal[2]=f[2],a++}}(g.length,v);const y=[],M=Math.cos(w.DEGTORAD*b),x={};let P,A,E,C,L,R,D,F,S,k,T,B=!1;for(let e=0,t=g.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)P=s[e+i],A=s[e+(i+1)%3],void 0===x[L=(E=Math.min(P,A))+","+(C=Math.max(P,A))]?x[L]={index1:E,index2:C,face1:t,face2:void 0}:x[L].face2=t}for(L in x)void 0!==(R=x[L]).face2&&(D=r[R.face1].normal,F=r[R.face2].normal,(S=w.dotVec3(D,F))>M)||(k=i[R.index1],T=i[R.index2],(!B&&k>65535||T>65535)&&(B=!0),y.push(k),y.push(T));return B?new Uint32Array(y):new Uint16Array(y)}}();function ye(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(a))*(r>=0?1:-1),t=(1-Math.abs(r))*(a>=0?1:-1);r=e,a=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*a+(a<0?-1:0))])}function Me(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function xe(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}const we={getPositionsBounds:function(e){const t=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=3)for(r=0;r<3;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},compressPositions:function(){const e=w.mat4(),t=w.mat4();return function(i,s,r){const a=new Uint16Array(i.length);var o=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let n;for(n=0;n<i.length;n+=3)a[n+0]=Math.floor((i[n+0]-s[0])*o[0]),a[n+1]=Math.floor((i[n+1]-s[1])*o[1]),a[n+2]=Math.floor((i[n+2]-s[2])*o[2]);return w.identityMat4(e),w.translationMat4v(s,e),w.identityMat4(t),w.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],t),{quantized:a,decodeMatrix:w.mulMat4(e,t,w.identityMat4())}}}(),decompressPositions:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressPosition:function(e,t,i){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i},decompressAABB:function(e,t,i=e){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i[3]=e[3]*t[0]+t[12],i[4]=e[4]*t[5]+t[13],i[5]=e[5]*t[10]+t[14],i},getUVBounds:function(e){const t=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=2)for(r=0;r<2;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},compressUVs:function(){const e=w.mat3(),t=w.mat3();return function(i,s,r){const a=new Uint16Array(i.length),o=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let n;for(n=0;n<i.length;n+=2)a[n+0]=Math.floor((i[n+0]-s[0])*o[0]),a[n+1]=Math.floor((i[n+1]-s[1])*o[1]);return w.identityMat3(e),w.translationMat3v(s,e),w.identityMat3(t),w.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],t),{quantized:a,decodeMatrix:w.mulMat3(e,t,w.identityMat3())}}}(),decompressUVs:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},compressNormals:function(e){const t=new Int8Array(e.length);let i,s,r,a,o;for(let n=0;n<e.length;n+=3)r=i=ye(e,n,"floor","floor"),a=o=xe(e,n,s=Me(i)),(a=xe(e,n,s=Me(i=ye(e,n,"ceil","floor"))))>o&&(r=i,o=a),(a=xe(e,n,s=Me(i=ye(e,n,"floor","ceil"))))>o&&(r=i,o=a),(a=xe(e,n,s=Me(i=ye(e,n,"ceil","ceil"))))>o&&(r=i,o=a),t[n]=r[0],t[n+1]=r[1];return t},decompressNormals:function(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],a=e[i+1];r=(2*r+1)/255,a=(2*a+1)/255;const o=1-Math.abs(r)-Math.abs(a);o<0&&(r=(1-Math.abs(a))*(r>=0?1:-1),a=(1-Math.abs(r))*(a>=0?1:-1));const n=Math.sqrt(r*r+a*a+o*o);t[s+0]=r/n,t[s+1]=a/n,t[s+2]=o/n,s+=3}return t},decompressNormal:function(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const a=Math.sqrt(i*i+s*s+r*r);return t[0]=i/a,t[1]=s/a,t[2]=r/a,t}},Pe=r.memory,Ae=L.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ee=Ae?Uint32Array:Uint16Array,Ce=w.AABB3();class Le extends ve{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Z({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(this._state.compressGeometry){const e=we.getPositionsBounds(t.positions),s=we.compressPositions(t.positions,e.min,e.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(i.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const e=we.getUVBounds(t.uv),s=we.compressUVs(t.uv,e.min,e.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);if(t.normals&&(this._state.compressGeometry?i.normals=we.compressNormals(t.normals):i.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices){if(!Ae&&t.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");i.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Ee(t.indices)}this._buildHash(),Pe.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new G(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),Pe.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new G(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),Pe.positions+=e.positionsBuf.numItems),e.normals){let i=e.compressGeometry;e.normalsBuf=new G(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),Pe.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new G(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),Pe.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new G(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),Pe.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=be(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new G(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),Pe.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=w.buildPickTriangles(e.positions,e.indices,e.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new G(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new G(t,t.ARRAY_BUFFER,r,r.length,4,t.STATIC_DRAW,!0),Pe.positions+=this._pickTrianglePositionsBuf.numItems,Pe.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),we.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.compressGeometry){const i=we.getPositionsBounds(e),s=we.compressPositions(e,i.min,i.max);e=s.quantized,t.positionsDecodeMatrix=s.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),we.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),we.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=w.AABB3()),w.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=w.OBB3()),w.positions3ToAABB3(this._state.positions,Ce,this._state.positionsDecodeMatrix),w.AABB3ToOBB3(Ce,this._obb),this._obbDirty=!1),this._obb}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Pe.meshes--}}class Re extends P{get type(){return"Material"}constructor(e,t={}){super(e,t),r.memory.materials++}destroy(){super.destroy(),r.memory.materials--}}const De={opaque:0,mask:1,blend:2},Fe=["opaque","mask","blend"];class Se extends Re{get type(){return"PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new Z({type:"PhongMaterial",ambient:w.vec3([1,1,1]),diffuse:w.vec3([1,1,1]),specular:w.vec3([1,1,1]),emissive:w.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=void 0!==e?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){let t=De[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return Fe[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const ke={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Te extends Re{get type(){return"EmphasisMaterial"}get presets(){return ke}constructor(e,t={}){super(e,t),this._state=new Z({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",t.preset?(this.preset=t.preset,void 0!==t.fill&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),void 0!==t.fillAlpha&&(this.fillAlpha=t.fillAlpha),void 0!==t.edges&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth),void 0!==t.backfaces&&(this.backfaces=t.backfaces)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces)}set fill(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set preset(e){if(e=e||"default",this._preset===e)return;const t=ke[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ke).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Be={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class Ne extends Re{get type(){return"EdgeMaterial"}get presets(){return Be}constructor(e,t={}){super(e,t),this._state=new Z({type:"EdgeMaterial",edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth)}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=Be[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Be).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}function Ie(e,t){const i={};let s,r;for(let a=0,o=t.length;a<o;a++)s=t[a],(r=e.component[s])?r.isEntity?i[s]=!0:e.warn("pick(): Component is not an Entity: "+s):e.warn("pick(): Component not found: "+s);return i}class Oe extends P{get type(){return"Scene"}constructor(e={}){if(super(null,e),!e.canvasId)throw"Mandatory config expected: canvasId";const t=document.getElementById(e.canvasId);if(!t)throw"Canvas not found: '"+e.canvasId+"'";const i=!!e.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this.visibleObjects={},this.xrayedObjects={},this.highlightedObjects={},this.selectedObjects={},this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.canvas=new F(this,{dontClear:!0,canvas:t,spinnerElementId:e.spinnerElementId,transparent:i,backgroundColor:e.backgroundColor,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},clearColorAmbient:e.clearColorAmbient}),this.canvas.on("boundary",()=>{this.glRedraw()}),this.canvas.on("webglContextFailed",()=>{alert("xeokit failed to find WebGL!")}),this._renderer=new W(this,{transparent:i}),this._sectionPlanesState=new function(){this.sectionPlanes=[];let e=null;this.getHash=function(){if(e)return e;const t=this.sectionPlanes;if(0===t.length)return this.hash=";";let i;const s=[];for(let e=0,r=t.length;e<r;e++)i=t[e],s.push("cp");return s.push(";"),e=s.join("")},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null},this.removeSectionPlane=function(t){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===t.id)return this.sectionPlanes.splice(i,1),void(e=null)}},this._lightsState=new function(){const e=w.vec3([0,0,0]),t=w.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const e=[],t=this.lights;let s;for(let i=0,r=t.length;i<r;i++)s=t[i],e.push("/"),e.push(s.type),e.push("world"===s.space?"w":"v"),s.castsShadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),i=e.join("")},this.addLight=function(e){this.lights.push(e),s=null,i=null},this.removeLight=function(e){for(let t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),s&&s.id===e.id&&(s=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(let t=0,s=this.reflectionMaps.length;t<s;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(let t=0,s=this.lightMaps.length;t<s;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColor=function(){if(!s)for(let e=0,t=this.lights.length;e<t;e++){const t=this.lights[e];if("ambient"===t.type){s=t;break}}if(s){const e=s.color,i=s.intensity;return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}return e}},this.input=new K(this,{dontClear:!0,element:this.canvas.canvas}),this.ticksPerRender=e.ticksPerRender,this.ticksPerOcclusionTest=e.ticksPerOcclusionTest,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor,v._addScene(this),this._initDefaults(),this._viewport=new $(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new _e(this,{id:"default.camera",dontClear:!0}),new ge(this,{color:[.3,.3,.3],intensity:1}),new me(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new me(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new me(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"}),this._camera.on("dirty",()=>{this._renderer.imageDirty()})}_initDefaults(){let e;e=this.geometry,e=this.material,e=this.xrayMaterial,e=this.edgeMaterial,e=this.selectedMaterial,e=this.highlightMaterial}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+n.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="_"+window.nextID++;this.components[e.id];)e.id=w.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var t=e.id,i=e.type;delete this.components[t];const s=this.types[i];s&&(delete s[t],n.isEmptyObject(s)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this._needRecompile=!0}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){delete this.models[e.id],this._modelIds=null}_registerObject(e){this.objects[e.id]=e,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._objectIds=null}_objectVisibilityUpdated(e){e.visible?this.visibleObjects[e.id]=e:delete this.visibleObjects[e.id],this._visibleObjectIds=null}_objectXRayedUpdated(e){e.xrayed?this.xrayedObjects[e.id]=e:delete this.xrayedObjects[e.id],this._xrayedObjectIds=null}_objectHighlightedUpdated(e){e.highlighted?this.highlightedObjects[e.id]=e:delete this.highlightedObjects[e.id],this._highlightedObjectIds=null}_objectSelectedUpdated(e){e.selected?this.selectedObjects[e.id]=e:delete this.selectedObjects[e.id],this._selectedObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&v.runTasks();const t={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),t.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,a;for(r=0;r<i;r++)t.pass=r,this.fire("rendering",t,!0),a=s||0===r,this._renderer.render({pass:r,clear:a,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile()}_saveAmbientColor(){const e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{const t=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=w.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}set ticksPerRender(e){null==e?e=1:(!n.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){null==e?e=20:(!n.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){null==e?e=1:(!n.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0)}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){(e=!1!==e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0)}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||function(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=e.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=e.center,a=r?r[0]:0,o=r?r[1]:0,l=r?r[2]:0,h=-t+a,c=-i+o,u=-s+l,d=t+a,p=i+o,_=s+l;return n.apply(e,{positions:[d,p,_,h,p,_,h,c,_,d,c,_,d,p,_,d,c,_,d,c,u,d,p,u,d,p,_,d,p,u,h,p,u,h,p,_,h,p,_,h,p,u,h,c,u,h,c,_,h,c,u,d,c,u,d,c,_,h,c,_,d,c,u,h,c,u,h,p,u,d,p,u],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}(Le)}get material(){return this.components["default.material"]||new Se(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Te(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Te(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Te(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new Ne(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=w.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=w.AABB3());let e,t=w.MAX_DOUBLE,i=w.MAX_DOUBLE,s=w.MAX_DOUBLE,r=-w.MAX_DOUBLE,a=-w.MAX_DOUBLE,o=-w.MAX_DOUBLE;const n=this._collidables;let l,h=!1;for(const c in n)if(n.hasOwnProperty(c)){if(!1===(l=n[c]).collidable)continue;(e=l.aabb)[0]<t&&(t=e[0]),e[1]<i&&(i=e[1]),e[2]<s&&(s=e[2]),e[3]>r&&(r=e[3]),e[4]>a&&(a=e[4]),e[5]>o&&(o=e[5]),h=!0}h||(t=-1,i=-1,s=-1,r=1,a=1,o=1),this._aabb[0]=t,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=a,this._aabb[5]=o,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.origin&&e.direction||this.warn("picking without canvasPos or ray origin and direction");const i=e.includeEntities||e.include;i&&(e.includeEntityIds=Ie(this,i));const s=e.excludeEntities||e.exclude;return s&&(e.excludeEntityIds=Ie(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=this._renderer.pick(e,t))?(t.entity.fire&&t.entity.fire("picked",t),t):void 0}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearClips(){const e=Object.keys(this.sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}getAABB(e){if(void 0===e)return this.aabb;if(n.isString(e)){const t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e]}if(0===e.length)return this.aabb;let t,i=1e5,s=1e5,r=1e5,a=-1e5,o=-1e5,l=-1e5;if(this._withEntities(e,this.objects,e=>{if(e.collidable){const n=e.aabb;n[0]<i&&(i=n[0]),n[1]<s&&(s=n[1]),n[2]<r&&(r=n[2]),n[3]>a&&(a=n[3]),n[4]>o&&(o=n[4]),n[5]>l&&(l=n[5]),t=!0}}),t){const e=w.AABB3();return e[0]=i,e[1]=s,e[2]=r,e[3]=a,e[4]=o,e[5]=l,e}return this.aabb}setObjectsVisible(e,t){return this._withEntities(e,this.objects,e=>{const i=e.visible!==t;return e.visible=t,i})}setObjectsCollidable(e,t){return this._withEntities(e,this.objects,e=>{const i=e.collidable!==t;return e.collidable=t,i})}setObjectsCulled(e,t){return this._withEntities(e,this.objects,e=>{const i=e.culled!==t;return e.culled=t,i})}setObjectsSelected(e,t){return this._withEntities(e,this.objects,e=>{const i=e.selected!==t;return e.selected=t,i})}setObjectsHighlighted(e,t){return this._withEntities(e,this.objects,e=>{const i=e.highlighted!==t;return e.highlighted=t,i})}setObjectsXRayed(e,t){return this._withEntities(e,this.objects,e=>{const i=e.xrayed!==t;return e.xrayed=t,i})}setObjectsEdges(e,t){return this._withEntities(e,this.objects,e=>{const i=e.edges!==t;return e.edges=t,i})}setObjectsColorized(e,t){return this._withEntities(e,this.objects,e=>{e.colorize=t})}setObjectsOpacity(e,t){return this._withEntities(e,this.objects,e=>{const i=e.opacity!==t;return e.opacity=t,i})}setObjectsPickable(e,t){return this._withEntities(e,this.objects,e=>{const i=e.pickable!==t;return e.pickable=t,i})}_withEntities(e,t,i){n.isString(e)&&(e=[e]);let s=!1;for(let r=0,a=e.length;r<a;r++){let a=t[e[r]];a&&(s=i(a)||s)}return s}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Ve=w.vec3(),Ue=w.vec3(),ze=w.vec3(),Ge=w.vec3(),je=w.vec3();class Ye extends P{get type(){return"CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=w.vec3(),this._eye1=w.vec3(),this._up1=w.vec3(),this._look2=w.vec3(),this._eye2=w.vec3(),this._up2=w.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==t.easing,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera,r=!!e.projection&&e.projection!==s.projection;let a,o,l,h,c;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)a=e.aabb;else if(6===e.length)a=e;else if(e.eye&&e.look||e.up)o=e.eye,l=e.look,h=e.up;else if(e.eye)o=e.eye;else if(e.look)l=e.look;else{let s=e;if((n.isNumeric(s)||n.isString(s))&&(c=s,!(s=this.scene.components[c])))return this.error("Component not found: "+n.inQuotes(c)),void(t&&(i?t.call(i):t()));r||(a=s.aabb||this.scene.aabb)}const u=e.poi;if(a){if(a[3]<a[0]||a[4]<a[1]||a[5]<a[2])return;if(a[3]===a[0]&&a[4]===a[1]&&a[5]===a[2])return;a=a.slice();const t=w.getAABB3Center(a);this._look2=u||t;const i=w.subVec3(this._eye1,this._look1,Ve),s=w.normalizeVec3(i),r=u?w.getAABB3DiagPoint(a,u):w.getAABB3Diag(a),o=e.fitFOV||this._fitFOV,n=Math.abs(r/Math.tan(o*w.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*n,this._eye2[1]=this._look2[1]+s[1]*n,this._eye2[2]=this._look2[2]+s[2]*n,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(o||l||h)&&(this._flyingEyeLookUp=!!o&&!!l&&!!h,this._flyingEye=!!o&&!l,this._flyingLook=!!l&&!o,o&&(this._eye2[0]=o[0],this._eye2[1]=o[1],this._eye2[2]=o[2]),l&&(this._look2[0]=l[0],this._look2[1]=l[1],this._look2[2]=l[2]),h&&(this._up2[0]=h[0],this._up2[1]=h[1],this._up2[2]=h[2]));r&&("ortho"===e.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),s.ortho.scale=this._orthoScale2,this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===e.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")),this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,v.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,r,a,o;if(e.aabb)i=e.aabb;else if(6===e.length)i=e;else if(e.eye||e.look||e.up)r=e.eye,a=e.look,o=e.up;else{let t=e;if((n.isNumeric(t)||n.isString(t))&&(s=t,!(t=this.scene.components[s])))return void this.error("Component not found: "+n.inQuotes(s));i=t.aabb||this.scene.aabb}const l=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var h=l?w.getAABB3DiagPoint(i,l):w.getAABB3Diag(i);let s;a=l||w.getAABB3Center(i,a),this._trail?w.subVec3(t.look,a,je):w.subVec3(t.eye,t.look,je),w.normalizeVec3(je),s=(void 0!==e.fit?e.fit:this._fit)?Math.abs(h/Math.tan((e.fitFOV||this._fitFOV)*w.DEGTORAD)):w.lenVec3(w.subVec3(t.eye,t.look,Ve)),w.mulVec3Scalar(je,s),t.eye=w.addVec3(a,je,Ve),t.look=a,this.scene.camera.ortho.scale=1.1*h}else(r||a||o)&&(r&&(t.eye=r),a&&(t.look=a),o&&(t.up=o))}_update(){if(!this._flying)return;let e=(Date.now()-this._time1)/(this._time2-this._time1);const t=e>=1;e>1&&(e=1);const i=this.easing?Ye._ease(e,0,1,1):e,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(w.subVec3(s.eye,s.look,je),s.eye=w.lerpVec3(i,0,1,this._eye1,this._eye2,ze),s.look=w.subVec3(ze,je,Ue)):this._flyingLook&&(s.look=w.lerpVec3(i,0,1,this._look1,this._look2,Ue),s.up=w.lerpVec3(i,0,1,this._up1,this._up2,Ge)):this._flyingEyeLookUp&&(s.eye=w.lerpVec3(i,0,1,this._eye1,this._eye2,ze),s.look=w.lerpVec3(i,0,1,this._look1,this._look2,Ue),s.up=w.lerpVec3(i,0,1,this._up1,this._up2,Ge)),this._projection2){const t="ortho"===this._projection2?Ye._easeOutExpo(e,0,1,1):Ye._easeInCubic(e,0,1,1);s.customProjection.matrix=w.lerpMat4(t,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);t?this.stop():v.scheduleTask(this._update,this)}static _ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}static _easeInCubic(e,t,i,s){return i*(e/=s)*e*e+t}static _easeOutExpo(e,t,i,s){return i*(1-Math.pow(2,-10*e/s))+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?1e3*e:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=!1!==e}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}}class He extends P{get type(){return"CameraControl"}constructor(e,t={}){super(e,t);const i=this;this._pivoter=new function(){const e=i.scene,t=e.camera,s=e.canvas,r=new Float32Array(3);let a,o=0,n=0,l=0,h=!1;const c=document.createElement("div");c.innerText=" ",c.style.color="#ffffff",c.style.position="absolute",c.style.width="25px",c.style.height="25px",c.style.left="0px",c.style.top="0px",c.style["border-radius"]="15px",c.style.border="2px solid #ffffff",c.style.background="black",c.style.visibility="hidden",c.style["box-shadow"]="5px 5px 15px 1px #000000",c.style["z-index"]=0,c.style["pointer-events"]="none",document.body.appendChild(c),function(){const i=w.vec4(),a=w.vec4(),o=w.vec2();let n=!0;t.on("viewMatrix",function(){n=!0}),t.on("projMatrix",function(){n=!0}),e.on("tick",function(){if(h&&n){w.transformPoint3(t.viewMatrix,r,i),i[3]=1,w.transformPoint4(t.projMatrix,i,a);const e=s.boundary;o[0]=Math.floor((1+a[0]/a[3])*e[2]/2),o[1]=Math.floor((1-a[1]/a[3])*e[3]/2);const l=s.canvas.getBoundingClientRect();c.style.left=Math.floor(l.left+o[0])-12+"px",c.style.top=Math.floor(l.top+o[1])-12+"px",c.style.visibility="visible",n=!1}})}(),this.startPivot=function(e){e&&r.set(e);let i=w.lookAtMat4v(t.eye,t.look,t.worldUp);(a=w.transformPoint3(i,r))[2]+=w.distVec3(t.eye,r),i=w.inverseMat4(i);const s=w.transformVec3(i,a),c=w.vec3();if(w.subVec3(t.eye,r,c),w.addVec3(c,s),1===t.worldUp[2]){const e=c[1];c[1]=c[2],c[2]=e}l=w.lenVec3(c),n=Math.acos(c[1]/l),o=Math.atan2(c[0],c[2]),h=!0},this.getPivoting=function(){return h},this.getPivotPos=function(){return r},this.continuePivot=function(e,i){if(!h)return;if(0===e&&0===i)return;1===t.worldUp[2]&&(s=-s);var s=-e;o+=.01*-s,n+=.01*-i,n=w.clamp(n,.001,Math.PI-.001);const u=[l*Math.sin(n)*Math.sin(o),l*Math.cos(n),l*Math.sin(n)*Math.cos(o)];if(1===t.worldUp[2]){const e=u[1];u[1]=u[2],u[2]=e}const d=w.lenVec3(w.subVec3(t.look,t.eye,w.vec3()));w.addVec3(u,r);let p=w.lookAtMat4v(u,r,t.worldUp);p=w.inverseMat4(p);const _=w.transformVec3(p,a);p[12]-=_[0],p[13]-=_[1],p[14]-=_[2];const f=[p[8],p[9],p[10]];t.eye=[p[12],p[13],p[14]],w.subVec3(t.eye,w.mulVec3Scalar(f,d),t.look),t.up=[p[4],p[5],p[6]],c.style.visibility="visible"},this.endPivot=function(){c.style.visibility="hidden",h=!1}},this._cameraFlight=new Ye(this,{duration:.5}),this.planView=t.planView,this.firstPerson=t.firstPerson,this.walking=t.walking,this.keyboardLayout=t.keyboardLayout,this.doublePickFlyTo=t.doublePickFlyTo,this.active=t.active,this.pivoting=t.pivoting,this.panToPointer=t.panToPointer,this.panToPivot=t.panToPivot,this.inertia=t.inertia,this.pointerEnabled=!0,this._initEvents()}set active(e){this._active=!1!==e}get active(){return this._active}set pivoting(e){this._pivoting=!!e}get pivoting(){return this._pivoting}set panToPointer(e){this._panToPointer=!!e,this._panToPointer&&(this._panToPivot=!1)}get panToPointer(){return this._panToPointer}set panToPivot(e){this._panToPivot=!!e,this._panToPivot&&(this._panToPointer=!1)}get panToPivot(){return this._panToPivot}set planView(e){this._planView=!!e}get planView(){return this._planView}set firstPerson(e){this._firstPerson=!!e}get firstPerson(){return this._firstPerson}set walking(e){this._walking=!!e}get walking(){return this._walking}set doublePickFlyTo(e){this._doublePickFlyTo=!1!==e}get doublePickFlyTo(){return this._doublePickFlyTo}set inertia(e){this._inertia=void 0===e?.5:e}get inertia(){return this._inertia}set pointerEnabled(e){this._pointerEnabled=!!e}get pointerEnabled(){return this._pointerEnabled}set keyboardLayout(e){this._keyboardLayout=e||"qwerty"}get keyboardLayout(){return this._keyboardLayout}_initEvents(){const e=this,t=this.scene,i=t.input,s=t.camera,r=this.scene.canvas.canvas;let a=!1;r.oncontextmenu=function(e){e.preventDefault()};const o=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t},n=[0,0];let l,h,c=!1,u=!1,d=!1,p=!1;function _(){if(e._pointerEnabled&&(c||u)){if(d=!1,p=!1,h=u||e.hasSubs("hoverSurface")?t.pick({pickSurface:!0,canvasPos:n}):t.pick({canvasPos:n})){d=!0;const i=h.entity.id;l!==i&&(void 0!==l&&e.fire("hoverOut",{entity:t.components[l]}),e.fire("hoverEnter",h),l=i),e.fire("hover",h),h.worldPos&&(p=!0,e.fire("hoverSurface",h))}else void 0!==l&&(e.fire("hoverOut",{entity:t.components[l]}),l=void 0),e.fire("hoverOff",{canvasPos:n});c=!1,u=!1}}t.on("tick",_),function(){let n=0,l=0,c=0,d=0,f=0,m=0;const g=w.vec2();let v=!1,b=!1,y=!1,M=!1;const x={},P=function(){const e=new Float32Array(3);return function(){return w.lenVec3(w.subVec3(s.look,s.eye,e))}}(),A=function(){let e=!0;s.on("projMatrix",function(){e=!0});const t=w.mat4();return function(){return e&&w.inverseMat4(s.projMatrix,t),t}}(),E=function(){let e=!0;s.on("projMatrix",function(){e=!0});const t=w.mat4();return function(){return e&&w.transposeMat4(s.projMatrix,t),t}}(),C=function(){let e=!0;s.on("viewMatrix",function(){e=!0});const t=w.mat4();return function(){return e&&w.inverseMat4(s.viewMatrix,t),t}}(),L=function(){let e=!0,i=1;return t.on("boundary",function(){e=!0}),function(){return e&&(i=w.getAABB3Diag(t.aabb)),i}}(),R=function(){const e=w.vec4(),i=w.vec4(),r=w.vec4(),a=w.vec3();return function(o,n){const l=A(),h=C(),c=E(),u=c.subarray(8,12),d=c.subarray(12),p=[0,0,-L(),1];!function(i,s,r,a,o,n){const l=t.canvas.canvas,h=l.offsetWidth/2,c=l.offsetHeight/2;e[0]=(r[0]-h)/h,e[1]=(r[1]-c)/c,e[2]=a,e[3]=1,w.mulMat4v4(i,e,o),w.mulVec3Scalar(o,1/o[3]),o[3]=1,o[1]*=-1,w.mulMat4v4(s,o,n)}(l,h,o,w.dotVec4(p,u)/w.dotVec4(p,d),i,r),w.subVec3(r,s.eye,a),w.normalizeVec3(a);const _=a[0]*n,f=a[1]*n,m=a[2]*n,g=s.eye,v=s.look;s.eye=[g[0]+_,g[1]+f,g[2]+m],s.look=[v[0]+_,v[1]+f,v[2]+m]}}(),D=function(){const e=w.vec3();return function(t,i){w.subVec3(t,s.eye,e),w.normalizeVec3(e);const r=e[0]*i,a=e[1]*i,o=e[2]*i,n=s.eye,l=s.look;s.eye=[n[0]+r,n[1]+a,n[2]+o],s.look=[l[0]+r,l[1]+a,l[2]+o]}}();function F(){const e=t.aabb,i=e[3]-e[0],s=e[4]-e[1],r=e[5]-e[2];let a=i>s?i:s;return(a=r>a?r:a)/30}t.on("tick",function(){const t=e._inertia;if(Math.abs(n)<.001&&(n=0),Math.abs(l)<.001&&(l=0),0===l&&0===n||(e._pivoter.getPivoting()?e._pivoter.continuePivot(l,n):(0!==n&&(e._firstPerson?s.pitch(-n):s.orbitPitch(n)),0!==l&&(e._firstPerson?s.yaw(l):s.orbitYaw(l))),n*=t,l*=t),Math.abs(c)<.001&&(c=0),Math.abs(d)<.001&&(d=0),Math.abs(f)<.001&&(f=0),0!==c||0!==d||0!==f){const t=P()/80;if(e._walking){let e=s.eye[1];s.pan([c*t,d*t,f*t]);let i=s.eye;i[1]=e,s.eye=i}else s.pan([c*t,d*t,f*t])}if(c*=t,d*=t,f*=t,Math.abs(m)<.001&&(m=0),0!==m){if(e._firstPerson){let t;if(e._walking&&(t=s.eye[1]),v?R(g,2*-m):s.pan([0,0,m]),e._walking){let e=s.eye;e[1]=t,s.eye=e}}else e._panToPointer?(_(),p&&h.worldPos?D(h.worldPos,-m):s.zoom(m)):e._panToPivot?D(e._pivoter.getPivotPos(),-m):s.zoom(m),s.ortho.scale=s.ortho.scale+m;m*=t}}),document.addEventListener("keyDown",function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(b=t.ctrlKey||17===t.keyCode||t.metaKey,y=t.altKey||18===t.keyCode,M=16===t.keyCode,x[t.keyCode]=!0)},!0),document.addEventListener("keyup",function(t){e._active&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&((t.ctrlKey||17===t.keyCode)&&(b=!1),(t.altKey||18===t.keyCode)&&(y=!1),16===t.keyCode&&(M=!1),x[t.keyCode]=!1)}),function(){let s,h,p,_,b,y=0,x=0,w=!1;r.addEventListener("mousedown",function(t){if(e._active&&e._pointerEnabled)switch(a=!0,t.which){case 1:p=!0,w=!0,y=0,x=0,o(t,g),s=g[0],h=g[1];break;case 2:_=!0;break;case 3:b=!0,w=!0,y=0,x=0,o(t,g),s=g[0],h=g[1]}}),r.addEventListener("mouseup",function(t){if(e._active&&e._pointerEnabled){switch(t.which){case 1:p=!1;break;case 2:_=!1;break;case 3:b=!1}w=!1,y=0,x=0}}),document.addEventListener("mouseup",function(t){if(e._active&&e._pointerEnabled){switch(t.which){case 1:p=!1;break;case 2:_=!1;break;case 3:b=!1}w=!1,y=0,x=0}}),r.addEventListener("mouseenter",function(){e._active&&e._pointerEnabled&&(a=!0,y=0,x=0)}),r.addEventListener("mouseleave",function(){e._active&&e._pointerEnabled&&(a=!1,y=0,x=0)}),r.addEventListener("mousemove",function(t){if(!e._active||!e._pointerEnabled)return;if(!a)return;if(o(t,g),v=!0,!w)return;const i=g[0],r=g[1];y+=.4*(i-s),x+=.4*(r-h),s=i,h=r}),t.on("tick",function(){if(!e._active||!e._pointerEnabled)return;if(0===Math.abs(y)&&0===Math.abs(x))return;M||b?(c=.1*y,d=.1*x):e._planView||(l=.4*-y,n=.4*x),y=0,x=0}),r.addEventListener("wheel",function(t){if(!e._active||!e._pointerEnabled)return;e._panToPointer&&(u=!0);const i=Math.max(-1,Math.min(1,40*-t.deltaY));if(0===i)return;const s=i/Math.abs(i);m=-s*F()*.1,t.preventDefault()}),t.on("tick",function(t){if(!e._active||!e._pointerEnabled)return;if(!a)return;const s=t.deltaTime;if(!e.ctrlDown&&!e.altDown){const e=i.keyDown[i.KEY_ADD],t=i.keyDown[i.KEY_SUBTRACT];(e||t)&&(t?m=s*F()*.02:e&&(m=-s*F()*.02))}}),t.on("tick",function(t){if(!e._active||!e._pointerEnabled)return;if(!a)return;const s=t.deltaTime;let r,o,n,l,h,u;"azerty"===e._keyboardLayout?(r=i.keyDown[i.KEY_Z],o=i.keyDown[i.KEY_S],n=i.keyDown[i.KEY_Q],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_W],u=i.keyDown[i.KEY_X]):(r=i.keyDown[i.KEY_W],o=i.keyDown[i.KEY_S],n=i.keyDown[i.KEY_A],l=i.keyDown[i.KEY_D],h=i.keyDown[i.KEY_Z],u=i.keyDown[i.KEY_X]),(r||o||n||l||h||u)&&(u?d+=.02*s:h&&(d+=.02*-s),l?c+=.02*-s:n&&(c+=.02*s),o?f=.02*s:r&&(f=.02*-s))})}(),function(){let t;const i=new Float32Array(2);let s=-1;const a=[];let o=0;const h=new Float32Array(2),u=new Float32Array(2),p=50,_=0;let f=_,g=Date.now();function v(e){const t=Date.now();return f===_?(f=e,!0):f===e?t-g>p:(f=e,g=t,!1)}r.addEventListener("touchstart",function(r){if(!e._active||!e._pointerEnabled)return;const n=r.touches,l=r.changedTouches;for(t=Date.now(),1===n.length&&1===l.length?(s=t,i[0]=n[0].pageX,i[1]=n[0].pageY):s=-1;a.length<n.length;)a.push(new Float32Array(2));for(let e=0,t=n.length;e<t;++e)a[e][0]=n[e].pageX,a[e][1]=n[e].pageY;f=_,o=n.length,r.stopPropagation()},{passive:!0}),r.addEventListener("touchmove",function(t){if(!e._active||!e._pointerEnabled)return;const i=t.touches;if(1===o){var s=i[0];if(v(1)){const e=s.pageX-a[0][0],t=s.pageY-a[0][1];n+=.3*t,l+=-(.3*e)}}else if(2===o){s=i[0];const e=i[1];w.subVec2([s.pageX,s.pageY],a[0],h),w.subVec2([e.pageX,e.pageY],a[1],u);const t=w.dotVec2(h,u)>0;if(t&&v(2)&&(w.subVec2([s.pageX,s.pageY],a[0],h),c+=.2*h[0],d+=.2*h[1]),!t&&v(4)){const t=w.distVec2([s.pageX,s.pageY],[e.pageX,e.pageY]),i=w.distVec2(a[0],a[1]);m=(i-t)*F()*.05}}for(let e=0;e<o;++e)a[e][0]=i[e].pageX,a[e][1]=i[e].pageY;t.stopPropagation()},{passive:!0})}(),t.on("tick",function(t){if(!e._active||!e._pointerEnabled)return;if(!a)return;if(e._planView)return;const s=t.deltaTime,r=i.keyDown[i.KEY_LEFT_ARROW],o=i.keyDown[i.KEY_RIGHT_ARROW],h=i.keyDown[i.KEY_UP_ARROW],c=i.keyDown[i.KEY_DOWN_ARROW];(r||o||h||c)&&(o?l+=.02*-s:r&&(l+=.02*s),c?n+=.02*s:h&&(n+=.02*-s))}),t.on("tick",function(t){if(!e._active||!e._pointerEnabled)return;if(!a)return;const s=t.deltaTime;let r,o;"azerty"===e._keyboardLayout?(r=i.keyDown[i.KEY_A],o=i.keyDown[i.KEY_E]):(r=i.keyDown[i.KEY_Q],o=i.keyDown[i.KEY_E]),(o||r)&&(r?l+=.02*s:o&&(l+=.02*-s))})}(),function(){let t,i,s,a;r.addEventListener("mousemove",function(t){e._active&&e._pointerEnabled&&(o(t,n),(e.hasSubs("hover")||e.hasSubs("hoverOut")||e.hasSubs("hoverOff")||e.hasSubs("hoverSurface"))&&(c=!0))}),r.addEventListener("mousedown",function(r){e._active&&e._pointerEnabled&&(t=r.clientX,i=r.clientY,s=n[0],a=n[1],u=e._pivoting,_(),e._pivoting&&(h?e._pivoter.startPivot(h.worldPos):e._pivoter.startPivot()))}),r.addEventListener("mouseup",function(r){let o,l=0;return function(r){if(e._active&&e._pointerEnabled&&(e._pivoter.endPivot(),!(Math.abs(r.clientX-t)>3||Math.abs(r.clientY-i)>3))){if(!(e._doublePickFlyTo||e.hasSubs("doublePicked")||e.hasSubs("doublePickedSurface")||e.hasSubs("doublePickedNothing")))return u=!!e.hasSubs("pickedSurface"),_(),void(h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"));1==++l?o=setTimeout(function(){c=e._doublePickFlyTo,u=c||!!e.hasSubs("pickedSurface"),n[0]=s,n[1]=a,_(),h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"),l=0},250):(clearTimeout(o),c=e._doublePickFlyTo,u=c&&!!e.hasSubs("doublePickedSurface"),_(),h?(e.fire("doublePicked",h),p&&e.fire("doublePickedSurface",h),e._doublePickFlyTo&&e._flyTo(h)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),l=0)}}}(),!1)}(),function(){let t;const i=[],s=new Float32Array(2);let a=-1,o=-1;r.addEventListener("touchstart",function(r){if(!e._active||!e._pointerEnabled)return;const o=r.touches,n=r.changedTouches;for(t=Date.now(),1===o.length&&1===n.length?(a=t,s[0]=o[0].pageX,s[1]=o[0].pageY):a=-1;i.length<o.length;)i.push(new Float32Array(2));for(let e=0,t=o.length;e<t;++e)i[e][0]=o[e].pageX,i[e][1]=o[e].pageY;i.length=o.length,r.stopPropagation()},{passive:!0}),r.addEventListener("touchend",function(t){if(!e._active||!e._pointerEnabled)return;const r=Date.now(),l=t.touches,d=t.changedTouches;0===l.length&&1===d.length&&a>-1&&r-a<150&&(o>-1&&a-o<325?(n[0]=Math.round(d[0].clientX),n[1]=Math.round(d[0].clientY),c=!0,u=!!e.hasSubs("pickedSurface"),_(),h?(e.fire("doublePicked",h),p&&e.fire("doublePickedSurface",h),e._doublePickFlyTo&&e._flyTo(h)):(e.fire("doublePickedNothing"),e._doublePickFlyTo&&e._flyTo()),o=-1):w.distVec2(i[0],s)<4&&(n[0]=Math.round(d[0].clientX),n[1]=Math.round(d[0].clientY),c=!0,u=!!e.hasSubs("pickedSurface"),_(),h?(e.fire("picked",h),p&&e.fire("pickedSurface",h)):e.fire("pickedNothing"),o=r),a=-1),i.length=l.length;for(let e=0,t=l.length;e<t;++e)i[e][0]=l[e].pageX,i[e][1]=l[e].pageY;t.stopPropagation()},{passive:!0})}(),function(){const i=w.vec3(),r=w.vec3(),o=w.vec3(),n=w.vec3(),l={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)};document.addEventListener("keydown",function(h){if(!e._active||!e._pointerEnabled)return;if(!a)return;const c=h.keyCode;if(49!==c&&50!==c&&51!==c&&52!==c&&53!==c&&54!==c)return;const u=t.aabb,d=w.getAABB3Diag(u);i[0]=u[0]+u[3]/2,i[1]=u[1]+u[4]/2,i[2]=u[2]+u[5]/2;const p=Math.abs(d/Math.tan(e._cameraFlight.fitFOV/2));switch(c){case 49:l.eye.set(w.mulVec3Scalar(s.worldRight,p,r)),l.look.set(i),l.up.set(s.worldUp);break;case 50:l.eye.set(w.mulVec3Scalar(s.worldForward,p,r)),l.look.set(i),l.up.set(s.worldUp);break;case 51:l.eye.set(w.mulVec3Scalar(s.worldRight,-p,r)),l.look.set(i),l.up.set(s.worldUp);break;case 52:l.eye.set(w.mulVec3Scalar(s.worldForward,-p,r)),l.look.set(i),l.up.set(s.worldUp);break;case 53:l.eye.set(w.mulVec3Scalar(s.worldUp,p,r)),l.look.set(i),l.up.set(w.normalizeVec3(w.mulVec3Scalar(s.worldForward,1,o),n));break;case 54:l.eye.set(w.mulVec3Scalar(s.worldUp,-p,r)),l.look.set(i),l.up.set(w.normalizeVec3(w.mulVec3Scalar(s.worldForward,-1,o)));break;default:return}e._cameraFlight.duration>0?e._cameraFlight.flyTo(l):e._cameraFlight.jumpTo(l)})}()}_flyTo(e){let t;e&&e.worldPos&&(t=e.worldPos);const i=e?e.entity.aabb:this.scene.aabb;if(t){const e=this.scene.camera;w.subVec3(e.eye,e.look,[]);this._cameraFlight.flyTo({aabb:i})}else this._cameraFlight.flyTo({aabb:i})}destroy(){this.active=!1,super.destroy()}}class Xe{constructor(e,t,i,s,r){this.id=t,this.projectId=i,this.revisionId=s,this.metaScene=e,this.rootMetaObject=r}getJSON(){var e=[];return function t(i){var s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),e.push(s);var r=i.children;if(r)for(var a=0,o=r.length;a<o;a++)t(r[a])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:e}}}class We{constructor(e,t,i,s,r,a,o,n){this.metaModel=e,this.id=t,this.name=i,this.type=s,r&&(this.properties=r),null!=a&&(this.parent=a),null!=o&&(this.children=o),null!=n&&(this.external=n)}getObjectIDsInSubtree(){const e=[];return function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var r=0,a=s.length;r<a;r++)t(s[r])}(this),e}getObjectIDsInSubtreeByType(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=e[i];const r=[];return function e(i){if(!i)return;t[i.type]&&r.push(i.id);const s=i.children;if(s)for(var a=0,o=s.length;a<o;a++)e(s[a])}(this),r}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class Ke{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}createMetaModel(e,t,i={}){const s=t.projectId||"none",r=t.revisionId||"none",a=t.metaObjects;const o=new Xe(this,e,s,r,null);this.metaModels[e]=o;for(let e=0,t=a.length;e<t;e++){const t=a[e],i=t.type;void 0;const s=t.id,r=t.name,n=t.properties,l=null,h=null,c=t.external,u=new We(o,s,r,i,n,l,h,c);this.metaObjects[s]=u,(this.metaObjectsByType[i]||(this.metaObjectsByType[i]={}))[s]=u,void 0===this._typeCounts[i]?this._typeCounts[i]=1:this._typeCounts[i]++}for(let e=0,t=a.length;e<t;e++){const t=a[e],i=t.id,s=this.metaObjects[i];if(s)if(void 0===t.parent||null===t.parent)o.rootMetaObject=s;else{let e=this.metaObjects[t.parent];s.parent=e,e.children=e.children||[],e.children.push(s)}}return o}destroyMetaModel(e){const t=this.metaModels[e];if(!t)return;const i=this.metaObjects,s=this.metaObjectsByType;let r=e=>{delete i[e.id];const t=s[e.type];t&&t[e.id]&&(delete t[e.id],0==--this._typeCounts[e.type]&&(delete this._typeCounts[e.type],delete s[e.type]));const a=e.children;if(a)for(let e=0,t=a.length;e<t;e++){const t=a[e];r(t)}};r(t.rootMetaObject),delete this.metaModels[e],this.fire("metaModelDestroyed",e)}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e){const t=[];return function e(i){if(!i)return;t.push(i.id);const s=i.children;if(s)for(var r=0,a=s.length;r<a;r++)e(s[r])}(this.metaObjects[e]),t}}class qe{constructor(e){this.language="en",this.scene=new Oe({viewer:this,canvasId:e.canvasId,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==e.preserveDrawingBuffer},spinnerElementId:e.spinnerElementId,transparent:!1!==e.transparent,gammaInput:!0,gammaOutput:!0,clearColorAmbient:e.clearColorAmbient,ticksPerRender:1,ticksPerOcclusionTest:20}),this.metaScene=new Ke(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new Ye(this.scene,{duration:.5}),this.cameraControl=new He(this.scene,{doublePickFlyTo:!0}),this.plugins={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this.plugins[e.id]&&this.error(`Plugin with this ID already installed: ${e.id}`),this.plugins[e.id]=e,this.log(`Installed plugin: ${e.id}`)}removePlugin(e){const t=this.plugins[e.id];t?t===e?(t.clear&&t.clear(),delete this.plugins[e.id],this.log(`Removed plugin: ${e.id}`)):this.error(`Can't remove plugin - a different plugin is installed with this ID: ${e.id}`):this.error(`Can't remove plugin - no plugin with this ID is installed: ${e.id}`)}sendToPlugins(e,t){const i=this.plugins;for(const s in i)i.hasOwnProperty(s)&&i[s].send(e,t)}clear(){this.sendToPlugins("clear")}resetView(){this.sendToPlugins("resetView")}getSnapshot(e={}){this.sendToPlugins("snapshotStarting"),this.scene.render();const t=this.scene.canvas._getSnapshot(e);return this.sendToPlugins("snapshotFinished"),t}destroy(){for(let e in this.plugins)this.plugins.hasOwnProperty(e)&&this.plugins[e].destroy();this.scene.destroy()}}const Ze=new Uint16Array([0,0,0,0]);class $e{constructor(e,t,i,s,r=null,a=0){this.model=e,this.object=null,this.parent=null,this.id=t,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=w.AABB3(),this._layer=r,this._portionId=a,this._color=[i[0],i[1],i[2],s]}_initFlags(e){this._layer.initFlags(this._portionId,e)}_setVisible(e){this._layer.setVisible(this._portionId,e)}_setColor(e,t){Ze[0]=Math.floor(this._color[0]/255*(e[0]/255)*255),Ze[1]=Math.floor(this._color[1]/255*(e[1]/255)*255),Ze[2]=Math.floor(this._color[2]/255*(e[2]/255)*255),Ze[3]=Math.floor(this._color[3]/255*(e[3]/255)*255),this._layer.setColor(this._portionId,Ze,t)}_setHighlighted(e){this._layer.setHighlighted(this._portionId,e)}_setXRayed(e){this._layer.setXRayed(this._portionId,e)}_setSelected(e){this._layer.setSelected(this._portionId,e)}_setEdges(e){this._layer.setEdges(this._portionId,e)}_setClippable(e){this._layer.setClippable(this._portionId,e)}_setCollidable(e){this._layer.setCollidable(this._portionId,e)}_setPickable(e){this._layer.setPickable(this._portionId,e)}canPickTriangle(){return!1}drawPickTriangles(e){}pickTriangleSurface(e){}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const Qe={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096},Je=new Float32Array([0,0,0]);class et{constructor(e,t,i,s,r,a){this._isObject=t,this.model=e,this.meshes=s;for(var o=0,n=this.meshes.length;o<n;o++){this.meshes[o].parent=this}this.id=i,this._flags=r,this._colorize=new Uint8Array([255,255,255,255]),this._aabb=a,this._isObject&&e.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._aabb}set visible(e){if(!!(this._flags&Qe.VISIBLE)!==e){this._flags=e?this._flags|Qe.VISIBLE:this._flags&~Qe.VISIBLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get visible(){return this._getFlag(Qe.VISIBLE)}_getFlag(e){return!!(this._flags&e)}set highlighted(e){if(!!(this._flags&Qe.HIGHLIGHTED)!==e){this._flags=e?this._flags|Qe.HIGHLIGHTED:this._flags&~Qe.HIGHLIGHTED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(Qe.HIGHLIGHTED)}set xrayed(e){if(!!(this._flags&Qe.XRAYED)!==e){this._flags=e?this._flags|Qe.XRAYED:this._flags&~Qe.XRAYED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(Qe.XRAYED)}set selected(e){if(!!(this._flags&Qe.SELECTED)!==e){this._flags=e?this._flags|Qe.SELECTED:this._flags&~Qe.SELECTED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(Qe.SELECTED)}set edges(e){if(!!(this._flags&Qe.EDGES)!==e){this._flags=e?this._flags|Qe.EDGES:this._flags&~Qe.EDGES;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get edges(){return this._getFlag(Qe.EDGES)}set culled(e){}get culled(){return!1}set clippable(e){if(!!(this._flags&Qe.CLIPPABLE)!==e){this._flags=e?this._flags|Qe.CLIPPABLE:this._flags&~Qe.CLIPPABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(Qe.CLIPPABLE)}set collidable(e){if(!!(this._flags&Qe.COLLIDABLE)!==e){this._flags=e?this._flags|Qe.COLLIDABLE:this._flags&~Qe.COLLIDABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get collidable(){return this._getFlag(Qe.COLLIDABLE)}set pickable(e){if(!!(this._flags&Qe.PICKABLE)!==e){this._flags=e?this._flags|Qe.PICKABLE:this._flags&~Qe.PICKABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get pickable(){return this._getFlag(Qe.PICKABLE)}set colorize(e){this._colorize[0]=Math.floor(255*e[0]),this._colorize[1]=Math.floor(255*e[1]),this._colorize[2]=Math.floor(255*e[2]);for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColor(this._colorize,!1);this.model.glRedraw()}get colorize(){return Je[0]=this._colorize[0]/255,Je[1]=this._colorize[1]/255,Je[2]=this._colorize[2]/255,Je}set opacity(e){if(e<0?e=0:e>1&&(e=1),e=Math.floor(255*e),this._colorize[3]===e)return;this._colorize[3]=e;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColor(this._colorize,!0);this.model.glRedraw()}get opacity(){return this._colorize[3]/255}set castsShadow(e){}get castsShadow(){return!1}set receivesShadow(e){}get receivesShadow(){return!1}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._initFlags(this._flags)}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._objectVisibilityUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this));for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._destroy();e._aabbDirty=!0}}const tt=L.SUPPORTED_EXTENSIONS.OES_element_index_uint,it=!0,st=it?tt?5e6:65530:5e6;class rt{constructor(){this.slicing=it,this.maxVerts=st,this.positions=new Float32Array(3*st),this.colors=new Uint8Array(4*st),this.quantizedPositions=new Uint16Array(3*st),this.normals=new Int8Array(3*st),this.pickColors=new Uint8Array(4*st),this.flags=new Uint8Array(4*st),this.flags2=new Uint8Array(4*st),this.indices=tt?new Uint32Array(6*st):new Uint16Array(6*st),this.edgeIndices=tt?new Uint32Array(6*st):new Uint16Array(6*st),this.lenPositions=0,this.lenColors=0,this.lenNormals=0,this.lenPickColors=0,this.lenFlags=0,this.lenIndices=0,this.lenEdgeIndices=0}}const at=[];function ot(e){at.push(e)}const nt={NORMAL_OPAQUE:0,NORMAL_TRANSPARENT:1,NORMAL_EDGES:2,HIGHLIGHTED:3,HIGHLIGHTED_EDGES:4,XRAYED:5,XRAYED_EDGES:6,SELECTED:7,SELECTED_EDGES:8},lt=function(e){this.vertex=function(e){var t=e.model.scene;const i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0;let a,o,n;const l=[];for(l.push("// Batched geometry drawing vertex shader"),l.push("uniform int renderPass;"),l.push("attribute vec3 position;"),l.push("attribute vec3 normal;"),l.push("attribute vec4 color;"),l.push("attribute vec4 flags;"),l.push("attribute vec4 flags2;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),l.push("uniform mat4 positionsDecodeMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec4 lightAmbient;"),a=0,o=s.lights.length;a<o;a++)"ambient"!==(n=s.lights[a]).type&&(l.push("uniform vec4 lightColor"+a+";"),"dir"===n.type&&l.push("uniform vec3 lightDir"+a+";"),"point"===n.type&&l.push("uniform vec3 lightPos"+a+";"),"spot"===n.type&&(l.push("uniform vec3 lightPos"+a+";"),l.push("uniform vec3 lightDir"+a+";")));l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"),r&&(l.push("varying vec4 vWorldPosition;"),l.push("varying vec4 vFlags2;"));for(l.push("varying vec4 vColor;"),l.push("void main(void) {"),l.push("bool visible      = (float(flags.x) > 0.0);"),l.push("bool xrayed       = (float(flags.y) > 0.0);"),l.push("bool highlighted  = (float(flags.z) > 0.0);"),l.push("bool selected     = (float(flags.w) > 0.0);"),l.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),l.push(`if (\n    !visible ||  \n    (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${nt.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),l.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),l.push("} else {"),l.push("vec4 worldPosition = (positionsDecodeMatrix * vec4(position, 1.0)); "),l.push("vec4 viewPosition  = viewMatrix * worldPosition; "),l.push("vec4 worldNormal =  vec4(octDecode(normal.xy), 0.0); "),l.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),a=0,o=s.lights.length;a<o;a++)if("ambient"!==(n=s.lights[a]).type){if("dir"===n.type)"view"===n.space?l.push("viewLightDir = normalize(lightDir"+a+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if("point"===n.type)"view"===n.space?l.push("viewLightDir = normalize(lightPos"+a+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else{if("spot"!==n.type)continue;"view"===n.space?l.push("viewLightDir = normalize(lightDir"+a+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}l.push("vColor = colorize *  vec4(reflectedColor * ((lightAmbient.rgb * lightAmbient.a) + vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0)), float(color.a) / 255.0);"),r&&(l.push("vWorldPosition = worldPosition;"),l.push("vFlags2 = flags2;"));return l.push("gl_Position = projMatrix * viewPosition;"),l.push("}"),l.push("}"),l}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,a=[];if(a.push("// Batched geometry drawing fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),r)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("varying vec4 vColor;"),a.push("void main(void) {"),r){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = vColor;"),a.push("}"),a}(e)};const ht=new s({}),ct=function(e,t){this.id=ht.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new lt(t),this._allocate(t)},ut={},dt=new Float32Array([1,1,1,1]);function pt(e){return[e.canvas.canvas.id,"",e._lightsState.getHash(),e._sectionPlanesState.getHash()].join(";")}ct.get=function(e){const t=pt(e.model.scene);let i=ut[t];if(!i){if((i=new ct(t,e)).errors)return console.log(i.errors.join("\n")),null;ut[t]=i,r.memory.programs++}return i._useCount++,i},ct.prototype.getValid=function(){return this._hash===pt(this._scene)},ct.prototype.put=function(){0==--this._useCount&&(ht.removeItem(this.id),this._program&&this._program.destroy(),delete ut[this._hash],r.memory.programs--)},ct.prototype.webglContextRestored=function(){this._program=null},ct.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state;if(this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.uniform1i(this._uRenderPass,i),this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aNormal&&(this._aNormal.bindArrayBuffer(o.normalsBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(o.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),e.bindArray++),o.indicesBuf.bind(),e.bindArray++,i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColorize,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColorize,t[0],t[1],t[2],i)}else a.uniform4fv(this._uColorize,dt);a.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++},ct.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._lightsState,r=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const a=this._program;this._uRenderPass=a.getLocation("renderPass"),this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uColorize=a.getLocation("colorize"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=s.lights;let n;for(let e=0,t=o.length;e<t;e++)switch((n=o[e]).type){case"ambient":this._uLightAmbient[e]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[e]=a.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=a.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=a.getLocation("lightColor"+e),this._uLightPos[e]=a.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=a.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=a.getLocation("lightColor"+e),this._uLightPos[e]=a.getLocation("lightPos"+e),this._uLightDir[e]=a.getLocation("lightDir"+e),this._uLightAttenuation[e]=a.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let e=0,t=r.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+e),pos:a.getLocation("sectionPlanePos"+e),dir:a.getLocation("sectionPlaneDir"+e)});this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._aFlags2=a.getAttribute("flags2")},ct.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._lightsState,o=i._sectionPlanesState,n=a.lights;let l;r.bind(),e.useProgram++;const h=i.camera;s.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix);for(var c=0,u=n.length;c<u;c++)l=n[c],this._uLightAmbient[c]?s.uniform4f(this._uLightAmbient[c],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[c]&&s.uniform4f(this._uLightColor[c],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[c]&&(s.uniform3fv(this._uLightPos[c],l.pos),this._uLightAttenuation[c]&&s.uniform1f(this._uLightAttenuation[c],l.attenuation)),this._uLightDir[c]&&s.uniform3fv(this._uLightDir[c],l.dir));if(o.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,n;for(c=0,u=this._uSectionPlanes.length;c<u;c++)r=(t=this._uSectionPlanes[c]).active,a=e[c],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(n=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const _t=function(e){this.vertex=function(e){const t=e.model.scene,i=t._sectionPlanesState,s=(t._lightsState,i.sectionPlanes.length>0);const r=[];r.push("// Batched fill vertex shader"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform vec4 color;"),s&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;"));r.push("void main(void) {"),r.push("bool visible      = (float(flags.x) > 0.0);"),r.push("bool xrayed       = (float(flags.y) > 0.0);"),r.push("bool highlighted  = (float(flags.z) > 0.0);"),r.push("bool selected     = (float(flags.w) > 0.0);"),r.push("bool clippable    = (float(flags2.x) > 0.0);"),r.push("bool transparent  = (color.a < 1.0);"),r.push(`if (\n    !visible || \n    (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${nt.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;"));return r.push("gl_Position = projMatrix * viewPosition;"),r.push("}"),r.push("}"),r}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,a=[];if(a.push("// Batched fill fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),r)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("uniform vec4 color;"),a.push("void main(void) {"),r){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = color;"),a.push("}"),a}(e)};const ft=new s({}),mt=function(e,t){this.id=ft.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new _t(t),this._allocate(t)},gt={},vt=new Float32Array([1,1,1,1]);function bt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}mt.get=function(e){const t=bt(e.model.scene);let i=gt[t];if(!i){if((i=new mt(t,e)).errors)return console.log(i.errors.join("\n")),null;gt[t]=i,r.memory.programs++}return i._useCount++,i},mt.prototype.getValid=function(){return this._hash===bt(this._scene)},mt.prototype.put=function(){0==--this._useCount&&(ft.removeItem(this.id),this._program&&this._program.destroy(),delete gt[this._hash],r.memory.programs--)},mt.prototype.webglContextRestored=function(){this._program=null},mt.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,s.worldMatrix),this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),e.bindArray++),o.indicesBuf.bind(),e.bindArray++,i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.SELECTED){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else a.uniform4fv(this._uColor,vt);a.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++}},mt.prototype._allocate=function(e){const t=e.model.scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},mt.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;r.bind(),e.useProgram++;const o=i.camera;if(s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const yt=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry edges drawing vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("uniform vec4 color;"),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = false;"),i.push("bool edges        = (float(flags2.y) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`if (\n    !visible || !edges ||\n    (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) ||\n    (renderPass == ${nt.NORMAL_TRANSPARENT} &&  (!transparent || xrayed || highlighted || selected)) ||\n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) ||\n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;"));return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,a=[];if(a.push("// Batched geometry edges drawing fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),r)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("uniform vec4 color;"),a.push("void main(void) {"),r){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = color;"),a.push("}"),a}(e)};const Mt=new s({}),xt=function(e,t){this.id=Mt.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new yt(t),this._allocate(t)},wt={};new Float32Array([1,1,1,1]);function Pt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}xt.get=function(e){const t=Pt(e.model.scene);let i=wt[t];if(!i){if((i=new xt(t,e)).errors)return console.log(i.errors.join("\n")),null;wt[t]=i,r.memory.programs++}return i._useCount++,i},xt.prototype.getValid=function(){return this._hash===Pt(this._scene)},xt.prototype.put=function(){0==--this._useCount&&(Mt.removeItem(this.id),this._program&&this._program.destroy(),delete wt[this._hash],r.memory.programs--)},xt.prototype.webglContextRestored=function(){this._program=null},xt.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.SELECTED){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else{const e=r.edgeMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.uniform1i(this._uRenderPass,i),this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),e.bindArray++),o.edgeIndicesBuf.bind(),e.bindArray++,a.drawElements(a.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0),e.drawElements++}},xt.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uColor=r.getLocation("color"),this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},xt.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;r.bind(),e.useProgram++;const o=i.camera;if(s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};class At{constructor(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry picking vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}(e)}}const Et=new s({}),Ct=function(e,t){this.id=Et.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new At(t),this._allocate(t)},Lt={};function Rt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Ct.get=function(e){const t=Rt(e.model.scene);let i=Lt[t];if(!i){if((i=new Ct(t,e)).errors)return console.log(i.errors.join("\n")),null;Lt[t]=i,r.memory.programs++}return i._useCount++,i},Ct.prototype.getValid=function(){return this._hash===Rt(this._scene)},Ct.prototype.put=function(){0==--this._useCount&&(Et.removeItem(this.id),this._program&&this._program.destroy(),delete Lt[this._hash],r.memory.programs--)},Ct.prototype.webglContextRestored=function(){this._program=null},Ct.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene.canvas.gl,r=t._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),this._aPosition.bindArrayBuffer(r.positionsBuf),e.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(r.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),e.bindArray++),this._aPickColor&&(this._aPickColor.bindArrayBuffer(r.pickColorsBuf),e.bindArray++),r.indicesBuf.bind(),e.bindArray++,s.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++},Ct.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},Ct.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState,o=i.camera;if(r.bind(),e.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix||o.project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};class Dt{constructor(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry depth vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),s.push("precision highp float;"),s.push("uniform float zNear;"),s.push("uniform float zFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float zNormalizedDepth = abs((zNear + vViewPosition.z) / (zFar - zNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}(e)}}const Ft=new s({}),St=function(e,t){this.id=Ft.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Dt(t),this._allocate(t)},kt={};function Tt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}St.get=function(e){const t=Tt(e.model.scene);let i=kt[t];if(!i){if((i=new St(t,e)).errors)return console.log(i.errors.join("\n")),null;kt[t]=i,r.memory.programs++}return i._useCount++,i},St.prototype.getValid=function(){return this._hash===Tt(this._scene)},St.prototype.put=function(){0==--this._useCount&&(Ft.removeItem(this.id),this._program&&this._program.destroy(),delete kt[this._hash],r.memory.programs--)},St.prototype.webglContextRestored=function(){this._program=null},St.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene,r=s.canvas.gl,a=t._state,o=s.camera.project._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.uniform1f(this._uZNear,o.near),r.uniform1f(this._uZFar,o.far),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),e.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(a.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),e.bindArray++),a.indicesBuf.bind(),e.bindArray++,r.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++},St.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._uZNear=r.getLocation("zNear"),this._uZFar=r.getLocation("zFar")},St.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._sectionPlanesState;t.camera;if(s.bind(),e.useProgram++,r.sectionPlanes.length>0){const e=t._sectionPlanesState.sectionPlanes;let s,r,n,l,h;for(var a=0,o=this._uSectionPlanes.length;a<o;a++)r=(s=this._uSectionPlanes[a]).active,n=e[a],r&&i.uniform1i(r,n.active),(l=s.pos)&&i.uniform3fv(s.pos,n.pos),(h=s.dir)&&i.uniform3fv(s.dir,n.dir)}};class Bt{constructor(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched geometry normals vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool pickable  = (float(flags2.z) > 0.0);"),i.push("  if (!visible || !pickable) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),s.push("precision highp float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}(e)}}const Nt=new s({}),It=function(e,t){this.id=Nt.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Bt(t),this._allocate(t)},Ot={};function Vt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}It.get=function(e){const t=Vt(e.model.scene);let i=Ot[t];if(!i){if((i=new It(t,e)).errors)return console.log(i.errors.join("\n")),null;Ot[t]=i,r.memory.programs++}return i._useCount++,i},It.prototype.getValid=function(){return this._hash===Vt(this._scene)},It.prototype.put=function(){0==--this._useCount&&(Nt.removeItem(this.id),this._program&&this._program.destroy(),delete Ot[this._hash],r.memory.programs--)},It.prototype.webglContextRestored=function(){this._program=null},It.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene.canvas.gl,r=t._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(r.positionsBuf),e.bindArray++,this._aNormal&&(this._aNormal.bindArrayBuffer(r.normalsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(r.flagsBuf),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),e.bindArray++),r.indicesBuf.bind(),e.bindArray++,s.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++},It.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},It.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;i.camera;if(r.bind(),e.useProgram++,a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(t=this._uSectionPlanes[o]).active,a=e[o],r&&s.uniform1i(r,a.active),(l=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};class Ut{constructor(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Batched occlusion vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("void main(void) {"),i.push("  bool visible   = (float(flags.x) > 0.0);"),i.push("  bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;"));return i.push("      gl_Position = projMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched occlusion fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}(e)}}const zt=new s({}),Gt=function(e,t){this.id=zt.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Ut(t),this._allocate(t)},jt={};function Yt(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Gt.get=function(e){const t=Yt(e.model.scene);let i=jt[t];if(!i){if((i=new Gt(t,e)).errors)return console.log(i.errors.join("\n")),null;jt[t]=i,r.memory.programs++}return i._useCount++,i},Gt.prototype.getValid=function(){return this._hash===Yt(this._scene)},Gt.prototype.put=function(){0==--this._useCount&&(zt.removeItem(this.id),this._program&&this._program.destroy(),delete jt[this._hash],r.memory.programs--)},Gt.prototype.webglContextRestored=function(){this._program=null},Gt.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene,r=s.canvas.gl,a=t._state,o=s.camera;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uViewMatrix,!1,i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),e.bindArray+=5,r.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++},Gt.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")},Gt.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._sectionPlanesState;if(s.bind(),e.useProgram++,r.sectionPlanes.length>0){const e=t._sectionPlanesState.sectionPlanes;let s,r,n,l,h;for(var a=0,o=this._uSectionPlanes.length;a<o;a++)r=(s=this._uSectionPlanes[a]).active,n=e[a],r&&i.uniform1i(r,n.active),(l=s.pos)&&i.uniform3fv(s.pos,n.pos),(h=s.dir)&&i.uniform3fv(s.dir,n.dir)}};const Ht=L.SUPPORTED_EXTENSIONS.OES_element_index_uint,Xt=new Uint8Array(4*(Ht?5e6:65530)),Wt=w.mat4(),Kt=w.mat4(),qt=w.vec4([0,0,0,1]),Zt=w.vec4([0,0,0,1]);class $t{constructor(e,t){this.model=e,this._buffer=t.buffer;var i,s=t.primitive||"triangles";const r=e.scene.canvas.gl;switch(s){case"points":i=r.POINTS;break;case"lines":i=r.LINES;break;case"line-loop":i=r.LINE_LOOP;break;case"line-strip":i=r.LINE_STRIP;break;case"triangles":i=r.TRIANGLES;break;case"triangle-strip":i=r.TRIANGLE_STRIP;break;case"triangle-fan":i=r.TRIANGLE_FAN;break;default:throw`Unsupported value for 'primitive': '${s}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`}this._state=new Z({primitiveName:s,primitive:i,positionsBuf:null,normalsBuf:null,colorsbuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:w.mat4()}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._aabb=w.collapseAABB3(),this._portions=[],this._finalized=!1,this._preCompressed=!!t.preCompressed,this._positionsDecodeMatrix=t.positionsDecodeMatrix,this.compileShaders()}canCreatePortion(e){if(this._finalized)throw"Already finalized";return(!this._finalized&&this._buffer.lenPositions+e)<3*this._buffer.maxVerts}createPortion(e,t,i,s,r,a,o,n,l,h){if(this._finalized)throw"Already finalized";const c=this._buffer,u=c.lenPositions/3,d=e.length/3,p=e.length;if(this._preCompressed)c.positions.set(e,c.lenPositions),c.lenPositions+=p,w.collapseAABB3(l),w.expandAABB3Points3(l,e),we.decompressAABB(l,this._positionsDecodeMatrix),w.expandAABB3(this._aabb,l);else{if(c.positions.set(e,c.lenPositions),n)for(let e=c.lenPositions,t=c.lenPositions+p;e<t;e+=3)qt[0]=c.positions[e+0],qt[1]=c.positions[e+1],qt[2]=c.positions[e+2],w.transformPoint4(n,qt,Zt),w.expandAABB3Point3(l,Zt),w.expandAABB3Point3(this._aabb,Zt),c.positions[e+0]=Zt[0],c.positions[e+1]=Zt[1],c.positions[e+2]=Zt[2];else for(let e=c.lenPositions,t=c.lenPositions+p;e<t;e+=3)qt[0]=c.positions[e+0],qt[1]=c.positions[e+1],qt[2]=c.positions[e+2],w.expandAABB3Point3(l,qt),w.expandAABB3Point3(this._aabb,qt);c.lenPositions+=p}if(t)if(this._preCompressed)c.normals.set(t,c.lenNormals),c.lenNormals+=t.length;else{var _=Wt;n?w.inverseMat4(w.transposeMat4(n,Kt),_):w.identityMat4(_,_),c.lenNormals=function(e,t,i,s,r){let a,o,n,l,h,c,u=new Float32Array([0,0,0,0]),d=new Float32Array([0,0,0,0]);for(c=0;c<i;c+=3)u[0]=t[c],u[1]=t[c+1],u[2]=t[c+2],w.transformVec3(e,u,d),w.normalizeVec3(d,d),n=a=Jt(d,"floor","floor"),o=ei(a),l=h=ti(d,o),a=Jt(d,"ceil","floor"),o=ei(a),(l=ti(d,o))>h&&(n=a,h=l),a=Jt(d,"floor","ceil"),o=ei(a),(l=ti(d,o))>h&&(n=a,h=l),a=Jt(d,"ceil","ceil"),o=ei(a),(l=ti(d,o))>h&&(n=a,h=l),s[r+c+0]=n[0],s[r+c+1]=n[1],s[r+c+2]=0;return r+=i}(_,t,t.length,c.normals,c.lenNormals)}if(void 0!==r){const e=4*d,t=r&Qe.VISIBLE?255:0,i=r&Qe.XRAYED?255:0,s=r&Qe.HIGHLIGHTED?255:0,a=r&Qe.SELECTED?255:0,o=r&Qe.CLIPPABLE?255:0,n=r&Qe.EDGES?255:0,l=r&Qe.PICKABLE?255:0;for(var f=c.lenFlags,m=c.lenFlags+e;f<m;f+=4)c.flags[f+0]=t,c.flags[f+1]=i,c.flags[f+2]=s,c.flags[f+3]=a,c.flags2[f+0]=o,c.flags2[f+1]=n,c.flags2[f+2]=l;c.lenFlags+=e,t&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),i&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),s&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),a&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),n&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),l&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++)}if(a){const e=4*d,t=a[0],i=a[1],s=a[2],r=o;for(f=c.lenColors,m=c.lenColors+e;f<m;f+=4)c.colors[f+0]=t,c.colors[f+1]=i,c.colors[f+2]=s,c.colors[f+3]=o;c.lenColors+=e,r<255&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++)}if(i){for(f=0,m=i.length;f<m;f++)c.indices[c.lenIndices+f]=i[f]+u;c.lenIndices+=i.length}if(s){for(f=0,m=s.length;f<m;f++)c.edgeIndices[c.lenEdgeIndices+f]=s[f]+u;c.lenEdgeIndices+=s.length}{const e=4*d;for(f=c.lenPickColors,m=c.lenPickColors+e;f<m;f+=4)c.pickColors[f+0]=h[0],c.pickColors[f+1]=h[1],c.pickColors[f+2]=h[2],c.pickColors[f+3]=h[3];c.lenPickColors+=e}var g=this._portions.length/2;return this._portions.push(u),this._portions.push(d),this._numPortions++,this.model.numPortions++,g}finalize(){if(this._finalized)return void this.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(this._preCompressed?(e.positionsDecodeMatrix=this._positionsDecodeMatrix,e.positionsBuf=new G(t,t.ARRAY_BUFFER,i.positions,i.lenPositions,3,t.STATIC_DRAW)):(Qt(i.positions,i.lenPositions,this._aabb,i.quantizedPositions,e.positionsDecodeMatrix),i.lenPositions>0&&(e.positionsBuf=new G(t,t.ARRAY_BUFFER,i.quantizedPositions.slice(0,i.lenPositions),i.lenPositions,3,t.STATIC_DRAW))),i.lenNormals>0){let s=!0;e.normalsBuf=new G(t,t.ARRAY_BUFFER,i.normals.slice(0,i.lenNormals),i.lenNormals,3,t.STATIC_DRAW,s)}if(i.lenColors>0){let s=!1;e.colorsBuf=new G(t,t.ARRAY_BUFFER,i.colors.slice(0,i.lenColors),i.lenColors,4,t.STATIC_DRAW,s)}if(i.lenFlags>0){let s=!0;e.flagsBuf=new G(t,t.ARRAY_BUFFER,i.flags.slice(0,i.lenFlags),i.lenFlags,4,t.STATIC_DRAW,s),e.flags2Buf=new G(t,t.ARRAY_BUFFER,i.flags2.slice(0,i.lenFlags),i.lenFlags,4,t.STATIC_DRAW,s)}if(i.lenPickColors>0){let s=!1;e.pickColorsBuf=new G(t,t.ARRAY_BUFFER,i.pickColors.slice(0,i.lenPickColors),i.lenPickColors,4,t.STATIC_DRAW,s)}i.lenIndices>0&&(e.indicesBuf=new G(t,t.ELEMENT_ARRAY_BUFFER,i.indices.slice(0,i.lenIndices),i.lenIndices,1,t.STATIC_DRAW)),i.lenEdgeIndices>0&&(e.edgeIndicesBuf=new G(t,t.ELEMENT_ARRAY_BUFFER,i.edgeIndices.slice(0,i.lenEdgeIndices),i.lenEdgeIndices,1,t.STATIC_DRAW)),i.lenPositions=0,i.lenColors=0,i.lenNormals=0,i.lenFlags=0,i.lenPickColors=0,i.lenIndices=0,i.lenEdgeIndices=0,this._buffer=null,this._finalized=!0}initFlags(e,t){t&Qe.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Qe.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&Qe.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&Qe.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&Qe.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&Qe.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),this._setFlags(e,t),this._setFlags2(e,t)}setVisible(e,t){if(!this._finalized)throw"Not finalized";t&Qe.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t)}setHighlighted(e,t){if(!this._finalized)throw"Not finalized";t&Qe.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t)}setXRayed(e,t){if(!this._finalized)throw"Not finalized";t&Qe.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t)}setSelected(e,t){if(!this._finalized)throw"Not finalized";t&Qe.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t)}setEdges(e,t){if(!this._finalized)throw"Not finalized";t&Qe.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags2(e,t)}setClippable(e,t){if(!this._finalized)throw"Not finalized";this._setFlags2(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t){if(!this._finalized)throw"Not finalized";t&Qe.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t)}setColor(e,t,i=!1){if(!this._finalized)throw"Not finalized";var s=2*e,r=4*this._portions[s],a=4*this._portions[s+1];const o=t[0],n=t[1],l=t[2],h=t[3];for(var c=0;c<a;c+=4)Xt[c+0]=o,Xt[c+1]=n,Xt[c+2]=l,Xt[c+3]=h;if(i){t[3]<255?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--)}this._state.colorsBuf.setData(Xt.slice(0,a),r,a)}_setFlags(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],a=t&Qe.VISIBLE?255:0,o=t&Qe.XRAYED?255:0,n=t&Qe.HIGHLIGHTED?255:0,l=t&Qe.SELECTED?255:0,h=0;h<r;h+=4)Xt[h+0]=a,Xt[h+1]=o,Xt[h+2]=n,Xt[h+3]=l;this._state.flagsBuf.setData(Xt.slice(0,r),s,r)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";for(var i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],a=t&Qe.CLIPPABLE?255:0,o=t&Qe.EDGES?255:0,n=t&Qe.PICKABLE?255:0,l=0;l<r;l+=4)Xt[l+0]=a,Xt[l+1]=o,Xt[l+2]=n;this._state.flags2Buf.setData(Xt.slice(0,r),s,r)}drawNormalFillOpaque(e){0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(e,this,nt.NORMAL_OPAQUE)}drawNormalEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.NORMAL_OPAQUE)}drawNormalFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(e,this,nt.NORMAL_TRANSPARENT)}drawNormalTransparentEdges(e){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.NORMAL_TRANSPARENT)}drawXRayedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.XRAYED)}drawHighlightedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawSelectedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.SELECTED)}drawPickMesh(e){0!==this._numVisibleLayerPortions&&this._pickMeshRenderer&&this._pickMeshRenderer.drawLayer(e,this)}drawPickDepths(e){0!==this._numVisibleLayerPortions&&this._pickDepthRenderer&&this._pickDepthRenderer.drawLayer(e,this)}drawPickNormals(e){0!==this._numVisibleLayerPortions&&this._pickNormalsRenderer&&this._pickNormalsRenderer.drawLayer(e,this)}drawOcclusion(e){0!==this._numVisibleLayerPortions&&(this._occlusionRenderer||(this._occlusionRenderer=Gt.get(this)),this._occlusionRenderer&&this._occlusionRenderer.drawLayer(e,this))}compileShaders(){this._drawRenderer&&!1===this._drawRenderer.getValid()&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&!1===this._fillRenderer.getValid()&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&!1===this._edgesRenderer.getValid()&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&!1===this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!1===this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.put(),this._occlusionRenderer=null),this._drawRenderer||(this._drawRenderer=ct.get(this)),this._fillRenderer||(this._fillRenderer=mt.get(this)),this._edgesRenderer||(this._edgesRenderer=xt.get(this)),this._pickMeshRenderer||(this._pickMeshRenderer=Ct.get(this)),this._pickDepthRenderer||(this._pickDepthRenderer=St.get(this)),this._pickNormalsRenderer||(this._pickNormalsRenderer=It.get(this))}destroy(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null);const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}var Qt=function(){const e=w.mat4(),t=w.mat4();return function(i,s,r,a,o){const n=r[0],l=r[1],h=r[2],c=r[3]-n,u=r[4]-l,d=r[5]-h,p=65525/c,_=65525/u,f=65525/d;let m;for(m=0;m<s;m+=3)a[m+0]=Math.floor((i[m+0]-n)*p),a[m+1]=Math.floor((i[m+1]-l)*_),a[m+2]=Math.floor((i[m+2]-h)*f);w.identityMat4(e),w.translationMat4v(r,e),w.identityMat4(t),w.scalingMat4v([c/65525,u/65525,d/65525],t),w.mulMat4(e,t,o)}}();function Jt(e,t,i){let s=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),r=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){let e=s,t=r;e=(1-Math.abs(r))*(s>=0?1:-1),t=(1-Math.abs(s))*(r>=0?1:-1),s=e,r=t}return new Int8Array([Math[t](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function ei(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function ti(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}const ii=function(e){this.vertex=function(e){var t=e.model.scene;const i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0;let a,o,n;const l=[];for(l.push("// Instancing geometry drawing vertex shader"),l.push("uniform int renderPass;"),l.push("attribute vec3 position;"),l.push("attribute vec2 normal;"),l.push("attribute vec4 color;"),l.push("attribute vec4 flags;"),l.push("attribute vec4 flags2;"),l.push("attribute vec4 modelMatrixCol0;"),l.push("attribute vec4 modelMatrixCol1;"),l.push("attribute vec4 modelMatrixCol2;"),l.push("attribute vec4 modelNormalMatrixCol0;"),l.push("attribute vec4 modelNormalMatrixCol1;"),l.push("attribute vec4 modelNormalMatrixCol2;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),l.push("uniform mat4 positionsDecodeMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec4 lightAmbient;"),a=0,o=s.lights.length;a<o;a++)"ambient"!==(n=s.lights[a]).type&&(l.push("uniform vec4 lightColor"+a+";"),"dir"===n.type&&l.push("uniform vec3 lightDir"+a+";"),"point"===n.type&&l.push("uniform vec3 lightPos"+a+";"),"spot"===n.type&&(l.push("uniform vec3 lightPos"+a+";"),l.push("uniform vec3 lightDir"+a+";")));l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"),r&&(l.push("varying vec4 vWorldPosition;"),l.push("varying vec4 vFlags2;"));for(l.push("varying vec4 vColor;"),l.push("void main(void) {"),l.push("bool visible      = (float(flags.x) > 0.0);"),l.push("bool xrayed       = (float(flags.y) > 0.0);"),l.push("bool highlighted  = (float(flags.z) > 0.0);"),l.push("bool selected     = (float(flags.w) > 0.0);"),l.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),l.push(`if \n    (!visible || \n    (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${nt.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),l.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),l.push("} else {"),l.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),l.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),l.push("vec4 viewPosition  = viewMatrix * worldPosition; "),l.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),l.push("vec4 worldNormal = vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),l.push("vec3 viewNormal = normalize(vec4(worldNormal * viewNormalMatrix).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),a=0,o=s.lights.length;a<o;a++)if("ambient"!==(n=s.lights[a]).type){if("dir"===n.type)"view"===n.space?l.push("viewLightDir = normalize(lightDir"+a+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if("point"===n.type)"view"===n.space?l.push("viewLightDir = normalize(lightPos"+a+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else{if("spot"!==n.type)continue;"view"===n.space?l.push("viewLightDir = normalize(lightDir"+a+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}l.push("vColor = colorize *  vec4(reflectedColor * ((lightAmbient.rgb * lightAmbient.a) + vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0)), float(color.a) / 255.0);"),r&&(l.push("vWorldPosition = worldPosition;"),l.push("vFlags2 = flags2;"));return l.push("gl_Position = projMatrix * viewPosition;"),l.push("}"),l.push("}"),l}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,a=[];if(a.push("// Instancing geometry drawing fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),r)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("varying vec4 vColor;"),a.push("void main(void) {"),r){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = vColor;"),a.push("}"),a}(e)};const si=new s({}),ri=function(e,t){this.id=si.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new ii(t),this._allocate(t)},ai={},oi=new Float32Array([1,1,1,1]);function ni(e){return[e.canvas.canvas.id,"",e._lightsState.getHash(),e._sectionPlanesState.getHash()].join(";")}ri.get=function(e){const t=ni(e.model.scene);let i=ai[t];if(!i){if((i=new ri(t,e)).errors)return console.log(i.errors.join("\n")),null;ai[t]=i,r.memory.programs++}return i._useCount++,i},ri.prototype.getValid=function(){return this._hash===ni(this._scene)},ri.prototype.put=function(){0==--this._useCount&&(si.removeItem(this.id),this._program&&this._program.destroy(),delete ai[this._hash],r.memory.programs--)},ri.prototype.webglContextRestored=function(){this._program=null},ri.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state,n=this._instanceExt;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aModelNormalMatrixCol0.bindArrayBuffer(o.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(o.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(o.modelNormalMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),e.bindArray+=3,this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aNormal.bindArrayBuffer(o.normalsBuf),e.bindArray++,this._aColor.bindArrayBuffer(o.colorsBuf),n.vertexAttribDivisorANGLE(this._aColor.location,1),e.bindArray++,this._aFlags.bindArrayBuffer(o.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),o.indicesBuf.bind(),e.bindArray++,i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColorize,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColorize,t[0],t[1],t[2],i)}else a.uniform4fv(this._uColorize,oi);n.drawElementsInstancedANGLE(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aColor.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++}},ri.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._lightsState,r=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const a=this._program;this._uRenderPass=a.getLocation("renderPass"),this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uColorize=a.getLocation("colorize"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=s.lights;let n;for(var l=0,h=o.length;l<h;l++)switch((n=o[l]).type){case"ambient":this._uLightAmbient[l]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[l]=a.getLocation("lightColor"+l),this._uLightPos[l]=null,this._uLightDir[l]=a.getLocation("lightDir"+l);break;case"point":this._uLightColor[l]=a.getLocation("lightColor"+l),this._uLightPos[l]=a.getLocation("lightPos"+l),this._uLightDir[l]=null,this._uLightAttenuation[l]=a.getLocation("lightAttenuation"+l);break;case"spot":this._uLightColor[l]=a.getLocation("lightColor"+l),this._uLightPos[l]=a.getLocation("lightPos"+l),this._uLightDir[l]=a.getLocation("lightDir"+l),this._uLightAttenuation[l]=a.getLocation("lightAttenuation"+l)}this._uSectionPlanes=[];for(l=0,h=r.sectionPlanes.length;l<h;l++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+l),pos:a.getLocation("sectionPlanePos"+l),dir:a.getLocation("sectionPlaneDir"+l)});this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._aFlags2=a.getAttribute("flags2"),this._aModelMatrixCol0=a.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=a.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=a.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=a.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=a.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=a.getAttribute("modelNormalMatrixCol2")},ri.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._lightsState,o=i._sectionPlanesState,n=a.lights;let l;r.bind(),e.useProgram++;const h=i.camera;h._state;s.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix);for(var c=0,u=n.length;c<u;c++)l=n[c],this._uLightAmbient[c]?s.uniform4f(this._uLightAmbient[c],l.color[0],l.color[1],l.color[2],l.intensity):(this._uLightColor[c]&&s.uniform4f(this._uLightColor[c],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[c]&&(s.uniform3fv(this._uLightPos[c],l.pos),this._uLightAttenuation[c]&&s.uniform1f(this._uLightAttenuation[c],l.attenuation)),this._uLightDir[c]&&s.uniform3fv(this._uLightDir[c],l.dir));if(o.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,n;for(c=0,u=this._uSectionPlanes.length;c<u;c++)r=(t=this._uSectionPlanes[c]).active,a=e[c],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(n=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const li=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing fill vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = (float(flags.w) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`if\n    (!visible ||\n    (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) || \n    (renderPass == ${nt.NORMAL_TRANSPARENT} && (!transparent || xrayed || highlighted || selected)) || \n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) || \n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,a=[];if(a.push("// Instancing fill fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),r)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("uniform vec4 color;"),a.push("void main(void) {"),r){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = color;"),a.push("}"),a}(e)};const hi=new s({}),ci=function(e,t){this.id=hi.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new li(t),this._allocate(t)},ui={},di=new Float32Array([1,1,1,1]);function pi(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}ci.get=function(e){const t=pi(e.model.scene);let i=ui[t];if(!i){if((i=new ci(t,e)).errors)return console.log(i.errors.join("\n")),null;ui[t]=i,r.memory.programs++}return i._useCount++,i},ci.prototype.getValid=function(){return this._hash===pi(this._scene)},ci.prototype.put=function(){0==--this._useCount&&(hi.removeItem(this.id),this._program&&this._program.destroy(),delete ui[this._hash],r.memory.programs--)},ci.prototype.webglContextRestored=function(){this._program=null},ci.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state,n=this._instanceExt;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aFlags.bindArrayBuffer(o.flagsBuf,a.UNSIGNED_BYTE,!0),n.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,a.UNSIGNED_BYTE,!0),n.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),o.indicesBuf.bind(),e.bindArray++,i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.SELECTED){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else a.uniform4fv(this._uColor,di);n.drawElementsInstancedANGLE(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++}},ci.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},ci.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;r.bind(),e.useProgram++;const o=i.camera;o._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const _i=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing edges vertex shader"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("uniform vec4 color;"),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool xrayed       = (float(flags.y) > 0.0);"),i.push("bool highlighted  = (float(flags.z) > 0.0);"),i.push("bool selected     = (float(flags.w) > 0.0);"),i.push("bool edges        = (float(flags2.y) > 0.0);"),i.push("bool transparent  = (color.a < 1.0);"),i.push(`\n     if (!visible || !edges ||\n        (renderPass == ${nt.NORMAL_OPAQUE} && (transparent || xrayed || selected)) ||\n    (renderPass == ${nt.NORMAL_TRANSPARENT} &&  (!transparent || xrayed || highlighted || selected)) ||\n    (renderPass == ${nt.XRAYED} && (!xrayed || highlighted || selected)) ||\n    (renderPass == ${nt.HIGHLIGHTED} && !highlighted) ||\n    (renderPass == ${nt.SELECTED} && !selected)) {`),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0;let s,r;const a=[];if(a.push("// Instancing edges fragment shader"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("uniform vec4 color;"),i)for(a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),s=0,r=t.sectionPlanes.length;s<r;s++)a.push("uniform bool sectionPlaneActive"+s+";"),a.push("uniform vec3 sectionPlanePos"+s+";"),a.push("uniform vec3 sectionPlaneDir"+s+";");if(a.push("void main(void) {"),i){for(a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),s=0,r=t.sectionPlanes.length;s<r;s++)a.push("if (sectionPlaneActive"+s+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = color;"),a.push("}"),a}(e)};const fi=new s({}),mi=function(e,t){this.id=fi.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new _i(t),this._allocate(t)},gi={};function vi(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}mi.get=function(e){const t=vi(e.model.scene);let i=gi[t];if(!i){if((i=new mi(t,e)).errors)return console.log(i.errors.join("\n")),null;gi[t]=i,r.memory.programs++}return i._useCount++,i},mi.prototype.getValid=function(){return this._hash===vi(this._scene)},mi.prototype.put=function(){0==--this._useCount&&(fi.removeItem(this.id),this._program&&this._program.destroy(),delete gi[this._hash],r.memory.programs--)},mi.prototype.webglContextRestored=function(){this._program=null},mi.prototype.drawLayer=function(e,t,i){const s=t.model,r=s.scene,a=r.canvas.gl,o=t._state,n=this._instanceExt;if(this._program||(this._allocate(t),!this.errors)){if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),i===nt.XRAYED){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===nt.SELECTED){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}else{const e=r.edgeMaterial._state,t=e.edgeColor,i=e.edgeAlpha;a.uniform4f(this._uColor,t[0],t[1],t[2],i)}a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,s.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++,this._aFlags&&(this._aFlags.bindArrayBuffer(o.flagsBuf,a.UNSIGNED_BYTE,!0),n.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf,a.UNSIGNED_BYTE,!0),n.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),o.edgeIndicesBuf.bind(),e.bindArray++,n.drawElementsInstancedANGLE(a.LINES,o.edgeIndicesBuf.numItems,o.edgeIndicesBuf.itemType,0,o.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aFlags&&n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++}},mi.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uColor=r.getLocation("color"),this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},mi.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl;this._program.bind(),e.useProgram++;const r=i.camera;r._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),i._sectionPlanesState.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,n,l,h;for(var a=0,o=this._uSectionPlanes.length;a<o;a++)r=(t=this._uSectionPlanes[a]).active,n=e[a],r&&s.uniform1i(r,n.active),(l=t.pos)&&s.uniform3fv(t.pos,n.pos),(h=t.dir)&&s.uniform3fv(t.dir,n.dir)}};const bi=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry picking vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;"));return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("gl_FragColor = vPickColor; "),s.push("}"),s}(e)};const yi=new s({}),Mi=function(e,t){this.id=yi.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new bi(t),this._allocate(t)},xi={};function wi(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Mi.get=function(e){const t=wi(e.model.scene);let i=xi[t];if(!i){if((i=new Mi(t,e)).errors)return console.log(i.errors.join("\n")),null;xi[t]=i,r.memory.programs++}return i._useCount++,i},Mi.prototype.getValid=function(){return this._hash===wi(this._scene)},Mi.prototype.put=function(){0==--this._useCount&&(yi.removeItem(this.id),this._program&&this._program.destroy(),delete xi[this._hash],r.memory.programs--)},Mi.prototype.webglContextRestored=function(){this._program=null},Mi.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene.canvas.gl,r=t._state,a=this._instanceExt;!this._program&&(this._allocate(t),this.errors)||(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aPickColor.bindArrayBuffer(r.pickColorsBuf),a.vertexAttribDivisorANGLE(this._aPickColor.location,1),e.bindArray++,this._aPosition.bindArrayBuffer(r.positionsBuf),e.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),r.indicesBuf.bind(),e.bindArray++,a.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aPickColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++)},Mi.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},Mi.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=(i._lightsState,i._sectionPlanesState);r.bind(),e.useProgram++;const o=i.camera;o._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const Pi=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry depth vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&i.push("  vWorldPosition = worldPosition;");return i.push("  vViewPosition = viewPosition;"),i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),s.push("precision highp float;"),s.push("uniform float zNear;"),s.push("uniform float zFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float zNormalizedDepth = abs((zNear + vViewPosition.z) / (zFar - zNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}(e)};const Ai=new s({}),Ei=function(e,t){this.id=Ai.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Pi(t),this._allocate(t)},Ci={};function Li(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Ei.get=function(e){const t=Li(e.model.scene);let i=Ci[t];if(!i){if((i=new Ei(t,e)).errors)return console.log(i.errors.join("\n")),null;Ci[t]=i,r.memory.programs++}return i._useCount++,i},Ei.prototype.getValid=function(){return this._hash===Li(this._scene)},Ei.prototype.put=function(){0==--this._useCount&&(Ai.removeItem(this.id),this._program&&this._program.destroy(),delete Ci[this._hash],r.memory.programs--)},Ei.prototype.webglContextRestored=function(){this._program=null},Ei.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene,r=s.canvas.gl,a=t._state,o=this._instanceExt;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t));const n=s.camera.project._state;r.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),r.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.uniform1f(this._uZNear,n.near),r.uniform1f(this._uZFar,n.far),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aPosition.bindArrayBuffer(a.positionsBuf),e.bindArray++,this._aFlags.bindArrayBuffer(a.flagsBuf),o.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),o.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),a.indicesBuf.bind(),e.bindArray++,o.drawElementsInstancedANGLE(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),o.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),o.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),o.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++},Ei.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uZNear=r.getLocation("zNear"),this._uZFar=r.getLocation("zFar")},Ei.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;if(r.bind(),e.useProgram++,a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,l,h;for(var o=0,n=this._uSectionPlanes.length;o<n;o++)r=(t=this._uSectionPlanes[o]).active,a=e[o],r&&s.uniform1i(r,a.active),(l=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const Ri=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing geometry normals vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool pickable  = (float(flags2.z) > 0.0);"),i.push("if (!visible || !pickable) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),t&&i.push("  vWorldPosition = worldPosition;");return i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),s.push("precision highp float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}(e)};const Di=new s({}),Fi=function(e,t){this.id=Di.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Ri(t),this._allocate(t)},Si={};function ki(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Fi.get=function(e){const t=ki(e.model.scene);let i=Si[t];if(!i){if((i=new Fi(t,e)).errors)return console.log(i.errors.join("\n")),null;Si[t]=i,r.memory.programs++}return i._useCount++,i},Fi.prototype.getValid=function(){return this._hash===ki(this._scene)},Fi.prototype.put=function(){0==--this._useCount&&(Di.removeItem(this.id),this._program&&this._program.destroy(),delete Si[this._hash],r.memory.programs--)},Fi.prototype.webglContextRestored=function(){this._program=null},Fi.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene.canvas.gl,r=t._state,a=this._instanceExt;!this._program&&(this._allocate(t),this.errors)||(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix?i.getPickViewMatrix(e.pickViewMatrix):i.viewMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aModelNormalMatrixCol0.bindArrayBuffer(r.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(r.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(r.modelNormalMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),e.bindArray+=3,this._aPosition.bindArrayBuffer(r.positionsBuf),e.bindArray++,this._aNormal.bindArrayBuffer(r.normalsBuf),e.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),r.indicesBuf.bind(),e.bindArray++,a.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++)},Fi.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2")},Fi.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._sectionPlanesState;if(s.bind(),e.useProgram++,r.sectionPlanes.length>0){const e=t._sectionPlanesState.sectionPlanes;let s,r,n,l,h;for(var a=0,o=this._uSectionPlanes.length;a<o;a++)r=(s=this._uSectionPlanes[a]).active,n=e[a],r&&i.uniform1i(r,n.active),(l=s.pos)&&i.uniform3fv(s.pos,n.pos),(h=s.dir)&&i.uniform3fv(s.dir,n.dir)}};const Ti=function(e){this.vertex=function(e){const t=e.model.scene._sectionPlanesState.sectionPlanes.length>0,i=[];i.push("// Instancing occlusion vertex shader"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;"));i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("bool visible   = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&i.push("  vWorldPosition = worldPosition;");return i.push("  vViewPosition = viewPosition;"),i.push("  gl_Position = projMatrix * viewPosition;"),i.push("}"),i.push("}"),i}(e),this.fragment=function(e){const t=e.model.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched occlusion fragment shader"),s.push("precision mediump float;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}(e)};const Bi=new s({}),Ni=function(e,t){this.id=Bi.addItem({}),this._hash=e,this._scene=t.model.scene,this._useCount=0,this._shaderSource=new Ti(t),this._allocate(t)},Ii={};function Oi(e){return[e.canvas.canvas.id,"",e._sectionPlanesState.getHash()].join(";")}Ni.get=function(e){const t=Oi(e.model.scene);let i=Ii[t];if(!i){if((i=new Ni(t,e)).errors)return console.log(i.errors.join("\n")),null;Ii[t]=i,r.memory.programs++}return i._useCount++,i},Ni.prototype.getValid=function(){return this._hash===Oi(this._scene)},Ni.prototype.put=function(){0==--this._useCount&&(Bi.removeItem(this.id),this._program&&this._program.destroy(),delete Ii[this._hash],r.memory.programs--)},Ni.prototype.webglContextRestored=function(){this._program=null},Ni.prototype.drawLayer=function(e,t){const i=t.model,s=i.scene.canvas.gl,r=t._state,a=this._instanceExt;!this._program&&(this._allocate(t),this.errors)||(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),s.uniformMatrix4fv(this._uViewMatrix,!1,i.viewMatrix),this._aModelMatrixCol0.bindArrayBuffer(r.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(r.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(r.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),e.bindArray+=3,this._aColor&&(this._aColor.bindArrayBuffer(r.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),e.bindArray++),this._aPosition.bindArrayBuffer(r.positionsBuf),e.bindArray++,this._aFlags.bindArrayBuffer(r.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),e.bindArray++,this._aFlags2&&(this._aFlags2.bindArrayBuffer(r.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1),e.bindArray++),r.indicesBuf.bind(),e.bindArray++,a.drawElementsInstancedANGLE(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0,r.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),e.drawElements++)},Ni.prototype._allocate=function(e){var t=e.model.scene;const i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new z(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var a=0,o=s.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")},Ni.prototype._bindProgram=function(e,t){const i=this._scene,s=i.canvas.gl,r=this._program,a=i._sectionPlanesState;r.bind(),e.useProgram++;const o=i.camera;o._state;if(s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,h;for(var n=0,l=this._uSectionPlanes.length;n<l;n++)r=(t=this._uSectionPlanes[n]).active,a=e[n],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(h=t.dir)&&s.uniform3fv(t.dir,a.dir)}};const Vi=L.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ui=Vi?5e6:65530,zi=new Uint16Array(3*Ui),Gi=new Int8Array(3*Ui),ji=new Uint8Array(4),Yi=w.vec4([0,0,0,1]),Hi=w.vec4([0,0,0,1]);class Xi{constructor(e,t){this.model=e,this._aabb=w.collapseAABB3();var i,s=t.primitive||"triangles";const r=e.scene.canvas.gl;switch(s){case"points":i=r.POINTS;break;case"lines":i=r.LINES;break;case"line-loop":i=r.LINE_LOOP;break;case"line-strip":i=r.LINE_STRIP;break;case"triangles":i=r.TRIANGLES;break;case"triangle-strip":i=r.TRIANGLE_STRIP;break;case"triangle-fan":i=r.TRIANGLE_FAN;break;default:throw`Unsupported value for 'primitive': '${s}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`}var a={primitiveName:s,primitive:i,positionsDecodeMatrix:w.mat4(),numInstances:0,obb:w.OBB3()};if(t.positions)if(t.preCompressed){let e=!1;a.positionsBuf=new G(r,r.ARRAY_BUFFER,t.positions,t.positions.length,3,r.STATIC_DRAW,e),a.positionsDecodeMatrix.set(t.positionsDecodeMatrix);let i=w.collapseAABB3();w.expandAABB3Points3(i,t.positions),we.decompressAABB(i,a.positionsDecodeMatrix),w.AABB3ToOBB3(i,a.obb)}else{let e=t.positions.length,i=w.collapseAABB3();w.expandAABB3Points3(i,t.positions),w.AABB3ToOBB3(i,a.obb),Wi(t.positions,e,i,zi,a.positionsDecodeMatrix);let s=!1;a.positionsBuf=new G(r,r.ARRAY_BUFFER,zi,e,3,r.STATIC_DRAW,s)}if(t.normals)if(t.preCompressed){let e=!0;a.normalsBuf=new G(r,r.ARRAY_BUFFER,t.normals,t.normals.length,3,r.STATIC_DRAW,e)}else{var o=function(e,t,i,s){let r,a,o,n,l;for(let h=0;h<t;h+=3)o=r=Ki(e,h,"floor","floor"),a=qi(r),n=l=Zi(e,h,a),r=Ki(e,h,"ceil","floor"),a=qi(r),(n=Zi(e,h,a))>l&&(o=r,l=n),r=Ki(e,h,"floor","ceil"),a=qi(r),(n=Zi(e,h,a))>l&&(o=r,l=n),r=Ki(e,h,"ceil","ceil"),a=qi(r),(n=Zi(e,h,a))>l&&(o=r,l=n),i[s+h+0]=o[0],i[s+h+1]=o[1],i[s+h+2]=0;return s+=t}(t.normals,t.normals.length,Gi,0);let e=!0;a.normalsBuf=new G(r,r.ARRAY_BUFFER,Gi,o,3,r.STATIC_DRAW,e)}t.indices&&(a.indicesBuf=new G(r,r.ELEMENT_ARRAY_BUFFER,Vi?new Uint32Array(t.indices):new Uint16Array(t.indices),t.indices.length,1,r.STATIC_DRAW));var n=t.edgeIndices;n||(n=be(t.positions,t.indices,null,10)),a.edgeIndicesBuf=new G(r,r.ELEMENT_ARRAY_BUFFER,Vi?new Uint32Array(n):new Uint16Array(n),n.length,1,r.STATIC_DRAW),this._state=new Z(a),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this.numIndices=t.indices?t.indices/3:0,this._flags=[],this._flags2=[],this._colors=[],this._pickColors=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._finalized=!1,this._preCompressed=!!t.preCompressed,this.compileShaders()}createPortion(e,t,i,s,r,a){if(this._finalized)throw"Already finalized";var o=e&Qe.VISIBLE?255:0,n=e&Qe.XRAYED?255:0,l=e&Qe.HIGHLIGHTED?255:0,h=e&Qe.HIGHLIGHTED?255:0,c=e&Qe.CLIPPABLE?255:0,u=e&Qe.EDGES?255:0,d=e&Qe.PICKABLE?255:0;this._flags.push(o),this._flags.push(n),this._flags.push(l),this._flags.push(h),this._flags2.push(c),this._flags2.push(u),this._flags2.push(d),this._flags2.push(0),o&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),n&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),l&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),h&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),u&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),d&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++);const p=t[0],_=t[1],f=t[2];t[3];i<255&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._colors.push(p),this._colors.push(_),this._colors.push(f),this._colors.push(i),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]);let m=w.transposeMat4(s,w.mat4()),g=w.inverseMat4(m);this._modelNormalMatrixCol0.push(g[0]),this._modelNormalMatrixCol0.push(g[4]),this._modelNormalMatrixCol0.push(g[8]),this._modelNormalMatrixCol0.push(g[12]),this._modelNormalMatrixCol1.push(g[1]),this._modelNormalMatrixCol1.push(g[5]),this._modelNormalMatrixCol1.push(g[9]),this._modelNormalMatrixCol1.push(g[13]),this._modelNormalMatrixCol2.push(g[2]),this._modelNormalMatrixCol2.push(g[6]),this._modelNormalMatrixCol2.push(g[10]),this._modelNormalMatrixCol2.push(g[14]),this._pickColors.push(a[0]),this._pickColors.push(a[1]),this._pickColors.push(a[2]),this._pickColors.push(a[3]),w.collapseAABB3(r);for(var v=this._state.obb,b=v.length,y=0;y<b;y+=4)Yi[0]=v[y+0],Yi[1]=v[y+1],Yi[2]=v[y+2],w.transformPoint4(s,Yi,Hi),w.expandAABB3Point3(r,Hi);this._state.numInstances++;var M=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,M}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl;if(this._colors.length>0){let t=!1;this._state.colorsBuf=new G(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.STATIC_DRAW,t),this._colors=[]}if(this._flags.length>0){let t=!0;this._state.flagsBuf=new G(e,e.ARRAY_BUFFER,new Uint8Array(this._flags),this._flags.length,4,e.STATIC_DRAW,t),this._state.flags2Buf=new G(e,e.ARRAY_BUFFER,new Uint8Array(this._flags2),this._flags2.length,4,e.STATIC_DRAW,t),this._flags=[],this._flags2=[]}if(this._modelMatrixCol0.length>0){let t=!1;this._state.modelMatrixCol0Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.modelNormalMatrixCol0Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelNormalMatrixCol1Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelNormalMatrixCol2Buf=new G(e,e.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[]}if(this._pickColors.length>0){let t=!1;this._state.pickColorsBuf=new G(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,t),this._pickColors=[]}this._finalized=!0}initFlags(e,t){t&Qe.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Qe.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&Qe.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&Qe.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&Qe.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&Qe.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),this._setFlags(e,t),this._setFlags2(e,t)}setVisible(e,t){if(!this._finalized)throw"Not finalized";t&Qe.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t)}setHighlighted(e,t){if(!this._finalized)throw"Not finalized";t&Qe.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t)}setXRayed(e,t){if(!this._finalized)throw"Not finalized";t&Qe.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t)}setSelected(e,t){if(!this._finalized)throw"Not finalized";t&Qe.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t)}setEdges(e,t){if(!this._finalized)throw"Not finalized";t&Qe.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags2(e,t)}setClippable(e,t){if(!this._finalized)throw"Not finalized";this._setFlags2(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t){if(!this._finalized)throw"Not finalized";t&Qe.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t)}setColor(e,t,i=!1){if(!this._finalized)throw"Not finalized";if(ji[0]=t[0],ji[1]=t[1],ji[2]=t[2],ji[3]=t[3],i){t[3]<255?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--)}this._state.colorsBuf.setData(ji,4*e,4)}_setFlags(e,t){if(!this._finalized)throw"Not finalized";var i=t&Qe.VISIBLE?255:0,s=t&Qe.XRAYED?255:0,r=t&Qe.HIGHLIGHTED?255:0,a=t&Qe.SELECTED?255:0;ji[0]=i,ji[1]=s,ji[2]=r,ji[3]=a,this._state.flagsBuf.setData(ji,4*e,4)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";var i=t&Qe.CLIPPABLE?255:0,s=t&Qe.EDGES?255:0,r=t&Qe.PICKABLE?255:0;ji[0]=i,ji[1]=s,ji[2]=r,this._state.flags2Buf.setData(ji,4*e,4)}drawNormalFillOpaque(e){0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(e,this,nt.NORMAL_OPAQUE)}drawNormalEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.NORMAL_OPAQUE)}drawNormalFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._drawRenderer&&this._drawRenderer.drawLayer(e,this,nt.NORMAL_TRANSPARENT)}drawNormalTransparentEdges(e){0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.NORMAL_TRANSPARENT)}drawXRayedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.XRAYED)}drawXRayedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.XRAYED)}drawHighlightedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawHighlightedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.HIGHLIGHTED)}drawSelectedFillOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedEdgesOpaque(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedFillTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._fillRenderer&&this._fillRenderer.drawLayer(e,this,nt.SELECTED)}drawSelectedEdgesTransparent(e){0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._edgesRenderer&&this._edgesRenderer.drawLayer(e,this,nt.SELECTED)}drawPickMesh(e){0!==this._numVisibleLayerPortions&&this._pickMeshRenderer&&this._pickMeshRenderer.drawLayer(e,this)}drawPickDepths(e){0!==this._numVisibleLayerPortions&&this._pickDepthRenderer&&this._pickDepthRenderer.drawLayer(e,this)}drawPickNormals(e){0!==this._numVisibleLayerPortions&&this._pickNormalsRenderer&&this._pickNormalsRenderer.drawLayer(e,this)}drawOcclusion(e){0!==this._numVisibleLayerPortions&&(this._occlusionRenderer||(this._occlusionRenderer=Ni.get(this)),this._occlusionRenderer&&this._occlusionRenderer.drawLayer(e,this))}compileShaders(){this._drawRenderer&&!1===this._drawRenderer.getValid()&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&!1===this._fillRenderer.getValid()&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&!1===this._edgesRenderer.getValid()&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&!1===this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!1===this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.put(),this._occlusionRenderer=null),this._drawRenderer||(this._drawRenderer=ri.get(this)),this._fillRenderer||(this._fillRenderer=ci.get(this)),this._edgesRenderer||(this._edgesRenderer=mi.get(this)),this._pickMeshRenderer||(this._pickMeshRenderer=Mi.get(this)),this._pickDepthRenderer||(this._pickDepthRenderer=Ei.get(this)),this._pickNormalsRenderer||(this._pickNormalsRenderer=Fi.get(this))}destroy(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._fillRenderer&&(this._fillRenderer.put(),this._fillRenderer=null),this._edgesRenderer&&(this._edgesRenderer.put(),this._edgesRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickDepthRenderer&&(this._pickDepthRenderer.put(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&(this._pickNormalsRenderer.put(),this._pickNormalsRenderer=null),this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null);const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}var Wi=function(){const e=w.mat4(),t=w.mat4(),i=w.vec3();return function(s,r,a,o,n){const l=a[0],h=a[1],c=a[2],u=a[3],d=a[4],p=a[5],_=a[3]-l,f=a[4]-h,m=a[5]-c,g=u!==l?65535/(u-l):0,v=d!==h?65535/(d-h):0,b=p!==c?65535/(p-c):0;let y;for(y=0;y<r;y+=3)o[y+0]=Math.floor((s[y+0]-l)*g),o[y+1]=Math.floor((s[y+1]-h)*v),o[y+2]=Math.floor((s[y+2]-c)*b);w.identityMat4(e),w.translationMat4v(a,e),w.identityMat4(t),i[0]=_/65535,i[1]=f/65535,i[2]=m/65535,w.scalingMat4v(i,t),w.mulMat4(e,t,n)}}();function Ki(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),a=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=r,t=a;e=(1-Math.abs(a))*(r>=0?1:-1),t=(1-Math.abs(r))*(a>=0?1:-1),r=e,a=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*a+(a<0?-1:0))])}function qi(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function Zi(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}const $i=L.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays;var Qi=w.mat4(),Ji=w.mat4();const es=w.vec3([1,1,1]),ts=w.vec3([0,0,0]),is=w.vec3([0,0,0]),ss=w.identityQuaternion(),rs="__default";class as extends P{constructor(e,t={}){super(e,t),this._preCompressed=!!t.preCompressed,this._tiles={},this._aabb=w.collapseAABB3(),this._layers=[],this._nodes=[],this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numEntities=0,this.numTriangles=0,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this._position=new Float32Array(t.position||[0,0,0]),this._rotation=new Float32Array(t.rotation||[0,0,0]),this._quaternion=new Float32Array(t.quaternion||[0,0,0,1]),t.rotation&&w.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=new Float32Array(t.scale||[1,1,1]),this._worldMatrix=w.mat4(),w.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=w.mat4(),(t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=w.mat4(),this._viewNormalMatrix=w.mat4(),this._viewMatrixDirty=!0),this._opacity=1,this._colorize=[1,1,1],this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.createTile({id:rs}),this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewMatrixDirty=!0})}get isPerformanceModel(){return!0}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(w.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),w.inverseMat4(this._viewMatrix,this._viewNormalMatrix),w.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(w.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),w.inverseMat4(this._viewMatrix,this._viewNormalMatrix),w.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}createTile(e){if(this._tiles[e.id])return void this.warn("Tile already exists: "+e.id);const t={id:e.id,layers:[],instancingLayers:{},currentBatchingLayer:null,buffer:at.length>0?at.pop():new rt,meshes:{},nodes:[]};this._tiles[e.id]=t}createGeometry(e){if(!$i)return void this.error("WebGL instanced arrays not supported");const t=e.id;if(null==t)return void this.error("Config missing: id");const i=e.tileId||rs;var s=this._tiles[i];if(s||(this.error("Tile not found: "+i+" - using default tile"),s=this._tiles[rs]),s.instancingLayers[t])this.error("Geometry already created: "+t);else{e.preCompressed=this._preCompressed;var r=new Xi(this,e);s.layers.push(r),s.instancingLayers[t]=r,this.numGeometries++,this.numTriangles+=e.indices?e.indices.length/3:0}}createMesh(e){var t=e.id;if(null==t)return void this.error("Config missing: id");this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=w.createUUID());const i=e.geometryId,s=void 0!==i,r=e.tileId||rs;var a=this._tiles[r];if(a||(this.error("Tile not found: "+r+" - using default tile"),a=this._tiles[rs]),s){if(!$i)return void this.error("WebGL instanced arrays not supported");if(!a.instancingLayers[i])return void this.error("Geometry not found: "+i+" - ensure that you create it first with createGeometry()")}var o,n,l;if(e.matrix)l=e.matrix;else{const t=e.scale||es,i=e.position||ts,s=e.rotation||is;w.eulerToQuaternion(s,"XYZ",ss),l=w.composeMat4(i,ss,t,Qi)}l=w.mulMat4(this._worldMatrix,l,Ji);const h=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],c=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255;c<255&&this.numTransparentLayerPortions++;var u=new $e(this,t,h,c),d=u.pickId;const p=new Uint8Array([255&d,d>>8&255,d>>16&255,d>>24&255]),_=w.collapseAABB3();if(s){var f=a.instancingLayers[i];o=f,n=f.createPortion(0,h,c,l,_,p),w.expandAABB3(this._aabb,_),this.numTriangles+=o.numIndices.length/3}else{var m=e.primitive||"triangles";"points"!==m&&"lines"!==m&&"line-loop"!==m&&"line-strip"!==m&&"triangles"!==m&&"triangle-strip"!==m&&"triangle-fan"!==m&&(this.error(`Unsupported value for 'primitive': '${m}' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'.`),m="triangles");var g=e.indices,v=e.edgeIndices,b=e.positions;if(!b)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;var y=e.normals;if(!y)return this.error("Config missing: normals (no meshIds provided, so expecting geometry arrays instead)"),null;if(!v&&!g)return this.error("Config missing: must have one or both of indices and edgeIndices  (no meshIds provided, so expecting geometry arrays instead)"),null;if(a.currentBatchingLayer&&(a.currentBatchingLayer.canCreatePortion(b.length)||(a.currentBatchingLayer.finalize(),a.currentBatchingLayer=null)),a.currentBatchingLayer||(a.currentBatchingLayer=new $t(this,{primitive:"triangles",buffer:a.buffer,preCompressed:this._preCompressed,positionsDecodeMatrix:e.positionsDecodeMatrix}),a.layers.push(a.currentBatchingLayer)),o=a.currentBatchingLayer,!v&&g&&(v=be(b,g,null,10)),this._preCompressed){const t=we.getPositionsBounds(b),i=we.decompressPosition(t.min,e.positionsDecodeMatrix,[]),s=we.decompressPosition(t.max,e.positionsDecodeMatrix,[]);_[0]=i[0],_[1]=i[1],_[2]=i[2],_[3]=s[0],_[4]=s[1],_[5]=s[2]}n=a.currentBatchingLayer.createPortion(b,y,g,v,0,h,c,l,_,p),w.expandAABB3(this._aabb,_),this.numGeometries++,this.numTriangles+=g.length/3}u.parent=null,u._layer=o,u._portionId=n,u.aabb=_,a.meshes[t]=u}createEntity(e){var t=e.id;void 0===t?t=w.createUUID():this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=w.createUUID());var i=e.meshIds;if(void 0===i)return void this.error("Config missing: meshIds");const s=e.tileId||rs;var r,a,o,n,l=this._tiles[s];l||(this.error("Tile not found: "+s+" - using default tile"),l=this._tiles[rs]);var h=[];for(r=0,a=i.length;r<a;r++)o=i[r],(n=l.meshes[o])?n.parent?this.error("Mesh with ID "+o+" already belongs to object with ID "+n.parent.id+" - ignoring this mesh"):(delete l.meshes[o],h.push(n)):this.error("Mesh with this ID not found: "+o+" - ignoring this mesh");var c,u=0;if(this._visible&&!1!==e.visible&&(u|=Qe.VISIBLE),this._pickable&&!1!==e.pickable&&(u|=Qe.PICKABLE),this._clippable&&!1!==e.clippable&&(u|=Qe.CLIPPABLE),this._collidable&&!1!==e.collidable&&(u|=Qe.COLLIDABLE),this._edges&&!1!==e.edges&&(u|=Qe.EDGES),this._xrayed&&!1!==e.xrayed&&(u|=Qe.XRAYED),this._highlighted&&!1!==e.highlighted&&(u|=Qe.HIGHLIGHTED),this._selected&&!1!==e.selected&&(u|=Qe.SELECTED),1===h.length)c=h[0].aabb;else for(c=w.collapseAABB3(),r=0,a=h.length;r<a;r++)w.expandAABB3(c,h[r].aabb);var d=new et(this,e.isObject,t,h,u,c);return l.nodes.push(d),this.numEntities++,d}finalizeTile(e){const t=this._tiles[e];if(t){t.currentBatchingLayer&&(t.currentBatchingLayer.finalize(),t.currentBatchingLayer=null),t.buffer&&(ot(t.buffer),t.buffer=null);for(const e in t.instancingLayers)t.instancingLayers.hasOwnProperty(e)&&t.instancingLayers[e].finalize();for(var i=0,s=t.nodes.length;i<s;i++){const e=t.nodes[i];e._finalize(),this._nodes.push(e)}for(i=0,s=t.layers.length;i<s;i++){const e=t.layers[i];e instanceof Xi?this._layers.unshift(e):this._layers.push(e)}delete this._tiles[e],this.glRedraw(),this.scene._aabbDirty=!0}else this.warn("Tile not found: "+e)}finalize(){for(var e in this._tiles)this._tiles.hasOwnProperty(e)&&this.finalizeTile(e)}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabb}set visible(e){e=!1!==e,this._visible=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].visible=e;this.glRedraw()}get visible(){return this.numVisibleLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].xrayed=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].highlighted=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].selected=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].edges=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set culled(e){e=!!e,this._culled=e,this.glRedraw()}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].clippable=e;this.glRedraw()}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].pickable=e}get pickable(){return this._pickable}set colorize(e){this._colorize=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].colorize=e}get colorize(){return this._colorize}set opacity(e){this._opacity=e;for(var t=0,i=this._nodes.length;t<i;t++)this._nodes[t].opacity=e}get opacity(){return this._opacity}set castsShadow(e){}get castsShadow(){return!1}set receivesShadow(e){}get receivesShadow(){return!1}get isDrawable(){return!0}get isStateSortable(){return!1}stateSortCompare(e,t){}getRenderFlags(e){if(e.reset(),0!==this.numVisibleLayerPortions){if(this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedFillTransparent=!0:e.xrayedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.alpha<1?e.normalEdgesTransparent=!0:e.normalEdgesOpaque=!0}if(this.numXRayedLayerPortions<this.numVisibleLayerPortions&&this.numHighlightedLayerPortions<this.numVisibleLayerPortions&&this.numSelectedLayerPortions<this.numVisibleLayerPortions&&this.numTransparentLayerPortions<this.numVisibleLayerPortions&&(e.normalFillOpaque=!0),this.numTransparentLayerPortions>0&&(e.normalFillTransparent=!0),this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedFillTransparent=!0:e.selectedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedFillTransparent=!0:e.highlightedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}drawNormalFillOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawNormalFillOpaque(e)}drawNormalEdgesOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawNormalEdgesOpaque(e)}drawNormalFillTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawNormalFillTransparent(e)}drawNormalEdgesTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawNormalEdgesTransparent(e)}drawXRayedFillOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawXRayedFillOpaque(e)}drawXRayedEdgesOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawXRayedEdgesOpaque(e)}drawXRayedFillTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawXRayedFillTransparent(e)}drawXRayedEdgesTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawXRayedEdgesTransparent(e)}drawHighlightedFillOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawHighlightedFillOpaque(e)}drawHighlightedEdgesOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawHighlightedEdgesOpaque(e)}drawHighlightedFillTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawHighlightedFillTransparent(e)}drawHighlightedEdgesTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawHighlightedEdgesTransparent(e)}drawSelectedFillOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawSelectedFillOpaque(e)}drawSelectedEdgesOpaque(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawSelectedEdgesOpaque(e)}drawSelectedFillTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawSelectedFillTransparent(e)}drawSelectedEdgesTransparent(e){for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawSelectedEdgesTransparent(e)}drawPickMesh(e){if(0!==this.numVisibleLayerPortions)for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawPickMesh(e)}drawPickDepths(e){if(0!==this.numVisibleLayerPortions)for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawPickDepths(e)}drawPickNormals(e){if(0!==this.numVisibleLayerPortions)for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawPickNormals(e)}drawOcclusion(e){if(0!==this.numVisibleLayerPortions)for(var t=0,i=this._layers.length;t<i;t++)this._layers[t].drawOcclusion(e)}compile(){for(var e=0,t=this._layers.length;e<t;e++)this._layers[e].compileShaders()}destroy(){for(var e in this._tiles)if(this._tiles.hasOwnProperty(e)){const s=this._tiles[e];var t=0;for(s.nodes.length;t<i;t++){s.nodes[t]._destroy()}ot(s.buffer)}this.scene.camera.off(this._onCameraViewMatrix),super.destroy();t=0;for(var i=this._layers.length;t<i;t++)this._layers[t].destroy();for(t=0,i=this._nodes.length;t<i;t++)this._nodes[t]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this)}}class os{constructor(e,t,i){this.id=i&&i.id?i.id:e,this.viewer=t,this._eventSubs={},t.addPlugin(this)}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,t){}destroy(){this.viewer.removePlugin(this)}}class ns{constructor(){}getMetaModel(e,t,i){n.loadJSON(e,e=>{t(e)},function(e){i(e)})}getXKT(e,t,i){var s=()=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var a=r[3];a=window.decodeURIComponent(a),e&&(a=window.atob(a));try{const e=new ArrayBuffer(a.length),s=new Uint8Array(e);for(var o=0;o<a.length;o++)s[o]=a.charCodeAt(o);t(e)}catch(e){i(e)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("getXKT error : "+s.response))},s.send(null)}}}const ls={IfcRoof:{colorize:[.837255,.203922,.270588],priority:0},IfcSlab:{colorize:[.637255,.603922,.670588],priority:0},IfcWall:{colorize:[.537255,.337255,.237255],priority:0},IfcWallStandardCase:{colorize:[.537255,.337255,.237255],priority:0},IfcCovering:{colorize:[.8470588235,.427450980392,0],priority:0},IfcDoor:{colorize:[.637255,.603922,.670588],priority:1},IfcStair:{colorize:[.637255,.603922,.670588],priority:2},IfcStairFlight:{colorize:[.637255,.603922,.670588],priority:2},IfcProxy:{colorize:[.137255,.403922,.870588],priority:2},IfcRamp:{colorize:[.8470588235,.427450980392,0],priority:2},IfcColumn:{colorize:[.137255,.403922,.870588],priority:3},IfcBeam:{colorize:[.137255,.403922,.870588],priority:3},IfcCurtainWall:{colorize:[.137255,.403922,.870588],priority:3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.5,priority:3},IfcTransportElement:{colorize:[.8470588235,.427450980392,0],priority:3},IfcFooting:{colorize:[.8470588235,.427450980392,0],priority:3},IfcRailing:{colorize:[.137255,.403922,.870588],priority:4},IfcFurnishingElement:{colorize:[.137255,.403922,.870588],priority:4},IfcFurniture:{colorize:[.8470588235,.427450980392,0],priority:4},IfcSystemFurnitureElement:{colorize:[.8470588235,.427450980392,0],priority:4},IfcFlowSegment:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowitting:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowTerminal:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowController:{colorize:[.8470588235,.427450980392,0],priority:5},IfcFlowFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctSegment:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDistributionFlowElement:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcLightFixture:{colorize:[.8470588235,.8470588235,.870588],priority:5},IfcAirTerminal:{colorize:[.8470588235,.427450980392,0],priority:6},IfcOpeningElement:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,priority:6},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.5,priority:6},IfcWindow:{colorize:[.137255,.403922,.870588],pickable:!1,opacity:.4,priority:6},IfcBuildingElementProxy:{colorize:[.5,.5,.5]},IfcSite:{colorize:[.137255,.403922,.870588]},IfcMember:{colorize:[.8470588235,.427450980392,0]},DEFAULT:{colorize:[.5,.5,.5],priority:10}};var hs=i(0);const cs=window.pako||hs,us=1,ds=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();class ps extends os{constructor(e,t={}){super("XKTLoader",e,t),this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes}static get XKTVersion(){return us}set dataSource(e){this._dataSource=e||new ns}get dataSource(){return this._dataSource}set objectDefaults(e){this._objectDefaults=e||ls}get objectDefaults(){return this._objectDefaults}set includeTypes(e){this._includeTypes=e}get includeTypes(){return this._includeTypes}set excludeTypes(e){this._excludeTypes=e}get excludeTypes(){return this._excludeTypes}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new as(this.viewer.scene,n.apply(e,{isModel:!0,preCompressed:!0})),i=t.id;if(!e.src&&!e.xkt)return this.error("load() param expected: src or xkt"),t;const s={};if(e.metaModelSrc||e.metaModelData){const r=e.includeTypes||this._includeTypes,a=e.excludeTypes||this._excludeTypes,o=e.objectDefaults||this._objectDefaults;if(r){s.includeTypesMap={};for(let e=0,t=r.length;e<t;e++)s.includeTypesMap[r[e]]=!0}if(a){s.excludeTypesMap={};for(let e=0,t=a.length;e<t;e++)s.excludeTypesMap[a[e]]=!0}o&&(s.objectDefaults=o);const n=o=>{this.viewer.metaScene.createMetaModel(i,o,{includeTypes:r,excludeTypes:a}),this.viewer.scene.canvas.spinner.processes--,e.src?this._loadModel(e.src,e,s,t):this._parseModel(e.xkt,e,s,t)};if(e.metaModelSrc){const t=e.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(t,e=>{this.viewer.scene.canvas.spinner.processes--,n(e)},e=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${t}' - ${e}`),this.viewer.scene.canvas.spinner.processes--})}else e.metaModelData&&n(e.metaModelData)}else e.src?this._loadModel(e.src,e,s,t):this._parseModel(e.xkt,e,s,t);return t.once("destroyed",()=>{this.viewer.metaScene.destroyMetaModel(i)}),t}_loadModel(e,t,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getXKT(t.src,e=>{this._parseModel(e,t,i,s),r.processes--,this.viewer.scene.once("tick",()=>{s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!0)})},e=>{r.processes--,this.error(e),s.fire("error",e)})}_parseModel(e,t,i,s){const r=this._extractData(e);if(!r)return;const a=this._inflateData(r);this._loadDataIntoModel(a,i,s)}_extractData(e){const t=new DataView(e),i=new Uint8Array(e);if(t.getUint32(0,!0)>us)return void this.error("Incompatible .XKT file version; this XKTLoaderPlugin supports versions <= V"+us);const s=t.getUint32(4,!0),r=[];let a=4*(s+2);for(let e=0;e<s;e++){const s=t.getUint32(4*(e+2),!0);r.push(i.slice(a,a+s)),a+=s}return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11]}}_inflateData(e){return{positions:new Uint16Array(cs.inflate(e.positions.buffer).buffer),normals:new Int8Array(cs.inflate(e.normals.buffer).buffer),indices:new Uint32Array(cs.inflate(e.indices.buffer).buffer),edgeIndices:new Uint32Array(cs.inflate(e.edgeIndices.buffer).buffer),meshPositions:new Uint32Array(cs.inflate(e.meshPositions.buffer).buffer),meshIndices:new Uint32Array(cs.inflate(e.meshIndices.buffer).buffer),meshEdgesIndices:new Uint32Array(cs.inflate(e.meshEdgesIndices.buffer).buffer),meshColors:new Uint8Array(cs.inflate(e.meshColors.buffer).buffer),entityIDs:cs.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(cs.inflate(e.entityMeshes.buffer).buffer),entityIsObjects:new Uint8Array(cs.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(cs.inflate(e.positionsDecodeMatrix).buffer)}}_loadDataIntoModel(e,t,i){const s=e.positions,r=e.normals,a=e.indices,o=e.edgeIndices,l=e.meshPositions,h=e.meshIndices,c=e.meshEdgesIndices,u=e.meshColors,d=JSON.parse(e.entityIDs),p=e.entityMeshes,_=e.entityIsObjects,f=l.length,m=p.length;for(let g=0;g<m;g++){const v=d[g],b=this.viewer.metaScene.metaObjects[v],y={},M={};if(b){if(t.excludeTypesMap&&b.type&&t.excludeTypesMap[b.type])continue;if(t.includeTypesMap&&b.type&&!t.includeTypesMap[b.type])continue;const e=t.objectDefaults?t.objectDefaults[b.type||"DEFAULT"]:null;e&&(!1===e.visible&&(y.visible=!1),!1===e.pickable&&(y.pickable=!1),e.colorize&&(M.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(M.opacity=e.opacity))}else this.warn("metaobject not found for entity: "+v);const x=g===m-1,w=[];for(let t=p[g],d=x?p.length:p[g+1];t<d;t++){const d=t===f-1,p=v+".mesh."+t,_=ds(u.slice(4*t,4*t+3)),m=u[4*t+3]/255;i.createMesh(n.apply(M,{id:p,primitive:"triangles",positions:s.slice(l[t],d?s.length:l[t+1]),normals:r.slice(l[t],d?s.length:l[t+1]),indices:a.slice(h[t],d?a.length:h[t+1]),edgeIndices:o.slice(c[t],d?o.length:c[t+1]),positionsDecodeMatrix:e.positionsDecodeMatrix,color:_,opacity:m})),w.push(p)}i.createEntity(n.apply(y,{id:v,isObject:1===_[g],meshIds:w}))}i.finalize()}}const _s=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene._sectionPlanesState,i=e.scene._lightsState,s=e._geometry._state,r=e._state.billboard,a=e._state.stationary,o=t.sectionPlanes.length>0,n=!!s.compressGeometry;let l,h,c;const u=[];u.push("// Lambertian drawing vertex shader"),u.push("attribute vec3 position;"),u.push("uniform mat4 modelMatrix;"),u.push("uniform mat4 viewMatrix;"),u.push("uniform mat4 projMatrix;"),u.push("uniform vec4 colorize;"),n&&u.push("uniform mat4 positionsDecodeMatrix;");o&&u.push("varying vec4 vWorldPosition;");if(u.push("uniform vec4 lightAmbient;"),u.push("uniform vec4 materialColor;"),u.push("uniform vec3 materialEmissive;"),s.normalsBuf){for(u.push("attribute vec3 normal;"),u.push("uniform mat4 modelNormalMatrix;"),u.push("uniform mat4 viewNormalMatrix;"),l=0,h=i.lights.length;l<h;l++)"ambient"!==(c=i.lights[l]).type&&(u.push("uniform vec4 lightColor"+l+";"),"dir"===c.type&&u.push("uniform vec3 lightDir"+l+";"),"point"===c.type&&u.push("uniform vec3 lightPos"+l+";"),"spot"===c.type&&(u.push("uniform vec3 lightPos"+l+";"),u.push("uniform vec3 lightDir"+l+";")));n&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}u.push("varying vec4 vColor;"),"points"===s.primitiveName&&u.push("uniform float pointSize;");"spherical"!==r&&"cylindrical"!==r||(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),"spherical"===r&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}"));u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),n&&u.push("localPosition = positionsDecodeMatrix * localPosition;");s.normalsBuf&&(n?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));u.push("mat4 viewMatrix2 = viewMatrix;"),u.push("mat4 modelMatrix2 = modelMatrix;"),a&&u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),s.normalsBuf&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s.normalsBuf&&u.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(u.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),u.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),u.push("float lambertian = 1.0;"),s.normalsBuf)for(l=0,h=i.lights.length;l<h;l++)if("ambient"!==(c=i.lights[l]).type){if("dir"===c.type)"view"===c.space?u.push("viewLightDir = normalize(lightDir"+l+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===c.type)"view"===c.space?u.push("viewLightDir = normalize(lightPos"+l+" - viewPosition.xyz);"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==c.type)continue;"view"===c.space?u.push("viewLightDir = normalize(lightDir"+l+");"):u.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+l+", 0.0)).xyz);")}u.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),u.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}u.push("vColor = vec4(materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),o&&u.push("vWorldPosition = worldPosition;");"points"===s.primitiveName&&u.push("gl_PointSize = pointSize;");return u.push("   gl_Position = projMatrix * viewPosition;"),u.push("}"),u}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=(e._material._state,e._geometry._state);let r,a;const o=i.sectionPlanes.length>0,n=t.gammaOutput,l=[];if(l.push("// Lambertian drawing fragment shader"),l.push("precision lowp float;"),o)for(l.push("varying vec4 vWorldPosition;"),l.push("uniform bool clippable;"),r=0,a=i.sectionPlanes.length;r<a;r++)l.push("uniform bool sectionPlaneActive"+r+";"),l.push("uniform vec3 sectionPlanePos"+r+";"),l.push("uniform vec3 sectionPlaneDir"+r+";");l.push("varying vec4 vColor;"),n&&(l.push("uniform float gammaFactor;"),l.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),l.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),l.push("}"));if(l.push("void main(void) {"),o){for(l.push("if (clippable) {"),l.push("  float dist = 0.0;"),r=0,a=i.sectionPlanes.length;r<a;r++)l.push("if (sectionPlaneActive"+r+") {"),l.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),l.push("}");l.push("  if (dist > 0.0) { discard; }"),l.push("}")}"points"===s.primitiveName&&(l.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),l.push("float r = dot(cxy, cxy);"),l.push("if (r > 1.0) {"),l.push("   discard;"),l.push("}"));n?l.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):l.push("gl_FragColor = vColor;");return l.push("}"),l}(e)):(this.vertex=function(e){const t=e.scene,i=e._material,s=e._state,r=t._sectionPlanesState,a=e._geometry._state,o=t._lightsState;let n,l,h;const c=s.billboard,u=s.stationary,d=function(e){if(!e._geometry._state.uvBuf)return!1;const t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),p=gs(e),_=r.sectionPlanes.length>0,f=ms(e),m=!!a.compressGeometry,g=[];p&&i._normalMap&&g.push("#extension GL_OES_standard_derivatives : enable");g.push("// Drawing vertex shader"),g.push("attribute  vec3 position;"),m&&g.push("uniform mat4 positionsDecodeMatrix;");g.push("uniform  mat4 modelMatrix;"),g.push("uniform  mat4 viewMatrix;"),g.push("uniform  mat4 projMatrix;"),g.push("varying  vec3 vViewPosition;"),_&&g.push("varying vec4 vWorldPosition;");o.lightMaps.length>0&&g.push("varying    vec3 vWorldNormal;");if(p){for(g.push("attribute  vec3 normal;"),g.push("uniform    mat4 modelNormalMatrix;"),g.push("uniform    mat4 viewNormalMatrix;"),g.push("varying    vec3 vViewNormal;"),n=0,l=o.lights.length;n<l;n++)"ambient"!==(h=o.lights[n]).type&&("dir"===h.type&&g.push("uniform vec3 lightDir"+n+";"),"point"===h.type&&g.push("uniform vec3 lightPos"+n+";"),"spot"===h.type&&(g.push("uniform vec3 lightPos"+n+";"),g.push("uniform vec3 lightDir"+n+";")),"dir"===h.type&&"view"===h.space||g.push("varying vec4 vViewLightReverseDirAndDist"+n+";"));m&&(g.push("vec3 octDecode(vec2 oct) {"),g.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),g.push("    if (v.z < 0.0) {"),g.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),g.push("    }"),g.push("    return normalize(v);"),g.push("}"))}d&&(g.push("attribute vec2 uv;"),g.push("varying vec2 vUV;"),m&&g.push("uniform mat3 uvDecodeMatrix;"));a.colors&&(g.push("attribute vec4 color;"),g.push("varying vec4 vColor;"));"points"===a.primitiveName&&g.push("uniform float pointSize;");"spherical"!==c&&"cylindrical"!==c||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===c&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}"));if(f)for(g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),n=0,l=o.lights.length;n<l;n++)o.lights[n].castsShadow&&(g.push("uniform mat4 shadowViewMatrix"+n+";"),g.push("uniform mat4 shadowProjMatrix"+n+";"),g.push("varying vec4 vShadowPosFromLight"+n+";"));g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),g.push("vec4 worldPosition;"),m&&g.push("localPosition = positionsDecodeMatrix * localPosition;");p&&(m?g.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):g.push("vec4 localNormal = vec4(normal, 0.0); "),g.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),g.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));g.push("mat4 viewMatrix2           = viewMatrix;"),g.push("mat4 modelMatrix2          = modelMatrix;"),u&&g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===c||"cylindrical"===c?(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);"),g.push("billboard(modelViewMatrix);"),p&&(g.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),g.push("billboard(modelNormalMatrix2);"),g.push("billboard(viewNormalMatrix2);"),g.push("billboard(modelViewNormalMatrix);")),g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(p)for(g.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&g.push("vWorldNormal = worldNormal;"),g.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),g.push("vec3 tmpVec3;"),g.push("float lightDist;"),n=0,l=o.lights.length;n<l;n++)"ambient"!==(h=o.lights[n]).type&&("dir"===h.type&&"world"===h.space&&(g.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+n+", 0.0) ).xyz;"),g.push("vViewLightReverseDirAndDist"+n+" = vec4(-tmpVec3, 0.0);")),"point"===h.type&&("world"===h.space?(g.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+n+", 1.0)).xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")):(g.push("tmpVec3 = lightPos"+n+".xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")),g.push("vViewLightReverseDirAndDist"+n+" = vec4(tmpVec3, lightDist);")));d&&(m?g.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):g.push("vUV = uv;"));a.colors&&g.push("vColor = color;");"points"===a.primitiveName&&g.push("gl_PointSize = pointSize;");_&&g.push("vWorldPosition = worldPosition;");if(g.push("   vViewPosition = viewPosition.xyz;"),g.push("   gl_Position = projMatrix * viewPosition;"),g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),f)for(g.push("vec4 tempx; "),n=0,l=o.lights.length;n<l;n++)o.lights[n].castsShadow&&g.push("vShadowPosFromLight"+n+" = texUnitConverter * shadowProjMatrix"+n+" * (shadowViewMatrix"+n+" * worldPosition); ");return g.push("}"),g}(e),this.fragment=function(e){const t=e.scene,i=t.canvas.gl,s=e._material,r=e._geometry._state,a=e.scene._sectionPlanesState,o=e.scene._lightsState,n=e._material._state,l=a.sectionPlanes.length>0,h=gs(e),c=r.uvBuf,u="PhongMaterial"===n.type,d="MetallicMaterial"===n.type,p="SpecularMaterial"===n.type,_=ms(e),f=(t.gammaInput,t.gammaOutput);let m,g;const v=[];v.push("// Drawing fragment shader"),h&&s._normalMap&&v.push("#extension GL_OES_standard_derivatives : enable");v.push("precision "+function(e){if(!e.getShaderPrecisionFormat)return"mediump";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";if(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0)return"mediump";return"lowp"}(i)+" float;"),_&&(v.push("float unpackDepth (vec4 color) {"),v.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),v.push("  return dot(color, bitShift);"),v.push("}"));v.push("uniform float gammaFactor;"),v.push("vec4 linearToLinear( in vec4 value ) {"),v.push("  return value;"),v.push("}"),v.push("vec4 sRGBToLinear( in vec4 value ) {"),v.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),v.push("}"),v.push("vec4 gammaToLinear( in vec4 value) {"),v.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),v.push("}"),f&&(v.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),v.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),v.push("}"));if(l){v.push("varying vec4 vWorldPosition;"),v.push("uniform bool clippable;");for(var b=0;b<a.sectionPlanes.length;b++)v.push("uniform bool sectionPlaneActive"+b+";"),v.push("uniform vec3 sectionPlanePos"+b+";"),v.push("uniform vec3 sectionPlaneDir"+b+";")}h&&(o.lightMaps.length>0&&(v.push("uniform samplerCube lightMap;"),v.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&v.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("uniform mat4 viewMatrix;"),v.push("#define PI 3.14159265359"),v.push("#define RECIPROCAL_PI 0.31830988618"),v.push("#define RECIPROCAL_PI2 0.15915494"),v.push("#define EPSILON 1e-6"),v.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),v.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),v.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),v.push("}"),v.push("struct IncidentLight {"),v.push("   vec3 color;"),v.push("   vec3 direction;"),v.push("};"),v.push("struct ReflectedLight {"),v.push("   vec3 diffuse;"),v.push("   vec3 specular;"),v.push("};"),v.push("struct Geometry {"),v.push("   vec3 position;"),v.push("   vec3 viewNormal;"),v.push("   vec3 worldNormal;"),v.push("   vec3 viewEyeDir;"),v.push("};"),v.push("struct Material {"),v.push("   vec3    diffuseColor;"),v.push("   float   specularRoughness;"),v.push("   vec3    specularColor;"),v.push("   float   shine;"),v.push("};"),u&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(v.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(v.push("   vec3 irradiance = "+fs[o.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),v.push("   irradiance *= PI;"),v.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(v.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),v.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),v.push("   reflectedLight.specular     += radiance;")),v.push("}")),v.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),v.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),v.push("   vec3 irradiance = dotNL * directLight.color * PI;"),v.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),v.push("}")),(d||p)&&(v.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),v.push("   float r = ggxRoughness + 0.0001;"),v.push("   return (2.0 / (r * r) - 2.0);"),v.push("}"),v.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),v.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),v.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),v.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),v.push("}"),o.reflectionMaps.length>0&&(v.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),v.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),v.push("   vec3 envMapColor = "+fs[o.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),v.push("  return envMapColor;"),v.push("}")),v.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),v.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),v.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),v.push("}"),v.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),v.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),v.push("   return 1.0 / ( gl * gv );"),v.push("}"),v.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),v.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),v.push("   return 0.5 / max( gv + gl, EPSILON );"),v.push("}"),v.push("float D_GGX(const in float alpha, const in float dotNH) {"),v.push("   float a2 = ( alpha * alpha );"),v.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),v.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),v.push("}"),v.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),v.push("   float alpha = ( roughness * roughness );"),v.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),v.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),v.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),v.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),v.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),v.push("   vec3  F = F_Schlick( specularColor, dotLH );"),v.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),v.push("   float D = D_GGX( alpha, dotNH );"),v.push("   return F * (G * D);"),v.push("}"),v.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),v.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),v.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),v.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),v.push("   vec4 r = roughness * c0 + c1;"),v.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),v.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),v.push("   return specularColor * AB.x + AB.y;"),v.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(v.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(v.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),v.push("   irradiance *= PI;"),v.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(v.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),v.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),v.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),v.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),v.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),v.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),v.push("}")),v.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),v.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),v.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),v.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),v.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),v.push("}")));v.push("varying vec3 vViewPosition;"),r.colors&&v.push("varying vec4 vColor;");c&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._occlusionMap||s._alphaMap)&&v.push("varying vec2 vUV;");h&&(o.lightMaps.length>0&&v.push("varying vec3 vWorldNormal;"),v.push("varying vec3 vViewNormal;"));n.ambient&&v.push("uniform vec3 materialAmbient;");n.baseColor&&v.push("uniform vec3 materialBaseColor;");void 0!==n.alpha&&null!==n.alpha&&v.push("uniform vec4 materialAlphaModeCutoff;");n.emissive&&v.push("uniform vec3 materialEmissive;");n.diffuse&&v.push("uniform vec3 materialDiffuse;");void 0!==n.glossiness&&null!==n.glossiness&&v.push("uniform float materialGlossiness;");void 0!==n.shininess&&null!==n.shininess&&v.push("uniform float materialShininess;");n.specular&&v.push("uniform vec3 materialSpecular;");void 0!==n.metallic&&null!==n.metallic&&v.push("uniform float materialMetallic;");void 0!==n.roughness&&null!==n.roughness&&v.push("uniform float materialRoughness;");void 0!==n.specularF0&&null!==n.specularF0&&v.push("uniform float materialSpecularF0;");c&&s._ambientMap&&(v.push("uniform sampler2D ambientMap;"),s._ambientMap._state.matrix&&v.push("uniform mat4 ambientMapMatrix;"));c&&s._baseColorMap&&(v.push("uniform sampler2D baseColorMap;"),s._baseColorMap._state.matrix&&v.push("uniform mat4 baseColorMapMatrix;"));c&&s._diffuseMap&&(v.push("uniform sampler2D diffuseMap;"),s._diffuseMap._state.matrix&&v.push("uniform mat4 diffuseMapMatrix;"));c&&s._emissiveMap&&(v.push("uniform sampler2D emissiveMap;"),s._emissiveMap._state.matrix&&v.push("uniform mat4 emissiveMapMatrix;"));h&&c&&s._metallicMap&&(v.push("uniform sampler2D metallicMap;"),s._metallicMap._state.matrix&&v.push("uniform mat4 metallicMapMatrix;"));h&&c&&s._roughnessMap&&(v.push("uniform sampler2D roughnessMap;"),s._roughnessMap._state.matrix&&v.push("uniform mat4 roughnessMapMatrix;"));h&&c&&s._metallicRoughnessMap&&(v.push("uniform sampler2D metallicRoughnessMap;"),s._metallicRoughnessMap._state.matrix&&v.push("uniform mat4 metallicRoughnessMapMatrix;"));h&&s._normalMap&&(v.push("uniform sampler2D normalMap;"),s._normalMap._state.matrix&&v.push("uniform mat4 normalMapMatrix;"),v.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),v.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),v.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),v.push("      vec2 st0 = dFdx( uv.st );"),v.push("      vec2 st1 = dFdy( uv.st );"),v.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),v.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),v.push("      vec3 N = normalize( surf_norm );"),v.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),v.push("      mat3 tsn = mat3( S, T, N );"),v.push("      return normalize( tsn * mapN );"),v.push("}"));c&&s._occlusionMap&&(v.push("uniform sampler2D occlusionMap;"),s._occlusionMap._state.matrix&&v.push("uniform mat4 occlusionMapMatrix;"));c&&s._alphaMap&&(v.push("uniform sampler2D alphaMap;"),s._alphaMap._state.matrix&&v.push("uniform mat4 alphaMapMatrix;"));h&&c&&s._specularMap&&(v.push("uniform sampler2D specularMap;"),s._specularMap._state.matrix&&v.push("uniform mat4 specularMapMatrix;"));h&&c&&s._glossinessMap&&(v.push("uniform sampler2D glossinessMap;"),s._glossinessMap._state.matrix&&v.push("uniform mat4 glossinessMapMatrix;"));h&&c&&s._specularGlossinessMap&&(v.push("uniform sampler2D materialSpecularGlossinessMap;"),s._specularGlossinessMap._state.matrix&&v.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));h&&(s._diffuseFresnel||s._specularFresnel||s._alphaFresnel||s._emissiveFresnel||s._reflectivityFresnel)&&(v.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),v.push("    float fr = abs(dot(eyeDir, normal));"),v.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),v.push("    return pow(finalFr, power);"),v.push("}"),s._diffuseFresnel&&(v.push("uniform float  diffuseFresnelCenterBias;"),v.push("uniform float  diffuseFresnelEdgeBias;"),v.push("uniform float  diffuseFresnelPower;"),v.push("uniform vec3   diffuseFresnelCenterColor;"),v.push("uniform vec3   diffuseFresnelEdgeColor;")),s._specularFresnel&&(v.push("uniform float  specularFresnelCenterBias;"),v.push("uniform float  specularFresnelEdgeBias;"),v.push("uniform float  specularFresnelPower;"),v.push("uniform vec3   specularFresnelCenterColor;"),v.push("uniform vec3   specularFresnelEdgeColor;")),s._alphaFresnel&&(v.push("uniform float  alphaFresnelCenterBias;"),v.push("uniform float  alphaFresnelEdgeBias;"),v.push("uniform float  alphaFresnelPower;"),v.push("uniform vec3   alphaFresnelCenterColor;"),v.push("uniform vec3   alphaFresnelEdgeColor;")),s._reflectivityFresnel&&(v.push("uniform float  materialSpecularF0FresnelCenterBias;"),v.push("uniform float  materialSpecularF0FresnelEdgeBias;"),v.push("uniform float  materialSpecularF0FresnelPower;"),v.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),v.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),s._emissiveFresnel&&(v.push("uniform float  emissiveFresnelCenterBias;"),v.push("uniform float  emissiveFresnelEdgeBias;"),v.push("uniform float  emissiveFresnelPower;"),v.push("uniform vec3   emissiveFresnelCenterColor;"),v.push("uniform vec3   emissiveFresnelEdgeColor;")));if(v.push("uniform vec4   lightAmbient;"),h)for(b=0,m=o.lights.length;b<m;b++)"ambient"!==(g=o.lights[b]).type&&(v.push("uniform vec4 lightColor"+b+";"),"point"===g.type&&v.push("uniform vec3 lightAttenuation"+b+";"),"dir"===g.type&&"view"===g.space&&v.push("uniform vec3 lightDir"+b+";"),"point"===g.type&&"view"===g.space?v.push("uniform vec3 lightPos"+b+";"):v.push("varying vec4 vViewLightReverseDirAndDist"+b+";"));if(_)for(b=0,m=o.lights.length;b<m;b++)o.lights[b].castsShadow&&(v.push("varying vec4 vShadowPosFromLight"+b+";"),v.push("uniform sampler2D shadowMap"+b+";"));if(v.push("uniform vec4 colorize;"),v.push("void main(void) {"),l){v.push("if (clippable) {"),v.push("  float dist = 0.0;");for(b=0;b<a.sectionPlanes.length;b++)v.push("if (sectionPlaneActive"+b+") {"),v.push("   dist += clamp(dot(-sectionPlaneDir"+b+".xyz, vWorldPosition.xyz - sectionPlanePos"+b+".xyz), 0.0, 1000.0);"),v.push("}");v.push("  if (dist > 0.0) { discard; }"),v.push("}")}"points"===r.primitiveName&&(v.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),v.push("float r = dot(cxy, cxy);"),v.push("if (r > 1.0) {"),v.push("   discard;"),v.push("}"));v.push("float occlusion = 1.0;"),n.ambient?v.push("vec3 ambientColor = materialAmbient;"):v.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");n.diffuse?v.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?v.push("vec3 diffuseColor = materialBaseColor;"):v.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");r.colors&&v.push("diffuseColor *= vColor.rgb;");n.emissive?v.push("vec3 emissiveColor = materialEmissive;"):v.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");n.specular?v.push("vec3 specular = materialSpecular;"):v.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==n.alpha?v.push("float alpha = materialAlphaModeCutoff[0];"):v.push("float alpha = 1.0;");r.colors&&v.push("alpha *= vColor.a;");void 0!==n.glossiness?v.push("float glossiness = materialGlossiness;"):v.push("float glossiness = 1.0;");void 0!==n.metallic?v.push("float metallic = materialMetallic;"):v.push("float metallic = 1.0;");void 0!==n.roughness?v.push("float roughness = materialRoughness;"):v.push("float roughness = 1.0;");void 0!==n.specularF0?v.push("float specularF0 = materialSpecularF0;"):v.push("float specularF0 = 1.0;");c&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._occlusionMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._alphaMap)&&(v.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),v.push("vec2 textureCoord;"));c&&s._ambientMap&&(s._ambientMap._state.matrix?v.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),v.push("ambientTexel = "+fs[s._ambientMap._state.encoding]+"(ambientTexel);"),v.push("ambientColor *= ambientTexel.rgb;"));c&&s._diffuseMap&&(s._diffuseMap._state.matrix?v.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),v.push("diffuseTexel = "+fs[s._diffuseMap._state.encoding]+"(diffuseTexel);"),v.push("diffuseColor *= diffuseTexel.rgb;"),v.push("alpha *= diffuseTexel.a;"));c&&s._baseColorMap&&(s._baseColorMap._state.matrix?v.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),v.push("baseColorTexel = "+fs[s._baseColorMap._state.encoding]+"(baseColorTexel);"),v.push("diffuseColor *= baseColorTexel.rgb;"),v.push("alpha *= baseColorTexel.a;"));c&&s._emissiveMap&&(s._emissiveMap._state.matrix?v.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),v.push("emissiveTexel = "+fs[s._emissiveMap._state.encoding]+"(emissiveTexel);"),v.push("emissiveColor *= emissiveTexel.rgb;"));c&&s._alphaMap&&(s._alphaMap._state.matrix?v.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("alpha *= texture2D(alphaMap, textureCoord).r;"));c&&s._occlusionMap&&(s._occlusionMap._state.matrix?v.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(h&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){c&&s._normalMap?(s._normalMap._state.matrix?v.push("textureCoord = (normalMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):v.push("vec3 viewNormal = normalize(vViewNormal);"),c&&s._specularMap&&(s._specularMap._state.matrix?v.push("textureCoord = (specularMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("specular *= texture2D(specularMap, textureCoord).rgb;")),c&&s._glossinessMap&&(s._glossinessMap._state.matrix?v.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),c&&s._specularGlossinessMap&&(s._specularGlossinessMap._state.matrix?v.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),v.push("specular *= specGlossRGB.rgb;"),v.push("glossiness *= specGlossRGB.a;")),c&&s._metallicMap&&(s._metallicMap._state.matrix?v.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("metallic *= texture2D(metallicMap, textureCoord).r;")),c&&s._roughnessMap&&(s._roughnessMap._state.matrix?v.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),c&&s._metallicRoughnessMap&&(s._metallicRoughnessMap._state.matrix?v.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):v.push("textureCoord = texturePos.xy;"),v.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),v.push("metallic *= metalRoughRGB.b;"),v.push("roughness *= metalRoughRGB.g;")),v.push("vec3 viewEyeDir = normalize(-vViewPosition);"),s._diffuseFresnel&&(v.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),v.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),s._specularFresnel&&(v.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),v.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),s._alphaFresnel&&(v.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),v.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),s._emissiveFresnel&&(v.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),v.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),v.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),v.push("   discard;"),v.push("}"),v.push("IncidentLight  light;"),v.push("Material       material;"),v.push("Geometry       geometry;"),v.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),v.push("vec3           viewLightDir;"),u&&(v.push("material.diffuseColor      = diffuseColor;"),v.push("material.specularColor     = specular;"),v.push("material.shine             = materialShininess;")),p&&(v.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),v.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),v.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),v.push("material.specularColor     = specular;")),d&&(v.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),v.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),v.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),v.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),v.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&v.push("geometry.worldNormal   = normalize(vWorldNormal);"),v.push("geometry.viewNormal    = viewNormal;"),v.push("geometry.viewEyeDir    = viewEyeDir;"),u&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&v.push("computePBRLightMapping(geometry, material, reflectedLight);"),v.push("float shadow = 1.0;"),v.push("float shadowAcneRemover = 0.007;"),v.push("vec3 fragmentDepth;"),v.push("float texelSize = 1.0 / 1024.0;"),v.push("float amountInLight = 0.0;"),v.push("vec3 shadowCoord;"),v.push("vec4 rgbaDepth;"),v.push("float depth;");for(b=0,m=o.lights.length;b<m;b++)"ambient"!==(g=o.lights[b]).type&&("dir"===g.type&&"view"===g.space?v.push("viewLightDir = -normalize(lightDir"+b+");"):"point"===g.type&&"view"===g.space?v.push("viewLightDir = normalize(lightPos"+b+" - vViewPosition);"):v.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+b+".xyz);"),_&&g.castsShadow?(v.push("shadow = 0.0;"),v.push("fragmentDepth = vShadowPosFromLight"+b+".xyz;"),v.push("fragmentDepth.z -= shadowAcneRemover;"),v.push("for (int x = -3; x <= 3; x++) {"),v.push("  for (int y = -3; y <= 3; y++) {"),v.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+b+", fragmentDepth.xy + vec2(x, y) * texelSize));"),v.push("      if (fragmentDepth.z < texelDepth) {"),v.push("          shadow += 1.0;"),v.push("      }"),v.push("  }"),v.push("}"),v.push("shadow = shadow / 9.0;"),v.push("light.color =  lightColor"+b+".rgb * (lightColor"+b+".a * shadow);")):v.push("light.color =  lightColor"+b+".rgb * (lightColor"+b+".a );"),v.push("light.direction = viewLightDir;"),u&&v.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||d)&&v.push("computePBRLighting(light, geometry, material, reflectedLight);"));u?(v.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),v.push("vec3 outgoingLight =  ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;")):v.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else v.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),v.push("vec3 outgoingLight = emissiveColor + ambientColor;");v.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),f&&v.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");return v.push("}"),v}(e))},fs={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function ms(e){if(!e.receivesShadow)return!1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(let e=0,i=t.length;e<i;e++)if(t[e].castsShadow)return!0;return!1}function gs(e){const t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}const vs=new s({}),bs=function(e,t){this.id=vs.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new _s(t),this._allocate(t)},ys={};bs.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";");let s=ys[i];if(!s){if((s=new bs(i,e)).errors)return console.log(s.errors.join("\n")),null;ys[i]=s,r.memory.programs++}return s._useCount++,s},bs.prototype.put=function(){0==--this._useCount&&(vs.removeItem(this.id),this._program&&this._program.destroy(),delete ys[this._hash],r.memory.programs--)},bs.prototype.webglContextRestored=function(){this._program=null},bs.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=L.MAX_TEXTURE_UNITS,s=t.scene,r=t._material,a=s.canvas.gl,o=this._program,n=t._state,l=t._material._state,h=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=l.backfaces;e.backfaces!==t&&(t?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),e.backfaces=t);const s=l.frontface;switch(e.frontface!==s&&(s?a.frontFace(a.CCW):a.frontFace(a.CW),e.frontface=s),e.lineWidth!==l.lineWidth&&(a.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&a.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&a.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&a.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&a.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(o.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&a.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(o.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&a.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&a.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&a.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&a.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&a.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&a.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&a.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&a.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&a.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&a.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&a.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&a.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&a.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&a.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&a.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&a.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&a.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&a.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&a.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&a.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&a.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&a.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&a.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&a.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&a.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&a.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&a.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&a.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&a.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&a.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const t=r._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(o.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&a.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const n=r._metallicMap;n&&n._state.texture&&this._uMetallicMap&&(o.bindTexture(this._uMetallicMap,n._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&a.uniformMatrix4fv(this._uMetallicMapMatrix,!1,n._state.matrix));const h=r._roughnessMap;h&&h._state.texture&&this._uRoughnessMap&&(o.bindTexture(this._uRoughnessMap,h._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&a.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,h._state.matrix));const _=r._metallicRoughnessMap;_&&_._state.texture&&this._uMetallicRoughnessMap&&(o.bindTexture(this._uMetallicRoughnessMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&a.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,_._state.matrix)),(c=r._emissiveMap)&&c._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,c._state.matrix)),(u=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,u._state.matrix)),(d=r._alphaMap)&&d._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,d._state.matrix)),(p=r._normalMap)&&p._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,p._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&a.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&a.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&a.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&a.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&a.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&a.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const f=r._diffuseMap;f&&f._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&a.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,f._state.matrix));const m=r._specularMap;m&&m._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&a.uniformMatrix4fv(this._uSpecularMapMatrix,!1,m._state.matrix));const g=r._glossinessMap;g&&g._state.texture&&this._uGlossinessMap&&(o.bindTexture(this._uGlossinessMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&a.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,g._state.matrix));const v=r._specularGlossinessMap;var c,u,d,p;v&&v._state.texture&&this._uSpecularGlossinessMap&&(o.bindTexture(this._uSpecularGlossinessMap,v._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&a.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,v._state.matrix)),(c=r._emissiveMap)&&c._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&a.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,c._state.matrix)),(u=r._occlusionMap)&&u._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&a.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,u._state.matrix)),(d=r._alphaMap)&&d._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&a.uniformMatrix4fv(this._uAlphaMapMatrix,!1,d._state.matrix)),(p=r._normalMap)&&p._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&a.uniformMatrix4fv(this._uNormalMapMatrix,!1,p._state.matrix))}this._lastMaterialId=l.id}if(a.uniformMatrix4fv(this._uModelMatrix,a.FALSE,t.worldMatrix),this._uModelNormalMatrix&&a.uniformMatrix4fv(this._uModelNormalMatrix,a.FALSE,t.worldNormalMatrix),this._uClippable&&a.uniform1i(this._uClippable,n.clippable),this._uColorize){const e=n.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(a.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3])}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),e.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),e.bindArray++):h.positions,this._lastGeometryId=h.id),h.indicesBuf?(a.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positions&&(a.drawArrays(a.TRIANGLES,0,h.positions.numItems),e.drawArrays++)},bs.prototype._allocate=function(e){const t=e.scene.canvas.gl,i=e._material,s=e.scene._lightsState,r=e.scene._sectionPlanesState,a=e._material._state;if(this._program=new z(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=o.getLocation("uvDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[];const n=s.lights;let l;for(var h=0,c=n.length;h<c;h++){switch((l=n[h]).type){case"ambient":this._uLightAmbient[h]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=o.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=o.getLocation("lightColor"+h),this._uLightPos[h]=o.getLocation("lightPos"+h),this._uLightDir[h]=o.getLocation("lightDir"+h),this._uLightAttenuation[h]=o.getLocation("lightAttenuation"+h)}l.castsShadow&&(this._uShadowViewMatrix[h]=o.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=o.getLocation("shadowProjMatrix"+h))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(h=0,c=r.sectionPlanes.length;h<c;h++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+h),pos:o.getLocation("sectionPlanePos"+h),dir:o.getLocation("sectionPlaneDir"+h)});switch(this._uPointSize=o.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=o.getLocation("materialColor"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=o.getLocation("materialAmbient"),this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=o.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=o.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=o.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=o.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=o.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=o.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=o.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=o.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=o.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=o.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=o.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=o.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=o.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=o.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=o.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=o.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=o.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=o.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=o.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=o.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=o.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=o.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=o.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=o.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=o.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=o.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=o.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=o.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=o.getLocation("materialBaseColor"),this._uMaterialMetallic=o.getLocation("materialMetallic"),this._uMaterialRoughness=o.getLocation("materialRoughness"),this._uMaterialSpecularF0=o.getLocation("materialSpecularF0"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=o.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=o.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=o.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=o.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=o.getLocation("materialDiffuse"),this._uMaterialSpecular=o.getLocation("materialSpecular"),this._uMaterialGlossiness=o.getLocation("materialGlossiness"),this._uMaterialReflectivity=o.getLocation("reflectivityFresnel"),this._uMaterialEmissive=o.getLocation("materialEmissive"),this._uAlphaModeCutoff=o.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=o.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=o.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=o.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=o.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=o.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=o.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=o.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=o.getLocation("normalMapMatrix"))}this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._aUV=o.getAttribute("uv"),this._aColor=o.getAttribute("color"),this._aFlags=o.getAttribute("flags"),this._uClippable=o.getLocation("clippable"),this._uColorize=o.getLocation("colorize"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},bs.prototype._bindProgram=function(e){const t=L.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,a=i._sectionPlanesState;r.lights;let o;const n=this._program;n.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1;const l=i.camera,h=l._state;s.uniformMatrix4fv(this._uViewMatrix,!1,h.matrix),s.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.normalMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix);for(var c=0,u=r.lights.length;c<u;c++)if(o=r.lights[c],this._uLightAmbient[c])s.uniform4f(this._uLightAmbient[c],o.color[0],o.color[1],o.color[2],o.intensity);else if(this._uLightColor[c]&&s.uniform4f(this._uLightColor[c],o.color[0],o.color[1],o.color[2],o.intensity),this._uLightPos[c]&&(s.uniform3fv(this._uLightPos[c],o.pos),this._uLightAttenuation[c]&&s.uniform1f(this._uLightAttenuation[c],o.attenuation)),this._uLightDir[c]&&s.uniform3fv(this._uLightDir[c],o.dir),o.castsShadow){this._uShadowViewMatrix[c]&&s.uniformMatrix4fv(this._uShadowViewMatrix[c],!1,o.getShadowViewMatrix()),this._uShadowProjMatrix[c]&&s.uniformMatrix4fv(this._uShadowProjMatrix[c],!1,o.getShadowProjMatrix());const i=o.getShadowRenderBuf();i&&(n.bindTexture("shadowMap"+c,i.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++)}if(r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,r.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),a.sectionPlanes.length>0){const e=i._sectionPlanesState.sectionPlanes;let t,r,a,o,n;for(c=0,u=this._uSectionPlanes.length;c<u;c++)r=(t=this._uSectionPlanes[c]).active,a=e[c],r&&s.uniform1i(r,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(n=t.dir)&&s.uniform3fv(t.dir,a.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=e.textureUnit};class Ms{constructor(e){this.vertex=function(e){const t=e.scene,i=t._lightsState,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=t._sectionPlanesState.sectionPlanes.length>0,a=!!e._geometry._state.compressGeometry,o=e._state.billboard,n=e._state.stationary,l=[];let h,c,u;l.push("// EmphasisFillShaderSource vertex shader"),l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),a&&l.push("uniform mat4 positionsDecodeMatrix;");r&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){for(l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),h=0,c=i.lights.length;h<c;h++)"ambient"!==(u=i.lights[h]).type&&(l.push("uniform vec4 lightColor"+h+";"),"dir"===u.type&&l.push("uniform vec3 lightDir"+h+";"),"point"===u.type&&l.push("uniform vec3 lightPos"+h+";"),"spot"===u.type&&l.push("uniform vec3 lightPos"+h+";"));a&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===o||"cylindrical"===o)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===o&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),a&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(a?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(h=0,c=i.lights.length;h<c;h++)if("ambient"!==(u=i.lights[h]).type){if("dir"===u.type)"view"===u.space?l.push("viewLightDir = normalize(lightDir"+h+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else{if("point"!==u.type)continue;"view"===u.space?l.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");return l.push("   gl_Position = projMatrix * viewPosition;"),l.push("}"),l}(e),this.fragment=function(e){const t=e.scene._sectionPlanesState,i=e.scene.gammaOutput,s=t.sectionPlanes.length>0;let r,a;const o=[];o.push("// Lambertian drawing fragment shader"),o.push("precision lowp float;"),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s)for(o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;"),r=0,a=t.sectionPlanes.length;r<a;r++)o.push("uniform bool sectionPlaneActive"+r+";"),o.push("uniform vec3 sectionPlanePos"+r+";"),o.push("uniform vec3 sectionPlaneDir"+r+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("if (clippable) {"),o.push("  float dist = 0.0;"),r=0,a=t.sectionPlanes.length;r<a;r++)o.push("if (sectionPlaneActive"+r+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===e._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));o.push("gl_FragColor = vColor;"),i?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)}}const xs=new s({}),ws=function(e,t){this.id=xs.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Ms(t),this._allocate(t)},Ps={};ws.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Ps[t];return i||(i=new ws(t,e),Ps[t]=i,r.memory.programs++),i._useCount++,i},ws.prototype.put=function(){0==--this._useCount&&(xs.removeItem(this.id),this._program&&this._program.destroy(),delete Ps[this._hash],r.memory.programs--)},ws.prototype.webglContextRestored=function(){this._program=null},ws.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene.canvas.gl,r=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,o=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.fillColor,i=r.backfaces;e.backfaces!==i&&(i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=i),s.uniform4f(this._uFillColor,t[0],t[1],t[2],r.fillAlpha),this._lastMaterialId=r.id}s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._uUVDecodeMatrix&&s.uniformMatrix3fv(this._uUVDecodeMatrix,!1,o.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(o.normalsBuf),e.bindArray++),o.indicesBuf?(o.indicesBuf.bind(),e.bindArray++):o.positionsBuf,this._lastGeometryId=o.id),o.indicesBuf?(s.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positionsBuf&&(s.drawArrays(s.TRIANGLES,0,o.positionsBuf.numItems),e.drawArrays++)},ws.prototype._allocate=function(e){const t=e.scene._lightsState,i=e.scene._sectionPlanesState,s=e.scene.canvas.gl;if(this._program=new z(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uModelNormalMatrix=r.getLocation("modelNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var a=0,o=t.lights.length;a<o;a++){switch(t.lights[a].type){case"ambient":this._uLightAmbient[a]=r.getLocation("lightAmbient");break;case"dir":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=r.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=r.getLocation("lightColor"+a),this._uLightPos[a]=r.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=r.getLocation("lightAttenuation"+a)}}this._uSectionPlanes=[];for(a=0,o=i.sectionPlanes.length;a<o;a++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+a),pos:r.getLocation("sectionPlanePos"+a),dir:r.getLocation("sectionPlaneDir"+a)});this._uFillColor=r.getLocation("fillColor"),this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},ws.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState,r=t._lightsState,a=t.camera,o=a._state;let n;this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),i.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,a.project._state.matrix);for(var l=0,h=r.lights.length;l<h;l++)n=r.lights[l],this._uLightAmbient[l]?i.uniform4f(this._uLightAmbient[l],n.color[0],n.color[1],n.color[2],n.intensity):(this._uLightColor[l]&&i.uniform4f(this._uLightColor[l],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[l]&&(i.uniform3fv(this._uLightPos[l],n.pos),this._uLightAttenuation[l]&&i.uniform1f(this._uLightAttenuation[l],n.attenuation)),this._uLightDir[l]&&i.uniform3fv(this._uLightDir[l],n.dir));if(s.sectionPlanes.length>0){const e=t._sectionPlanesState.sectionPlanes;let s,r,a,o,n;for(l=0,h=this._uSectionPlanes.length;l<h;l++)r=(s=this._uSectionPlanes[l]).active,a=e[l],r&&i.uniform1i(r,a.active),(o=s.pos)&&i.uniform3fv(s.pos,a.pos),(n=s.dir)&&i.uniform3fv(s.dir,a.dir)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class As{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Edges drawing vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),t&&a.push("vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._sectionPlanesState,i=e.scene.gammaOutput,s=t.sectionPlanes.length>0;let r,a;const o=[];o.push("// Edges drawing fragment shader"),o.push("precision lowp float;"),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s)for(o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;"),r=0,a=t.sectionPlanes.length;r<a;r++)o.push("uniform bool sectionPlaneActive"+r+";"),o.push("uniform vec3 sectionPlanePos"+r+";"),o.push("uniform vec3 sectionPlaneDir"+r+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("if (clippable) {"),o.push("  float dist = 0.0;"),r=0,a=t.sectionPlanes.length;r<a;r++)o.push("if (sectionPlaneActive"+r+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}o.push("gl_FragColor = vColor;"),i?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(e)}}const Es=new s({}),Cs=function(e,t){this.id=Es.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new As(t),this._allocate(t)},Ls={};Cs.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Ls[t];return i||(i=new Cs(t,e),Ls[t]=i,r.memory.programs++),i._useCount++,i},Cs.prototype.put=function(){0==--this._useCount&&(Es.removeItem(this.id),this._program&&this._program.destroy(),delete Ls[this._hash],r.memory.programs--)},Cs.prototype.webglContextRestored=function(){this._program=null},Cs.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene.canvas.gl;let r;const a=t._state,o=t._geometry,n=o._state;switch(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i){case 0:r=t._xrayMaterial._state;break;case 1:r=t._highlightMaterial._state;break;case 2:r=t._selectedMaterial._state;break;case 3:default:r=t._edgeMaterial._state}if(r.id!==this._lastMaterialId){const t=r.backfaces;if(e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t),e.lineWidth!==r.edgeWidth&&(s.lineWidth(r.edgeWidth),e.lineWidth=r.edgeWidth),this._uEdgeColor){const e=r.edgeColor,t=r.edgeAlpha;s.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t)}this._lastMaterialId=r.id}let l;s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uModelNormalMatrix&&s.uniformMatrix4fv(this._uModelNormalMatrix,s.FALSE,t.worldNormalMatrix),this._uClippable&&s.uniform1i(this._uClippable,a.clippable),n.primitive===s.TRIANGLES?l=o._getEdgeIndices():n.primitive===s.LINES&&(l=n.indicesBuf),l&&(n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),l.bind(),e.bindArray++,this._lastGeometryId=n.id),s.drawElements(s.LINES,l.numItems,l.itemType,0),e.drawElements++)},Cs.prototype._allocate=function(e){const t=e.scene.canvas.gl,i=e.scene._sectionPlanesState;if(this._program=new z(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Cs.prototype._bindProgram=function(e){const t=this._program,i=this._scene,s=i.canvas.gl,r=i._sectionPlanesState,a=i.camera,o=a._state;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uViewMatrix,!1,o.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,a.project._state.matrix),r.sectionPlanes.length>0){const e=r.sectionPlanes;let t,i,a,o,n;for(let r=0,l=this._uSectionPlanes.length;r<l;r++)i=(t=this._uSectionPlanes[r]).active,a=e[r],i&&s.uniform1i(i,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(n=t.dir)&&s.uniform3fv(t.dir,a.dir)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class Rs{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Mesh picking vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),t&&a.push("   vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Mesh picking fragment shader"),s.push("precision lowp float;"),s.push("uniform vec4 pickColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = pickColor; "),s.push("}"),s}(e)}}const Ds=function(e,t){this._hash=e,this._shaderSource=new Rs(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Fs={};Ds.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Fs[t];if(!i){if((i=new Ds(t,e)).errors)return console.log(i.errors.join("\n")),null;Fs[t]=i,r.memory.programs++}return i._useCount++,i},Ds.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Fs[this._hash],r.memory.programs--)},Ds.prototype.webglContextRestored=function(){this._program=null},Ds.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene.canvas.gl,s=t._material._state,r=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){const t=s.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const r=s.frontface;e.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=r),this._lastMaterialId=s.id}i.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=r.id);var a=t._state.pickID;const o=a>>24&255,n=a>>16&255,l=a>>8&255,h=255&a;i.uniform4f(this._uPickColor,h/255,l/255,n/255,o/255),r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&i.drawArrays(i.TRIANGLES,0,r.positions.numItems)},Ds.prototype._allocate=function(e){const t=e.scene.canvas.gl;if(this._program=new z(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e.scene._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Ds.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let e,t,r,a,o;for(let n=0,l=this._uSectionPlanes.length;n<l;n++)t=(e=this._uSectionPlanes[n]).active,r=s.sectionPlanes[n],t&&i.uniform1i(t,r.active),(a=e.pos)&&i.uniform3fv(e.pos,r.pos),(o=e.dir)&&i.uniform3fv(e.dir,r.dir)}};class Ss{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=(e._state.billboard,e._state.stationary,[]);s.push("// Surface picking vertex shader"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),t&&(s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;"));s.push("varying vec4 vColor;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("   vec4 worldPosition = modelMatrix * localPosition; "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&s.push("   vWorldPosition = worldPosition;");return s.push("   vColor = color;"),s.push("   gl_Position = projMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Surface picking fragment shader"),s.push("precision lowp float;"),s.push("varying vec4 vColor;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),s.push("}"),s}(e)}}const ks=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Ss(t),this._allocate(t)},Ts={};ks.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Ts[t];if(!i){if((i=new ks(t,e)).errors)return console.log(i.errors.join("\n")),null;Ts[t]=i,r.memory.programs++}return i._useCount++,i},ks.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ts[this._hash],r.memory.programs--)},ks.prototype.webglContextRestored=function(){this._program=null},ks.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=i._sectionPlanesState,a=t._material._state,o=(t._state,t._geometry),n=t._geometry._state,l=a.backfaces,h=a.frontface,c=o._getPickTrianglePositions(),u=o._getPickTriangleColors();i.camera._state;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uViewMatrix,!1,e.pickViewMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.sectionPlanes.length>0){const e=r.sectionPlanes;let t,i,a,o,n;for(let r=0,l=this._uSectionPlanes.length;r<l;r++)i=(t=this._uSectionPlanes[r]).active,a=e[r],i&&s.uniform1i(i,a.active),(o=t.pos)&&s.uniform3fv(t.pos,a.pos),(n=t.dir)&&s.uniform3fv(t.dir,a.dir)}e.backfaces!==l&&(l?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=l),e.frontface!==h&&(h?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=h),this._lastMaterialId=a.id,s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(c,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(c),u.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,u.itemSize,u.itemType,!0,0,0),s.drawArrays(n.primitive,0,c.numItems/3)},ks.prototype._allocate=function(e){const t=e.scene.canvas.gl;if(this._program=new z(t,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e.scene._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uClippable=i.getLocation("clippable")};class Bs{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=e._state.billboard,r=e._state.stationary,a=[];a.push("// Mesh occlusion vertex shader"),a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),i&&a.push("uniform mat4 positionsDecodeMatrix;");t&&a.push("varying vec4 vWorldPosition;");"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),i&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),r&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),t&&a.push("   vWorldPosition = worldPosition;");return a.push("   gl_Position = projMatrix * viewPosition;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Mesh occlusion fragment shader"),s.push("precision lowp float;"),i){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}(e)}}const Ns=function(e,t){this._hash=e,this._shaderSource=new Bs(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Is={};Ns.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Is[t];if(!i){if((i=new Ns(t,e)).errors)return console.log(i.errors.join("\n")),null;Is[t]=i,r.memory.programs++}return i._useCount++,i},Ns.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Is[this._hash],r.memory.programs--)},Ns.prototype.webglContextRestored=function(){this._program=null},Ns.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._material._state,a=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=r.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=r.id}const o=i.camera,n=o._state;s.uniformMatrix4fv(this._uViewMatrix,!1,n.matrix),s.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=a.id),a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&s.drawArrays(s.TRIANGLES,0,a.positions.numItems)},Ns.prototype._allocate=function(e){const t=e.scene.canvas.gl;if(this._program=new z(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e.scene._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Ns.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let e,t,r,a,o;for(let n=0,l=this._uSectionPlanes.length;n<l;n++)t=(e=this._uSectionPlanes[n]).active,r=s.sectionPlanes[n],t&&i.uniform1i(t,r.active),(a=e.pos)&&i.uniform3fv(e.pos,r.pos),(o=e.dir)&&i.uniform3fv(e.dir,r.dir)}};const Os=w.OBB3(),Vs=new Float32Array(4),Us=new Float32Array(4),zs=new Float32Array(4),Gs=new Float32Array([1,0,0]),js=new Float32Array([0,1,0]),Ys=new Float32Array([0,0,1]),Hs=new Float32Array(3),Xs=new Float32Array(3),Ws=w.identityMat4();class Ks extends P{get type(){return"Mesh"}constructor(e,t={}){if(super(e,t),this._state=new Z({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:""}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._scale=w.vec3(),this._quaternion=w.identityQuaternion(),this._rotation=w.vec3(),this._position=w.vec3(),this._worldMatrix=w.identityMat4(),this._worldNormalMatrix=w.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=e}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get isMesh(){return!0}get parent(){return this._parentNode}_checkBillboard(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=bs.get(this),this._emphasisFillRenderer=ws.get(this),this._emphasisEdgesRenderer=Cs.get(this));const t=this._makePickHash();this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=Ds.get(this));const i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=Ns.get(this))}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)w.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=w.mat4()),w.transposeMat4(this._worldMatrix,this._worldNormalMatrix),w.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=w.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){w.transformOBB3(e,this._geometry.obb,Os),w.OBB3ToAABB3(Os,t)}get geometry(){return this._geometry}get material(){return this._material}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),w.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),w.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this.__localMatrix||(this.__localMatrix=w.identityMat4()),this.__localMatrix.set(e||Ws),w.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=w.identityMat4()),w.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}rotate(e,t){return Vs[0]=e[0],Vs[1]=e[1],Vs[2]=e[2],Vs[3]=t*w.DEGTORAD,w.angleAxisToQuaternion(Vs,Us),w.mulQuaternions(this.quaternion,Us,zs),this.quaternion=zs,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Vs[0]=e[0],Vs[1]=e[1],Vs[2]=e[2],Vs[3]=t*w.DEGTORAD,w.angleAxisToQuaternion(Vs,Us),w.mulQuaternions(Us,this.quaternion,Us),this}rotateX(e){return this.rotate(Gs,e)}rotateY(e){return this.rotate(js,e)}rotateZ(e){return this.rotate(Ys,e)}translate(e,t){return w.vec3ApplyQuaternion(this.quaternion,e,Hs),w.mulVec3Scalar(Hs,t,Xs),w.addVec3(this.position,Xs,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(Gs,e)}translateY(e){return this.translate(js,e)}translateZ(e){return this.translate(Ys,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set visible(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}get visible(){return this._state.visible}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}get xrayed(){return this._state.xrayed}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}get highlighted(){return this._state.highlighted}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}get selected(){return this._state.selected}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set culled(e){this._state.culled=!!e,this.glRedraw()}get culled(){return this._state.culled}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get clippable(){return this._state.clippable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get collidable(){return this._state.collidable}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}get pickable(){return this._state.pickable}set castsShadow(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get castsShadow(){return this._state.castsShadow}set receivesShadow(e){this._state.receivesShadow=!1}get receivesShadow(){return this._state.receivesShadow}set colorize(e){let t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get colorize(){return this._state.colorize}set opacity(e){let t=this._state.colorize;t||((t=this._state.colorize=new Float32Array(4))[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1,this.glRedraw()}get opacity(){return this._state.colorize[3]}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get layer(){return this._state.layer}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get isDrawable(){return!0}get isStateSortable(){return!0}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}getRenderFlags(e){e.reset();const t=this._state;if(t.xrayed){const t=this._xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedFillTransparent=!0:e.xrayedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.normalFillTransparent=!0:e.normalFillOpaque=!0,t.edges){this._edgeMaterial._state.alpha<1?e.normalEdgesTransparent=!0:e.normalEdgesOpaque=!0}if(t.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedFillTransparent=!0:e.selectedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedFillTransparent=!0:e.highlightedFillOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}drawNormalFillOpaque(e){(this._drawRenderer||(this._drawRenderer=bs.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawNormalEdgesOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawNormalFillTransparent(e){(this._drawRenderer||(this._drawRenderer=bs.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawNormalEdgesTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawXRayedFillOpaque(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawXRayedEdgesOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawXRayedFillTransparent(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawXRayedEdgesTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawHighlightedFillOpaque(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawHighlightedEdgesOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawHighlightedFillTransparent(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawHighlightedEdgesTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawSelectedFillOpaque(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawSelectedEdgesOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawSelectedFillTransparent(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=ws.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawSelectedEdgesTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Cs.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=Ds.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}drawOcclusion(e){(this._occlusionRenderer||(this._occlusionRenderer=Ns.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=ks.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i){qs(this,e,t,i)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const qs=function(){const e=w.vec3(),t=w.vec3(),i=w.vec3(),s=w.vec3(),r=w.vec3(),a=w.vec3(),o=w.vec4(),n=w.vec3(),l=w.vec3(),h=w.vec3(),c=w.vec3(),u=w.vec3(),d=w.vec3(),p=w.vec3(),_=w.vec3(),f=w.vec3(),m=w.vec4(),g=w.vec4(),v=w.vec4(),b=w.vec3(),y=w.vec3(),M=w.vec3(),x=w.vec3(),P=w.vec3(),A=w.vec3(),E=w.vec3(),C=w.vec3(),L=w.vec3(),R=w.vec3(),D=w.vec3();return function(F,S,k,T){var B=T.primIndex;if(null!=B&&B>-1){const V=F.geometry._state,U=F.scene,z=U.camera,G=U.canvas;if("triangles"===V.primitiveName){T.primitive="triangle";const U=B,j=V.indices,Y=V.positions;let H,X,W,K;if(j){var N=j[U+0],I=j[U+1],O=j[U+2];a[0]=N,a[1]=I,a[2]=O,T.indices=a,H=3*N,X=3*I,W=3*O}else W=(X=(H=3*U)+3)+3;if(i[0]=Y[H+0],i[1]=Y[H+1],i[2]=Y[H+2],s[0]=Y[X+0],s[1]=Y[X+1],s[2]=Y[X+2],r[0]=Y[W+0],r[1]=Y[W+1],r[2]=Y[W+2],V.compressGeometry){const e=V.positionsDecodeMatrix;e&&(we.decompressPosition(i,e,i),we.decompressPosition(s,e,s),we.decompressPosition(r,e,r))}T.canvasPos?(K=T.canvasPos,w.canvasPosToLocalRay(G.canvas,S,k,F.worldMatrix,K,e,t)):T.origin&&T.direction&&w.worldRayToLocalRay(F.worldMatrix,T.origin,T.direction,e,t),w.normalizeVec3(t),w.rayPlaneIntersect(e,t,i,s,r,o),T.localPos=o,T.position=o,m[0]=o[0],m[1]=o[1],m[2]=o[2],m[3]=1,w.transformVec4(F.worldMatrix,m,g),n[0]=g[0],n[1]=g[1],n[2]=g[2],T.worldPos=n,w.transformVec4(z.matrix,g,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],T.viewPos=l,w.cartesianToBarycentric(o,i,s,r,h),T.bary=h;const q=V.normals;if(q){if(V.compressGeometry){const e=3*N,t=3*I,i=3*O;we.decompressNormal(q.subarray(e,e+2),c),we.decompressNormal(q.subarray(t,t+2),u),we.decompressNormal(q.subarray(i,i+2),d)}else c[0]=q[H],c[1]=q[H+1],c[2]=q[H+2],u[0]=q[X],u[1]=q[X+1],u[2]=q[X+2],d[0]=q[W],d[1]=q[W+1],d[2]=q[W+2];const e=w.addVec3(w.addVec3(w.mulVec3Scalar(c,h[0],b),w.mulVec3Scalar(u,h[1],y),M),w.mulVec3Scalar(d,h[2],x),P);T.worldNormal=w.normalizeVec3(w.transformVec3(F.worldNormalMatrix,e,A))}const Z=V.uv;if(Z){if(p[0]=Z[2*N],p[1]=Z[2*N+1],_[0]=Z[2*I],_[1]=Z[2*I+1],f[0]=Z[2*O],f[1]=Z[2*O+1],V.compressGeometry){const e=V.uvDecodeMatrix;e&&(we.decompressUV(p,e,p),we.decompressUV(_,e,_),we.decompressUV(f,e,f))}T.uv=w.addVec3(w.addVec3(w.mulVec2Scalar(p,h[0],E),w.mulVec2Scalar(_,h[1],C),L),w.mulVec2Scalar(f,h[2],R),D)}}}}}(),Zs={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function $s(e,t,i){if(void 0===t)return i;const s=Zs[t];return void 0===s?i:e[s]}const Qs=new Uint8Array([0,0,0,1]);class Js{constructor(e,t){this.gl=e,this.target=t||e.TEXTURE_2D,this.texture=e.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}setPreloadColor(e){e?(Qs[0]=Math.floor(255*e[0]),Qs[1]=Math.floor(255*e[1]),Qs[2]=Math.floor(255*e[2]),Qs[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(Qs[0]=0,Qs[1]=0,Qs[2]=0,Qs[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,t.NEAREST),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=e.length;i<s;i++)t.texImage2D(e[i],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Qs)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Qs);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t){const i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),this.target===i.TEXTURE_CUBE_MAP){if(n.isArray(e)){const t=e,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,r=s.length;e<r;e++)i.texImage2D(s[e],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t[e])}}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)}setProps(e){const t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){const i=$s(t,e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){const i=$s(t,e.magFilter);i&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i)}if(e.wrapS){const i=$s(t,e.wrapS);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,i)}if(e.wrapT){const i=$s(t,e.wrapT);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,i)}t.bindTexture(this.target,null)}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function er(e){if(!tr(e.width)||!tr(e.height)){const t=document.createElement("canvas");t.width=ir(e.width),t.height=ir(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function tr(e){return 0==(e&e-1)}function ir(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class sr extends P{get type(){return"Texture"}constructor(e,t={}){super(e,t),this._state=new Z({texture:new Js(this.scene.canvas.gl),matrix:w.identityMat4(),hasMatrix:t.translate&&(0!==t.translate[0]||0!==t.translate[1])||!!t.rotate||t.scale&&(0!==t.scale[0]||0!==t.scale[1]),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=w.vec2([0,0]),this._scale=w.vec2([1,1]),this._rotate=w.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),r.memory.textures++}_checkMinFilter(e){return"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"nearestMipmapNearest"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),e}_checkMagFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkWrapS(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkWrapT(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkFlipY(e){return!!e}_checkEncoding(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e}_webglContextRestored(){this._state.texture=new Js(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;0===this._translate[0]&&0===this._translate[1]||(t=w.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=w.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?w.mulMat4(t,i):i),0!==this._rotate&&(i=w.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?w.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this.glRedraw()}set image(e){this._image=er(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=er(i),t._state.texture.setImage(i,t._state),t._state.texture.setProps(t._state),t.scene.loading--,t.scene.canvas.spinner.processes--,t.glRedraw()},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),r.memory.textures--}}function rr(e={}){let t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);let i=e.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=e.height||1;s<0&&(console.error("negative height not allowed - will invert"),s*=-1);let r=e.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let a=e.heightSegments||1;a<0&&(console.error("negative heightSegments not allowed - will invert"),a*=-1),a<1&&(a=1);const o=!!e.openEnded;let l=e.center;const h=l?l[0]:0,c=l?l[1]:0,u=l?l[2]:0,d=s/2,p=s/a,_=2*Math.PI/r,f=1/r,m=(t-i)/a,g=[],v=[],b=[],y=[];let M,x,w,P,A,E,C,L,R,D,F;const S=(90-180*Math.atan(s/(i-t))/Math.PI)/90;for(M=0;M<=a;M++)for(A=t-M*m,E=d-M*p,x=0;x<=r;x++)w=Math.sin(x*_),P=Math.cos(x*_),v.push(A*w),v.push(S),v.push(A*P),b.push(x*f),b.push(1*M/a),g.push(A*w+h),g.push(E+c),g.push(A*P+u);for(M=0;M<a;M++)for(x=0;x<=r;x++)L=(C=M*(r+1)+x)+r,y.push(C),y.push(L),y.push(L+1),y.push(C),y.push(L+1),y.push(C+1);if(!o&&t>0){for(R=g.length/3,v.push(0),v.push(1),v.push(0),b.push(.5),b.push(.5),g.push(0+h),g.push(d+c),g.push(0+u),x=0;x<=r;x++)w=Math.sin(x*_),P=Math.cos(x*_),D=.5*Math.sin(x*_)+.5,F=.5*Math.cos(x*_)+.5,v.push(t*w),v.push(1),v.push(t*P),b.push(D),b.push(F),g.push(t*w+h),g.push(d+c),g.push(t*P+u);for(x=0;x<r;x++)l=R,C=R+1+x,y.push(C),y.push(C+1),y.push(l)}if(!o&&i>0){for(R=g.length/3,v.push(0),v.push(-1),v.push(0),b.push(.5),b.push(.5),g.push(0+h),g.push(0-d+c),g.push(0+u),x=0;x<=r;x++)w=Math.sin(x*_),P=Math.cos(x*_),D=.5*Math.sin(x*_)+.5,F=.5*Math.cos(x*_)+.5,v.push(i*w),v.push(-1),v.push(i*P),b.push(D),b.push(F),g.push(i*w+h),g.push(0-d+c),g.push(i*P+u);for(x=0;x<r;x++)l=R,C=R+1+x,y.push(l),y.push(C+1),y.push(C)}return n.apply(e,{positions:g,normals:v,uv:b,indices:y})}function ar(e){const t="lightgrey",i="rgba(0,0,0,0.4)";var s=500+500/3,r=s/24;const a=[{boundary:[6,6,6,6],color:"#55FF55"},{boundary:[18,6,6,6],color:"#55FF55"},{boundary:[12,6,6,6],color:"#FF5555"},{boundary:[0,6,6,6],color:"#FF5555"},{boundary:[6,0,6,6],color:"#7777FF"},{boundary:[6,12,6,6],color:"#7777FF"}],o=[{label:"front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1],color:"lightgreen"},{label:"back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}],n=[{boundary:[6,6,6,6],color:"#55FF55"},{boundary:[18,6,6,6],color:"#55FF55"},{boundary:[12,6,6,6],color:"#FF5555"},{boundary:[0,6,6,6],color:"#FF5555"},{boundary:[6,0,6,6],color:"#7777FF"},{boundary:[6,12,6,6],color:"#7777FF"}],l=[{label:"front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0],color:"lightgreen"},{label:"back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0],color:"lightgreen"},{label:"right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0],color:"#FF5555"},{label:"left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0],color:"#FF5555"},{label:"top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1],color:"#5555FF"},{label:"bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-1,-1],up:[0,1,-1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[1,1,-1],up:[-1,1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,1,1],up:[-1,1,-1]},{boundaries:[[5,5,2,2]],dir:[1,-1,-1],up:[1,1,-1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,1,1],up:[1,1,-1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,1],up:[-1,1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,-1],up:[1,1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,1],up:[1,1,1]},{boundaries:[[11,5,2,2]],dir:[-1,-1,-1],up:[-1,1,-1]}];for(let e=0,t=o.length;e<t;e++)w.normalizeVec3(o[e].dir,o[e].dir),w.normalizeVec3(l[e].dir,l[e].dir);var h=l;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=s,this._textureCanvas.height=500,this._textureCanvas.style.width=s+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=t,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6,document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const c=this._textureCanvas.getContext("2d");function u(){for(let e=0,t=a.length;e<t;e++){const t=a[e],i=t.boundary,s=Math.round(i[0]*r),o=Math.round(i[1]*r),n=Math.round(i[2]*r),l=Math.round(i[3]*r);c.fillStyle=t.color,c.fillRect(s,o,n,l)}for(let a=0,l=h.length;a<l;a++){let l,u,p,_;const f=h[a],m=f.boundaries;for(var e=0,s=m.length;e<s;e++){const s=m[e];l=Math.round(s[0]*r),u=Math.round(s[1]*r),p=Math.round(s[2]*r),_=Math.round(s[3]*r),f.highlighted&&(c.fillStyle=f.highlighted?i:f.color||t,c.fillRect(l,u,p,_))}if(f.label){c.fillStyle="black",c.font="60px sans-serif",c.textAlign="center";var o=l+.5*p,n=u+.7*_;c.fillText(d(f.label),o,n,80)}}}var d=function(){const t={yUp:{front:"+Z",back:"-Z",right:"+X",left:"-X",top:"+Y",bottom:"-Y"},en:{front:"FRONT",back:"BACK",right:"RIGHT",left:"LEFT",top:"TOP",bottom:"BOTTOM"}};return function(i){var s;return(s=t[e.language||"en"])&&s[i]||i}}();this.setZUp=function(){!0,a,h=o,this.clear()},this.setYUp=function(){!1,n,h=l,this.clear()},this.clear=function(){c.fillStyle=t,c.fillRect(0,0,s,500);for(var e=0,i=h.length;e<i;e++){h[e].highlighted=!1}u()},this.getArea=function(e){const t=e[0]*s,i=500-500*e[1];for(var a=0,o=h.length;a<o;a++){const e=h[a].boundaries;for(var n=0,l=e.length;n<l;n++){const s=e[n];if(t>=s[0]*r&&t<=(s[0]+s[2])*r&&i>=s[1]*r&&i<=(s[1]+s[3])*r)return a}}return-1},this.setAreaHighlighted=function(e,t){var i=h[e];if(!i)throw"Area not found: "+e;i.highlighted=!!t,u()},this.getAreaDir=function(e){var t=h[e];if(!t)throw"Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=h[e];if(!t)throw"Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)},this.clear()}class or extends os{constructor(e,t={}){super("NavCube",e,t),e.navCube=this;if(!t.canvasId)return void this.error("Config missing: canvasId");if(this._navCubeCanvas=document.getElementById(t.canvasId),!this._navCubeCanvas)return void this.error("Can't find NavCube canvas: '"+t.canvasId+"'");this._navCubeScene=new Oe({canvasId:this._navCubeCanvas.id,transparent:!0});const i=this._navCubeScene;i.clearLights(),new me(i,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new me(i,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new me(i,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=i.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,this._zUp=!1,this._cameraFitFOV=t.cameraFitFOV||45;var s,r,a,o,n=this;this._synchCamera=(s=w.rotationMat4c(-90*w.DEGTORAD,1,0,0),r=w.vec3(),a=w.vec3(),o=w.vec3(),function(){var t=e.camera.eye,i=e.camera.look,l=e.camera.up;r=w.mulVec3Scalar(w.normalizeVec3(w.subVec3(t,i,r)),5),n._zUp?(w.transformVec3(s,r,a),w.transformVec3(s,l,o),n._navCubeCamera.look=[0,0,0],n._navCubeCamera.eye=w.transformVec3(s,r,a),n._navCubeCamera.up=w.transformPoint3(s,l,o)):(n._navCubeCamera.look=[0,0,0],n._navCubeCamera.eye=r,n._navCubeCamera.up=l)}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",this._synchCamera),this._onCameraFOV=e.camera.perspective.on("fov",e=>{this._navCubeCamera.perspective.fov=e}),this._onCameraProjection=e.camera.on("projection",e=>{this._navCubeCamera.projection=e}),e.camera.on("worldAxis",e=>{}),this._cubeTextureCanvas=new ar(e),this._cubeSampler=new sr(i,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge"}),this._cubeMesh=new Ks(i,{geometry:new Le(i,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new Se(i,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=new Ks(i,{geometry:new Le(i,rr({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new Se(i,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1});var l=-1;function h(e){var t=[0,0];if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t}var c,u,d=null,p=null,_=!1,f=!1,m=0,g=null,v=null,b=.5;n._navCubeCanvas.addEventListener("mouseenter",n._onMouseEnter=function(e){f=!0}),n._navCubeCanvas.addEventListener("mouseleave",n._onMouseLeave=function(e){f=!1}),n._navCubeCanvas.addEventListener("mousedown",n._onMouseDown=function(e){d=e.x,p=e.y,c=e.clientX,u=e.clientY;var t=h(e),s=i.pick({canvasPos:t});_=!!s}),document.addEventListener("mouseup",n._onMouseUp=function(e){if(1===e.which&&(_=!1,null!==d)){var t=h(e),s=i.pick({canvasPos:t,pickSurface:!0});if(s&&s.uv){var r=n._cubeTextureCanvas.getArea(s.uv);if(r>=0&&(document.body.style.cursor="pointer",l>=0&&(n._cubeTextureCanvas.setAreaHighlighted(l,!1),n._repaint(),l=-1),r>=0)){if(n._cubeTextureCanvas.setAreaHighlighted(r,!0),l=r,n._repaint(),e.x<d-3||e.x>d+3||e.y<p-3||e.y>p+3)return;var a=n._cubeTextureCanvas.getAreaDir(r);if(a){var o=n._cubeTextureCanvas.getAreaUp(r);M(a,o,function(){l>=0&&(n._cubeTextureCanvas.setAreaHighlighted(l,!1),n._repaint(),l=-1);var e=i.pick({canvasPos:t,pickSurface:!0});if(e&&e.uv){var s=n._cubeTextureCanvas.getArea(e.uv);void 0!==s&&(document.body.style.cursor="pointer",l>=0&&(n._cubeTextureCanvas.setAreaHighlighted(l,!1),n._repaint(),l=-1),s>=0&&(n._cubeTextureCanvas.setAreaHighlighted(s,!0),l=s,n._repaint()))}})}}}}}),document.addEventListener("mousemove",n._onMouseMove=function(t){if(l>=0&&(n._cubeTextureCanvas.setAreaHighlighted(l,!1),n._repaint(),l=-1),1!==t.buttons||_){if(_){var s=t.clientX,r=t.clientY;return document.body.style.cursor="move",void function(t,i){var s=(t-c)*-b,r=(i-u)*-b;s,m-=r,void 0!==g&&m<g&&(m=g),void 0!==v&&m>v&&(m=v),e.camera.orbitYaw(s),e.camera.orbitPitch(-r),c=t,u=i}(s,r)}if(f){var a=h(t),o=i.pick({canvasPos:a,pickSurface:!0});if(o){if(o.uv){document.body.style.cursor="pointer";var d=n._cubeTextureCanvas.getArea(o.uv);if(d===l)return;l>=0&&n._cubeTextureCanvas.setAreaHighlighted(l,!1),d>=0&&(n._cubeTextureCanvas.setAreaHighlighted(d,!0),n._repaint(),l=d)}}else document.body.style.cursor="default",l>=0&&(n._cubeTextureCanvas.setAreaHighlighted(l,!1),n._repaint(),l=-1)}}});var y,M=(y=w.vec3(),function(t,i,s){var r=e.scene.aabb,a=w.getAABB3Diag(r);w.getAABB3Center(r,y);var o=Math.abs(a/Math.tan(n._cameraFitFOV/2));n._cameraFly?e.cameraFlight.flyTo({look:y,eye:[y[0]-o*t[0],y[1]-o*t[1],y[2]-o*t[2]],up:i||[0,1,0],orthoScale:1.3*a,fitFOV:n._cameraFitFOV,duration:n._cameraFlyDuration},s):e.cameraFlight.jumpTo({look:y,eye:[y[0]-o*t[0],y[1]-o*t[1],y[2]-o*t[2]],up:i||[0,1,0],orthoScale:1.3*a,fitFOV:n._cameraFitFOV},s)});this.setVisible(t.visible),this.setCameraFitFOV(t.cameraFitFOV),this.setCameraFly(t.cameraFly),this.setCameraFlyDuration(t.cameraFlyDuration)}send(e,t){switch(e){case"language":this._cubeTextureCanvas.clear(),this._repaint()}}_repaint(){const e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}setVisible(e=!0){this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow.visible=e,this._navCubeCanvas.style.visibility=e?"visible":"hidden")}getVisible(){return!!this._navCubeCanvas&&this._cubeMesh.visible}setCameraFly(e=!0){this._cameraFly=e}getCameraFly(){return this._cameraFly}setCameraFitFOV(e=45){this._cameraFitFOV=e}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(e=.5){this._cameraFlyDuration=e}getCameraFlyDuration(){return this._cameraFlyDuration}destroy(){this._navCubeCanvas&&(this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}class nr extends P{get type(){return"CameraPathAnimation"}constructor(e,t={}){super(e,t),this._cameraFlightAnimation=new Ye(this),this._t=0,this.state=nr.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=t.playingRate||1,this._playingDir=1,this.cameraPath=t.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let t,i;switch(this.state){case nr.SCRUBBING:return;case nr.PLAYING:if(this._t+=this._playingRate,0===(t=this._cameraPath.frames.length)||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t)return this.state=nr.SCRUBBING,void(this._t=this._cameraPath.frames[t-1].t);e.loadFrame(this._t);break;case nr.PLAYING_TO:i=this._t+this._playingRate*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=nr.SCRUBBING),this._t=i,e.loadFrame(this._t)}}_ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this.state=nr.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this.state=nr.PLAYING_TO)}playToFrame(e){const t=this._cameraPath;if(!t)return;const i=t.frames[e];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+e)}flyToFrame(e,t){const i=this._cameraPath;if(!i)return;const s=i.frames[e];s?(this.state=nr.SCRUBBING,this._cameraFlightAnimation.flyTo(s,t)):this.error("flyToFrame - frame index out of range: "+e)}scrubToT(e){const t=this._cameraPath;t&&this.scene.camera&&(this._t=e,t.loadFrame(this._t),this.state=nr.SCRUBBING)}scrubToFrame(e){const t=this._cameraPath;t&&this.scene.camera&&(t.frames[e]?(t.loadFrame(this._t),this.state=nr.SCRUBBING):this.error("playToFrame - frame index out of range: "+e))}stop(){this.state=nr.SCRUBBING}destroy(){super.destroy(),this.scene.off(this._tick)}}nr.STOPPED=0,nr.SCRUBBING=1,nr.PLAYING=2,nr.PLAYING_TO=3;class lr extends P{constructor(e,t={}){super(e,t),this.t=t.t}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get tangent(){return this.getTangent(this._t)}get length(){var e=this._getLengths();return e[e.length-1]}getTangent(e){void 0===e&&(e=this._t);var t=e-1e-4,i=e+1e-4;t<0&&(t=0),i>1&&(i=1);var s=this.getPoint(t),r=this.getPoint(i),a=w.subVec3(r,s,[]);return w.normalizeVec3(a,[])}getPointAt(e){var t=this.getUToTMapping(e);return this.getPoint(t)}getPoints(e){e||(e=5);var t,i=[];for(t=0;t<=e;t++)i.push(this.getPoint(t/e));return i}_getLengths(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,s=[],r=this.getPoint(0),a=0;for(s.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),a+=w.lenVec3(w.subVec3(t,r,[])),s.push(a),r=t;return this.cacheArcLengths=s,s}_updateArcLengths(){this.needsUpdate=!0,this._getLengths()}getUToTMapping(e,t){var i,s=this._getLengths(),r=0,a=s.length;i=t||e*s[a-1];for(var o,n=0,l=a-1;n<=l;)if((o=s[r=Math.floor(n+(l-n)/2)]-i)<0)n=r+1;else{if(!(o>0)){l=r;break}l=r-1}if(s[r=l]===i)return r/(a-1);var h=s[r];return(r+(i-h)/(s[r+1]-h))/(a-1)}}class hr extends lr{constructor(e,t={}){super(e,t),this.points=t.points,this.t=t.t}set points(e){this._points=e||[]}get points(){return this._points}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(e){var t=this.points;if(!(t.length<3)){var i=(t.length-1)*e,s=Math.floor(i),r=i-s,a=t[0===s?s:s-1],o=t[s],n=t[s>t.length-2?t.length-1:s+1],l=t[s>t.length-3?t.length-1:s+2],h=w.vec3();return h[0]=w.catmullRomInterpolate(a[0],o[0],n[0],l[0],r),h[1]=w.catmullRomInterpolate(a[1],o[1],n[1],l[1],r),h[2]=w.catmullRomInterpolate(a[2],o[2],n[2],l[2],r),h}this.error("Can't sample point from SplineCurve - not enough points on curve - returning [0,0,0].")}getJSON(){return{points:points,t:this._t}}}const cr=w.vec3();class ur extends P{get type(){return"CameraPath"}constructor(e,t={}){super(e,t),this._frames=[],this._eyeCurve=new hr(this),this._lookCurve=new hr(this),this._upCurve=new hr(this),t.frames&&this.addFrames(t.frames)}get frames(){return this._frames}get eyeCurve(){return this._eyeCurve}get lookCurve(){return this._lookCurve}get upCurve(){return this._upCurve}saveFrame(e){const t=this.scene.camera;this.addFrame(e,t.eye,t.look,t.up)}addFrame(e,t,i,s){const r={t:e,eye:t.slice(0),look:i.slice(0),up:s.slice(0)};this._frames.push(r),this._eyeCurve.points.push(r.eye),this._lookCurve.points.push(r.look),this._upCurve.points.push(r.up)}addFrames(e){let t;for(let i=0,s=e.length;i<s;i++)t=e[i],this.addFrame(t.t||0,t.eye,t.look,t.up)}loadFrame(e){const t=this.scene.camera;e=(e/=this._frames[this._frames.length-1].t-this._frames[0].t)<0?0:e>1?1:e,t.eye=this._eyeCurve.getPoint(e,cr),t.look=this._lookCurve.getPoint(e,cr),t.up=this._upCurve.getPoint(e,cr)}sampleFrame(e,t,i,s){e=e<0?0:e>1?1:e,this._eyeCurve.getPoint(e,t),this._lookCurve.getPoint(e,i),this._upCurve.getPoint(e,s)}smoothFrameTimes(e){if(0===this._frames.length)return;const t=w.vec3();var i=0;this._frames[0].t=0;const s=[];for(let e=1,a=this._frames.length;e<a;e++){var r=w.lenVec3(w.subVec3(this._frames[e].eye,this._frames[e-1].eye,t));s[e]=r,i+=r}for(let t=1,r=this._frames.length;t<r;t++)this._frames[t].t=this._frames[t-1].t+s[t]/i*e}clearFrames(){this._frames=[],this._eyeCurve.points=[],this._lookCurve.points=[],this._upCurve.points=[]}}class dr extends P{constructor(e,t={}){super(e,t),this._skyboxMesh=new Ks(this,{geometry:new Le(this,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),scale:[2e3,2e3,2e3],rotation:[0,-90,0],material:new Se(this,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:new sr(this,{src:t.src,flipY:!0,encoding:t.encoding||"sRGB"}),backfaces:!0}),visible:!1,pickable:!1,collidable:!1}),this.size=t.size,this.active=t.active}set size(e){this._size=e||1e3,this._skyboxMesh.scale=[this._size,this._size,this._size]}get size(){return this._size}set active(e){this._skyboxMesh.visible=e}get active(){return this._skyboxMesh.visible}}function pr(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);let s=e.xSegments||1;s<0&&(console.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=e.xSegments||1;r<0&&(console.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const a=e.center,o=a?a[0]:0,l=a?a[1]:0,h=a?a[2]:0,c=t/2,u=i/2,d=Math.floor(s)||1,p=Math.floor(r)||1,_=d+1,f=p+1,m=t/d,g=i/p,v=new Float32Array(_*f*3),b=new Float32Array(_*f*3),y=new Float32Array(_*f*2);let M,x,w,P,A,E,C,L=0,R=0;for(M=0;M<f;M++){const e=M*g-u;for(x=0;x<_;x++)w=x*m-c,v[L]=w+o,v[L+1]=l,v[L+2]=-e+h,b[L+2]=-1,y[R]=(d-x)/d,y[R+1]=(p-M)/p,L+=3,R+=2}L=0;const D=new(v.length/3>65535?Uint32Array:Uint16Array)(d*p*6);for(M=0;M<p;M++)for(x=0;x<d;x++)P=x+_*M,A=x+_*(M+1),E=x+1+_*(M+1),C=x+1+_*M,D[L]=C,D[L+1]=A,D[L+2]=P,D[L+3]=C,D[L+4]=E,D[L+5]=A,L+=6;return n.apply(e,{positions:v,normals:b,uv:y,indices:D})}document.body.onload=function(){const e=new qe({canvasId:"myCanvas",transparent:!0});e.scene.camera.eye=[10.45,17.38,-98.31],e.scene.camera.look=[43.09,.5,-26.76],e.scene.camera.up=[.06,.96,.16],e.scene.camera.perspective.fov=40,e.scene.selectedMaterial.fillAlpha=.1,e.cameraControl.firstPerson=!0,e.cameraFlight.fitFOV=75,new Ks(e.scene,{geometry:new Le(e.scene,pr({xSize:2500,zSize:2500})),material:new Se(e.scene,{diffuse:[.2,.7,.2],backfaces:!0}),position:[0,-2,0],pickable:!1,collidable:!1});new or(e,{canvasId:"myNavCubeCanvas",visible:!0,size:250,alignment:"topRight",topMargin:170,cameraFly:!0,cameraFitFOV:65,cameraFlyDuration:.5});const t=new ps(e).load({id:"myModel",src:"data/models/xkt/OTCConferenceCenter/OTCConferenceCenter.xkt",metaModelSrc:"data/metaModels/OTCConferenceCenter/metaModel.json",edges:!0});new dr(e.scene,{src:"data/textures/skyboxes/cloudySkyBox.jpg",size:1e3});const i=[{t:0,eye:[10.449999809265137,17.3799991607666,-98.30999755859375],look:[43.09000015258789,.5,-26.760000228881836],up:[.05999999865889549,.9599999785423279,.1599999964237213]},{t:1,eye:[49.10879898071289,9.237162590026855,-99.9477310180664],look:[49.10879898071289,9.237162590026855,-29.48837661743164],up:[0,1,0]},{t:2,eye:[98.93108367919922,9.237162590026855,-79.31066131591797],look:[49.10879898071289,9.237162590026855,-29.48837661743164],up:[0,1,0]},{t:3,eye:[119.56815338134766,9.237162590026855,-29.48837661743164],look:[49.10879898071289,9.237162590026855,-29.48837661743164],up:[0,1,0]},{t:4,eye:[98.93108367919922,9.237162590026855,20.33390998840332],look:[49.10879898071289,9.237162590026855,-29.48837661743164],up:[0,1,0]},{t:5,eye:[49.10879898071289,9.237162590026855,40.970977783203125],look:[49.10879898071289,9.237162590026855,-29.48837661743164],up:[0,1,0]},{t:6,eye:[60.452980041503906,5.4778642654418945,7.06841516494751],look:[60.452980041503906,5.4778642654418945,-63.39092254638672],up:[0,1,0]},{t:7,eye:[67.25090789794922,2.1742258071899414,-25.556394577026367],look:[67.25090789794922,2.1742258071899414,-96.0157470703125],up:[0,1,0]},{t:8,eye:[68.87596130371094,1.7158464193344116,-42.77796173095703],look:[-1.51083242893219,-1.3406599760055542,-43.723968505859375],up:[-.04337577521800995,.9990599155426025,-.0005829741712659597]},{t:9,eye:[75.52992248535156,2.2329771518707275,-58.72169876098633],look:[26.099660873413086,-1.021628737449646,-8.616039276123047],up:[-.03243977576494217,.9989341497421265,.03288296237587929]},{t:10,eye:[40.69363784790039,2.919964075088501,-65.05496215820312],look:[41.92532730102539,9.625773429870605,5.074016094207764],up:[-.0016713117947801948,.9954627156257629,-.0951581671833992]},{t:11,eye:[18.983766555786133,2.655843496322632,-64.64852142333984],look:[20.215457916259766,9.361654281616211,5.480562686920166],up:[-.0016713117947801948,.9954627156257629,-.0951581671833992]},{t:12,eye:[9.118672370910645,6.608935832977295,-56.631927490234375],look:[14.692089080810547,10.801454544067383,13.48182487487793],up:[-.004715084098279476,.9982303977012634,-.059315573424100876]},{t:13,eye:[12.325481414794922,6.173153877258301,-38.165767669677734],look:[33.274269104003906,9.972784042358398,29.00037384033203],up:[-.016056619584560394,.9985471963882446,-.05148075148463249]},{t:14,eye:[13.830201148986816,6.100258827209473,-32.02607345581055],look:[-54.385101318359375,-11.52660083770752,-32.77553176879883],up:[-.2501545250415802,.9682056307792664,-.0027484712190926075]},{t:15,eye:[15.001229286193848,6.177117824554443,-25.8507137298584],look:[-53.21399688720703,-11.449746131896973,-26.60016632080078],up:[-.2501545250415802,.9682056307792664,-.0027484712190926075]},{t:16,eye:[13.10634994506836,5.951435089111328,-14.277751922607422],look:[72.52796936035156,-4.327131271362305,-50.71895980834961],up:[.12435629218816757,.9893066883087158,-.07626304030418396]},{t:17,eye:[23.32726287841797,5.76120662689209,-15.126765251159668],look:[27.343843460083008,-.392856627702713,-85.20191955566406],up:[.0049982876516878605,.9961833357810974,-.08719765394926071]},{t:18,eye:[29.602476119995117,6.041967868804932,-14.791736602783203],look:[33.61904525756836,-.11209755390882492,-84.86698150634766],up:[.0049982876516878605,.9961833357810974,-.08719765394926071]},{t:19,eye:[29.600866317749023,5.945443630218506,-27.180505752563477],look:[-39.207435607910156,.9682354927062988,-41.505836486816406],up:[-.06915532797574997,.9975070953369141,-.014397842809557915]},{t:20,eye:[14.093534469604492,5.877283096313477,-31.99447250366211],look:[-56.21117401123047,1.3034216165542603,-32.95225143432617],up:[-.06490764766931534,.997896134853363,-.00088452675845474]},{t:21,eye:[7.193114757537842,4.652937889099121,-31.983610153198242],look:[-1.2233401536941528,-6.07865571975708,37.14375305175781],up:[-.01840820163488388,.9883388876914978,.15119116008281708]},{t:22,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[76.40155792236328,-8.766175270080566,-22.826677322387695],up:[.1669786274433136,.9859421849250793,.006992913316935301]},{t:23,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[76.40155792236328,-8.766175270080566,-22.826677322387695],up:[.1669786274433136,.9859421849250793,.006992913316935301]},{t:24,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[-8.292724609375,44.24230194091797,29.319093704223633],up:[.1565653532743454,.8108972907066345,-.5638681650161743]},{t:25,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[-31.262920379638672,62.16260528564453,-27.14556121826172],up:[.8389599919319153,.5433249473571777,.030968336388468742]},{t:26,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[-13.927155494689941,28.453279495239258,-88.01988220214844],up:[.11497681587934494,.932532012462616,.3423153758049011]},{t:27,eye:[6.993342399597168,3.009431838989258,-25.73332405090332],look:[77.2800064086914,-1.8678998947143555,-26.56573486328125],up:[.06921900063753128,.9976098537445068,-.000818573753349483]},{t:28,eye:[13.432293891906738,2.444504499435425,-23.940013885498047],look:[37.39179992675781,4.128542423248291,-90.18046569824219],up:[-.008127529174089432,.9997235536575317,.022473540157079697]}];var s=new ur(e.scene,{frames:i});s.smoothFrameTimes(1);var r=new nr(e.scene,{cameraPath:s,playingRate:5e-4});t.on("loaded",function(){setTimeout(function(){r.play(0)},1e3)}),window.viewer=e,window.positions=i,e.scene.input.on("keydown",function(){i.push({t:i.length,eye:[e.scene.camera.eye[0],e.scene.camera.eye[1],e.scene.camera.eye[2]],look:[e.scene.camera.look[0],e.scene.camera.look[1],e.scene.camera.look[2]],up:[e.scene.camera.up[0],e.scene.camera.up[1],e.scene.camera.up[2]]})}),window.get=function(){console.log(JSON.stringify(i,null,"\t"))}}}]);